

<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>我不想努力了</title>
  
  <!-- 引入 xlsx.js 函式庫，用於處理 Excel 檔案 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- 引入 Supabase.js 函式庫 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- 引入 Chart.js 圖表庫 -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <!-- 引入 Google Fonts 的 LXGW WenKai TC (霞鶩文楷 TC) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=LXGW+WenKai+TC&display=swap" rel="stylesheet">
<style>
  
/* ========================================= */
/* 1. 核心變數 & Z-Index (系統設定) */
/* ========================================= */
:root {
  /* --- 顏色 --- */
  --primary-bg: #f7f3eb;       /* 主背景 - 米白 */
  --secondary-bg: #fcfaf6;     /* 卡片背景 - 奶油白 */
  --text-color: #5b5044;       /* 文字 - 深啡灰 */
  --border-color: #e1d8c8;     /* 邊框 - 淺亞麻 */
  --accent-color: #5A8F7B;     /* 主題色 - 灰綠 */
  --accent-color-soft: #cfe3d9;
  --title-color: #3d5c4f;      /* 標題色 - 深灰綠 */
  --header-bg: linear-gradient(120deg, #5A8F7B, #93b8a5); 
  --problem-color: #c86a5a;    /* 待改進 - 磚紅 */
  --excellent-color: #7a9e78;  /* 優點 - 橄欖綠 */
  --shadow-color: rgba(52, 43, 32, 0.10);
  
  --radius-lg: 14px;
  --radius-md: 10px;
  --radius-sm: 6px;
  --transition-fast: 0.18s ease-out;

  /* --- Z-Index 層級系統 (由低至高) --- */
  --z-back: -1;
  --z-normal: 1;
  --z-sticky: 100;        /* 黏性標題 */
  --z-nav: 500;           /* 導航列 */
  --z-float-btn: 600;     /* 懸浮按鈕 */
  --z-dropdown: 800;      /* 下拉選單 */
  --z-modal-backdrop: 1000; 
  --z-modal: 1001;        /* 彈窗內容 */
  --z-toast: 2000;        /* 系統通知 */
  --z-login-gate: 3000;   /* 登入牆 (最高) */
}

html { scroll-behavior: smooth; font-size: 16px; }
body {
  font-family: 'LXGW WenKai TC', sans-serif;
  line-height: 1.7;
  letter-spacing: 0.04em;
  background: radial-gradient(circle at top left, #faf3e4, #f5f3ef 55%, #f1f5f4);
  color: var(--text-color);
  margin: 0; padding: 0;
}

/* ========================================= */
/* 2. 佈局容器 (Layout) */
/* ========================================= */
.main-container { 
  max-width: 1200px;
  margin: 2rem auto 2.5rem; 
  background-color: var(--secondary-bg); 
  box-shadow: 0 18px 45px var(--shadow-color); 
  border-radius: 20px; 
  overflow: hidden;
  border: 1px solid rgba(255,255,255,0.7);
  backdrop-filter: blur(10px);
  position: relative;
}

.sticky-top-bar {
  position: sticky; top: 0; z-index: var(--z-sticky);
  background-color: var(--secondary-bg);
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.page-content { 
  display: none; /* 預設隱藏，由 JS 控制顯示 */
  background: radial-gradient(circle at top, #fdfbf7 0, #fbf8f3 45%, #f3f4f6 100%);
  min-height: 80vh;
}
.page-content.active { display: block; }

.section-box {
  padding: 2rem;
  border-bottom: 1px solid rgba(225,216,200,0.6);
  background-color: rgba(252,250,246,0.88);
  scroll-margin-top: 160px; /* 捲動時預留空間 */
}

/* ========================================= */
/* 3. 頁首與導航 (Header & Nav) */
/* ========================================= */
header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1rem 1.5rem;
  background: var(--header-bg);
  color: white;
  position: relative;
  z-index: var(--z-nav);
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.header-left {
  display: flex; flex-direction: column; gap: 6px;
  max-width: 85%;
}

header h1 {
  margin: 0; font-size: 1.8rem; font-weight: 500; letter-spacing: 0.1em; line-height: 1.2;
}

/* 身份與按鈕區 */
.auth-container {
  display: inline-flex; align-items: center; gap: 8px;
  background-color: rgba(255, 255, 255, 0.15);
  padding: 4px 10px; border-radius: 99px; width: fit-content;
}
#auth-status { font-size: 0.8rem; white-space: nowrap; }
#auth-buttons { display: flex; gap: 5px; }

/* 右側工具區 */
.header-right {
  display: flex; align-items: center; gap: 12px;
  position: relative;
}

/* 設定按鈕 (齒輪) */
.font-control-btn {
  width: 36px; height: 36px;
  border-radius: 50%; border: none;
  background: rgba(255,255,255,0.25); color: #fff;
  cursor: pointer; display: flex; align-items: center; justify-content: center;
  font-size: 1.2rem; transition: background 0.2s;
}
.font-control-btn:hover { background: rgba(255,255,255,0.4); }

/* 設定選單 (Dropdown) */
.settings-menu-popover {
  position: fixed;
  top: 70px; right: 30px;
  background: #fff; border-radius: 12px;
  box-shadow: 0 10px 60px rgba(0,0,0,0.3);
  width: 200px; padding: 12px;
  z-index: var(--z-dropdown);
  color: #555; text-align: left;
}

/* 導航列 (Tab) */
.page-nav-wrapper { background: #fff; position: relative; z-index: var(--z-sticky); }
.main-nav {
  display: flex; justify-content: center; gap: 2rem; padding: 0 1rem;
  height: 60px; align-items: center;
}
.nav-btn {
  background: transparent; border: none; cursor: pointer;
  padding: 8px 16px; border-radius: 12px; color: #888;
  font-size: 1rem; font-weight: 500; display: flex; align-items: center; gap: 6px;
}
.nav-btn.active { color: var(--accent-color); background-color: var(--accent-color-soft); font-weight: bold; }

/* 子導航懸浮島 */
.sub-nav-island {
  position: absolute; top: 65px; left: 50%; transform: translateX(-50%);
  background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);
  border: 1px solid rgba(0,0,0,0.05); box-shadow: 0 8px 30px rgba(0,0,0,0.08);
  padding: 6px 8px; border-radius: 99px;
  display: flex; gap: 5px; z-index: var(--z-dropdown); white-space: nowrap;
}
.sub-nav-btn {
  padding: 6px 16px; font-size: 0.9rem; background: transparent;
  border: none; border-radius: 99px; cursor: pointer; color: #666;
}
.sub-nav-btn.active { background-color: var(--accent-color); color: #fff; }

/* ========================================= */
/* 4. 按鈕與輸入框 (UI Components) */
/* ========================================= */
.action-btn, .secondary-btn, .danger-btn, .light-btn, .pop-btn {
  border-radius: 999px; border: none; cursor: pointer;
  font-family: inherit; font-size: 0.98rem; padding: 0.7rem 1.5rem;
  transition: transform var(--transition-fast), box-shadow var(--transition-fast);
  display: inline-flex; align-items: center; justify-content: center;
  white-space: nowrap;
}
.action-btn { background: linear-gradient(135deg, #5A8F7B, #78a693); color: white; box-shadow: 0 10px 20px rgba(41,81,64,0.35); }
.secondary-btn { background: linear-gradient(135deg, #a18b73, #8f7a63); color: white; }
.danger-btn { background: linear-gradient(135deg, #c86a5a, #de8b7c); color: white; }
.light-btn { background: #cfe3d9; color: #305244; }

.input-group { margin-bottom: 1.25rem; }
.input-group label { display: block; font-weight: 600; margin-bottom: 0.55rem; color: #716659; }
input[type="text"], input[type="number"], textarea, select, .pop-input {
  width: 100%; padding: 0.75rem 1rem;
  border: 1px solid var(--border-color); border-radius: var(--radius-md);
  font-size: 0.96rem; background-color: #fefcf9; box-sizing: border-box;
}
textarea { resize: vertical; min-height: 90px; }

/* ========================================= */
/* 5. 彈窗樣式 (Popups) */
/* ========================================= */
.pop-overlay {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(105, 129, 118, 0.6); backdrop-filter: blur(5px);
  display: flex; justify-content: center; align-items: center;
  z-index: var(--z-modal-backdrop);
  opacity: 0; pointer-events: none; transition: opacity 0.25s ease;
}
.pop-overlay.active { opacity: 1; pointer-events: auto; }

.pop-modal {
  background: #ffffff; width: 90%; max-width: 460px; max-height: 85vh;
  display: flex; flex-direction: column;
  border-radius: 24px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
  border: 4px solid #F2C037; padding: 24px;
  transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
  z-index: var(--z-modal);
}
.pop-overlay.active .pop-modal { transform: scale(1); }

.pop-scroll-area {
  background: #fffdf5; border-radius: 12px; padding: 10px;
  flex: 1; overflow-y: auto; min-height: 100px;
  margin-bottom: 20px; border: 2px solid #eee; text-align: left;
}
.pop-list-item {
  display: flex; align-items: center; padding: 10px; margin-bottom: 8px;
  background: #fff; border: 1px solid #eee; border-radius: 8px; cursor: pointer;
}
.pop-footer {
  display: flex; justify-content: center; gap: 12px; margin-top: auto; flex-wrap: wrap;
}
.pop-btn { min-width: 100px; font-weight: bold; }
.pop-btn-confirm { background: #F2C037; color: #fff; }
.pop-btn-cancel { background: #f0f0f0; color: #666; }

/* 登入牆特別樣式 */
#login-gate {
  position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(47, 79, 79, 0.9); backdrop-filter: blur(15px);
  z-index: var(--z-login-gate);
  display: flex; justify-content: center; align-items: center;
  transition: opacity 0.8s, visibility 0.8s;
}
#login-gate.unlocked { opacity: 0; visibility: hidden; pointer-events: none; }

/* ========================================= */
/* 6. Dashboard & 評語表 (Features) */
/* ========================================= */
.folder-grid {
  display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem;
}
.cozy-folder {
  background: #ffffff; border-radius: 16px; padding: 1.5rem;
  box-shadow: 0 4px 20px rgba(0,0,0,0.03); border: 1px solid rgba(0,0,0,0.06);
  cursor: pointer; transition: transform 0.3s; position: relative;
  display: flex; flex-direction: column; justify-content: space-between; min-height: 160px;
}
.cozy-folder:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0,0,0,0.08); }

/* 評語 Checkbox */
.check-item {
  border: 1px solid rgba(225,216,200,0.9); border-radius: 10px;
  margin-bottom: 0.8rem; background: #ffffff; cursor: pointer;
}
.check-item:has(input:checked) {
  background-color: #fcfdfc; border-color: var(--accent-color);
  box-shadow: 0 0 0 1px var(--accent-color) inset;
}
.check-item-header { display: flex; align-items: center; position: relative; padding: 0; }
.check-item-header input { position: absolute; left: 12px; pointer-events: none; }
.check-item-header label { flex: 1; padding: 14px 12px 14px 42px; cursor: pointer; user-select: none; }

/* 學生總覽表格 */
#student-overview-table-wrapper {
  overflow: auto; max-height: 70vh; margin-top: 1.25rem;
  background: #fdfbf8; border-radius: 12px; border: 1px solid rgba(225,216,200,0.9);
}
#student-overview-table { width: 100%; border-collapse: separate; border-spacing: 0; }
#student-overview-table th { position: sticky; top: 0; background: #f1ece4; z-index: 10; padding: 10px; }
#student-overview-table td { padding: 10px; border: 1px solid #eee; text-align: center; }
/* 凍結左側 */
#student-overview-table th:nth-child(1), #student-overview-table td:nth-child(1) {
  position: sticky; left: 0; z-index: 11; background: #fdfbf8; width: 80px;
}
#student-overview-table th:nth-child(2), #student-overview-table td:nth-child(2) {
  position: sticky; left: 80px; z-index: 11; background: #fdfbf8; width: 90px; border-right: 2px solid var(--accent-color);
}

/* Back To Top Button */
#back-to-top-btn {
  position: fixed; bottom: 30px; right: 30px; z-index: var(--z-toast);
  width: 45px; height: 45px; border-radius: 50%;
  background: rgba(90, 143, 123, 0.3); color: #fff;
  border: none; cursor: pointer; backdrop-filter: blur(4px);
}

/* ========================================= */
/* 7. 手機版與響應式 (Mobile RWD) */
/* ========================================= */
@media (max-width: 768px) {
  /* 容器調整 */
  .main-container { margin: 0; border-radius: 0; border: none; box-shadow: none; }
  .section-box { padding: 1.25rem 1rem; }
  
  /* Header 調整 */
  header {
    flex-direction: column; align-items: flex-start; gap: 10px; padding: 15px 20px;
  }
  .header-right { position: absolute; bottom: 15px; right: 20px; }
  .settings-menu-popover { top: 50px; right: 10px; }

  /* 導航調整 */
  .main-nav { justify-content: space-between; padding: 0 10px; width: 100%; }
  .nav-btn .nav-text { display: none; } /* 手機隱藏文字 */
  .nav-btn .nav-icon { font-size: 1.5rem; margin: 0; }
  
  .sub-nav-island {
    position: static; transform: none; width: 100%; border-radius: 0;
    justify-content: center; padding: 10px 0; background: #fcfcfc;
  }

  /* 表格卡片化 (Card View) */
  #student-overview-table-wrapper { border: none; box-shadow: none; }
  #student-overview-table thead { display: none; }
  #student-overview-table, tbody, tr, td { display: block; width: 100%; }
  #student-overview-table tr {
    margin-bottom: 20px; border: 2px solid var(--accent-color);
    border-radius: 12px; padding: 15px; background: #fff;
  }
  #student-overview-table td {
    display: flex; justify-content: space-between; padding: 10px 0;
    border-bottom: 1px dashed #eee; text-align: right;
    position: static !important; /* 取消凍結 */
  }
  #student-overview-table td::before {
    content: attr(data-label-fix); font-weight: bold; color: var(--accent-color);
  }
  /* 手機版表格文字框 */
  #student-overview-table textarea { width: 100%; min-height: 100px; }
  
  /* 其他 */
  .pop-footer { flex-direction: row; }
  .pop-btn { padding: 8px 12px; font-size: 0.9rem; flex: 1; }
  
  /* 懸浮導航位置 */
  #floating-nav { bottom: 95px; right: 20px; }
}

/* ========================================= */
/* 8. 列印樣式 (Print) */
/* ========================================= */
@media print {
  body > :not(#print-container) { display: none !important; }
  #print-container { display: block !important; position: absolute; top: 0; left: 0; width: 100%; }
  .report-page { page-break-after: always; width: 100%; }
}
</style>

</head>
<body>

  <div id="toast-container"></div> <!-- 新增：通知容器 -->

  <div class="main-container">
    <div class="sticky-top-bar">
<!-- [v12.1] Header 最終版 -->
<header>
    <!-- 左邊：標題 & 身份 -->
    <div class="header-left">
        <h1>我不想努力了</h1>
        
        <div class="auth-container">
            <span id="auth-status">未連接</span>
            <div id="auth-buttons">
                <button id="login-btn" class="btn light-btn" style="padding: 2px 8px; font-size: 0.75rem;">登入</button>
                <button id="logout-btn" class="btn danger-btn" style="display: none; padding: 2px 8px; font-size: 0.75rem;">登出</button>
                <button id="sync-btn" class="btn action-btn" style="display: none; padding: 2px 8px; font-size: 0.75rem;" disabled>同步</button>
                 <button class="font-control-btn" onclick="toggleSettingsMenu()">⚙️</button>
                
            </div>
        </div>
        
        <div id="project-header-info" class="project-header-info" style="display:none; margin-top:2px;" onclick="promptAndLoadCloudProject()">
            <span style="opacity:0.8">📂</span><span id="ph-class"></span><span class="ph-divider">|</span><span id="ph-topic"></span>
        </div>
    </div>

    <!-- 右邊：Setting 掣 -->
    <div class="header-right">
      <!-- [v17.5] 手機版導航書籤 (Header 嵌入) -->
<button class="header-book-btn" onclick="toggleBookMenu()">🔖</button>
       
        <div id="settings-dropdown" class="settings-menu-popover" style="display: none;">
            <div class="settings-group">
                <label style="font-size:0.8rem;color:#999;display:block;margin-bottom:5px;">字體大小</label>
                <div class="font-controls-row" style="display:flex;gap:5px;">
                    <button onclick="adjustFontSize('decrease')" style="flex:1;padding:5px;">A-</button>
                    <button onclick="adjustFontSize('reset')" style="flex:1;padding:5px;">⟳</button>
                    <button onclick="adjustFontSize('increase')" style="flex:1;padding:5px;">A+</button>
                </div>
            </div>
            <div style="height:1px;background:#eee;margin:10px 0;"></div>
            <div class="settings-group">
                <button class="text-btn" onclick="showHotkeyHelp()" style="width:100%;text-align:left;background:none;border:none;padding:5px;cursor:pointer;">⌨️ 鍵盤快捷鍵</button>
            </div>
        </div>
    </div>
</header>

<!-- [v11.0] 懸浮導航結構 (Floating Island) -->
<nav class="page-nav-wrapper">
  
  <!-- 第一層：主導航 (固定不動) -->
  <div class="main-nav">
    <button class="nav-btn active" onclick="switchMainTab('home')" data-target="home">
      <span class="nav-icon">☕️</span> <span class="nav-text">咖啡廳</span>
    </button>
    <button class="nav-btn" onclick="switchMainTab('workspace')" data-target="workspace">
      <span class="nav-icon">💻</span> <span class="nav-text">工作枱</span>
    </button>
    <button class="nav-btn" onclick="switchMainTab('ailab')" data-target="ailab">
      <span class="nav-icon">✨</span> <span class="nav-text">AI 烘焙室</span>
    </button>
    <button class="nav-btn" onclick="switchMainTab('archives')" data-target="archives">
      <span class="nav-icon">📑</span> <span class="nav-text">檔案室</span>
    </button>
  </div>

  <!-- 第二層：分頁懸浮島 (Floating Sub-nav) -->
  <!-- 這裡會絕對定位，不會推郁上面 -->
  <div id="sub-nav-container" class="sub-nav-island" style="display: none;">
    
    <!-- 💻 工作枱：Setup -> Grading -> Journal -> Analysis -->
    <div id="sub-nav-workspace" class="sub-nav-group">
        <button id="nav-page1" class="sub-nav-btn" onclick="showPage('page1')">基本設定</button>
        <button id="nav-page2" class="sub-nav-btn" onclick="showPage('page2')">批改介面</button>
        <button id="nav-page4" class="sub-nav-btn" onclick="showPage('page4')">進度手帳</button>
        <button id="nav-page5" class="sub-nav-btn" onclick="showPage('page5')">評語分析</button>
    </div>
    
    <!-- ✨ AI 烘焙室 -->
    <div id="sub-nav-ailab" class="sub-nav-group">
        <button id="nav-page6" class="sub-nav-btn" onclick="showPage('page6')">生成評語庫</button>
        <button id="nav-page7" class="sub-nav-btn" onclick="showPage('page7')">生成回饋</button>
    </div>

    <!-- 📑 檔案室 (原 Page 3 & 8) -->
    <div id="sub-nav-archives" class="sub-nav-group">
        <button id="nav-page3" class="sub-nav-btn" onclick="showPage('page3')">評語庫管理</button>
        <button id="nav-page8" class="sub-nav-btn" onclick="showPage('page8')">班級管理</button>
    </div>
  </div>

</nav>

<!-- 漢堡包已移除 🍔👋 -->


    </div>

    <main>


   <!-- [v10.4] Cozy Dashboard HTML -->
<div id="page-home" class="page-content active">
  <div class="overview-container">
    
    <!-- 1. 問候區 -->
    <div style="text-align: center; margin-bottom: 3rem; padding-top: 2rem;">
      <h2 id="welcome-msg" style="font-size: 2rem; color: var(--accent-color); border: none; margin-bottom: 0.5rem;">
        早晨，老師。
      </h2>
      <p style="color: #8c867a; font-size: 1.1rem;">
        準備好開始一杯咖啡的時間了嗎？
      </p>
    </div>

    <!-- 2. 核心操作區 (Quick Actions) -->
    <div style="display: flex; gap: 15px; justify-content: center; margin-bottom: 3rem; flex-wrap: wrap;">
      <button class="action-btn" onclick="startNewProjectForClass(null, null)" style="padding: 12px 24px; font-size: 1.1rem;">
        ✨ 開新批改
      </button>
      <button class="secondary-btn" onclick="showPage('page8')" style="padding: 12px 24px; font-size: 1.1rem;">
        🏫 管理班級
      </button>
    </div>

    <!-- 3. 進行中 (On My Desk) -->
    <div style="margin-bottom: 2rem;">
        <h3 style="font-size: 1.2rem; color: #5b5044; margin-bottom: 1.5rem; text-align: left; border-left: 5px solid var(--accent-color); padding-left: 15px;">
            📂 案頭工作 (Active Projects)
        </h3>
        <!-- 這裡會由 JS 插入「文件夾」卡片 -->
        <div id="focus-task-list" class="folder-grid">
            <div class="dashboard-loading">☕️ 正在沖泡數據...</div>
        </div>
    </div>

    <!-- 4. 班級歸檔 (隱藏式) -->
    <details style="background: transparent; border: none; box-shadow: none;">
        <summary style="justify-content: center; background: transparent; color: #999; font-size: 0.9rem;">
            查看過往歸檔
        </summary>
        <div id="class-accordion-container" style="margin-top: 1rem;"></div>
    </details>

  </div>
</div>

<!-- 自定義編輯專案 Modal -->
<div id="pop-edit-modal" class="pop-overlay">
  <div class="pop-modal">
    <div class="pop-icon">✏️</div>
    <h3>編輯專案資訊</h3>
    <p class="pop-desc">修改後的資料將同步至雲端。</p>
    
    <!-- 隱藏欄位：用來存 ID 和 類型 -->
    <input type="hidden" id="edit-project-id">
    <input type="hidden" id="edit-source-type">
    <input type="hidden" id="edit-class-id"> <!-- 給新資料用 -->

    <div style="text-align:left; margin-bottom:15px;">
      <label style="font-size:0.85rem; color:#666; font-weight:bold;">學年 (Academic Year)</label>
      <input type="text" id="edit-year" class="pop-input" style="margin:5px 0 15px 0; width:100%; box-sizing:border-box;" placeholder="例如：2024-2025">
      
      <label style="font-size:0.85rem; color:#666; font-weight:bold;">班別 (Class Name)</label>
      <input type="text" id="edit-class" class="pop-input" style="margin:5px 0 15px 0; width:100%; box-sizing:border-box;" placeholder="例如：6A">
      
      <label style="font-size:0.85rem; color:#666; font-weight:bold;">作文題目 (Topic)</label>
      <input type="text" id="edit-topic" class="pop-input" style="margin:5px 0 15px 0; width:100%; box-sizing:border-box;" placeholder="作文題目">
    </div>

    <!-- 修改後的 Footer，加入 justify-content: space-between 以便將刪除按鈕推到左邊 -->
    <div class="pop-footer" style="justify-content: space-between;">
      <!-- 左邊：刪除按鈕 -->
      <button class="pop-btn danger-btn" onclick="deleteProject()" style="background:#ffebee; color:#c62828; border:1px solid #ffcdd2;">🗑️ 刪除</button>
      
      <!-- 右邊：取消與儲存 -->
      <div style="display:flex; gap:10px;">
          <button class="pop-btn pop-btn-cancel" onclick="document.getElementById('pop-edit-modal').classList.remove('active')">取消</button>
          <button class="pop-btn pop-btn-confirm" onclick="saveProjectMeta()">儲存</button>
      </div>
    </div>
  </div>
</div>

<!-- [Pro-v6.3] 通用輸入/確認 Modal (取代原生 prompt/confirm) -->
<div id="pop-generic-modal" class="pop-overlay">
  <div class="pop-modal">
    <div class="pop-icon" id="pop-generic-icon">✨</div>
    <h3 id="pop-generic-title">標題</h3>
    <p class="pop-desc" id="pop-generic-desc">描述文字</p>
    
    <!-- 輸入框容器 (預設隱藏) -->
    <div id="pop-generic-input-container" style="display:none; margin-bottom:20px;">
        <input type="text" id="pop-generic-input" class="pop-input">
    </div>

    <div class="pop-footer">
      <button class="pop-btn pop-btn-cancel" id="pop-generic-cancel">取消</button>
      <button class="pop-btn pop-btn-confirm" id="pop-generic-confirm">確定</button>
    </div>
  </div>
</div>

<div id="page1" class="page-content">
 <div class="section-box">
    <h2>步驟一：設定作業資訊</h2>

    <!-- [v16.0] 只保留題目與班級，移除手動模式 -->
    <div class="input-group" style="margin-bottom: 1.5rem;">
        <label for="topic">作文題目</label>
        <input type="text" id="topic" placeholder="例如：記一次難忘的經歷">
    </div>

    <div id="setup-registry-panel">
        <div class="input-group">
            <label>選擇班級</label>
            <select id="setup-class-select" onchange="handleClassSelectChange()">
                <option value="">(請先登入以讀取班級)</option>
            </select>
            <div style="font-size: 0.85rem; color: #888; margin-top: 8px;">
                💡 找不到班級？請先前往 <a href="javascript:void(0)" onclick="showPage('page8')" style="font-weight:bold; color:var(--accent-color);">班級管理</a> 建立。
            </div>
        </div>

        <div id="setup-student-area" style="display:none; margin-top: 1.5rem;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.5rem;">
                <label style="margin:0;">勾選出席學生</label>
                <div style="font-size:0.9rem;">
                    <a href="javascript:void(0)" onclick="toggleAllSetupStudents(true)" style="color:var(--accent-color);">全選</a> |
                    <a href="javascript:void(0)" onclick="toggleAllSetupStudents(false)" style="color:#c86a5a;">全不選</a>
                </div>
            </div>
            <div id="setup-student-checklist" class="student-checklist-grid">
                <!-- JS 會在這裡產生學生卡片 -->
            </div>
        </div>
    </div>
</div>


  <div class="section-box">
    <h2>步驟二：開始批改</h2>
    <p style="font-size:0.9rem;color:#777;">設定好名單後，選擇載入方式：</p>
    
    <details class="io-details" open>
        <summary><h3>選項 A：使用預設罐頭評語</h3></summary>
        <div class="io-details-content">
            <p>請選擇文章類型：</p>
            <div id="genre-selection" class="checkbox-group">
                <label><input type="checkbox" name="genre" value="narrative"> 記敘</label>
                <label><input type="checkbox" name="genre" value="lyrical"> 抒情</label>
                <label><input type="checkbox" name="genre" value="descriptive"> 描寫</label>
                <label><input type="checkbox" name="genre" value="argumentative"> 議論</label>
            </div>
            <div class="btn-group" style="margin-top: 1rem;">
                <button class="action-btn" onclick="startGradingWithSetup('default')">確定並開始</button>
            </div>
        </div>
    </details>

    <details class="io-details">
        <summary><h3>選項 B：僅設定名單 (手動建立評語)</h3></summary>
        <div class="io-details-content">
            <button class="light-btn" onclick="startGradingWithSetup('manual')">僅確認名單，跳至手動修訂</button>
        </div>
    </details>
  </div>
</div>

      <!-- ==================== 第二頁：批改頁 (新) ==================== -->
      <div id="page2" class="page-content">
        <div class="grading-page-grid">
            
           <!-- ==================== Page 2 學生選擇區 (修復版) ==================== -->
<div id="grading-section-student" class="section-box">
    <h2>一、選擇學生</h2>
    <!-- [Pro-v9.8] 快速切換作業 (Smart Switcher) -->
    <!-- [v11.8] Page 2 專用題目欄 (與 Page 1 同步) -->
<div class="input-group" style="margin-bottom: 1rem; border-bottom: 1px dashed #ddd; padding-bottom: 1rem;">
    <label for="page2-topic-display" style="color:#5A8F7B;">作文題目</label>
   <!-- [v19.0] 題目鎖定 (Read-only) -->
<input type="text" id="page2-topic-display" 
       style="font-size: 1.2rem; font-weight: bold; color: #555; border: 1px solid #e0e0e0; background-color: #f4f4f4; cursor: not-allowed;" 
       placeholder="未設定題目" readonly>
      
</div>
    
    
    
    <!-- 🛑 關鍵修復：這兩個 ID 必須存在，Page 1 才能傳資料過來 -->
    <input type="hidden" id="student-class">
    <div class="input-group">
        <label for="student-names" style="color:#999; font-size:0.9rem;">
            學生名單數據 (系統自動填寫，請勿手動修改)
        </label>
        <!-- ID 必須是 student-names -->
        <textarea id="student-names" rows="3" readonly style="background:#eee; color:#555;" placeholder="等待數據載入..."></textarea>
    </div>
    <!-- 🛑 修復結束 -->

    <!-- 下面是操作區 -->
    <div class="btn-group" style="margin-bottom: 1rem;">
        <!-- 保留 Excel 匯入功能給 Page 2 直接使用 -->
        <label class="light-btn brown" for="import-student-list" style="cursor: pointer;">匯入名單 (Excel)</label>
        <input type="file" id="import-student-list" accept=".xlsx, .xls" style="display:none;">
        <!-- [v19.2] 快速班級管理按鈕 -->
<button class="light-btn" onclick="showPage('page8')" style="margin-left: 5px;">
    🏫 管理班級
</button>
    </div>

    <div class="input-group">
        <label for="student-select">當前批改學生</label>
        <select id="student-select" style="font-size:1.1rem; padding:10px; border:2px solid var(--accent-color);">
            <option value="">(尚未載入名單)</option>
        </select>
    </div>
    
    <div class="btn-group">
        <button class="secondary-btn" onclick="navigateToStudent('prev')">⏪ 上一位</button>
        <button class="secondary-btn" onclick="navigateToStudent('next')">下一位 ⏩</button>
    </div>
</div>

            <div id="grading-section-checklist" class="section-box">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                    <h2>二、評語項目選擇</h2>
                    <div class="btn-group">
                    <button class="light-btn" onclick="toggleAllDetails('checklist-container', true)">全展</button>
                    <button class="light-btn brown" onclick="toggleAllDetails('checklist-container', false)">全收</button>
                    </div>
                </div>
                <div id="checklist-container">
                    <div class="empty-state-message">請先在「基本設定」頁選擇或建立評語庫。</div>
                </div>
            </div>

            <div id="grading-section-typo-score" class="section-box">
                <h2>三、錯別字及評分</h2>
                <details class="sub-section-card">
                    <summary><h3>錯別字記錄與常見庫</h3></summary>
                    <div class="sub-section-card-content">
                        <div id="typo-module" style="display:flex; flex-wrap:wrap; gap:0.75rem; align-items:flex-end;">
                            <div class="input-group" style="flex:1; min-width:140px; margin-bottom:0;">
                            <label for="typo-wrong">錯字</label>
                            <input type="text" id="typo-wrong">
                            </div>
                            <div class="input-group" style="flex:1; min-width:140px; margin-bottom:0;">
                            <label for="typo-correct">正字</label>
                            <input type="text" id="typo-correct">
                            </div>
                            <button class="action-btn" onclick="addTypo()">新增</button>
                            <button class="secondary-btn" onclick="saveTypoToCommon()">存常見</button>
                        </div>
                        <ul id="typo-list" style="list-style:none; padding:0; margin-top:0.75rem;"></ul>
                        <div class="typo-saved-box">
                            <h3 class="io-box-title">常見錯別字庫</h3>
                            <ul id="typo-saved-list" class="typo-saved-list"></ul>
                        </div>
                    </div>
                </details>

                <details open class="sub-section-card">
                    <summary><h3>作文評分 (1-10分)</h3></summary>
                    <div class="sub-section-card-content">
                        <p style="font-size:0.9em; color:#888; margin-top:-0.7rem;">總分 = (內容×4)+(表達×3)+(結構×2)+(標點×1)+錯別字分</p>
                        <div class="score-main-grid">
                            <div class="input-group"><label for="score-content">內容</label><input type="number" id="score-content"></div>
                            <div class="input-group"><label for="score-expression">表達</label><input type="number" id="score-expression"></div>
                            <div class="input-group"><label for="score-structure">結構</label><input type="number" id="score-structure"></div>
                            <div class="input-group"><label for="score-punctuation">標點</label><input type="number" id="score-punctuation"></div>
                            <div class="input-group"><label for="score-typos">錯別字 (加/減)</label><input type="number" id="score-typos"></div>
                        </div>
                        <div class="score-total-box" style="margin-top: 1rem;">
                            <div class="input-group"><label for="score-total">總分</label><input type="number" id="score-total" readonly></div>
                        </div>
                    </div>
                </details>
            </div>

            <div id="grading-section-feedback" class="section-box">
                <h2>四、學生評語</h2>
                <div class="input-group">
                    <label for="unique-comment">特別留言（只給此學生）</label>
                    <textarea id="unique-comment" rows="4" placeholder="例如：本次作文立意深刻，能真誠表達個人感受。"></textarea>
                </div>
                <div class="panel" style="margin-top: 1rem;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h3>學生版本（點列式）</h3>
                       <div class="panel-actions">
    <!-- [v19.0] 新增：PDF 預覽按鈕 (紫色) -->
    <button class="action-btn" onclick="printReport('single')" style="background:#7986cb; border:none; margin-right:5px;" title="生成精美 A4 報告">
        🖨️ 預覽 PDF
    </button>
    <button class="action-btn" onclick="copyOutput('student-report-output', this)">複製</button>
</div>
                    </div>
                    <textarea id="student-report-output" placeholder="此處自動生成學生版本..." oninput="handleManualEdit('student')"></textarea>
                </div>
                <div class="panel" style="margin-top: 1rem;">
                    <details>
                        <summary><h3>完整版本（段落式，預設隱藏）</h3></summary>
                        <div class="panel-content-wrapper">
                        <div class="panel-actions" style="justify-content: flex-end;">
                            <button class="action-btn" onclick="copyOutput('full-output', this)">複製</button>
                        </div>
                        <textarea id="full-output" placeholder="此處自動生成完整版本..." oninput="handleManualEdit('full')"></textarea>
                        </div>
                    </details>
                </div>
            </div>

           <!-- [Pro-v9.4-FunctionalFix] 單一同步按鈕 -->
<!-- [Pro-v9.4-FunctionalFix] 單一同步按鈕 (已移除清空按鈕) -->
<div class="btn-group" style="justify-content: center; gap: 15px;">
    <button class="action-btn" onclick="saveCurrentStudentData('cloud')" title="儲存並同步至雲端資料庫">
        ☁️ 同步上雲
    </button>
</div>

            <!-- 新增的空白區域，用作頁底緩衝，防止懸浮導覽列（尤其在手機版）遮擋上方的儲存按鈕 -->
            <div style="height: 8rem;"></div>

        </div>
      </div>

      <!-- ==================== 第三頁：評語總覽與修訂 (原 page 2) ==================== -->
      <div id="page3" class="page-content">
        <div class="overview-container">
          <h2>評語總覽與修訂</h2>
          
          <details id="add-critique-section">
            <summary>新增評語項目</summary>
            <div class="add-critique-form">
              <div class="add-critique-grid">
                <div class="input-group">
                  <label for="new-critique-title">評語標題*</label>
                  <input type="text" id="new-critique-title" placeholder="例如：人物形象鮮明">
                </div>
                <div class="input-group">
                  <label>評語類型*</label>
                  <div class="radio-group">
                    <label><input type="radio" name="new-critique-type" value="excellent" checked> 優點</label>
                    <label><input type="radio" name="new-critique-type" value="problem"> 待改進</label>
                  </div>
                </div>
                <div class="input-group">
                  <label for="new-critique-category-select">範疇分類*</label>
                  <select id="new-critique-category-select"></select>
                </div>
                <div class="input-group" id="new-critique-category-new-wrapper" style="display:none;">
                  <label for="new-critique-category-new">新分類名稱*</label>
                  <input type="text" id="new-critique-category-new" placeholder="請輸入新的分類名稱">
                </div>
              </div>
              
              <div id="new-critique-fields">
                <div class="input-group" data-type-scope="excellent">
                  <label>優點總結 (可用 [選項1], [選項2]..)</label>
                  <textarea data-field="strengthSummary" placeholder="對優點的概括性描述"></textarea>
                </div>
                <div class="input-group" data-type-scope="problem" style="display:none;">
                  <label>問題 (可用 [選項1], [選項2]..)</label>
                  <textarea data-field="problemCore" placeholder="對問題核心的概括性描述"></textarea>
                </div>
                <div class="input-group" data-type-scope="problem" style="display:none;">
                  <label>宜 (可用 [選項1], [選項2]..)</label>
                  <textarea data-field="suggestion" placeholder="改善建議"></textarea>
                </div>
                <div class="input-group">
                  <label>例子（每行一條）</label>
                  <textarea data-field="example" placeholder="具體例子，用以說明觀點"></textarea>
                </div>
                <div class="input-group">
                  <label>下拉選項的描述文字 (用 | 分隔多個)</label>
                  <textarea data-field="optionsLabel" placeholder="例如：困難情節|描寫角度"></textarea>
                </div>
                <div class="input-group">
                  <label>下拉選項 (每行一項，用 | 分隔多組)</label>
                  <textarea data-field="options" placeholder="天氣突變&#10;體力透支&#10;其他&#10;|&#10;正面&#10;側面"></textarea>
                </div>
              </div>

              <button class="action-btn" onclick="addNewCritique()">新增項目</button>
            </div>
          </details>

          <p style="margin-top:1.5rem;">此頁為評語庫的來源。您可在此處編輯、新增或刪除評語項目。所有修改將自動保存至雲端（需登入）。</p>

          <details class="io-details">
            <summary><h3>評語庫管理 (導入/導出/重設)</h3></summary>
            <div class="io-details-content">
                <div class="btn-group">
                    <button class="action-btn" onclick="downloadCritiqueTemplate()">下載範本(Excel)</button>
                    <button class="action-btn" onclick="exportCritiquesToExcel()">導出評語庫(Excel)</button>
                    <label class="action-btn" for="import-critique-excel" style="cursor:pointer;">導入評語庫(Excel)</label>
                    <input type="file" id="import-critique-excel" accept=".xlsx, .xls, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" style="display:none;"/>
                </div>
                <div class="btn-group">
                    <button class="secondary-btn" onclick="exportCritiquesToJSON()">導出評語庫(JSON)</button>
                    <label class="secondary-btn" for="import-critique-json" style="cursor:pointer;">導入評語庫(JSON)</label>
                    <input type="file" id="import-critique-json" accept=".json" style="display:none;"/>
                </div>
                <!-- 新增：附加預設評語 (Append) -->
                <div class="btn-group" style="margin-top: 1rem; border-top: 1px dashed #ddd; padding-top: 1rem;">
                    <button class="action-btn" style="background:#7986cb;" onclick="appendPresetsMenu()">➕ 附加預設評語 (不覆蓋)</button>
                </div>
                 <div class="btn-group" style="margin-top: 1rem;">
                    <button class="danger-btn" onclick="confirmUI('確定要重設為程式內建的預設評語嗎？這會覆蓋您當前的評語庫。', resetToDefaultCritiques)">重設為程式預設評語</button>
                </div>
            </div>
          </details>

          <div id="overview-controls" class="btn-group" style="margin-top: 1.5rem; margin-bottom: 1rem;">
            <button class="light-btn" onclick="toggleAllDetails('overview-list', true)">全部展開</button>
            <button class="light-btn brown" onclick="toggleAllDetails('overview-list', false)">全部收合</button>
          </div>
          <div id="overview-list" class="overview-panel"></div>
        </div>
      </div>

      <!-- ==================== 第四頁：學生總覽 (原 page 3) ==================== -->
      <div id="page4" class="page-content">
        <div class="overview-container">
          <div class="page-header">
            <h2>學生評語記錄總覽</h2>
            <div class="btn-group">
                <!-- [v19.0] 新增：全班列印按鈕 -->
<button class="action-btn" onclick="printReport('batch')" style="background:#7986cb; border:none;">
    🖨️ 列印全班 PDF
</button>
              <button class="action-btn" onclick="exportOverviewToExcel()">📊 匯出為 Excel</button>
              <button class="secondary-btn" onclick="exportOverviewToWord()">📄 匯出學生版 Word</button>
              <button class="light-btn brown" onclick="exportProgressToExcel()">📊 匯出進度</button>
              <label class="light-btn" for="import-progress-excel" style="cursor:pointer;">📂 匯入進度</label>
              <input type="file" id="import-progress-excel" accept=".xlsx, .xls, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" style="display:none;">
            </div>
          </div>
          <h3 id="overview-class-display"></h3>
          <!-- 刪除舊的 div，換成這個： -->
<div id="literary-progress" class="literary-progress-box">
  <div class="literary-progress-header">
    <div class="progress-message" id="progress-text"></div>
    <div class="progress-stats" id="progress-numbers"></div>
  </div>
  <div class="progress-track">
    <div class="progress-fill" id="progress-bar"></div>
  </div>
</div>

<div id="student-overview-table-wrapper">
              <table id="student-overview-table">
                  <thead>
                      <tr>
                          <th>學號</th>
                          <th>姓名</th>
                          <th>內容</th>
                          <th>表達</th>
                          <th>結構</th>
                          <th>標點</th>
                          <th>錯別字</th>
                          <th>總分</th>
                          <th>學生版評語</th>
                   
                      </tr>
                  </thead>
                  <tbody>
                      <!-- 學生資料將由 JavaScript 動態填入 -->
                  </tbody>
              </table>
          </div>
        </div>
      </div>

      <!-- ==================== 第五頁：評語分析 (原 page 4) ==================== -->
      <div id="page5" class="page-content">
  <div class="overview-container">
    <div class="page-header">
      <h2>評語分析（全班概況）</h2>
      <div class="btn-group">
        <button class="action-btn" onclick="exportAnalysisToExcel()">📊 匯出分析 Excel</button>
        <button class="secondary-btn" onclick="exportAnalysisToWord()">📄 匯出分析 Word</button>
      </div>
    </div>
    <p style="font-size:0.9rem;color:#777;">
      透過視覺化圖表，快速掌握全班的強弱項分佈及常見問題。
    </p>
    
    <!-- 新增：圖表區域 -->
    <div class="analysis-grid" style="margin-bottom: 2rem;">
      <div class="analysis-card">
        <h3>📊 能力分佈雷達圖</h3>
        <div style="position: relative; height: 300px; width: 100%;">
            <canvas id="scoreChartCanvas"></canvas>
        </div>
      </div>
      <div class="analysis-card">
        <h3>🔥 常見評語 Top 5</h3>
        <div style="position: relative; height: 300px; width: 100%;">
            <canvas id="critiqueChartCanvas"></canvas>
        </div>
      </div>
    </div>

    <!-- 原有的表格區域 (保留作為詳細數據參考) -->
    <div class="analysis-grid">
      <div class="analysis-card">
        <h3>詳細分數數據</h3>
        <div id="analysis-score-summary"></div>
      </div>
      <div class="analysis-card">
        <h3>詳細評語統計</h3>
        <div id="analysis-top-critique"></div>
      </div>
    </div>
  </div>
</div>

      <!-- ==================== 第六頁：AI 評語庫生成 (原 page 5) ==================== -->
<div id="page6" class="page-content">
    <div class="overview-container">
        <h2>✨ AI 烘焙室：生成評語庫</h2>
        <div class="cozy-hint">
            這裏就像您的烘焙廚房。告訴 AI 您想「料理」什麼樣的評語，它會為您準備好新鮮的食材。<br>
            (無需擔心技術代碼，只需簡單的複製與貼上。)
        </div>

        <div class="ai-page-grid">
            <!-- 左欄：點餐區 (設定) -->
            <div class="ai-magic-card">
                <div class="ai-step-title">1. 設定口味</div>
                
                <div class="input-group">
                    <label>學生程度</label>
                    <select id="ai-student-level">
                        <option value="junior">初中 (基礎穩固)</option>
                        <option value="intermediate" selected>高中 (技巧提升)</option>
                        <option value="advanced">文憑試衝刺 (DSE)</option>
                    </select>
                </div>
                
                <div class="input-group">
                    <label>作文題目</label>
                    <input type="text" id="ai-topic" placeholder="例如：一次難忘的經歷">
                </div>

                <div class="input-group">
                    <label>評語重點</label>
                    <select id="ai-focus">
                        <option value="balanced">平衡 (優點/缺點各半)</option>
                        <option value="encourage">暖心鼓勵 (多讚賞)</option>
                        <option value="improve">嚴格提點 (多建議)</option>
                    </select>
                </div>

                <div class="input-group">
                    <label>特別關注點 (可選)</label>
                    <textarea id="ai-highlights" rows="2" placeholder="例如：想針對「人物描寫」給更多建議..."></textarea>
                </div>
            </div>

            <!-- 右欄：出餐區 (操作) -->
            <div class="ai-magic-card">
                <div class="ai-step-title">2. 獲取與應用</div>
                
                <p style="font-size:0.9rem; color:#666; margin-bottom:15px;">
                    準備好後，按下方按鈕複製指令，然後貼給您的 AI 助手 (ChatGPT/Poe)。
                </p>

                <button class="action-btn" onclick="generateAndCopyPrompt()" style="width:100%; padding:15px; font-size:1.1rem; margin-bottom:20px;">
                    📋 複製 AI 指令 (Copy Prompt)
                </button>

                <!-- 隱藏的 Prompt 預覽 (只有想 Check 嘅人先開) -->
                <details class="tech-details">
                    <summary>⚙️ 查看指令原文 (Technical View)</summary>
                    <textarea id="ai-prompt-preview" class="tech-textarea" rows="5" readonly></textarea>
                </details>

                <div style="margin: 30px 0 15px 0; border-top: 1px solid #eee;"></div>

                <div class="ai-step-title">3. 接收成品</div>
                <p style="font-size:0.9rem; color:#666;">
                    將 AI 回覆的內容 (以 <code>[</code> 開頭 <code>]</code> 結尾的文字) 貼在下方：
                </p>
                <textarea id="ai-json-input" class="pop-input" rows="4" placeholder="在此貼上 AI 的回信..."></textarea>
                
                <button class="secondary-btn" onclick="applyAIJson()" style="width:100%; margin-top:10px;">
                    📥 儲存到我的評語庫
                </button>
            </div>
        </div>
    </div>
</div>
      <!-- ==================== 第七頁：AI 生成回饋 (原 page 6) ==================== -->
 <div id="page7" class="page-content">
    <div class="overview-container">
        <h2>📝 AI 烘焙室：生成教學回饋</h2>
        <div class="cozy-hint">
            這裡可以將全班的表現，轉化為一份溫暖而專業的跟進文件。<br>
            我們會為您生成老師專用的「教學詳案」和給學生的「鼓勵單張」。
        </div>

        <div class="ai-page-grid">
            <!-- 左欄：材料準備 -->
            <div class="ai-magic-card">
                <div class="ai-step-title">1. 選擇材料 (分析來源)</div>
                <div class="checkbox-group" style="display:flex; flex-direction:column; gap:8px;">
                    <label><input type="checkbox" id="ai-source-excel" checked> 📊 全班評語數據 (Excel)</label>
                    <label><input type="checkbox" id="ai-source-stats" checked> 📈 分數分佈與統計</label>
                    <label><input type="checkbox" id="ai-source-basic" checked> 🏷️ 題目與年級資訊</label>
                </div>

                <div style="margin-top:20px;"></div>
                <div class="ai-step-title">2. 烹調內容 (輸出模組)</div>
                <div class="checkbox-group" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <label><input type="checkbox" id="ai-module-overview" checked> 總結概覽</label>
                    <label><input type="checkbox" id="ai-module-topic" checked> 審題分析</label>
                    <label><input type="checkbox" id="ai-module-material-theme" checked> 選材舉隅</label>
                    <label><input type="checkbox" id="ai-module-excellent-students" checked> 佳作表揚</label>
                    <label><input type="checkbox" id="ai-module-tiers" checked> 分層示例</label>
                    <label><input type="checkbox" id="ai-module-practice" checked> 跟進練習</label>
                    <label><input type="checkbox" id="ai-module-plan" checked> 教學計劃</label>
                </div>

                <div class="input-group" style="margin-top: 15px;">
                    <label>額外調味 (提示)</label>
                    <textarea id="ai-feedback-extra-hints" rows="2" placeholder="例如：這班同學比較缺乏自信，請多一點鼓勵..."></textarea>
                </div>
            </div>

            <!-- 右欄：開始製作 -->
            <div class="ai-magic-card">
                <div class="ai-step-title">3. 生成與匯出</div>
                
                <!-- 匯出 Excel 按鈕 -->
                <button class="light-btn brown" onclick="exportStudentDataForAI()" style="width:100%; margin-bottom:15px; text-align:left; justify-content: center;">
                    📂 下載數據 Excel (供上傳給 AI)
                </button>

                <button class="action-btn" onclick="generateFeedbackPromptAndCopy()" style="width:100%; padding:15px; font-size:1.1rem;">
                    ✨ 生成並複製指令 (Copy)
                </button>

                <!-- 隱藏細節 -->
                <details class="tech-details">
                    <summary>⚙️ 查看指令原文</summary>
                    <textarea id="ai-feedback-prompt-preview" class="tech-textarea" rows="5" readonly></textarea>
                </details>

                <div style="margin: 25px 0 15px 0; border-top: 1px solid #eee;"></div>

                <div class="ai-step-title">4. 領取文件</div>
                <textarea id="ai-feedback-json-input" class="pop-input" rows="4" placeholder="在此貼上 AI 回覆的 JSON..."></textarea>
                
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <button class="secondary-btn" onclick="generateTeacherWord()" style="flex:1;">👩🏻‍🏫 老師版 Word</button>
                    <button class="secondary-btn" onclick="generateStudentWord()" style="flex:1;">🧑🏻‍🎓 學生版 Word</button>
                </div>
            </div>
        </div>
    </div>
</div>

      <!-- ... 上面係 Page 7 的 </div> 結尾 ... -->

<!-- ✅✅✅ 在這裡貼上 Page 8 的 HTML ✅✅✅ -->
<div id="page8" class="page-content">
  <div class="overview-container">
    <div class="page-header">
      <h2>班級管理 (The Registry)</h2>
      <div class="btn-group">
        <button class="action-btn" onclick="createNewClass()">＋ 新增班級</button>
      </div>
    </div>
    
    <p style="font-size:0.9rem; color:#777;">
      在這裡建立您的班級母名單。日後開新批改時，可直接選取整班學生，無須每次匯入。<br>
      <span style="color:#c86a5a;">(注意：此功能需連接雲端資料庫)</span>
    </p>

    <!-- 班級列表容器 -->
    <div id="class-management-list" class="task-list-container" style="margin-top:2rem;">
      <div class="dashboard-loading">正在讀取班級資料...</div>
    </div>
  </div>
</div>
<!-- ✅✅✅ 貼上結束 ✅✅✅ -->
 <!-- 自定義管理學生名單 Modal (Page 8 專用 - 修正版) -->
<div id="pop-manage-students-modal" class="pop-overlay">
  <div class="pop-modal" style="max-width: 600px;">
    <div class="pop-icon">👥</div>
    <h3 id="manage-class-title">管理名單</h3>
    
    <!-- 隱藏欄位：存住現在改緊邊班 -->
    <input type="hidden" id="manage-class-id">

    <!-- 工具列：下載範本 與 匯入 -->
    <div style="display:flex; gap:10px; margin-bottom:15px; justify-content:center; flex-wrap:wrap;">
      <!-- ✅ 這是 Page 8 專用的下載按鈕 -->
      <button class="btn light-btn" onclick="downloadMasterListTemplate()" style="font-size:0.85rem;">
        📥 下載 Excel 範本
      </button>
      
      <label class="btn secondary-btn" style="font-size:0.85rem; cursor:pointer;">
        📂 匯入 Excel
        <input type="file" id="import-master-list-file" accept=".xlsx, .xls" style="display:none;" onchange="handleMasterListImport(this)">
      </label>
    </div>

    <!-- ✅ 批量文字輸入區 (不再摺疊，直接顯示) -->
    <div style="margin-bottom:15px; text-align:left; border:1px solid #eee; padding:10px; border-radius:8px; background:#fafafa;">
        <label style="font-size:0.85rem; font-weight:bold; color:#5A8F7B; display:block; margin-bottom:5px;">
            📝 批量貼上 (每行一位，例如：01 陳大文)
        </label>
        <!-- 確保這是 textarea -->
        <textarea id="batch-student-input" rows="4" class="pop-input" style="width:100%; box-sizing:border-box; text-align:left; font-size:0.9rem;" placeholder="在此直接貼上名單..."></textarea>
        <button class="action-btn" style="width:100%; margin-top:5px; padding:6px;" onclick="addBatchStudentsToMaster()">
            ⬇️ 確認新增名單
        </button>
    </div>

    <hr style="border:0; border-top:1px solid #eee; margin:10px 0;">

    <!-- 學生列表顯示區 -->
    <div class="pop-scroll-area" id="master-student-list" style="height: 200px; max-height: 30vh;">
      <div style="text-align:center; color:#999; padding:20px;">正在讀取...</div>
    </div>

    <div class="pop-footer">
      <button class="pop-btn pop-btn-confirm" onclick="closeManageStudentsModal()">完成 / 關閉</button>
    </div>
  </div>
</div>


    </main>
  </div>


  <!-- 自製確認對話框 -->
  <div id="modal" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-card" role="document">
      <div class="modal-title" id="modal-title">請確認</div>
      <div id="modal-text" style="white-space: pre-wrap;">確認執行？</div>
      <div class="modal-actions">
        <button class="btn btn-secondary" id="modal-cancel">取消</button>
        <button class="btn btn-danger" id="modal-ok">確定</button>
      </div>
    </div>
  </div>

  <!-- 評語資料來源 -->
  <div id="critique-data" style="display:none;">
    <!-- 預設評語會由 JS 載入 -->
  </div>

  <!-- [Pro-v6.1] 懸浮導覽列 (已修正儲存按鈕分流) -->
<nav id="floating-nav">
    <!-- 快速導航 -->
    <a href="#grading-section-student" class="floating-nav-btn" onclick="scrollToSection(event, 'grading-section-student')" data-tooltip="學生">😽</a>
    <a href="#grading-section-checklist" class="floating-nav-btn" onclick="scrollToSection(event, 'grading-section-checklist')" data-tooltip="評語項目">✅</a>
    <a href="#grading-section-typo-score" class="floating-nav-btn" onclick="scrollToSection(event, 'grading-section-typo-score')" data-tooltip="錯別字/評分">📝</a>
    <a href="#grading-section-feedback" class="floating-nav-btn" onclick="scrollToSection(event, 'grading-section-feedback')" data-tooltip="學生評語">📄</a>
    
   

    <!-- 唯一的儲存行動 (Unified Action) -->
    <a href="javascript:void(0)" class="floating-nav-btn" onclick="saveCurrentStudentData('cloud')" data-tooltip="☁️ 儲存並同步">☁️</a>
</nav>

<!-- 自定義 Pop Art 風格 Project Selection Modal -->
<div id="pop-project-modal" class="pop-overlay">
  <div class="pop-modal">
    <div class="pop-icon">📂</div>
    <h3>雲端專案讀取</h3>
    <p class="pop-desc">
      在雲端找到以下專案。<br>
      請輸入數字選擇，或直接點擊列表項目。
    </p>
    
    <div class="pop-scroll-area" id="pop-project-list">
      <!-- JS 會動態插入內容 -->
    </div>

    <input type="number" id="pop-project-input" class="pop-input" placeholder="輸入編號..." min="1">

   <div class="pop-footer">
      <!-- 改咗下面呢行文字，變成「開新專案」 -->
      <button class="pop-btn pop-btn-cancel" id="pop-project-cancel">開新專案 (不載入)</button>
      <button class="pop-btn pop-btn-confirm" id="pop-project-confirm">確定載入</button>

    </div>
  </div>
</div>


<!-- [Pro-v9.7.1] 班級綜合報告彈窗 (UI 優化版) -->
<div id="pop-class-report-modal" class="pop-overlay">
  <div class="pop-modal pop-modal-large">
    <h3 id="report-class-title">班級綜合報告</h3>
    <p class="pop-desc" style="margin-bottom: 10px;">請勾選作業，並選擇匯出模式。</p>
    
    <input type="hidden" id="report-class-id">

    <!-- 1. 作業列表區 (霸佔主要空間) -->
    <!-- min-height: 300px 確保列表夠長，睇得舒服 -->
    <div class="pop-scroll-area" id="report-project-list" style="flex-grow: 1; min-height: 300px; margin-top:0;">
      <div style="text-align:center; color:#999; padding:20px;">
        <div class="spinner"></div> 讀取中...
      </div>
    </div>

    <!-- 2. 匯出模式選擇區 (緊湊版) -->
    <div style="flex-shrink: 0; padding-top: 15px; border-top: 1px solid #eee;">
        <div style="font-weight:bold; color:#5A8F7B; margin-bottom:8px; text-align: left;">
            📊 報告類型：
        </div>
        
        <div style="display:flex; gap: 20px; flex-wrap: wrap;">
            <!-- 選項 A -->
            <label style="flex:1; display:flex; align-items:center; gap:10px; padding:12px; border:1px solid #ddd; border-radius:8px; cursor:pointer; background:#fdfbf7;">
                <input type="radio" name="report-mode" value="exam" checked style="accent-color:#5A8F7B; transform:scale(1.2);">
                <div>
                    <div style="font-weight:bold; color:#333;">📄 合併單次考試</div>
                    <div style="font-size:0.8rem; color:#888;">(分題合併為一總分)</div>
                </div>
            </label>

            <!-- 選項 B -->
            <label style="flex:1; display:flex; align-items:center; gap:10px; padding:12px; border:1px solid #ddd; border-radius:8px; cursor:pointer; background:#fdfbf7;">
                <input type="radio" name="report-mode" value="trend" style="accent-color:#5A8F7B; transform:scale(1.2);">
                <div>
                    <div style="font-weight:bold; color:#333;">📈 歷程趨勢分析</div>
                    <div style="font-size:0.8rem; color:#888;">(多次分數並列走勢)</div>
                </div>
            </label>
        </div>
    </div>

    <!-- 3. 底部按鈕 -->
    <div class="pop-footer">
      <button class="pop-btn pop-btn-cancel" onclick="document.getElementById('pop-class-report-modal').classList.remove('active')">取消</button>
      <button class="pop-btn pop-btn-confirm" onclick="generateCombinedExcel()">📥 生成 Excel</button>
    </div>
  </div>
</div>

<!-- 自定義登入 Modal (Email + 密碼 + 忘記密碼版) -->
<div id="pop-login-modal" class="pop-overlay">
  <div class="pop-modal">
    <div class="pop-icon">🔐</div>
    <h3>帳戶登入</h3>
    <p class="pop-desc">
      請使用 Email 及密碼登入。<br>
      <span style="font-size:0.85rem; color:#999;">(如未有帳戶，請填好資料後按「註冊」)</span>
    </p>
    
    <!-- Email 輸入框 -->
    <input type="text" id="login-email" class="pop-input" placeholder="電郵地址 (Email)" autocomplete="email" style="margin-bottom: 10px;">
    
    <!-- 密碼輸入框 -->
    <input type="password" id="login-password" class="pop-input" placeholder="密碼 (Password)" autocomplete="current-password">

    <!-- 忘記密碼連結 -->
    <div style="text-align: right; width: 80%; margin: -10px auto 20px auto;">
      <a href="javascript:void(0)" onclick="handleForgotPassword()" style="color: #888; font-size: 0.85rem; text-decoration: underline;">忘記密碼 / 設定新密碼？</a>
    </div>

    <div class="pop-footer" style="flex-wrap: wrap; gap: 10px; justify-content: center;">
      <button class="pop-btn pop-btn-cancel" onclick="closeLoginModal()">取消</button>
      <button class="pop-btn" style="background:#e0e0e0; color:#555;" onclick="handlePasswordAuth('signup')">註冊</button>
      <button class="pop-btn pop-btn-confirm" onclick="handlePasswordAuth('login')">登入</button>
    </div>
  </div>
</div>

<!-- 自定義重設密碼 Modal -->
<div id="pop-reset-password-modal" class="pop-overlay">
  <div class="pop-modal">
    <div class="pop-icon">🔐</div>
    <h3>設定新密碼</h3>
    <p class="pop-desc">
      歡迎回來！請輸入您的新密碼。<br>
      <span style="font-size:0.85rem; color:#c86a5a;">(⚠️ 密碼長度最少需 6 個字元)</span>
    </p>
    
    <input type="password" id="new-password-input" class="pop-input" placeholder="新密碼 (New Password)">
    
    <div class="pop-footer">
    <!-- 確保 onclick 指向我們的新函數 -->
<button class="pop-btn pop-btn-confirm" id="confirm-reset-btn" onclick="confirmResetPassword()">確認修改</button>
    </div>
  </div>
</div>


<!-- ... (這是原本的重設密碼 Modal) ... -->
<div id="pop-reset-password-modal" class="pop-overlay">
  <!-- ... 略 ... -->
    <div class="pop-footer">
    <!-- 確保 onclick 指向我們的新函數 -->
<button class="pop-btn pop-btn-confirm" id="confirm-reset-btn" onclick="confirmResetPassword()">確認修改</button>
    </div>
  </div>
</div>

<!-- ✅✅✅ 請將新代碼貼在這裡 (兩者中間) ✅✅✅ -->

<!-- 學生個人成長圖表 Modal -->
<div id="pop-student-history-modal" class="pop-overlay">
  <div class="pop-modal" style="max-width: 600px;">
    <div class="pop-icon">📈</div>
    <h3 id="history-student-name">學生歷程</h3>
    <p class="pop-desc">該生在不同作業中的表現趨勢。</p>
    
    <!-- 圖表容器 -->
    <div style="width: 100%; height: 300px; position: relative;">
        <canvas id="studentHistoryChart"></canvas>
    </div>

    <div class="pop-footer">
      <button class="pop-btn pop-btn-confirm" onclick="document.getElementById('pop-student-history-modal').classList.remove('active')">關閉</button>
    </div>
  </div>
</div>

<!-- ✅✅✅ 貼上結束 ✅✅✅ -->
<!-- ================================================= -->
<!-- [Pro-v9.9.7] 登入牆 (強制置頂版) -->
<!-- ================================================= -->
<div id="login-gate" class="login-gate">
  <div class="pop-modal gate-card" style="display: none">
    
    <div style="font-size: 2.5rem; margin-bottom: 5px;">☕️</div>
    <h2 style="color: #3d5c4f; font-size: 1.5rem; margin: 5px 0 10px 0;">我不想努力了 Pro</h2>
    <p style="color: #666; font-size: 0.9rem; margin-bottom: 20px;">願您的週末，有一杯熱咖啡的時間。</p>
    
    <div class="gate-input-group">
        <label style="display:block; color:#888; font-size:0.85rem; margin-bottom:5px; text-align: left;">電郵地址 (Email)</label>
        <input type="text" id="gate-email" class="pop-input" style="margin-bottom:15px; width: 100%;">
        
        <label style="display:block; color:#888; font-size:0.85rem; margin-bottom:5px; text-align: left;">密碼 (Password)</label>
        <input type="password" id="gate-password" class="pop-input" style="margin-bottom:5px; width: 100%;">
        
        <div style="text-align: right; margin-bottom: 25px;">
             <a href="javascript:void(0)" onclick="openForgotModal()" style="color:#999; font-size: 0.8rem; text-decoration:underline;">忘記密碼？</a>
        </div>
        
        <button class="pop-btn pop-btn-confirm" 
                style="width:100%; max-width:100%; margin: 0 auto; display: block; text-align: center; padding:12px; font-size:1.1rem; box-shadow: 0 10px 20px rgba(242, 192, 55, 0.3);" 
                onclick="handleGateAuth()">
             進入你的愜意工作咖啡廳 🥐
        </button>

        <div style="margin-top: 20px; text-align: center;">
            <a href="https://forms.gle/你的GoogleFormID" target="_blank" 
               style="color: #5A8F7B; font-weight: bold; text-decoration: none; border-bottom: 1px dashed #5A8F7B; font-size: 0.9rem; transition: all 0.2s;" 
               onmouseover="this.style.color='#3d5c4f'; this.style.borderBottomStyle='solid'" 
               onmouseout="this.style.color='#5A8F7B'; this.style.borderBottomStyle='dashed'">
                尚未持有通行證？申請成為咖啡廳常客🤍
            </a>
        </div>
    </div>

    <div style="margin-top: 25px; font-size: 0.85rem; background: rgba(90,143,123,0.08); padding: 10px 15px; border-radius: 99px;">
        <a href="http://idw-lite.vercel.app" target="_blank" style="color:#555; text-decoration:none;">
            只需單次批改？ <span style="color:#8d775f; font-weight:bold;">🌱 前往輕量版 (Lite) 試用</span>
        </a>
    </div>

  </div>
</div>

<!-- [v15.0] 進度還原提示 Modal -->
<div id="pop-restore-modal" class="pop-overlay">
    <div class="pop-modal">
        <div class="pop-icon">♻️</div>
        <h3>發現未儲存的進度</h3>
        <p class="pop-desc" id="restore-msg-time">
            系統檢測到您剛才正在批改中。<br>
            是否還原上次的畫面？
        </p>
        <div class="pop-footer">
            <button class="pop-btn pop-btn-cancel" onclick="discardAndGoHome()">不還原 (回首頁)</button>
            <button class="pop-btn pop-btn-confirm" onclick="confirmRestore()">還原並繼續</button>
        </div>
    </div>
</div>

<!-- [v18.3] 開新批改確認 Modal -->
<div id="pop-setup-confirm-modal" class="pop-overlay">
    <div class="pop-modal">
        <div class="pop-icon">☕️</div>
        <h3>預備好了嗎？</h3>
        <p class="pop-desc">請核對以下資訊，確定後將立即建立雲端專案。</p>
        
        <div style="background:#f9f9f9; padding:15px; border-radius:12px; text-align:left; margin-bottom:20px; border:1px solid #eee;">
            <div style="margin-bottom:8px;">
                <span style="color:#888; font-size:0.85rem;">作文題目：</span><br>
                <strong id="confirm-topic-display" style="font-size:1.1rem; color:#3d5c4f;"></strong>
            </div>
            <div style="margin-bottom:8px;">
                <span style="color:#888; font-size:0.85rem;">班別：</span><br>
                <strong id="confirm-class-display" style="font-size:1.1rem; color:#3d5c4f;"></strong>
            </div>
            <div>
                <span style="color:#888; font-size:0.85rem;">作答人數：</span><br>
                <strong id="confirm-count-display" style="font-size:1.1rem; color:#c86a5a;"></strong> 
         <div style="margin-top:12px; border-top:1px dashed #ddd; padding-top:10px;">
    <span style="color:#888; font-size:0.85rem;">已選名單預覽：</span>
    <div id="confirm-student-list" style="font-size:0.9rem; color:#555; max-height:100px; overflow-y:auto; margin-top:5px; line-height:1.5;">
        <!-- JS 會填入名單 -->
    </div>
</div>
        


 <div class="pop-footer">
   <button class="pop-btn pop-btn-cancel" onclick="document.getElementById('pop-setup-confirm-modal').classList.remove('active')">返回修改</button>
   <button class="pop-btn pop-btn-confirm" id="btn-create-project-confirm">確定建立</button>
 </div>
    </div>
</div>

<!-- [v19.0] 列印專用容器 (平時隱藏) -->
<div id="print-container">
    <!-- JS 會在這裡動態生成 .report-page -->
</div>

<!-- [v19.4] 專案詳情 Modal (補回) -->
<div id="pop-project-details-modal" class="pop-overlay">
  <div class="pop-modal">
    <div class="pop-icon">🗒</div>
    <h3>專案詳情</h3>
    
    <!-- 隱藏欄位：儲存 ID 用於刪除 -->
    <input type="hidden" id="detail-project-id">
    <input type="hidden" id="detail-project-title">

    <div style="text-align: left; margin: 15px 0; font-size: 0.95rem; line-height: 1.8; color: #555;">
        <div><strong>題目：</strong><span id="detail-topic"></span></div>
        <div><strong>班別：</strong><span id="detail-class"></span></div>
        <div><strong>進度：</strong><span id="detail-count"></span></div>
        <div style="border-top: 1px dashed #eee; margin: 8px 0;"></div>
        <div style="font-size: 0.85rem; color: #999;">
            建立日期：<span id="detail-create-date"></span><br>
            最後更新：<span id="detail-update-date"></span>
        </div>
    </div>

    <!-- 已有學生名單預覽 -->
    <div class="pop-scroll-area" id="detail-student-list" style="height: 150px; background: #fafafa; border: 1px solid #eee;">
        <!-- JS 動態填入 -->
    </div>

    <div class="pop-footer" style="justify-content: space-between;">
        <button class="pop-btn danger-btn" onclick="deleteProjectFromDetails()" style="background:#ffebee; color:#c62828;">🗑️ 刪除此作業</button>
        <button class="pop-btn pop-btn-confirm" onclick="document.getElementById('pop-project-details-modal').classList.remove('active')">關閉</button>
    </div>
  </div>
</div>
<script>
    (function() {
        const gate = document.getElementById('login-gate');
        // 檢查本地是否標記為「已登入」
        if (localStorage.getItem('idw_is_logged_in') === 'yes') {
            // 立即開門 (加上 unlocked class)
            if (gate) gate.classList.add('unlocked');
        }
    })();
</script>

<!-- [v11.3] Header 修改指引 (請手動調整 Header HTML) -->
<!-- 
1. 刪除 <div class="header-actions">...</div>
2. 將 <button ... onclick="toggleSettingsMenu()">⚙️</button> 放入 <div id="auth-buttons"> 內
3. 將 <div id="settings-dropdown">...</div> 也放入 <div id="auth-buttons"> 內 (或者放在 header 底部)
-->

<!-- [v11.3] 完整版快速新增評語 Modal -->
<div id="pop-instant-add-modal" class="pop-overlay">
  <div class="pop-modal" style="max-width: 500px; max-height: 90vh; display:flex; flex-direction:column;">
    <div class="pop-icon">✨</div>
    <h3>新增評語詳情</h3>
    <p class="pop-desc" id="instant-add-category-display">類別：內容</p>
    <input type="hidden" id="instant-add-category-val">

    <!-- 捲動區域 -->
    <div class="pop-scroll-area" style="text-align: left; padding: 15px;">
        
        <!-- 標題與類型 -->
        <label style="font-size:0.85rem; font-weight:bold; color:#5A8F7B;">標題 (必填)</label>
        <input type="text" id="instant-add-title" class="pop-input" style="margin-bottom: 15px;" placeholder="例如：立意深刻">
        
        <label style="font-size:0.85rem; font-weight:bold; color:#666;">類型</label>
        <div style="display:flex; gap:10px; margin-bottom: 20px;">
            <label style="flex:1; padding:10px; border:1px solid #ddd; border-radius:8px; cursor:pointer; text-align:center; background:#fff;">
                <input type="radio" name="instant-add-type" value="excellent" checked onchange="toggleInstantAddFields()"> 👍 優點
            </label>
            <label style="flex:1; padding:10px; border:1px solid #ddd; border-radius:8px; cursor:pointer; text-align:center; background:#fff;">
                <input type="radio" name="instant-add-type" value="problem" onchange="toggleInstantAddFields()"> 👎 待改進
            </label>
        </div>

        <!-- 優點專用 -->
        <div id="instant-field-excellent">
            <label style="font-size:0.85rem; font-weight:bold; color:#666;">優點詳情</label>
            <textarea id="instant-add-strength" class="pop-input" rows="2" placeholder="對優點的具體描述..."></textarea>
        </div>

        <!-- 缺點專用 (預設隱藏) -->
        <div id="instant-field-problem" style="display:none;">
            <label style="font-size:0.85rem; font-weight:bold; color:#c86a5a;">問題核心</label>
            <textarea id="instant-add-problem" class="pop-input" rows="2" placeholder="問題在於..."></textarea>
            
            <label style="font-size:0.85rem; font-weight:bold; color:#5A8F7B; margin-top:10px;">建議 (宜)</label>
            <textarea id="instant-add-suggestion" class="pop-input" rows="2" placeholder="建議如何改善..."></textarea>
        </div>

        <!-- 通用欄位 -->
        <div style="margin-top: 15px; border-top: 1px dashed #ddd; padding-top: 15px;">
            <label style="font-size:0.85rem; font-weight:bold; color:#666;">例子 (Example)</label>
            <textarea id="instant-add-example" class="pop-input" rows="2" placeholder="具體例子..."></textarea>

            <label style="font-size:0.85rem; font-weight:bold; color:#666; margin-top:10px;">下拉選項設定 (進階)</label>
            <input type="text" id="instant-add-options-label" class="pop-input" placeholder="標籤 (e.g. 描寫對象)" style="margin-bottom:5px;">
            <textarea id="instant-add-options" class="pop-input" rows="2" placeholder="選項 (每行一個，e.g. 天氣|心情)"></textarea>
            <div style="font-size:0.75rem; color:#999;">註：可用 | 分隔多組選項</div>
        </div>
    </div>

    <div class="pop-footer">
      <button class="pop-btn pop-btn-cancel" onclick="document.getElementById('pop-instant-add-modal').classList.remove('active')">取消</button>
      <button class="pop-btn pop-btn-confirm" onclick="saveInstantCritique()">儲存並選取</button>
    </div>
  </div>
</div>


<button id="mobile-menu-btn" style="display: none;">
    <i class="fas fa-bars"></i>
</button>

<!-- [Edition: 書] 手機版懸浮目錄按鈕 -->
<div id="mobile-book-trigger" onclick="toggleBookMenu()">
    <span style="font-size: 1.4rem;">🔖</span>
    <span style="font-size: 0.75rem; font-weight: bold;">書籤</span>
</div>

<!-- [Edition: 書] 全螢幕目錄遮罩 -->
<div id="mobile-book-overlay">
    <!-- 關閉按鈕 -->
    <button class="book-close-btn" onclick="toggleBookMenu()">✕</button>
    
    <div class="book-menu-container">
        <h2 class="book-menu-title">工作日誌目錄</h2>
        
        <!-- 目錄列表 (JS 動態生成或靜態寫入) -->
        <div id="book-menu-list">
            <!-- 1. 咖啡廳 (無子選單) -->
            <div class="book-main-item" onclick="mobileNavClick('home', null)">
                <span class="book-icon">☕️</span> 咖啡廳
            </div>

            <!-- 2. 工作枱 -->
            <div class="book-main-item has-subs" onclick="toggleBookSub('workspace')">
                <div class="book-main-header">
                    <span><span class="book-icon">💻</span> 工作枱</span>
                    <span class="book-arrow">▼</span>
                </div>
                <div id="book-sub-workspace" class="book-sub-list">
                    <div class="book-sub-item" onclick="mobileNavClick('workspace', 'page1')">基本設定</div>
                    <div class="book-sub-item" onclick="mobileNavClick('workspace', 'page2')">批改介面</div>
                    <div class="book-sub-item" onclick="mobileNavClick('workspace', 'page4')">進度手帳</div>
                    <div class="book-sub-item" onclick="mobileNavClick('workspace', 'page5')">評語分析</div>
                </div>
            </div>

            <!-- 3. AI 烘焙室 -->
            <div class="book-main-item has-subs" onclick="toggleBookSub('ailab')">
                <div class="book-main-header">
                    <span><span class="book-icon">✨</span> AI 烘焙室</span>
                    <span class="book-arrow">▼</span>
                </div>
                <div id="book-sub-ailab" class="book-sub-list">
                    <div class="book-sub-item" onclick="mobileNavClick('ailab', 'page6')">生成評語庫</div>
                    <div class="book-sub-item" onclick="mobileNavClick('ailab', 'page7')">生成回饋</div>
                </div>
            </div>

            <!-- 4. 檔案室 -->
            <div class="book-main-item has-subs" onclick="toggleBookSub('archives')">
                <div class="book-main-header">
                    <span><span class="book-icon">📑</span> 檔案室</span>
                    <span class="book-arrow">▼</span>
                </div>
                <div id="book-sub-archives" class="book-sub-list">
                    <div class="book-sub-item" onclick="mobileNavClick('archives', 'page3')">評語庫管理</div>
                    <div class="book-sub-item" onclick="mobileNavClick('archives', 'page8')">班級管理</div>
                </div>
            </div>
        </div>

        <div style="margin-top: 3rem; text-align: center; opacity: 0.5; font-size: 0.8rem;">
            — 我不想努力了 Pro —
        </div>
    </div>
</div>

<!-- [v11.4] 快速開 Project Modal (補鑊專用) -->
<div id="pop-quick-project-modal" class="pop-overlay">
    <div class="pop-modal">
        <div class="pop-icon">🚦</div>
        <h3>稍等，還差一步...</h3>
        <p class="pop-desc">
            系統發現您尚未建立作業專案。<br>
            為了讓這些 AI 評語能順利套用到學生身上，請先告訴我們：
        </p>

        <!-- 暫存 AI 數據用 -->
        <input type="hidden" id="quick-json-storage">

        <div style="text-align: left; margin-bottom: 20px;">
            <label style="font-weight:bold; color:#5A8F7B; font-size:0.9rem;">這份評語是用於哪一班？</label>
            <select id="quick-class-select" class="pop-input" style="margin-top:5px;">
                <option value="">讀取中...</option>
            </select>
            
            <div id="quick-manual-area" style="display:none; margin-top:10px;">
                <label style="font-weight:bold; color:#666; font-size:0.9rem;">(未登入) 請貼上學生名單：</label>
                <textarea id="quick-manual-list" class="pop-input" rows="3" placeholder="陳大文&#10;李小美"></textarea>
            </div>
        </div>

        <div class="pop-footer">
            <button class="pop-btn pop-btn-cancel" onclick="document.getElementById('pop-quick-project-modal').classList.remove('active')">取消</button>
            <button class="pop-btn pop-btn-confirm" onclick="confirmQuickProject()">🚀 建立並開始批改</button>
        </div>
    </div>
</div>


<!-- [v18.11] 未同步提醒 Modal (防 Hang 機版) -->
<div id="pop-unsaved-guard-modal" class="pop-overlay" style="z-index: 2147483650;">
    <div class="pop-modal">
        <div class="pop-icon">🍃</div>
        <h3>還未同步喔</h3>
        <p class="pop-desc">
            您在批改頁的更動尚未同步至雲端。<br>
            直接離開可能會遺失剛才的進度。
        </p>
        <div class="pop-footer">
            <!-- 暫存目標頁面 ID -->
            <input type="hidden" id="guard-target-page">
            
            <button class="pop-btn pop-btn-cancel" onclick="forceLeavePage()">👋 直接離開</button>
            <button class="pop-btn pop-btn-confirm" onclick="stayAndSync()">☁️ 留低同步</button>
        </div>
    </div>
</div>


<script>

// --- Supabase 初始化與設定 ---
const SUPABASE_URL = 'https://wtcegbkfuklnkurrouka.supabase.co'; 
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind0Y2VnYmtmdWtsbmt1cnJvdWthIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0MTU5MjgsImV4cCI6MjA3ODk5MTkyOH0.mQT2TXLR6m41D1WzmqH35mKdoGDGqHaHhZm-sTpPmpQ';
const { createClient } = supabase;
const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);


// --- 全域變數 ---
// [v18.2.0] Page 8 Inline Editing State
let _editingMasterStudentId = null;
let currentUser = null;
let isDataDirty = false; 
let allStudentRecords = [];
let currentTypos = [];
let commonTypos = [];
let cannedCritiques = {}; // 用於儲存預設評語
const CATEGORY_ORDER = ['扣題與立意', '取材與刻畫', '結構與鋪排', '語言與表達'];




/* ====== 小型 Confirm UI ====== */
const modal = {
  el: null, okBtn: null, cancelBtn: null, textEl: null, resolve: null,
  init() {
    this.el = document.getElementById('modal');
    this.okBtn = document.getElementById('modal-ok');
    this.cancelBtn = document.getElementById('modal-cancel');
    this.textEl = document.getElementById('modal-text');
    this.okBtn.addEventListener('click', ()=>{ this.hide(); if (this.resolve) this.resolve(true); });
    this.cancelBtn.addEventListener('click', ()=>{ this.hide(); if (this.resolve) this.resolve(false); });
    this.el.addEventListener('click', (e)=>{ if (e.target===this.el) { this.hide(); if (this.resolve) this.resolve(false); }});
  },
  show(message) {
    if (!this.el) this.init();
    this.textEl.textContent = message || '請確認';
    this.el.classList.add('active');
    this.el.setAttribute('aria-hidden', 'false');
    return new Promise(res => { this.resolve = res; });
  },
  hide() {
    this.el.classList.remove('active');
    this.el.setAttribute('aria-hidden', 'true');
  }
};
function confirmUI(message, onOk) {
  modal.show(message).then(ok => { if (ok && typeof onOk === 'function') onOk(); });
}

// --- 新增：Toast Notification Function ---
function showToast(message, type = 'info') {
    const container = document.getElementById('toast-container');
    if (!container) return;

    const toast = document.createElement('div');
    toast.className = `toast-notification ${type}`;
    
    // 不同類型對應的 icon
    let icon = '';
    switch(type) {
        case 'success': icon = '✅'; break;
        case 'warning': icon = '⚠️'; break;
        case 'error': icon = '❌'; break;
        default: icon = 'ℹ️';
    }

    toast.innerHTML = `<span>${icon}</span><span>${message}</span>`;
    container.appendChild(toast);

    // 3秒後移除
    setTimeout(() => {
        toast.style.animation = 'toastFadeOut 0.4s forwards';
        setTimeout(() => {
            if (toast.parentNode) toast.parentNode.removeChild(toast);
        }, 400);
    }, 3000);
}
// 新增：更新頂部專案資訊函式 (防彈版)
function updateHeaderInfo() {
    // 嘗試獲取各種可能的輸入框
    const classInput = document.getElementById('student-class') || document.getElementById('student-class-manual');
    const topicInput = document.getElementById('topic');
    
    // 獲取顯示容器
    const container = document.getElementById('project-header-info');
    const classSpan = document.getElementById('ph-class');
    const topicSpan = document.getElementById('ph-topic');

    // 如果容器不存在 (可能未載入)，直接離開
    if (!container || !classSpan || !topicSpan) return;

    const className = classInput ? classInput.value.trim() : '';
    const topic = topicInput ? topicInput.value.trim() : '';

    if (className || topic) {
        container.style.display = 'inline-flex';
        classSpan.textContent = className || '未設定班別';
        topicSpan.textContent = topic || '未設定題目';
    } else {
        container.style.display = 'none';
    }
}
// --- Supabase 核心功能 ---



/* ========================================= */
/* === [v14.0] 登出 (清除防閃爍標記) === */
/* ========================================= */

async function handleLogout() {
    if (!confirm("確定要登出嗎？所有未同步的變更將會遺失。")) return;

    const authStatus = document.getElementById('auth-status');
    if (authStatus) authStatus.textContent = "正在登出...";

    try {
        await supabaseClient.auth.signOut();
    } catch (error) {
        console.warn("雲端登出回報錯誤:", error.message);
    } finally {
        // 🔥 清除防閃爍標記
        localStorage.removeItem('idw_is_logged_in');

        // 清理本地狀態
        currentUser = null;
        allStudentRecords = [];
        commonTypos = [];
        sessionStorage.removeItem('projectPromptShownThisSession');

        // 重置介面
        resetToDefaultCritiques(false);
        buildChecklist();
        buildOverviewPage();
        renderCommonTypoList();
        renderStudentOverviewTable();
        clearAllCore();
        updateUIBasedOnAuthState();

        if (typeof loadDashboard === 'function') loadDashboard();

        // 立即鎖門
        const gate = document.getElementById('login-gate');
        if (gate) {
            gate.classList.remove('unlocked');
            document.getElementById('gate-email').value = '';
            document.getElementById('gate-password').value = '';
        }

        if (typeof showToast === 'function') showToast("已安全登出", "success");
    }
}

// [Pro-v7.2] 雲端資料初始化 (移除自動彈出專案列表)
async function loadDataFromCloud() {
  if (!currentUser) return;
  const authStatus = document.getElementById('auth-status');
  authStatus.textContent = '同步中...';
  
  try {
    // 1. 讀取評語庫
    const { data: critiquesData, error: critiquesError } = await supabaseClient
      .from('critiques').select('*').eq('user_id', currentUser.id);
      
    if (critiquesData && critiquesData.length > 0) {
      applyCritiquesToDOM(critiquesData.map(c => ({
        id: c.critique_id, category: c.category, type: c.type, title: c.title,
        strengthSummary: c.strength_summary, problemCore: c.problem_core,
        suggestion: c.suggestion, example: c.example, options: c.options,
        optionsLabel: c.options_label
      })));
    } else {
      resetToDefaultCritiques(false);
    }
    buildChecklist();
    buildOverviewPage();

    // 2. 讀取錯別字
    const { data: typosData } = await supabaseClient
      .from('common_typos').select('*').eq('user_id', currentUser.id);
    if (typosData) {
        commonTypos = typosData.map(t => ({ id: t.typo_id, wrong: t.wrong, correct: t.correct }));
        renderCommonTypoList();
    }

    // 🔥 [修改] 這裡不再自動呼叫 promptAndLoadCloudProject()
    // 讓新用戶專注於 Dashboard 或 歡迎彈窗
    
    isDataDirty = false;
    updateUIBasedOnAuthState();
    authStatus.textContent = `已登入: ${currentUser.email}`;
    
  } catch (error) {
    console.error(error);
    authStatus.textContent = `連線錯誤`;
  }
}

// [Pro-v4.3] 混合雲端讀取器 (同時讀取新舊資料庫)
async function promptAndLoadCloudProject() {
    if (!currentUser) {
        alert("請先登入以使用雲端專案功能。");
        return;
    }
    const authStatus = document.getElementById('auth-status');
    const originalText = authStatus.textContent;
    authStatus.textContent = '正在搜尋雲端專案...';

    try {
        // 1. 讀取 [新] assignments 表
        // (暫時移除 classes join 以避免關聯錯誤，只讀 title)
    const { data: newProjects, error: newError } = await supabaseClient
    .from('assignments')
    // 👇 關鍵是這句，要加 classes(class_name)
    .select('id, title, created_at, user_id, classes(class_name)') 
    .eq('user_id', currentUser.id)
    .order('created_at', { ascending: false });

        // 2. 讀取 [舊] student_projects 表 (Legacy)
        const { data: oldProjects, error: oldError } = await supabaseClient
            .from('student_projects')
            .select('id, topic, class_name, updated_at')
            .eq('user_id', currentUser.id)
            .order('updated_at', { ascending: false });

        authStatus.textContent = originalText;

        if (newError) console.error("新表讀取錯誤:", newError);
        if (oldError) console.error("舊表讀取錯誤:", oldError);

        // 3. 合併資料 (標準化格式)
        let combinedList = [];

        // 處理新資料
        if (newProjects) {
            newProjects.forEach(p => {
                combinedList.push({
    id: p.id,
    title: p.title,
    // 👇 這段意思是：如果抓得到 class_name 就顯示，抓不到才顯示 (未分類)
    className: (p.classes && p.classes.class_name) ? p.classes.class_name : '(未分類)',
    date: p.created_at,
    type: 'new'
});
            });
        }

        // 處理舊資料
        if (oldProjects) {
            oldProjects.forEach(p => {
                combinedList.push({
                    id: p.id,
                    title: p.topic,
                    className: p.class_name,
                    date: p.updated_at,
                    type: 'legacy' // 標記為舊版
                });
            });
        }

        // 按時間排序 (最新的在上面)
        combinedList.sort((a, b) => new Date(b.date) - new Date(a.date));

        // --- 顯示 UI ---
        return new Promise((resolve) => {
            const modal = document.getElementById('pop-project-modal');
            const listContainer = document.getElementById('pop-project-list');
            const input = document.getElementById('pop-project-input');
            const confirmBtn = document.getElementById('pop-project-confirm');
            const cancelBtn = document.getElementById('pop-project-cancel');
            const footer = modal.querySelector('.pop-footer');

            // 備份檢查邏輯
            const backupStr = localStorage.getItem('idw_grading_backup_v1');
            let hasBackup = false;
            let backupTime = '';
            const oldBackupBtn = document.getElementById('pop-backup-btn-container');
            if (oldBackupBtn) oldBackupBtn.remove();

            if (backupStr) {
                try {
                    const b = JSON.parse(backupStr);
                    if (b.timestamp && (b.students && b.students.length > 0)) {
                        hasBackup = true;
                        const d = new Date(b.timestamp);
                        backupTime = `${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${d.getMinutes() < 10 ? '0'+d.getMinutes() : d.getMinutes()}`;
                    }
                } catch(e){}
            }

            // 渲染列表
            listContainer.innerHTML = '';
            if (combinedList.length === 0) {
                listContainer.innerHTML = '<div style="padding:20px; color:#999;">雲端上沒有專案。<br>(請確認您已「儲存」過作業)</div>';
            } else {
                combinedList.forEach((p, index) => {
                    const dateStr = new Date(p.date).toLocaleDateString();
                    const div = document.createElement('div');
                    div.className = 'pop-list-item';
                    
                    // 視覺區分新舊
                    const badge = p.type === 'legacy' 
                        ? '<span style="background:#eee; color:#666; font-size:0.7em; padding:2px 4px; border-radius:4px;">🍃</span>' 
                        : '<span style="background:#e0f2f1; color:#00695c; font-size:0.7em; padding:2px 4px; border-radius:4px;">☁️</span>';

                    div.innerHTML = `<strong>${index + 1}.</strong> ${badge} ${escapeHtmlAttr(p.className)} - ${escapeHtmlAttr(p.title)} <span style="font-size:0.8em;color:#999">(${dateStr})</span>`;
                    
                    div.onclick = () => {
                        input.value = index + 1;
                        triggerConfirm();
                    };
                    listContainer.appendChild(div);
                });
            }

            // 插入備份按鈕
            if (hasBackup) {
                const backupContainer = document.createElement('div');
                backupContainer.id = 'pop-backup-btn-container';
                backupContainer.style.cssText = 'margin-top: 15px; border-top: 1px solid #eee; padding-top: 15px; text-align: center;';
                backupContainer.innerHTML = `
                    <div style="font-size: 0.9rem; color: #666; margin-bottom: 8px;">
                        ♻️ 發現未儲存的本機備份 (${backupTime})
                    </div>
                    <button class="pop-btn" style="background: #e8f5e9; color: #2e7d32; border: 1px solid #a5d6a7; width: 100%; padding: 8px;">
                        還原此備份
                    </button>
                `;
                footer.parentNode.insertBefore(backupContainer, footer);
                backupContainer.querySelector('button').onclick = () => {
                    closeModal();
                    restoreFromLocalBackup();
                    resolve(true);
                };
            }

            modal.classList.add('active');
            input.value = '';
            setTimeout(() => input.focus(), 100); 

            const triggerConfirm = async () => {
                const val = parseInt(input.value, 10);
                if (!isNaN(val) && val >= 1 && val <= combinedList.length) {
                    const project = combinedList[val - 1];
                    closeModal();
                    
                    // 🔥 [關鍵分流] 根據類型呼叫不同的載入函數
                    if (project.type === 'legacy') {
                        await loadProjectById(project.id); // 舊版載入器
                    } else {
                        await openAssignment(project.id); // 新版載入器
                    }
                    resolve(true);
                } else {
                    input.style.borderColor = '#c86a5a';
                    setTimeout(() => input.style.borderColor = '#e0e0e0', 500);
                }
            };

            const closeModal = () => {
                modal.classList.remove('active');
                confirmBtn.onclick = null;
                cancelBtn.onclick = null;
                input.onkeydown = null;
                const btn = document.getElementById('pop-backup-btn-container');
                if(btn) btn.remove();
            };

            confirmBtn.onclick = triggerConfirm;
            cancelBtn.textContent = "開新專案";
            cancelBtn.onclick = () => {
                closeModal();
                showPage('page1');
                resolve(false);
            };
            input.onkeydown = (e) => { if (e.key === 'Enter') triggerConfirm(); };
        });
    } catch (err) {
        console.error(err);
        alert("系統錯誤：" + err.message);
        authStatus.textContent = originalText;
    }
}

async function loadProjectById(projectId) {
    const authStatus = document.getElementById('auth-status');
    authStatus.textContent = "正在載入...";
    try {
        const { data: fullProject, error: fullProjectError } = await supabaseClient
            .from('student_projects').select('project_data, class_name, topic').eq('id', projectId).single();
        if (fullProjectError) throw fullProjectError;
        
        clearAllCore(false);
        allStudentRecords = [];
        document.getElementById('student-names').value = '';

        // 讀取專案資料
        const rawData = fullProject.project_data;
        let loadedStudents = [];
        let loadedCritiques = null;

        // 判斷資料格式 (新舊版相容)
        if (Array.isArray(rawData)) {
            loadedStudents = rawData;
        } else if (rawData && rawData.students) {
            loadedStudents = rawData.students || [];
            loadedCritiques = rawData.critiques || [];
        }

        allStudentRecords = loadedStudents;
        document.getElementById('student-class').value = fullProject.class_name || '';
        document.getElementById('topic').value = fullProject.topic || '';
        document.getElementById('student-names').value = allStudentRecords.map(r => r.originalName).join('\n');
        
        // === 【關鍵修正】載入前先清空評語庫 DOM ===
        document.getElementById('critique-data').innerHTML = '';

        // 處理評語庫還原
        if (loadedCritiques && loadedCritiques.length > 0) {
            applyCritiquesToDOM(loadedCritiques);
        } else {
            // 如果專案冇自帶評語，就試下跌用戶全域設定，或者用系統預設
            const { data: globalData } = await supabaseClient.from('critiques').select('*').eq('user_id', currentUser.id);
            if (globalData && globalData.length > 0) {
                 applyCritiquesToDOM(globalData.map(c => ({
                    id: c.critique_id, category: c.category, type: c.type, title: c.title,
                    strengthSummary: c.strength_summary, problemCore: c.problem_core,
                    suggestion: c.suggestion, example: c.example, options: c.options, optionsLabel: c.options_label
                })));
            } else {
                 resetToDefaultCritiques(false);
            }
        }

        buildChecklist(); 
        buildOverviewPage(); 
        updateStudentDropdown();
        renderStudentOverviewTable();
       updateHeaderInfo();     
        
        const studentSelect = document.getElementById('student-select');
        if (studentSelect.options.length > 0) {
            studentSelect.selectedIndex = 0;
            loadStudentData(studentSelect.value);
        }
        showPage('page2');
        if (typeof showToast === 'function') showToast(`專案「${fullProject.class_name || ''}」載入成功！`, "success");
        else alert(`專案「${fullProject.class_name}」載入成功！`);
    } catch (error) {
        alert(`載入專案時發生錯誤：${error.message}`);
    } finally {
        updateUIBasedOnAuthState();
    }
}
// [Pro-v9.3] 儲存 (加入評語庫 Snapshot)
async function syncDataToCloud() {
  if (!currentUser) { showToast("尚未登入", "warning"); return; }
  const className = document.getElementById('student-class').value.trim();
  const topic = document.getElementById('topic').value.trim();
  
  if (!window.currentClassId) { showToast("請先選擇班級", "warning"); return; }

  const syncBtn = document.getElementById('sync-btn');
  syncBtn.textContent = '同步中...'; syncBtn.disabled = true; syncBtn.classList.remove('dirty');
  
  try {
    console.log("☁️ 正在同步專案與評語庫...");

    // 1. 準備評語庫 Snapshot (這就是當日的 Menu)
    const currentCritiques = collectExportData(); 

    let assignmentId = window.currentAssignmentId;
    if (!assignmentId) {
        const { data: existing } = await supabaseClient.from('assignments').select('id').eq('class_id', window.currentClassId).eq('title', topic).maybeSingle();
        if (existing) assignmentId = existing.id;
    }

    // 2. 寫入 assignments (包含 settings)
    const payload = {
        user_id: currentUser.id,
        class_id: window.currentClassId,
        title: topic,
        settings: { critiques: currentCritiques }, // 🔥 核心：將評語庫存入 Project
        ...(assignmentId && { id: assignmentId }),
        created_at: new Date().toISOString()
    };

    const { data, error } = await supabaseClient.from('assignments').upsert(payload).select().single();
    if (error) throw error;

    window.currentAssignmentId = data.id;
    
    // 3. 順便儲存當前學生 (如果在 Page 2)
    if (document.getElementById('page2').classList.contains('active')) {
        await saveCurrentStudentData('cloud_silent'); // Silent mode 避免重複 Toast
    }

    showToast("✅ 專案與評語庫已同步！", "success");
    isDataDirty = false; updateUIBasedOnAuthState(); 
    setTimeout(() => { if(syncBtn) { syncBtn.classList.remove('dirty'); syncBtn.textContent = '資料已同步'; } }, 100);

  } catch (error) {
    console.error("同步失敗:", error);
    showToast(`同步失敗: ${error.message}`, "error");
    isDataDirty = true; updateUIBasedOnAuthState();
  } finally {
    if (isDataDirty) { syncBtn.disabled = false; syncBtn.textContent = '儲存變更到雲端'; } 
    else { syncBtn.disabled = false; }
  }
}
// ====== 登入/介面狀態 強制修復版 ======
// ==========================================

// 1. 介面狀態更新函數 (v10.0-Auth-Core-Fix: 隱藏多餘登入制)
function updateUIBasedOnAuthState() {
    const authStatus = document.getElementById('auth-status');
    const loginBtn = document.getElementById('login-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const syncBtn = document.getElementById('sync-btn');
    const selectProjectBtn = document.getElementById('select-project-btn');
    const phContainer = document.getElementById('project-header-info');

    if (currentUser) {
        // 已登入狀態
        if(authStatus) authStatus.textContent = `已登入: ${currentUser.email}`;
        if(authStatus) authStatus.style.backgroundColor = "rgba(90, 143, 123, 0.2)";
        
        if(loginBtn) loginBtn.style.display = 'none';
        if(logoutBtn) logoutBtn.style.display = 'inline-flex';
        if(syncBtn) syncBtn.style.display = 'inline-flex';
        if(selectProjectBtn) selectProjectBtn.style.display = 'inline-flex';

        if (isDataDirty) {
            syncBtn.disabled = false;
            syncBtn.classList.add('dirty');
            syncBtn.textContent = '儲存變更到雲端';
        } else {
            syncBtn.disabled = false;
            syncBtn.classList.remove('dirty');
            syncBtn.textContent = '資料已同步';
        }
    } else {
        // 未登入狀態
        if(authStatus) authStatus.textContent = '未連接';
        if(authStatus) authStatus.style.backgroundColor = "rgba(0, 0, 0, 0.15)";

        // 🔥 核心改動：因為有登入牆，Header 嘅「登入/註冊」按鈕隱藏，避免雙重入口
        if(loginBtn) loginBtn.style.display = 'none';
        
        if(logoutBtn) logoutBtn.style.display = 'none';
        if(syncBtn) syncBtn.style.display = 'none';
        if(selectProjectBtn) selectProjectBtn.style.display = 'none';
        if(phContainer) phContainer.style.display = 'none';
    }
}

/* ====== 字體大小調整功能 ====== */
const FONT_SCALE_KEY = 'globalFontScale';
const FONT_SCALE_STEP = 0.05;
const MIN_FONT_SCALE = 0.8;
const MAX_FONT_SCALE = 1.3;
const DEFAULT_FONT_SCALE = 1.0;
function adjustFontSize(direction) {
    const root = document.documentElement;
    let currentScale = parseFloat(root.style.getPropertyValue('--font-scale') || DEFAULT_FONT_SCALE);
    if (direction === 'increase') currentScale = Math.min(MAX_FONT_SCALE, currentScale + FONT_SCALE_STEP);
    else if (direction === 'decrease') currentScale = Math.max(MIN_FONT_SCALE, currentScale - FONT_SCALE_STEP);
    else currentScale = DEFAULT_FONT_SCALE;
    root.style.setProperty('--font-scale', currentScale);
    root.style.fontSize = `calc(16px * ${currentScale})`;
    saveFontSize(currentScale);
}
function saveFontSize(scale) { try { localStorage.setItem(FONT_SCALE_KEY, scale); } catch (e) { console.warn("無法儲存字體大小設定:", e); } }
function loadFontSize() { try { const savedScale = localStorage.getItem(FONT_SCALE_KEY); const scale = parseFloat(savedScale) || DEFAULT_FONT_SCALE; const root = document.documentElement; root.style.setProperty('--font-scale', scale); root.style.fontSize = `calc(16px * ${scale})`; } catch (e) { console.warn("無法讀取字體大小設定:", e); } }

/* ---------------- 頁面切換與通用功能 ---------------- */

// [Pro-v9.5.2] Scroll Fix: 使用原生 scrollIntoView 配合 CSS scroll-margin-top
function scrollToSection(event, targetId) {
if (event) event.preventDefault();
const targetElement = document.getElementById(targetId);
if (!targetElement) return;

// 直接叫瀏覽器捲動過去，它會自動讀取 CSS 的 scroll-margin-top
targetElement.scrollIntoView({
behavior: 'smooth',
block: 'start'
});
}

  


function initFloatingNavObserver() {
    const sections = document.querySelectorAll('#page2 .section-box');
    const navLinks = document.querySelectorAll('#floating-nav .floating-nav-btn');
    
    if (sections.length === 0 || navLinks.length === 0) return;

    const observer = new IntersectionObserver(entries => {
        let lastVisibleSectionId = null;
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                lastVisibleSectionId = entry.target.getAttribute('id');
            }
        });

        if (lastVisibleSectionId) {
             navLinks.forEach(link => {
                const linkHrefId = link.getAttribute('href').substring(1);
                if (linkHrefId === lastVisibleSectionId) {
                    link.classList.add('active');
                } else {
                    link.classList.remove('active');
                }
            });
        }
    }, {
         rootMargin: '-120px 0px -80% 0px',
        threshold: 0
    });

    sections.forEach(section => {
        observer.observe(section);
    });
}

// ▼▼▼ 在這裡貼上整段新函數 ▼▼▼
function initScrollAutoShow() {
    let scrollTimer = null;
    const nav = document.getElementById('floating-nav');

    window.addEventListener('scroll', () => {
        // 只有在導覽列本身是 visible (即在 page2) 時才執行
        if (!nav.classList.contains('visible')) return;

        // 1. 開始滾動：顯示導覽列
        nav.classList.add('is-scrolling');

        // 2. 清除舊的計時器
        if (scrollTimer) clearTimeout(scrollTimer);

        // 3. 設定新的計時器：停止滾動 2 秒後隱藏
        scrollTimer = setTimeout(() => {
            // 如果滑鼠還指在上面，就不隱藏 (方便電腦版操作)
            if (!nav.matches(':hover')) {
                nav.classList.remove('is-scrolling');
            }
        }, 2000); 
    }, { passive: true });
}

function toggleAllDetails(containerId, openState) {
  const container = document.getElementById(containerId);
  if (container) container.querySelectorAll('details').forEach(detail => detail.open = openState);
}

/* ---------------- 評語庫核心功能 (新增/修改) ---------------- */
function loadDefaultCritiques() {
    cannedCritiques = {
        narrative: [
            { id: 'nar_exc_1', category: '結構與鋪排', type: 'excellent', title: '敘事線索清晰', strengthSummary: '能圍繞單一線索（如時間、地點、物件）展開敘事，脈絡分明。', example: '以「那隻舊手錶」為線索，串連起童年回憶與現在的感受，結構完整。' },
            { id: 'nar_exc_2', category: '取材與刻畫', type: 'excellent', title: '情節曲折，引人入勝', strengthSummary: '情節有起伏，善用[選項1]製造懸念或轉折。', options: '倒敘\n插敘\n預設懸念', optionsLabel: '敘事技巧', example: '開首寫出結果，再用倒敘法交代前因後果，成功吸引讀者追看。' },
            { id: 'nar_pro_1', category: '結構與鋪排', type: 'problem', title: '敘事平鋪直敘', problemCore: '事件只按時序記下，缺乏重點和波瀾。', suggestion: '可嘗試在關鍵部分詳細描寫，加入人物的心理活動，或製造情節的起伏。', example: '寫宿營只是「早上集合、中午吃飯、下午遊戲」，可集中寫一次晚上的營火會及與同學的互動。' },
            { id: 'nar_pro_2', category: '扣題與立意', type: 'problem', title: '有敘事，欠主題', problemCore: '只記敘了事件經過，但未從中提煉出感受或道理。', suggestion: '可在結尾點明事件對你的影響或啟發，深化文章主旨。', example: '記一次旅行，除了行程，更應寫出旅行讓你學到了什麼，或對你心情的影響。' },
            { id: 'nar_exc_3', category: '語言與表達', type: 'excellent', title: '善用對話，活現人物', strengthSummary: '能運用簡潔而富個性的對話，表現人物的性格和關係。', example: '透過祖孫之間生活化的對答，自然流露出深厚的親情。'},
            { id: 'nar_pro_3', category: '取材與刻畫', type: 'problem', title: '人物形象模糊', problemCore: '對人物的描寫不足，性格模糊，難以留下印象。', suggestion: '可集中描寫人物一兩個最突出的外貌或性格特點，並配以具體事例。', example: '與其說「他很樂於助人」，不如寫一件他如何幫助同學的具體事件。'}
        ],
        lyrical: [
            { id: 'lyr_exc_1', category: '語言與表達', type: 'excellent', title: '情景交融，觸景生情', strengthSummary: '能將眼前景物與內心感受緊密結合，互相烘托。', example: '透過描寫窗外的冷雨，來烘托自己孤單、失落的心情，情景配合得宜。' },
            { id: 'lyr_exc_2', category: '扣題與立意', type: 'excellent', title: '感情真摯，深刻動人', strengthSummary: '情感表達真實、自然，不造作，能引起讀者共鳴。', example: '對祖母的思念之情，透過回憶共處的瑣碎小事表達，真實感人。' },
            { id: 'lyr_pro_1', category: '語言與表達', type: 'problem', title: '情感空泛，欠缺承托', problemCore: '只不斷重複「我好難過」，但沒有具體事件或描寫來支撐。', suggestion: '可透過描寫具體的動作、神情或回憶一個片段，來表現抽象的情感。', example: '與其說「我很開心」，不如寫「我一路上哼著歌，腳步也輕快起來」。' },
            { id: 'lyr_pro_2', category: '結構與鋪排', type: 'problem', title: '情感跳躍，缺乏鋪墊', problemCore: '情感轉變過於突兀，讀者難以理解。', suggestion: '在情感轉變處，可加入過渡句或心理獨白，交代心路歷程。', example: '由悲傷轉為釋懷，可加上「看著窗外雨後天晴，我忽然覺得…」等過渡。' },
            { id: 'lyr_exc_3', category: '取材與刻畫', type: 'excellent', title: '善用象徵，寄託情感', strengthSummary: '能藉由[選項1]等具體事物，寄託抽象的感情或意義。', options: '一件物件\n一種植物\n一個場景', optionsLabel: '象徵物', example: '以凋謝的玫瑰象徵逝去的愛情，含蓄而有深度。'},
            { id: 'lyr_pro_3', category: '扣題與立意', type: 'problem', title: '為賦新詞強說愁', problemCore: '情感誇張失實，缺乏生活基礎，難以令人信服。', suggestion: '應從真實的生活體驗和感受出發，即使是微小的情感，只要真實便能動人。', example: '只是遺失了一枝筆，卻形容為「世界末日」，情感表達過於誇張。'}
        ],
        descriptive: [
            { id: 'des_exc_1', category: '取材與刻畫', type: 'excellent', title: '多角度描寫，層次豐富', strengthSummary: '能從視覺、聽覺、嗅覺、觸覺等多個感官角度描寫[選項1]，使形象更立體。', options: '景物\n人物', optionsLabel: '描寫對象', example: '描寫街市不只寫看見的東西，還寫了叫賣聲（聽覺）和魚腥味（嗅覺），非常立體。' },
            { id: 'des_exc_2', category: '語言與表達', type: 'excellent', title: '善用修辭，描寫生動', strengthSummary: '善於運用比喻、擬人、誇張等修辭手法，使描寫更生動有趣。', example: '用「像一塊巨大的綠色地氈」來比喻草地，貼切而形象。' },
            { id: 'des_pro_1', category: '取材與刻畫', type: 'problem', title: '描寫欠具體', problemCore: '只用「美麗」、「宏偉」等抽象詞語，缺乏細節支撐。', suggestion: '嘗試將抽象形容詞，轉化為具體的細節描寫。', example: '與其說「公園很美」，不如描寫公園裡花朵的顏色、樹木的形態、湖水的波光。' },
            { id: 'des_pro_2', category: '結構與鋪排', type: 'problem', title: '描寫沒有順序', problemCore: '描寫景物時東一句西一句，缺乏觀察順序。', suggestion: '可按固定順序描寫，如「由遠及近」、「由上而下」或「由靜態到動態」。', example: '描寫房間時，可先從門口望進去，再逐一描寫房內的傢俱佈置。' },
            { id: 'des_exc_3', category: '結構與鋪排', type: 'excellent', title: '動靜結合，畫面豐富', strengthSummary: '能將靜態景物與動態景物結合描寫，使畫面更富生氣和活力。', example: '描寫公園時，既寫了靜止的亭台樓閣，也寫了池中游動的錦鯉，一靜一動，相映成趣。'},
            { id: 'des_pro_3', category: '扣題與立意', type: 'problem', title: '只有描寫，沒有中心', problemCore: '文章羅列了大量景物，但沒有一條中心思想或情感線索將其串連。', suggestion: '在描寫景物時，應融入作者的感情或觀點，做到「一切景語皆情語」。', example: '描寫黃昏，除了景色，更可以藉此抒發對時光飛逝的感慨。'}
        ],
        argumentative: [
            { id: 'arg_exc_1', category: '扣題與立意', type: 'excellent', title: '論點清晰，立場鮮明', strengthSummary: '在文章開首已明確提出中心論點，並且全文圍繞此論點展開。', example: '開宗明義指出「我認為中學生不應沉迷手機遊戲」，立場清晰。' },
            { id: 'arg_exc_2', category: '結構與鋪排', type: 'excellent', title: '論證層層遞進', strengthSummary: '論證由淺入深，或由個人層面推及至社會層面，結構嚴謹。', example: '先論證沉迷手機遊戲影響個人學業，再論證影響人際關係，最後推及對社會風氣的影響，層次分明。' },
            { id: 'arg_pro_1', category: '扣題與立意', type: 'problem', title: '論點模糊，立場搖擺', problemCore: '文章沒有明確的中心論點，或在文中不斷轉換立場。', suggestion: '在下筆前，應先確立自己支持或反對的立場，並以此作為全文的中心。', example: '文章一時說勤能補拙，一時又說天分更重要，讓讀者感到混亂。' },
            { id: 'arg_pro_2', category: '取材與刻畫', type: 'problem', title: '論據不足，說服力弱', problemCore: '只有論點，沒有足夠的例子或道理去支持。', suggestion: '每個分論點後，都應配以具體的例證（史例、設例、語例）或道理論證來加強說服力。', example: '提出「合作很重要」的論點後，可引用「三個臭皮匠，勝過一個諸葛亮」的俗語，或舉出球隊合作取勝的例子。' },
            { id: 'arg_exc_3', category: '取材與刻畫', type: 'excellent', title: '論據恰當，具說服力', strengthSummary: '能運用[選項1]等不同類型的論據來支持論點，使論證更堅實有力。', options: '史例\n設例\n語例\n數據', optionsLabel: '論據類型', example: '引用愛迪生發明電燈的史例來論證「堅持」的重要性，非常貼切。'},
            { id: 'arg_pro_3', category: '語言與表達', type: 'problem', title: '議論文語言欠客觀', problemCore: '語言過於情緒化，像在吵架而非說理。', suggestion: '議論文應使用客觀、中性的語言，對事不對人，以理服人。', example: '使用「簡直愚蠢」等詞語攻擊對方觀點，顯得不夠理性。'}
        ],
        common: [
            { id: 'com_exc_1', category: '語言與表達', type: 'excellent', title: '語言流暢', strengthSummary: '文句通順，表達準確，詞彙豐富。', example: '用詞精煉，沒有贅言，閱讀時感覺一氣呵成。' },
            { id: 'com_pro_1', category: '語言與表達', type: 'problem', title: '語句不通', problemCore: '語言欠通順，有病句，影響文意表達。', suggestion: '寫作後宜多讀幾遍，檢查並修正語句不通順之處。', example: '「我的心情十分高興。」（「心情」與「高興」搭配不當）' },
            { id: 'com_pro_2', category: '語言與表達', type: 'problem', title: '用詞單調', problemCore: '詞彙貧乏，用詞重複單調。', suggestion: '可多積累同義詞、近義詞，並在寫作中嘗試替換使用。', example: '全文多次使用「開心」，可用「愉快」、「興奮」、「雀躍」等詞代替。' },
            { id: 'com_pro_3', category: '語言與表達', type: 'problem', title: '字詞標點錯誤', problemCore: '錯別字較多，標點符號運用不當。', suggestion: '需加強對字詞的掌握，並注意標點符號的正確用法。', example: '「的、地、得」不分；一句話結尾沒有句號。' }
        ]
    };
}

function loadCannedCritiquesAndFocus() {
    const selectedGenres = Array.from(document.querySelectorAll('#genre-selection input:checked')).map(cb => cb.value);
    if (selectedGenres.length === 0) {
        alert('請至少選擇一種文章類型。');
        return;
    }

    const critiquesToLoad = new Map();
    const addCritique = (critique) => {
        if (!critiquesToLoad.has(critique.id)) {
            critiquesToLoad.set(critique.id, critique);
        }
    };

    selectedGenres.forEach(genre => {
        if (cannedCritiques[genre]) {
            cannedCritiques[genre].forEach(addCritique);
        }
    });
    cannedCritiques.common.forEach(addCritique);
    
    const finalCritiques = Array.from(critiquesToLoad.values());

    applyCritiquesToDOM(finalCritiques);
    buildChecklist();
    buildOverviewPage();
    isDataDirty = true;
    updateUIBasedOnAuthState();
    alert(`已成功載入 ${finalCritiques.length} 條預設評語！`);
    
    showPage('page2', 'student-select');
}

function resetToDefaultCritiques(showConfirm = true) {
    const action = () => {
        const allDefaultCritiques = Object.values(cannedCritiques).flat();
        const uniqueCritiques = Array.from(new Map(allDefaultCritiques.map(c => [c.id, c])).values());
        applyCritiquesToDOM(uniqueCritiques);
        buildChecklist();
        buildOverviewPage();
        isDataDirty = true;
        updateUIBasedOnAuthState();
        if (showConfirm) alert('評語庫已重設為程式內建的預設評語。');
    };

    if (showConfirm) {
        confirmUI('確定要重設為程式內建的預設評語嗎？這會覆蓋您當前的評語庫。', action);
    } else {
        action();
    }
}

function applyCritiquesToDOM(critiques) {
    const dataContainer = document.getElementById('critique-data');
    dataContainer.innerHTML = '';
    critiques.forEach(c => {
        const div = document.createElement('div');
        div.dataset.id = c.id || c.critique_id;
        div.dataset.category = c.category;
        div.dataset.type = c.type;
        div.dataset.strengthSummary = c.strengthSummary || c.strength_summary || '';
        div.dataset.problemCore = c.problemCore || c.problem_core || '';
        div.dataset.suggestion = c.suggestion || '';
        div.dataset.example = c.example || '';
        div.dataset.options = c.options || '';
        div.dataset.optionsLabel = c.optionsLabel || c.options_label || '';
        div.innerHTML = `<h4>${c.title}</h4>`;
        dataContainer.appendChild(div);
    });
}


// [v19.6] 全域監聽 (修復下拉選單即時更新)
function attachGlobalListeners() {
    // 按鈕監聽
    const loginBtn = document.getElementById('login-btn'); if(loginBtn) loginBtn.addEventListener('click', handleLogin);
    const logoutBtn = document.getElementById('logout-btn'); if(logoutBtn) logoutBtn.addEventListener('click', handleLogout);
    const syncBtn = document.getElementById('sync-btn'); if(syncBtn) syncBtn.addEventListener('click', syncDataToCloud);
    const selProjBtn = document.getElementById('select-project-btn'); if(selProjBtn) selProjBtn.addEventListener('click', promptAndLoadCloudProject);

    // 題目同步
    const syncTopic = (val) => {
        ['topic', 'ai-topic', 'page2-topic-display'].forEach(id => {
            const el = document.getElementById(id);
            if(el && el.value !== val) el.value = val;
        });
        updateHeaderInfo();
        isDataDirty = true;
        updateUIBasedOnAuthState();
    };
    ['topic', 'ai-topic', 'page2-topic-display'].forEach(id => {
        const el = document.getElementById(id);
        if(el) el.addEventListener('input', (e) => syncTopic(e.target.value));
    });

    // 學生下拉選單
    document.getElementById('student-select').addEventListener('change', (e) => loadStudentData(e.target.value));

    // 分數欄位
    ['score-content', 'score-expression', 'score-structure', 'score-punctuation', 'score-typos'].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            el.addEventListener('input', () => calculateTotalScore());
            el.addEventListener('change', (e) => handlePessimisticScoreSave(e.target));
        }
    });

    // 🔥 核心修復：監聽所有變更
    document.body.addEventListener('change', (e) => {
        const page = e.target.closest('.page-content');
        if(!page || page.id !== 'page2') return;

        // A. 下拉選單變更 -> 立即更新文字框
        if (e.target.tagName === 'SELECT' && e.target.closest('.interactive-module')) {
            const moduleDiv = e.target.closest('.interactive-module');
            const critiqueId = moduleDiv.id.replace('module-', '');
            
            // 1. 處理「其他」選項的顯示
            toggleOtherBlock(e.target.id, e.target.value);
            
            // 2. 更新該評語的文字框 (Textarea)
            populateEditableTextarea(critiqueId);
            
            // 3. 更新總評語 (Output)
            updateAllOutputs();
            isDataDirty = true;
            updateUIBasedOnAuthState();
        }

        // B. Checkbox 變更
        if (e.target.matches('input[type="checkbox"]')) {
            handleCheckboxChange(e.target, true);
        }
    });

    // 監聽打字 (Input)
    document.body.addEventListener('input', (e) => {
        const page = e.target.closest('.page-content');
        if(!page) return;
        if (e.target.id && e.target.id.startsWith('score-')) return; // 分數已處理

        // 如果係「其他」輸入框打字，都要更新 Textarea
        if (page.id === 'page2' && e.target.matches('.other-input input')) {
             const moduleDiv = e.target.closest('.interactive-module');
             if(moduleDiv) {
                 const critiqueId = moduleDiv.id.replace('module-', '');
                 populateEditableTextarea(critiqueId);
             }
        }

        triggerAutoSave();
        if (page.id === 'page2') {
            updateAllOutputs();
            isDataDirty = true;
            updateUIBasedOnAuthState();
        }
    });

    // 檔案匯入
    document.getElementById('import-student-list').addEventListener('change', handleStudentListImport);
    document.getElementById('import-progress-excel').addEventListener('change', handleProgressImportExcel);
    document.getElementById('import-critique-excel').addEventListener('change', handleCritiqueImportExcel);
    document.getElementById('import-critique-json').addEventListener('change', handleCritiqueImportJSON);
    bindOverviewEvents();
    initSwipeGestures();
}
/* ===== [v10.3] 雙層導航邏輯 ===== */

/* ========================================= */
/* === [v10.6] 導航與核心顯示邏輯 (JS) === */
/* ========================================= */

// [v11.0] 導航邏輯 (無漢堡版)
function switchMainTab(target) {
    // A. 更新 Main Nav 狀態
    document.querySelectorAll('.main-nav .nav-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.target === target);
    });

    // B. 隱藏所有 Sub Group
    document.querySelectorAll('.sub-nav-group').forEach(grp => {
        grp.style.display = 'none';
    });
    
    // C. 顯示 Sub Nav Container (懸浮島)
    const container = document.getElementById('sub-nav-container');
    
    if (target === 'home') {
        showPage('page-home'); 
        container.style.display = 'none'; // 首頁無需懸浮島
    } else {
        container.style.display = 'flex'; // 顯示懸浮島
        const subGroup = document.getElementById('sub-nav-' + target);
        if (subGroup) {
            subGroup.style.display = 'flex'; // 顯示對應按鈕
        }
    }
}

// showPage 保持 v10.6 版本即可，它已經兼容這種父子結構
// 唯一要刪除的是 toggleMobileMenu 函數，因為按鈕已經沒了

// [v19.0] Show Page (穩定版：移除攔截，保留瀏覽器上一頁功能)
function showPage(pageId, focusElementId = null, pushToHistory = true) {
    // 1. 權限檢查 (Route Guard)
    if (pageId === 'page2') {
        const hasProject = window.currentAssignmentId || (typeof allStudentRecords !== 'undefined' && allStudentRecords.length > 0);
        if (!hasProject) {
            if(typeof showToast === 'function') showToast("⚠️ 請先在首頁選擇或建立作業", "warning");
            pageId = 'page-home'; 
        }
    }

    // 2. 執行轉頁
    document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active'));
    const targetPage = document.getElementById(pageId);
    if(targetPage) targetPage.classList.add('active');

    // 3. 更新導航按鈕狀態
    document.querySelectorAll('.sub-nav-btn').forEach(n => n.classList.remove('active'));
    const subBtn = document.getElementById('nav-' + pageId);
    
    if (subBtn) {
        subBtn.classList.add('active');
        const group = subBtn.closest('.sub-nav-group');
        if(group && typeof switchMainTab === 'function') {
            switchMainTab(group.id.replace('sub-nav-', ''));
        }
    } else if (pageId === 'page-home') {
        document.querySelectorAll('.main-nav .nav-btn').forEach(b => b.classList.remove('active'));
        const homeBtn = document.querySelector('.main-nav .nav-btn[data-target="home"]');
        if(homeBtn) homeBtn.classList.add('active');
        
        const subNav = document.getElementById('sub-nav-container');
        if(subNav) subNav.style.display = 'none';
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // 4. 處理懸浮導覽列 (只在 Page 2 顯示)
    if (typeof autoExpandCurrentSection === 'function') autoExpandCurrentSection();
    const fNav = document.getElementById('floating-nav');
    if(fNav) fNav.classList.toggle('visible', pageId === 'page2');

    // 5. 頁面初始化
    if (pageId === 'page-home') setTimeout(() => { if(typeof loadDashboard === 'function') loadDashboard(); }, 50);
    if (pageId === 'page8') { if(typeof loadAllClasses === 'function') loadAllClasses(); }
    if (pageId === 'page5') { if(typeof renderAnalysisPage === 'function') renderAnalysisPage(); }

    // 6. 自動滾動
    if (focusElementId) {
        setTimeout(() => {
            const el = document.getElementById(focusElementId);
            if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 150);
    }
    
    localStorage.setItem('idw_last_page', pageId);

    // 7. 瀏覽器歷史紀錄
    if (pushToHistory) {
        const state = { pageId: pageId };
        if (window.location.hash !== '#' + pageId) {
            history.pushState(state, '', '#' + pageId);
        }
    }
}

// [v18.11] 攔截彈窗按鈕功能
function forceLeavePage() {
    const modal = document.getElementById('pop-unsaved-guard-modal');
    const targetInput = document.getElementById('guard-target-page');
    
    if(modal) modal.classList.remove('active');
    
    // 重置髒狀態 (因為用戶選擇「直接離開」，代表放棄未儲存更動)
    isDataDirty = false;
    updateUIBasedOnAuthState();
    
    const target = targetInput ? targetInput.value : 'page-home';
    
    // 強制轉頁 (forceBypass = true)
    showPage(target, null, true, true);
}

function stayAndSync() {
    const modal = document.getElementById('pop-unsaved-guard-modal');
    if(modal) modal.classList.remove('active');
    
    // 執行同步
    saveCurrentStudentData('cloud');
}

// [v18.9] 攔截器按鈕功能
function stayAndSync() {
    // 關閉 Modal
    document.getElementById('pop-unsaved-guard-modal').classList.remove('active');
    // 執行同步
    saveCurrentStudentData('cloud');
}

function forceLeavePage() {
    const target = document.getElementById('guard-target-page').value;
    document.getElementById('pop-unsaved-guard-modal').classList.remove('active');
    
    // 重置髒狀態 (因為用戶選擇放棄更改)
    isDataDirty = false;
    updateUIBasedOnAuthState();
    
    // 強制跳轉 (forceBypass = true)
    showPage(target, null, true, true);
}

// 4. 🔥 補回缺失的 buildCardHtml 函數 (修復紅字錯誤)
// 這個函數被 Dashboard 和 Archive 共用
function buildCardHtml(item, uniqueId) {
    const dateStr = new Date(item.last_updated).toLocaleDateString();
    let clickAction = (item.source_type === 'legacy') ? `loadProjectById('${item.id}')` : `openAssignment('${item.id}')`;
    const itemSafe = JSON.stringify(item).replace(/"/g, '&quot;');

    return `
    <div class="cozy-folder" onclick="${clickAction}">
        <div style="position:absolute; top:15px; right:15px;" onclick="event.stopPropagation();">
            <button onclick="openEditModal(${itemSafe})" style="background:transparent; border:none; color:#ddd; cursor:pointer; font-size:1.1rem; padding:5px;">⚙️</button>
        </div>
        <div class="folder-meta">
            <span class="folder-class">${escapeHtml(item.class_name)}</span>
            <div class="folder-title">${escapeHtml(item.topic)}</div>
        </div>
        <div class="folder-stats">
            <span>📅 ${dateStr}</span>
            <span class="folder-progress-pill">${item.progress}% 完成</span>
        </div>
    </div>`;
}

// 2. 擴充 showPage (兼容新導航)
// 請將這段邏輯整合進原本的 showPage 函數，或者將原本 showPage 替換為此版本
// 建議：手動修改原本 showPage，加入 Sub-nav 的 active 狀態更新

/* 
修改指引：
在原本 showPage(pageId) 裡面，搵到 "更新導航按鈕狀態" 嗰幾行，改成：
*/
/*
  // 更新 Sub Nav 按鈕狀態
  document.querySelectorAll('.sub-nav-btn').forEach(n => n.classList.remove('active'));
  const subBtn = document.getElementById('nav-' + pageId);
  if(subBtn) {
      subBtn.classList.add('active');
      
      // 反向激活 Main Tab (例如我在 Page 2，Workplace Tab 應該要著燈)
      const parentGroup = subBtn.closest('.sub-nav-group');
      if (parentGroup) {
          const groupId = parentGroup.id.replace('sub-nav-', '');
          document.querySelectorAll('.main-nav .nav-btn').forEach(btn => {
              btn.classList.toggle('active', btn.dataset.target === groupId);
          });
          // 確保該組 Sub Nav 係顯示嘅
          document.querySelectorAll('.sub-nav-group').forEach(g => g.style.display = 'none');
          parentGroup.style.display = 'flex';
          document.getElementById('sub-nav-container').style.display = 'flex';
      }
  } else if (pageId === 'page-home') {
      // 確保 Home Tab 著燈
      document.querySelectorAll('.main-nav .nav-btn').forEach(btn => {
          btn.classList.toggle('active', btn.dataset.target === 'home');
      });
      document.getElementById('sub-nav-container').style.display = 'none';
  }
*/

// 3. 手機版漢堡選單切換
function toggleMobileMenu() {
    document.querySelector('.page-nav-wrapper').classList.toggle('mobile-active');
}

/* === 手機 Swipe 手勢偵測功能 (增強版：顯示名 + 自動滾動) === */
function initSwipeGestures() {
  const targetArea = document.getElementById('page2'); // 只在批改頁生效
  if (!targetArea) return;

  let touchStartX = 0;
  let touchStartY = 0;
  let touchEndX = 0;
  let touchEndY = 0;

  // 1. 手指掂到螢幕
  targetArea.addEventListener('touchstart', function(e) {
    touchStartX = e.changedTouches[0].screenX;
    touchStartY = e.changedTouches[0].screenY;
  }, {passive: true});

  // 2. 手指離開螢幕
  targetArea.addEventListener('touchend', function(e) {
    touchEndX = e.changedTouches[0].screenX;
    touchEndY = e.changedTouches[0].screenY;
    handleSwipeGesture();
  }, {passive: true});

  function handleSwipeGesture() {
    const diffX = touchEndX - touchStartX;
    const diffY = touchEndY - touchStartY;
    const threshold = window.innerWidth * 0.5

    // 邏輯：橫向移動距離 > 直向移動 && 移動距離夠長
    if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > threshold) {
      
      let direction = '';
      let actionName = '';
      let icon = '';

      if (diffX < 0) {
        // 向左掃 -> 下一位
        direction = 'next';
        actionName = '下一位';
        icon = '⏩';
      } else {
        // 向右掃 -> 上一位
        direction = 'prev';
        actionName = '上一位';
        icon = '⏪';
      }

      // 1. 執行切換
      navigateToStudent(direction);

      // 2. 獲取切換後的學生姓名
      const selectElement = document.getElementById('student-select');
      const currentStudentName = selectElement.options[selectElement.selectedIndex].text;

      // 3. 顯示 Toast 通知
      if (typeof showToast === 'function') {
        showToast(`${icon} ${actionName}：${currentStudentName}`, 'info');
      }

      // 4. 自動滾動到「評語項目選擇」區域
      // 使用 setTimeout 確保畫面渲染完先滑動，感覺更順暢
      setTimeout(() => {
          scrollToSection(new Event('dummy'), 'grading-section-checklist');
      }, 50);
    }
  }
}

// [v12.1] Setting 選單開關 (支援 Fixed Positioning)
function toggleSettingsMenu() {
    const menu = document.getElementById('settings-dropdown');
    if (!menu) return;

    // 獲取按鈕位置 (如果是 Desktop)
    const btn = document.querySelector('.header-right .font-control-btn');
    
    if (menu.style.display === 'none' || menu.style.display === '') {
        menu.style.display = 'block';
        
        // 電腦版動態定位 (對齊按鈕)
        if (window.innerWidth > 768 && btn) {
            const rect = btn.getBoundingClientRect();
            menu.style.top = (rect.bottom + 10) + 'px';
            menu.style.right = (window.innerWidth - rect.right) + 'px';
            menu.style.left = 'auto';
        }
    } else {
        menu.style.display = 'none';
    }
}

// 點擊空白處關閉 (保持不變，但確保能抓到 fixed 元素)
document.addEventListener('click', (e) => {
    const menu = document.getElementById('settings-dropdown');
    const btn = document.querySelector('.font-control-btn');
    
    // 檢查是否點擊了 Menu 內部或按鈕
    if (menu && menu.style.display === 'block') {
        if (!menu.contains(e.target) && !btn.contains(e.target)) {
            menu.style.display = 'none';
        }
    }
});

// 視窗縮放時關閉 Menu (防止位置錯亂)
window.addEventListener('resize', () => {
    const menu = document.getElementById('settings-dropdown');
    if (menu) menu.style.display = 'none';
});

// 點擊空白處關閉選單
document.addEventListener('click', (e) => {
    const menu = document.getElementById('settings-dropdown');
    const btn = document.querySelector('.font-control-btn'); // 齒輪掣
    
    // 如果點擊目標唔係 Menu 本身，又唔係個掣，就關閉
    if (menu && menu.style.display === 'block' && !menu.contains(e.target) && !btn.contains(e.target)) {
        menu.style.display = 'none';
    }
});



// [v19.2] 評語清單渲染 (支援即時編輯監聽)
function buildChecklist() {
    const dataContainer = document.getElementById('critique-data');
    const checklistContainer = document.getElementById('checklist-container');
    
    // 狀態備份
    const checkedStates = {}; const editedTexts = {};
    document.querySelectorAll('#checklist-container input[type="checkbox"]').forEach(cb => { 
        checkedStates[cb.id] = cb.checked; 
        if(cb.checked) { const ta = document.getElementById(`text-${cb.id}`); if(ta) editedTexts[cb.id] = ta.value; } 
    });

    checklistContainer.innerHTML = '';
    const currentCategories = {};
    let hasItems = false;

    dataContainer.querySelectorAll('div[data-id]').forEach(el => {
        hasItems = true;
        const cat = el.dataset.category || '未分類';
        if (!currentCategories[cat]) currentCategories[cat] = [];
        currentCategories[cat].push(el);
    });

    if (hasItems) {
        checklistContainer.style.display = 'grid';
        checklistContainer.className = '';
        
        const sortedCats = Object.keys(currentCategories).sort((a,b) => {
            const idxA = CATEGORY_ORDER.indexOf(a), idxB = CATEGORY_ORDER.indexOf(b);
            if (idxA > -1 && idxB > -1) return idxA - idxB;
            return idxA > -1 ? -1 : (idxB > -1 ? 1 : a.localeCompare(b));
        });

        for (const catName of sortedCats) {
            const details = document.createElement('details');
            details.className = 'category-group'; details.open = true;
            details.innerHTML = `<summary><div style="display:flex;align-items:center;gap:10px;width:100%;"><h3>${escapeHtml(catName)}</h3><button class="light-btn" style="padding:2px 8px;font-size:0.8rem;border-radius:99px;" onclick="event.preventDefault();openInstantAdd('${escapeHtmlAttr(catName)}')">+ 新增</button></div></summary>`;
            const content = document.createElement('div'); content.className = 'category-content';
            
            currentCategories[catName].forEach(el => {
                const id = el.dataset.id;
                const type = el.dataset.type;
                const title = el.querySelector('h4').textContent;
                const hasOptions = (el.dataset.options || '').trim() !== '';
                
                const itemDiv = document.createElement('div');
                itemDiv.className = `check-item ${type==='problem'?'is-problem':'is-excellent'}`;
                
                itemDiv.innerHTML = `<div class="check-item-header"><input type="checkbox" id="${id}"><label for="${id}">${title}</label></div>`;
                if (hasOptions) itemDiv.appendChild(createInteractiveModule(id));
                
                // 編輯區 (預覽與修改)
                const editDiv = document.createElement('div'); 
                editDiv.className = 'editable-comment';
                // 🔥 加入 oninput 事件，打字即觸發更新
                editDiv.innerHTML = `<textarea id="text-${id}" placeholder="點擊此處編輯評語內容..." oninput="updateAllOutputs(); isDataDirty=true; updateUIBasedOnAuthState();"></textarea>`;
                
                itemDiv.appendChild(editDiv);
                content.appendChild(itemDiv);
                
                if (checkedStates[id]) {
                    const cb = itemDiv.querySelector('input'); cb.checked = true;
                    if(hasOptions) itemDiv.querySelector('.interactive-module').style.display = 'block';
                    editDiv.style.display = 'block';
                    const ta = editDiv.querySelector('textarea');
                    // 如果有舊輸入，優先還原
                    if(ta && editedTexts[id]) ta.value = editedTexts[id];
                    // 如果冇舊輸入，產生預設內容
                    else if(ta) ta.value = composeStudentFromConcise(id);
                }
            });
            details.appendChild(content);
            checklistContainer.appendChild(details);
        }
    } else {
        checklistContainer.style.display = 'block';
        checklistContainer.innerHTML = `
            <div class="rescue-card">
                <div class="rescue-title">尚未有評語項目</div>
                <div class="rescue-desc">請選擇載入方式：</div>
                <div class="rescue-grid">
                    <div class="rescue-btn" onclick="quickLoadPresets()">
                        <div class="rescue-icon">📚</div>
                        <div class="rescue-label">載入預設</div>
                    </div>
                    <div class="rescue-btn" onclick="showPage('page6')">
                        <div class="rescue-icon">✨</div>
                        <div class="rescue-label">AI 生成</div>
                    </div>
                    <div class="rescue-btn" onclick="showPage('page3')">
                        <div class="rescue-icon">✍️</div>
                        <div class="rescue-label">手動新增</div>
                    </div>
                </div>
            </div>
        `;
    }
}

// [Phase 3] 打開新增評語 Modal
function openInstantAdd(category) {
    document.getElementById('instant-add-category-display').textContent = `分類：${category}`;
    document.getElementById('instant-add-category-val').value = category;
    document.getElementById('instant-add-title').value = '';
    document.getElementById('pop-instant-add-modal').classList.add('active');
    setTimeout(() => document.getElementById('instant-add-title').focus(), 100);
}

/* [v11.3] 快速新增邏輯 (完整欄位版) */

// 切換欄位顯示 (優點 vs 問題)
function toggleInstantAddFields() {
    const type = document.querySelector('input[name="instant-add-type"]:checked').value;
    const divExc = document.getElementById('instant-field-excellent');
    const divProb = document.getElementById('instant-field-problem');
    
    if (type === 'excellent') {
        divExc.style.display = 'block';
        divProb.style.display = 'none';
    } else {
        divExc.style.display = 'none';
        divProb.style.display = 'block';
    }
}

// 儲存並應用
async function saveInstantCritique() {
    const title = document.getElementById('instant-add-title').value.trim();
    const category = document.getElementById('instant-add-category-val').value;
    const type = document.querySelector('input[name="instant-add-type"]:checked').value;
    
    // 獲取詳細欄位
    const strength = document.getElementById('instant-add-strength').value.trim();
    const problem = document.getElementById('instant-add-problem').value.trim();
    const suggestion = document.getElementById('instant-add-suggestion').value.trim();
    const example = document.getElementById('instant-add-example').value.trim();
    const optionsLabel = document.getElementById('instant-add-options-label').value.trim();
    const options = document.getElementById('instant-add-options').value.trim();

    if (!title) { alert("請輸入標題"); return; }

    const id = 'manual_' + Date.now();
    
    // 1. 建立 DOM 元素 (包含所有 dataset)
    const newDiv = document.createElement('div');
    newDiv.dataset.id = id;
    newDiv.dataset.category = category;
    newDiv.dataset.type = type;
    newDiv.dataset.title = title;
    
    // 寫入詳細資料
    if(type === 'excellent') newDiv.dataset.strengthSummary = strength;
    if(type === 'problem') {
        newDiv.dataset.problemCore = problem;
        newDiv.dataset.suggestion = suggestion;
    }
    newDiv.dataset.example = example;
    newDiv.dataset.optionsLabel = optionsLabel;
    newDiv.dataset.options = options;

    newDiv.innerHTML = `<h4>${title}</h4>`;
    document.getElementById('critique-data').appendChild(newDiv);

    // 2. 刷新介面
    buildChecklist();

    // 3. 自動勾選
    const checkbox = document.getElementById(id);
    if (checkbox) {
        checkbox.checked = true;
        handleCheckboxChange(checkbox);
        
        setTimeout(() => {
            checkbox.closest('.check-item').scrollIntoView({ behavior: 'smooth', block: 'center' });
            checkbox.closest('.check-item').style.backgroundColor = '#fff9c4';
            setTimeout(() => { checkbox.closest('.check-item').style.backgroundColor = ''; }, 800);
        }, 100);
    }

    // 4. 關閉
    document.getElementById('pop-instant-add-modal').classList.remove('active');
    
    // 5. 觸發儲存
    isDataDirty = true;
    updateUIBasedOnAuthState();
    if(typeof showToast === 'function') showToast("已新增並選取！", "success");
}

// [Pro-v9.5] 快速載入預設 (Rescue Action)
function quickLoadPresets() {
    // 這裡我們用回你現在最穩陣的 "Pop Art 彈窗" (Step 1.5 版)
    // 雖然 CSS 係 Step 1.5，但結構係一樣的
    
    // 1. 建立選項內容
    const optionsHtml = `
        <div style="text-align:left; padding:10px;">
            <label class="pop-list-item"><input type="checkbox" class="preset-cb" value="narrative" checked> 📝 記敘文套裝</label>
            <label class="pop-list-item"><input type="checkbox" class="preset-cb" value="lyrical"> ❤️ 抒情文套裝</label>
            <label class="pop-list-item"><input type="checkbox" class="preset-cb" value="descriptive"> 🖼️ 描寫文套裝</label>
            <label class="pop-list-item"><input type="checkbox" class="preset-cb" value="argumentative"> 🗣️ 議論文套裝</label>
            <label class="pop-list-item"><input type="checkbox" class="preset-cb" value="common" checked> 🔧 通用評語 (語法/標點)</label>
        </div>
    `;

    // 2. 借用 Generic Modal 顯示
    const modal = document.getElementById('pop-generic-modal');
    const titleEl = document.getElementById('pop-generic-title');
    const descEl = document.getElementById('pop-generic-desc');
    const inputContainer = document.getElementById('pop-generic-input-container');
    const confirmBtn = document.getElementById('pop-generic-confirm');
    const cancelBtn = document.getElementById('pop-generic-cancel');

    // 設定內容
    document.getElementById('pop-generic-icon').textContent = '📥';
    titleEl.textContent = '載入預設評語';
    descEl.textContent = '請勾選您需要的評語類型：';
    
    // 插入選項
    inputContainer.style.display = 'block';
    inputContainer.innerHTML = optionsHtml; // 替換原本的 input

    modal.classList.add('active');

    // 綁定確認按鈕
    confirmBtn.onclick = () => {
        const selected = Array.from(inputContainer.querySelectorAll('.preset-cb:checked')).map(cb => cb.value);
        
        if (selected.length === 0) {
            alert("請至少選擇一項！");
            return;
        }

        // 載入邏輯
        const critiquesToLoad = new Map();
        selected.forEach(genre => {
            if (cannedCritiques[genre]) {
                cannedCritiques[genre].forEach(c => critiquesToLoad.set(c.id, c));
            }
        });

        // 轉成 Array 並寫入
        const finalCritiques = Array.from(critiquesToLoad.values());
        applyCritiquesToDOM(finalCritiques);
        buildChecklist(); // 重繪介面，這時 Rescue Card 會消失，變回 Checklist
        
        // 恢復 Modal 原狀 (以防影響其他功能)
        inputContainer.innerHTML = '<input type="text" id="pop-generic-input" class="pop-input">';
        modal.classList.remove('active');
        
        if(typeof showToast === 'function') showToast(`已載入 ${finalCritiques.length} 條評語`, "success");
    };

    // 綁定取消按鈕
    cancelBtn.onclick = () => {
        inputContainer.innerHTML = '<input type="text" id="pop-generic-input" class="pop-input">';
        modal.classList.remove('active');
    };
}

function createInteractiveModule(id) {
  const moduleDiv = document.createElement('div');
  moduleDiv.id = `module-${id}`;
  moduleDiv.className = 'interactive-module';
  
  const critiqueEl = document.querySelector(`#critique-data div[data-id="${id}"]`);
  const optionsSets = (critiqueEl.dataset.options || '').split('|');
  const labels = (critiqueEl.dataset.optionsLabel || '').split('|');

  let content = '';
  optionsSets.forEach((optionsStr, index) => {
    const optionLines = optionsStr.trim().split('\n').map(s => s.trim()).filter(Boolean);
    if (optionLines.length === 0) return;

    const labelText = labels[index] || `請選擇 ${index + 1}：`;
    const selectId = `${id}-select-${index + 1}`;
    const otherId = `${id}-other-${index + 1}`;

    function ensureOther(list) {
      return list.includes('其他') ? list : [...list, '其他'];
    }
    const list = ensureOther(optionLines);
    
    content += `<div class="module-row">
      <label>${labelText}</label>
      <select id="${selectId}">
        <option value=""></option>
        ${list.map(o => `<option value="${o}">${o}</option>`).join('')}
      </select>
    </div>
    <div class="module-row other-input" id="${otherId}" style="display:none;">
      <input type="text" id="${otherId}-text" placeholder="請輸入其他內容">
    </div>`;
  });

  moduleDiv.innerHTML = content;
  return moduleDiv;
}

function getCritiqueOptions(id) {
  const el = document.querySelector(`#critique-data div[data-id="${id}"]`);
  const raw = el?.dataset.options || '';
  if (!raw) return null;
  return raw.split('|')[0].split('\n').map(s=>s.trim()).filter(Boolean);
}

function populateEditableTextarea(id) {
  const textarea = document.getElementById(`text-${id}`);
  if (!textarea) return;
  textarea.value = composeStudentFromConcise(id);
}

function concretizeExample(id, rawExample) {
  const trimmed = (rawExample || '').trim();
  if (!trimmed) return [];
  let lines = trimmed.split('\n').map(s=>s.trim()).filter(Boolean);
  return lines.slice(0, 2);
}

// ============================================================
// [Pro-v9.9.4] 學生名單與狀態渲染系統 (嚴格狀態版)
// ============================================================

/* [v17.2] 姓名解析器 (純學號支援) */
function parseStudentName(rawName) {
    if (!rawName) return { number: null, name: '', originalName: '' };
    // 移除所有裝飾符號
    let cleanRaw = rawName.replace(/[✅⚪💾]/g, '').trim();
    
    // 1. 標準格式： "01 陳大文" 或 "01-陳大文"
    // 只要開頭是數字，後面跟著非數字
    const match = cleanRaw.match(/^(\d+)[-\s._]+(.*)$/);
    if (match) {
        return { number: parseInt(match[1], 10), name: match[2].trim(), originalName: cleanRaw };
    }
    
    // 2. 純數字格式： "23"
    // 如果整串都是數字
    if (/^\d+$/.test(cleanRaw)) {
        return { 
            number: parseInt(cleanRaw, 10), 
            name: cleanRaw, // 名字就是學號 (e.g. "23")
            originalName: cleanRaw 
        };
    }

    // 3. 純文字格式： "陳大文"
    return { number: null, name: cleanRaw, originalName: cleanRaw };
}


/* [v17.3] 學生選單 (學號修復 + 去重 Emoji) */
function updateStudentDropdown() {
    const namesText = document.getElementById('student-names').value;
    const studentSelect = document.getElementById('student-select');

    // 1. 解析名單
    let parsedNames = namesText.split('\n')
        .map(name => parseStudentName(name))
        .filter(p => p.originalName); // 只要有野就留

    sortStudents(parsedNames);

    // 2. 同步全域變數
    const oldRecords = [...allStudentRecords];
    allStudentRecords = parsedNames.map(p => {
        const existing = oldRecords.find(r => r.originalName === p.originalName);
        return existing || { ...p, data: null, dbId: existing?.dbId || null };
    });

    // 3. 渲染
    const currentSelected = studentSelect.value;
    studentSelect.innerHTML = parsedNames.length === 0 ? '<option value="">請先在上方輸入學生名單</option>' : '';

    let newSelectionExists = false;

    parsedNames.forEach(p => {
        const record = allStudentRecords.find(r => r.originalName === p.originalName);
        const option = document.createElement('option');
        
        // Value 保持原始字串 (這是 Key)
        option.value = p.originalName;

        // --- 狀態 Icon 邏輯 ---
        let icon = '⚪'; 
        let statusColor = '';
        let isBold = false;

        if (record && record.data) {
            const hasScore = record.data.scores && record.data.scores.total;
            const hasComment = record.data.pureStudentComment;
            if (hasScore || hasComment) {
                if (record.dbId) { icon = '✅'; statusColor = '#2e7d32'; isBold = true; }
                else { icon = '💾'; statusColor = '#f57f17'; }
            }
        }

        // --- 顯示名稱邏輯 (學號修復) ---
        let displayName = p.name;
        // 如果名字純數字，或者同 number 一樣，即係冇名
        if (!p.name || p.name == p.number) {
            displayName = `(學號 ${p.number})`;
        } else if (p.number !== null) {
            const paddedNum = p.number.toString().padStart(2, '0');
            displayName = `${paddedNum} ${p.name}`;
        }

        // 🔥 去除舊 Emoji (防止 ✅ ✅ 陳大文)
        displayName = displayName.replace(/[✅⚪💾]/g, '').trim();

        // 組合
        option.textContent = `${icon} ${displayName}`;
        if(statusColor) option.style.color = statusColor;
        if(isBold) option.style.fontWeight = 'bold';

        studentSelect.appendChild(option);

        if (p.originalName === currentSelected) newSelectionExists = true;
    });

    if (newSelectionExists) {
        studentSelect.value = currentSelected;
    } else if (studentSelect.options.length > 0) {
        studentSelect.selectedIndex = 0;
        loadStudentData(studentSelect.value);
    }

    updateAllOutputs();
    renderStudentOverviewTable();
    updateHeaderInfo();
}


function toggleOtherBlock(selectId, value) {
  const otherBlockId = selectId.replace('-select-', '-other-');
  const block = document.getElementById(otherBlockId);
  if (!block) return;
  block.style.display = (value === '其他' || value === 'other') ? 'flex' : 'none';
  if (value !== '其他' && value !== 'other') {
    const input = document.getElementById(`${otherBlockId}-text`);
    if (input) input.value = '';
  }
}

function calculateTotalScore() {
  const content = parseFloat(document.getElementById('score-content').value) || 0;
  const expression = parseFloat(document.getElementById('score-expression').value) || 0;
  const structure = parseFloat(document.getElementById('score-structure').value) || 0;
  const punctuation = parseFloat(document.getElementById('score-punctuation').value) || 0;
  const typos = parseFloat(document.getElementById('score-typos').value) || 0;

  const total = (content * 4) + (expression * 3) + (structure * 2) + (punctuation * 1) + typos;
  document.getElementById('score-total').value = total;
  return total;
}

// [v19.9] Checkbox 邏輯 (確保清空後再點選能顯示)
function handleCheckboxChange(checkbox, doUpdate = true) {
  const isChecked = checkbox.checked;
  const checkItem = checkbox.closest('.check-item');
  
  if (!checkItem) return;

  const interactiveModule = checkItem.querySelector('.interactive-module');
  const editableComment = checkItem.querySelector('.editable-comment');

  // 強制設定 display style
  if (interactiveModule) {
      interactiveModule.style.display = isChecked ? 'block' : 'none';
  }
  
  if (editableComment) {
      editableComment.style.display = isChecked ? 'block' : 'none';
      
      if (isChecked) {
          const textarea = editableComment.querySelector('textarea');
          // 如果 Textarea 是空的，自動填入預設內容
          if (textarea && !textarea.value.trim()) {
              textarea.value = composeStudentFromConcise(checkbox.id);
          }
      }
  }

  if (doUpdate) updateAllOutputs();
}

function getCritiqueData(id, type) {
  const critiqueEl = document.querySelector(`#critique-data div[data-id="${id}"]`);
  if (!critiqueEl) return '';
  switch (type) {
    case 'title': return critiqueEl.querySelector('h4')?.textContent || critiqueEl.dataset.title || '';
    default: return '';
  }
}

function getConciseData(id) {
  const el = document.querySelector(`#critique-data div[data-id="${id}"]`);
  if (!el) return null;
  return {
    problemCore: el.dataset.problemCore || '',
    suggestion: el.dataset.suggestion || '',
    strengthSummary: el.dataset.strengthSummary || '',
    example: el.dataset.example || ''
  };
}

function performInteractiveReplacements(text, critiqueId) {
    let replacedText = text;
    const module = document.getElementById(`module-${critiqueId}`);
    if (!module) return replacedText;

    const selects = module.querySelectorAll('select');
    selects.forEach((select, index) => {
        const placeholder = `[選項${index + 1}]`;
        let value = select.value;
        if (value === '其他') {
            const otherInput = document.getElementById(`${critiqueId}-other-${index + 1}-text`);
            value = otherInput ? otherInput.value.trim() : '';
        }
        if (value) {
            replacedText = replacedText.replace(placeholder, `「${value}」`);
        } else {
            const label = select.previousElementSibling?.textContent || `選項${index + 1}`;
            replacedText = replacedText.replace(placeholder, `[${label}]`);
        }
    });
    return replacedText;
}

function buildTypoSectionRaw(typosList) {
  const list = Array.isArray(typosList) ? typosList : currentTypos;
  if (!list.length) return [];
  return list.map((t, idx) => {
    const wrong = t.wrong ? `「${t.wrong}」` : '';
    const correct = t.correct ? `「${t.correct}」` : '「（未填正字）」';
    return `${idx + 1}. ${wrong}→${correct}`;
  });
}

function buildTypoSection(isStudent = false, typosList = null) {
  const rawLines = buildTypoSectionRaw(typosList);
  if (!rawLines.length) return '';
  const header = isStudent ? '【✏️錯別字】' : '【錯別字】';
  const body = (isStudent ? rawLines.map(s => `- ${s}`) : rawLines).join('\n');
  return [header, body].filter(s => s && s.trim()).join('\n');
}

function normalizeSpacing(text) {
  if (!text) return '';
  let t = text.split('\n').map(s=>s.replace(/\s+$/,'')).join('\n').trim();
  t = t.replace(/\n{3,}/g, '\n\n');
  return t.replace(/^\n+/, '').replace(/\n+$/, '');
}

function toFullWidthPunctuation(str) {
    if (typeof str !== 'string') return str;
    const map = { ',': '，', '.': '。', '?': '？', '!': '！', ':': '：', ';': '；', '(': '（', ')': '）', '[': '【', ']': '】' };
    return str.replace(/[[],.?_!:]/g, m => map[m] || m);
}

function updateAllOutputs() {
  const getVal = (id) => { const el = document.getElementById(id); return el ? el.value : ''; };

  const scores = {
    content: getVal('score-content'),
    expression: getVal('score-expression'),
    structure: getVal('score-structure'),
    punctuation: getVal('score-punctuation'),
    typos: getVal('score-typos'),
    total: getVal('score-total'),
  };

  let scoreSummaryText = '';
  if (Object.values(scores).some(v => v)) {
    scoreSummaryText = `【📝評分】\n內容：${scores.content||'-'} | 表達：${scores.expression||'-'} | 結構：${scores.structure||'-'} | 標點：${scores.punctuation||'-'} | 錯別字：${scores.typos||'-'}\n總分：${scores.total||'-'}`;
  }

  const excellentCritiques = [], problemCritiques = [];
  document.querySelectorAll('#checklist-container input[type="checkbox"]:checked').forEach(cb => {
    const el = document.querySelector(`#critique-data div[data-id="${cb.id}"]`);
    if (el) {
        if (el.dataset.type === 'excellent') excellentCritiques.push({ id: cb.id });
        else problemCritiques.push({ id: cb.id });
    }
  });

  const sClass = getVal('student-class');
  const topic = getVal('topic');
  const sName = getVal('student-select');
  const uComm = getVal('unique-comment');

  if (typeof generateFullVersion === 'function') 
      generateFullVersion(sClass, sName, topic, uComm, excellentCritiques, problemCritiques, scoreSummaryText, buildTypoSection(false));
  
  if (typeof generateStudentReport === 'function') 
      generateStudentReport(sClass, sName, topic, uComm, excellentCritiques, problemCritiques, scoreSummaryText, buildTypoSection(true));
}
function generatePureFullVersion(excellents, problems) {
  let parts = [];
  if (excellents.length > 0) {
    parts.push('【優點】');
    excellents.forEach((c, i) => {
      const concise = getConciseData(c.id);
      if (!concise) return;
      let summary = performInteractiveReplacements(concise.strengthSummary || '', c.id);
      const examples = concretizeExample(c.id, concise.example).join(' ');
      parts.push(`（${i+1}）${getCritiqueData(c.id, 'title')}\n${summary}\n${examples ? `例如：${examples}` : ''}`.trim());
    });
  }
  if (problems.length > 0) {
    parts.push('', '【待改進】');
    problems.forEach((c, i) => {
      const concise = getConciseData(c.id);
      if (!concise) return;
      let problemText = performInteractiveReplacements(concise.problemCore || '', c.id);
      let suggestion = performInteractiveReplacements(concise.suggestion || '', c.id);
      const examples = concretizeExample(c.id, concise.example).join(' ');
      parts.push(`（${i+1}）\n問題：${problemText}\n宜：${suggestion}\n${examples ? `例如，${examples}` : ''}`.trim());
    });
  }
  return toFullWidthPunctuation(normalizeSpacing(parts.join('\n\n')));
}

function generatePureStudentReport(excellents, problems) {
  let out = [];
  if (excellents.length > 0) {
    out.push('【😎做得好】');
    excellents.forEach((c, index) => {
      const ta = document.getElementById(`text-${c.id}`);
      out.push(`(${index + 1}) ${(ta && ta.value) ? ta.value : composeStudentFromConcise(c.id)}`);
    });
  }
  if (problems.length > 0) {
    out.push('', '【😥待改進】');
    problems.forEach((c, index) => {
      const ta = document.getElementById(`text-${c.id}`);
      out.push(`(${index + 1}) ${(ta && ta.value) ? ta.value : composeStudentFromConcise(c.id)}`);
    });
  }
  return toFullWidthPunctuation(normalizeSpacing(out.join('\n')));
}

function generateFullVersion(studentClass, student, topic, unique, excellents, problems, score, typoTextFullRaw) {
  const ta = document.getElementById('full-output');
  if (ta?.dataset.userEditing) return;
  let parts = [`班別：${studentClass || 'N/A'}`, `學生：${student || 'N/A'}`, `題目：${topic || 'N/A'}`];
  if (unique) parts.push('', '【特別留言】', unique);
  const pureComment = generatePureFullVersion(excellents, problems);
  if(pureComment) parts.push('', pureComment);
  if (typoTextFullRaw) parts.push('', typoTextFullRaw);
  if (score) parts.push('', score);
  ta.value = toFullWidthPunctuation(normalizeSpacing(parts.join('\n')));
}

function generateStudentReport(studentClass, student, topic, unique, excellents, problems, scoreTextRaw, typoTextRaw) {
  const ta = document.getElementById('student-report-output');
  if (ta?.dataset.userEditing) return;
  let out = [`班別：${studentClass || 'N/A'}`, `學生：${student || 'N/A'}`, `題目：${topic || 'N/A'}`];
  if (unique) out.push('', '【特別留言】', unique);
  const pureComment = generatePureStudentReport(excellents, problems);
  if(pureComment) out.push('', pureComment);
if (typoTextRaw) out.push('', typoTextRaw);
  if (scoreTextRaw) out.push('', scoreTextRaw);
  ta.value = toFullWidthPunctuation(normalizeSpacing(out.join('\n')));
}

function composeStudentFromConcise(id) {
  const c = getConciseData(id);
  if (!c) return '';
  const isExcellent = document.querySelector(`#critique-data div[data-id="${id}"]`)?.dataset.type === 'excellent';
  const exampleLines = concretizeExample(id, c.example);
  const parts = [`${getCritiqueData(id, 'title')}`];
  
  if (isExcellent) {
    let summary = performInteractiveReplacements(c.strengthSummary || '', id);
    if (summary) parts.push(`- 優點：${summary}`);
    exampleLines.forEach(line => parts.push(`- ${line}`));
  } else {
    let problem = performInteractiveReplacements(c.problemCore || '', id);
    if (problem) parts.push(`- 問題：${problem}`);
    let suggestion = performInteractiveReplacements(c.suggestion || '', id);
    if (suggestion) parts.push(`- 宜：${suggestion}`);
    exampleLines.forEach(line => parts.push(`- 例：${line}`));
  }
  return parts.join('\n');
}

function copyOutput(textareaId, buttonElement) {
  const textarea = document.getElementById(textareaId);
  if (!textarea.value) return;
  textarea.select();
  navigator.clipboard.writeText(textarea.value).then(() => {
    notifyCopySuccess(buttonElement, "已複製");
  }).catch(() => {
    try { document.execCommand('copy'); notifyCopySuccess(buttonElement, "已複製"); } catch (e) { notifyCopySuccess(buttonElement, "複製失敗"); }
  });
}

function notifyCopySuccess(buttonElement, message) {
  const originalText = buttonElement.innerText;
  buttonElement.innerText = message;
  buttonElement.classList.add('copied');
  setTimeout(() => {
    buttonElement.innerText = originalText;
    buttonElement.classList.remove('copied');
  }, 2000);
}

function addTypo() {
  const wrong = (document.getElementById('typo-wrong').value || '').trim();
  const correct = (document.getElementById('typo-correct').value || '').trim();
  if (!correct) return;
  currentTypos.push({ wrong, correct });
  document.getElementById('typo-wrong').value = '';
  document.getElementById('typo-correct').value = '';
  renderTypoList();
  renderCommonTyposCheckedState();
  updateAllOutputs();
  isDataDirty = true;
  updateUIBasedOnAuthState();
}

function removeTypo(idx) {
  currentTypos.splice(idx, 1);
  renderTypoList();
  renderCommonTyposCheckedState();
  updateAllOutputs();
  isDataDirty = true;
  updateUIBasedOnAuthState();
}

function renderTypoList() {
  const ul = document.getElementById('typo-list');
  if (!ul) return;
  ul.innerHTML = '';
  currentTypos.forEach((t, i) => {
    const wrongPart = t.wrong ? `「${t.wrong}」` : '';
    const li = document.createElement('li');
    li.style.cssText = 'display:flex; gap:8px; align-items:center; padding:6px 10px; background:#f9f9fb; border:1px solid #eee; border-radius:6px; margin-bottom:8px;';
    li.innerHTML = `
      <span style="flex:1;">本次： ${wrongPart}→「${t.correct || '（未填正字）'}」</span>
      <button class="action-btn" style="background:var(--btn-brown-bg); padding:6px 10px; border-radius:4px;" onclick="savePairIfNotInCommon(${i})">加入常見庫</button>
      <button class="action-btn" style="background:#c86a5a; padding:6px 10px; border-radius:4px;" onclick="removeTypo(${i})">刪除</button>
    `;
    ul.appendChild(li);
  });
}

function savePairIfNotInCommon(idx) {
  const pair = currentTypos[idx];
  if (!pair) return;
  if (!commonTypos.some(t => t.wrong === pair.wrong && t.correct === pair.correct) && pair.correct) {
    commonTypos.push({ id: `c_${Date.now()}_${Math.random().toString(36).slice(2,7)}`, wrong: pair.wrong, correct: pair.correct });
    isDataDirty = true;
    updateUIBasedOnAuthState();
    renderCommonTypoList();
  } else {
    renderCommonTyposCheckedState();
  }
}

function saveTypoToCommon() {
  const wrong = (document.getElementById('typo-wrong').value || '').trim();
  const correct = (document.getElementById('typo-correct').value || '').trim();
  if (!correct) return;
  if (!commonTypos.some(t => t.wrong === wrong && t.correct === correct)) {
    commonTypos.push({ id: `c_${Date.now()}_${Math.random().toString(36).slice(2,7)}`, wrong, correct });
    isDataDirty = true;
    updateUIBasedOnAuthState();
  }
  if (!currentTypos.some(t => t.wrong === wrong && t.correct === correct)) {
    currentTypos.push({ wrong, correct });
  }
  renderCommonTypoList();
  renderTypoList();
  renderCommonTyposCheckedState();
  updateAllOutputs();
  document.getElementById('typo-wrong').value = '';
  document.getElementById('typo-correct').value = '';
}

function renderCommonTypoList() {
  const ul = document.getElementById('typo-saved-list');
  if (!ul) return;
  ul.innerHTML = '';
  commonTypos = commonTypos.filter(t => (t.correct||'').trim());
  commonTypos.forEach(t => {
    const isInCurrent = currentTypos.some(x => x.wrong === t.wrong && x.correct === t.correct);
    const wrongPart = t.wrong ? `「${t.wrong}」` : '';
    const li = document.createElement('li');
    li.innerHTML = `
      <input type="checkbox" ${isInCurrent ? 'checked' : ''} onchange="toggleCommonToCurrent('${t.id}', this.checked)" style="accent-color: var(--accent-color);">
      <span class="word">${wrongPart}→「${t.correct}」</span>
      <button class="danger-btn" onclick="confirmUI('刪除此條常見錯別字？', ()=> deleteCommonTypo('${t.id}'))">刪除</button>
    `;
    ul.appendChild(li);
  });
}

function renderCommonTyposCheckedState() {
  document.querySelectorAll('#typo-saved-list li').forEach(li => {
    const cb = li.querySelector('input[type="checkbox"]');
    const label = li.querySelector('.word');
    if (!cb || !label) return;
    const match = (label.textContent || '').match(/「(.*?)」→「(.*?)」/);
    if (!match) return;
    cb.checked = currentTypos.some(x => x.wrong === match[1] && x.correct === match[2]);
  });
}

function toggleCommonToCurrent(id, checked) {
  const item = commonTypos.find(t => t.id === id);
  if (!item) return;
  if (checked) {
    if (!currentTypos.some(x => x.wrong === item.wrong && x.correct === item.correct)) {
        currentTypos.push({ wrong: item.wrong, correct: item.correct });
    }
  } else {
    const idx = currentTypos.findIndex(x => x.wrong === item.wrong && x.correct === item.correct);
    if (idx >= 0) currentTypos.splice(idx, 1);
  }
  renderTypoList();
  renderCommonTyposCheckedState();
  updateAllOutputs();
  isDataDirty = true;
  updateUIBasedOnAuthState();
}

function deleteCommonTypo(id) {
  const idx = commonTypos.findIndex(t => t.id === id);
  if (idx >= 0) {
    const { wrong, correct } = commonTypos[idx];
    const idxCur = currentTypos.findIndex(x => x.wrong === wrong && x.correct === correct);
    if (idxCur >= 0) currentTypos.splice(idxCur, 1);
    commonTypos.splice(idx, 1);
    isDataDirty = true;
    updateUIBasedOnAuthState();
    renderCommonTypoList();
    renderTypoList();
    updateAllOutputs();
  }
}

/* --- 學生資料儲存、讀取與總覽 --- */

// [v19.4] 導航切換：先儲存，後跳轉
async function navigateToStudent(direction) {
  const select = document.getElementById('student-select');
  if (select.options.length <= 1) return;

  // 1. 先執行雲端同步 (顯示 Toast)
  if (typeof saveCurrentStudentData === 'function') {
      // 使用 await 確保儲存完成才轉頁
      await saveCurrentStudentData('cloud');
  }

  // 2. 計算新索引
  let newIndex = select.selectedIndex + (direction === 'next' ? 1 : -1);
  if (newIndex >= select.options.length) newIndex = 0; 
  if (newIndex < 0) newIndex = select.options.length - 1; 
  
  // 3. 執行切換
  select.selectedIndex = newIndex;
  select.dispatchEvent(new Event('change'));
}

// [Pro-v9.4] 智能同步引擎 (Unified Sync + Smart Diff)
async function saveCurrentStudentData(mode = 'cloud') {
  const studentSelect = document.getElementById('student-select');
  const studentOriginalName = studentSelect.value; 
  if (!studentOriginalName) { alert('請先選擇一位學生。'); return; }

  const studentRecord = allStudentRecords.find(r => r.originalName === studentOriginalName);
  if (!studentRecord) { alert('錯誤：找不到該學生資料。請刷新。'); return; }

  // 1. 收集數據
  const checkedCritiques = [];
  const selectedTags = []; 
  document.querySelectorAll('#checklist-container input[type="checkbox"]:checked').forEach(cb => {
    selectedTags.push(cb.id);
    const data = { id: cb.id, selectValues: [] };
    const module = document.getElementById(`module-${cb.id}`);
    if (module) {
        module.querySelectorAll('select').forEach((select, index) => {
            let value = select.value;
            let otherValue = '';
            if (value === '其他') {
                const otherInput = document.getElementById(`${cb.id}-other-${index + 1}-text`);
                otherValue = otherInput ? otherInput.value : '';
            }
            data.selectValues.push({ value, otherValue });
        });
    }
    checkedCritiques.push(data);
  });

  const scores = {
      content: document.getElementById('score-content').value,
      expression: document.getElementById('score-expression').value,
      structure: document.getElementById('score-structure').value,
      punctuation: document.getElementById('score-punctuation').value,
      typos: document.getElementById('score-typos').value,
      total: document.getElementById('score-total').value,
  };
  const fullComment = document.getElementById('full-output').value;
  const studentComment = document.getElementById('student-report-output').value;

  // 2. 更新記憶體
  studentRecord.data = {
    class: document.getElementById('student-class').value,
    topic: document.getElementById('topic').value,
    uniqueComment: document.getElementById('unique-comment').value,
    scores: scores,
    typos: [...currentTypos],
    checkedCritiques: checkedCritiques,
    selectedTitles: checkedCritiques.join(','), 
    fullComment: fullComment,
    studentComment: studentComment,
    pureFullComment: fullComment,
    pureStudentComment: studentComment,
  };

  if (mode === 'local') {
      // 雖然你說要刪除 Local 按鈕，但保留這個邏輯給自動備份用
      saveToLocalBackup(); renderStudentOverviewTable(); isDataDirty = true; updateUIBasedOnAuthState();
      if (typeof showToast === 'function') showToast("💾 草稿已儲存", "success");
  } else {
      // === Cloud Mode ===
      if (window.currentClassId && currentUser) {
          // 因為只剩一個懸浮按鈕，我們直接抓它
          const saveBtn = document.querySelector('#floating-nav a[onclick*="cloud"]'); 
          const originalBtnText = saveBtn ? saveBtn.textContent : '☁️';
          
          if(saveBtn) { saveBtn.textContent = "⏳"; saveBtn.style.opacity = "0.7"; }

          try {
              const topicTitle = document.getElementById('topic').value.trim();
              let assignmentId = window.currentAssignmentId;

              // A. 確保 Assignment 存在
              if (!assignmentId) {
                  const { data: assignData } = await supabaseClient.from('assignments').select('id').eq('class_id', window.currentClassId).eq('title', topicTitle).maybeSingle();
                  if (assignData) { assignmentId = assignData.id; } 
                  else {
                      const { data: newAssign, error: createError } = await supabaseClient.from('assignments').insert([{ user_id: currentUser.id, class_id: window.currentClassId, title: topicTitle, settings: { critiques: collectExportData() } }]).select().single();
                      if (createError) throw createError;
                      assignmentId = newAssign.id;
                      // 新作業，當然要更新基準線
                      window.lastSavedCritiques = JSON.stringify(collectExportData());
                  }
                  window.currentAssignmentId = assignmentId;
              }

              // 🔥 B. 智能評語庫同步 (Smart Sync)
              // 比較當前評語庫 vs 上次儲存的基準線
              const currentCritiquesJson = JSON.stringify(collectExportData());
              if (currentCritiquesJson !== window.lastSavedCritiques) {
                  console.log("⚡ 偵測到評語庫變更，正在同步 Assignments 表...");
                  const { error: settingsError } = await supabaseClient
                      .from('assignments')
                      .update({ settings: { critiques: JSON.parse(currentCritiquesJson) } }) // 更新 Menu
                      .eq('id', assignmentId);
                  
                  if (settingsError) throw settingsError;
                  
                  // 更新基準線，下次就不用存了
                  window.lastSavedCritiques = currentCritiquesJson;
                  console.log("✅ 評語庫已更新");
              } else {
                  console.log("⏩ 評語庫無變更，跳過 Assignments 表寫入 (Speed Optimization)");
              }

              // C. 寫入 Results (學生資料)
              if (!studentRecord.dbId) {
                  const { data: fixedStudent } = await supabaseClient.from('students').select('id').eq('class_id', window.currentClassId).eq('name', studentRecord.name).maybeSingle();
                  if (fixedStudent) studentRecord.dbId = fixedStudent.id;
                  else throw new Error(`找不到學生 ID`);
              }

              const payload = {
                  assignment_id: assignmentId, student_id: studentRecord.dbId,
                  content_score: parseFloat(scores.content)||0, expression_score: parseFloat(scores.expression)||0,
                  structure_score: parseFloat(scores.structure)||0, punctuation_score: parseFloat(scores.punctuation)||0,
                  typo_score: parseFloat(scores.typos)||0, total_score: parseFloat(scores.total)||0,
                  comment_full: fullComment, comment_student: studentComment, 
                  comment_data: { uniqueComment: document.getElementById('unique-comment').value, typos: currentTypos, checkedCritiques: checkedCritiques, studentComment: studentComment, pureStudentComment: studentComment, pureFullComment: fullComment },
                  tags: selectedTags, updated_at: new Date().toISOString()
              };

              const { error: resultError } = await supabaseClient.from('results').upsert(payload, { onConflict: 'assignment_id, student_id' });
              if (resultError) throw resultError;
              
              // 🔥 D. 即時 UI 更新 (Hot Update)
              // 1. 更新下拉選單狀態 (Visual Feedback)
              const options = studentSelect.options;
              for(let i=0; i<options.length; i++) {
                  if(options[i].value === studentOriginalName) {
                      // 如果還沒加綠勾，就加上去
                      if(!options[i].text.includes('✅')) {
                          options[i].text = `✅ ${options[i].text.replace('✅ ', '')}`;
                      }
                      break;
                  }
              }
              
              // 2. 顯示成功訊息
              if (typeof showToast === 'function') showToast("☁️ 學生及評語庫已同步！", "success");
              
              // 3. 備份
              saveToLocalBackup();

          } catch (e) {
              console.error("Sync Error:", e);
              alert(`同步失敗:\n${e.message}`);
          } finally {
              if(saveBtn) { saveBtn.textContent = originalBtnText; saveBtn.style.opacity = "1"; }
          }
      } else {
          saveToLocalBackup();
          if (typeof showToast === 'function') showToast("⚠️ 未登入，僅儲存於本機", "warning");
      }
      
      // 更新總覽表記憶體 (但不強制重繪整個表格以免閃爍)
      renderStudentOverviewTable(); 
      isDataDirty = false; // 標記為已乾淨
      updateUIBasedOnAuthState();
      
      // 自動跳轉
      setTimeout(() => scrollToSection(new Event('dummy'), 'student-select'), 100);
  }
}

// [v18.2.0] Pessimistic Score Save (安全鎖定版)
async function handlePessimisticScoreSave(input) {
    // 1. 準備數據
    const scoreType = input.id.replace('score-', ''); // content, expression...
    const newValue = input.value;
    const oldValue = input.defaultValue; // 瀏覽器會記住舊值
    
    // 獲取當前作業 ID 和 學生 ID
    const assignmentId = window.currentAssignmentId;
    // 這裡我們需要從 student-select 找到當前學生的 DB ID
    const studentName = document.getElementById('student-select').value;
    const studentRecord = allStudentRecords.find(r => r.originalName === studentName);
    
    if (!assignmentId || !studentRecord || !studentRecord.dbId) {
        // 如果沒有專案或學生ID，暫時只做本地計算 (降級處理)
        calculateTotalScore();
        triggerAutoSave();
        return;
    }

    // 2. UI 鎖定 (黃色 Loading)
    input.style.backgroundColor = '#fffde7'; // 淡黃
    input.style.borderColor = '#fbc02d';
    // input.disabled = true; // 暫不 Disable，以免失焦問題，用顏色提示即可

    try {
        // 3. 準備 Payload
        const updatePayload = { 
            assignment_id: assignmentId,
            student_id: studentRecord.dbId,
            updated_at: new Date().toISOString()
        };
        // 動態設定要改的欄位
        let dbField = '';
        if (scoreType === 'typos') dbField = 'typo_score';
        else dbField = `${scoreType}_score`;
        
        updatePayload[dbField] = parseFloat(newValue) || 0;

        // 因為 Total Score 會變，所以要順便計埋 Total 並儲存
        const currentTotal = calculateTotalScore(); 
        updatePayload['total_score'] = currentTotal;

        // 4. 發送 Supabase 請求
        const { error } = await supabaseClient
            .from('results')
            .upsert(updatePayload, { onConflict: 'assignment_id, student_id' });

        if (error) throw error;

        // 5. 成功 (綠色閃一下)
        input.style.backgroundColor = '#e8f5e9'; // 淡綠
        input.style.borderColor = '#4caf50';
        input.defaultValue = newValue; // 更新基準值
        
        // 更新記憶體 (保持同步)
        if (studentRecord.data && studentRecord.data.scores) {
            studentRecord.data.scores[scoreType] = newValue;
            studentRecord.data.scores.total = currentTotal;
        }

        setTimeout(() => {
            input.style.backgroundColor = ''; // 還原
            input.style.borderColor = '';
        }, 1000);

    } catch (err) {
        console.error("Save failed:", err);
        // 6. 失敗 (紅色 + 還原數值)
        input.style.backgroundColor = '#ffebee'; // 淡紅
        input.style.borderColor = '#c62828';
        input.value = oldValue; // 還原
        calculateTotalScore(); // 重新計算 Total
        
        alert(`❌ 儲存失敗！請檢查網絡。\n數值已還原為: ${oldValue}`);
    }
}

function loadStudentData(studentOriginalName) {
  const studentRecord = allStudentRecords.find(r => r.originalName === studentOriginalName);
  clearAllCore(false); 
  if (!studentRecord || !studentRecord.data) {
    const studentClass = document.getElementById('student-class').value;
    const topic = document.getElementById('topic').value;
    clearAllCore(true);
    document.getElementById('student-class').value = studentClass;
    document.getElementById('topic').value = topic;
    updateAllOutputs();
    return;
  }
  const data = studentRecord.data;
  document.getElementById('student-class').value = data.class || '';
  document.getElementById('topic').value = data.topic || '';
  document.getElementById('unique-comment').value = data.uniqueComment || '';
  Object.keys(data.scores).forEach(key => {
    const el = document.getElementById(`score-${key.toLowerCase()}`);
    if (el) el.value = data.scores[key] || '';
  });
  currentTypos = data.typos ? [...data.typos] : [];
  renderTypoList();
  renderCommonTyposCheckedState();
  if (data.checkedCritiques) {
    data.checkedCritiques.forEach(item => {
      const cb = document.getElementById(item.id);
      if (cb) {
        cb.checked = true;
        handleCheckboxChange(cb, false); 
        if (item.selectValues && Array.isArray(item.selectValues)) {
            item.selectValues.forEach((sv, index) => {
                const select = document.getElementById(`${item.id}-select-${index + 1}`);
                if (select) {
                    select.value = sv.value;
                    toggleOtherBlock(select.id, sv.value);
                    if (sv.value === '其他' && sv.otherValue) {
                        const otherInput = document.getElementById(`${item.id}-other-${index + 1}-text`);
                        if (otherInput) otherInput.value = sv.otherValue;
                    }
                }
            });
        }
      }
    });
  }
  document.getElementById('full-output').value = data.fullComment || '';
  document.getElementById('student-report-output').value = data.studentComment || '';
  updateAllOutputs();
}

function handleTableEdit(textarea) {
    const studentOriginalName = textarea.dataset.studentName;
    const field = textarea.dataset.field;
    const studentRecord = allStudentRecords.find(r => r.originalName === studentOriginalName);
    if (studentRecord && studentRecord.data) {
        studentRecord.data[field] = textarea.value;
        isDataDirty = true;
        updateUIBasedOnAuthState();
    }
}

function autoResizeTextarea(textarea) {
    textarea.style.height = 'auto';
    textarea.style.height = textarea.scrollHeight + 'px';
}

function handleOverviewScoreChange(input) {
    const studentOriginalName = input.dataset.studentName;
    const scoreType = input.dataset.scoreType;
    const studentRecord = allStudentRecords.find(r => r.originalName === studentOriginalName);
    if (!studentRecord || !studentRecord.data) return;
    studentRecord.data.scores[scoreType] = input.value;
    const s = studentRecord.data.scores;
    const newTotal = ((parseFloat(s.content) || 0) * 4) + ((parseFloat(s.expression) || 0) * 3) + ((parseFloat(s.structure) || 0) * 2) + ((parseFloat(s.punctuation) || 0) * 1) + (parseFloat(s.typos) || 0);
    studentRecord.data.scores.total = newTotal;
    const totalCell = document.getElementById(`total-score-${escapeHtmlAttr(studentOriginalName)}`);
    if (totalCell) totalCell.textContent = newTotal;
    isDataDirty = true;
    updateUIBasedOnAuthState();
}

/* [v17.4] 進度表渲染 (強力數據讀取版) */
function renderStudentOverviewTable() {
    const tbody = document.querySelector("#student-overview-table tbody");
    const classDisplay = document.getElementById("overview-class-display");
    const progressBox = document.getElementById("literary-progress");
    if (!tbody || !classDisplay) return;
    tbody.innerHTML = '';

    if (allStudentRecords.length === 0) {
        tbody.innerHTML = `<tr><td colspan="9" class="empty-state-message">暫無學生資料。</td></tr>`;
        if (progressBox) progressBox.style.display = 'none';
        return;
    }

    // 寬鬆判斷：只要有分數 OR 有評語字串，就算已批改
    const withData = allStudentRecords.filter(r => {
        if (!r.data) return false;
        const s = r.data.scores || {};
        const c = r.data.pureStudentComment || r.data.studentComment || '';
        return (s.total && s.total !== '') || c.trim().length > 0;
    });
    
    // 更新進度條
    if (progressBox) {
        const total = allStudentRecords.length;
        const graded = withData.length;
        const pct = total > 0 ? Math.round((graded/total)*100) : 0;
        progressBox.style.display = 'block';
        progressBox.classList.toggle('finished', graded === total);
        document.getElementById("progress-numbers").textContent = `${graded} / ${total}`;
        document.getElementById("progress-bar").style.width = `${pct}%`;
        document.getElementById("progress-text").innerHTML = (total - graded) > 0 ? `尚有 <strong>${total - graded}</strong> 篇待閱。` : `全班批改完成。`;
    }

    classDisplay.textContent = `班別：${document.getElementById('student-class').value || '未分類'}`;

    const renderRow = (r, isGraded) => {
        const d = r.data || {};
        const s = d.scores || {content:'',expression:'',structure:'',punctuation:'',typos:'',total:''};
        
        // 🔥 強力讀取：嘗試多個欄位，確保抓到字
        // 優先次序：pureStudentComment -> studentComment -> comments -> 空
        let comment = d.pureStudentComment || d.studentComment || '';
        if (typeof comment !== 'string') comment = ''; // 防爆

        const safeName = escapeHtmlAttr(r.originalName);
        
        const tr = document.createElement('tr');
        if (!isGraded) tr.classList.add('row-missing');
        tr.innerHTML = `
            <td>${r.number || ''}</td>
            <td style="text-align:left;"><a href="javascript:void(0)" onclick="jumpToStudentFromOverview('${safeName}')" style="color:var(--accent-color);font-weight:bold;">${escapeHtml(r.name)}</a></td>
            <td><input type="number" value="${s.content}" data-student-name="${safeName}" data-score-type="content" oninput="handleOverviewScoreChange(this)"></td>
            <td><input type="number" value="${s.expression}" data-student-name="${safeName}" data-score-type="expression" oninput="handleOverviewScoreChange(this)"></td>
            <td><input type="number" value="${s.structure}" data-student-name="${safeName}" data-score-type="structure" oninput="handleOverviewScoreChange(this)"></td>
            <td><input type="number" value="${s.punctuation}" data-student-name="${safeName}" data-score-type="punctuation" oninput="handleOverviewScoreChange(this)"></td>
            <td><input type="number" value="${s.typos}" data-student-name="${safeName}" data-score-type="typos" oninput="handleOverviewScoreChange(this)"></td>
            <td class="total-score-cell" id="total-score-${safeName}">${s.total}</td>
            <td>
                <!-- 🔥 加入 spellcheck="false" 加快渲染 -->
                <textarea data-student-name="${safeName}" data-field="pureStudentComment" spellcheck="false" 
                    oninput="handleTableEdit(this); autoResizeTextarea(this);">${escapeHtml(comment)}</textarea>
            </td>
        `;
        tbody.appendChild(tr);
    };
    
    const sorter = (a, b) => (a.number || 999) - (b.number || 999);
    // 重新排序並渲染 (已批改在上)
    allStudentRecords.filter(r => withData.includes(r)).sort(sorter).forEach(r => renderRow(r, true));
    allStudentRecords.filter(r => !withData.includes(r)).sort(sorter).forEach(r => renderRow(r, false));
    
    // 強制觸發一次高度調整
    setTimeout(() => tbody.querySelectorAll('textarea').forEach(autoResizeTextarea), 100);
}

// [Pro-v8.9] 顯示學生歷史圖表 (讀取該學生所有作業成績)
let _historyChart = null;

// [Pro-v9.5.2] 學生歷程 (隱藏 Legend)
async function showStudentHistory(studentId, studentName) {
    if (!studentId) return;
    
    const modal = document.getElementById('pop-student-history-modal');
    const modalContent = modal.querySelector('.pop-modal');
    if (modalContent) modalContent.classList.add('pop-modal-large');

    document.getElementById('history-student-name').textContent = `${studentName} 的成長足跡 👣`;
    modal.classList.add('active');
    
    const chartContainer = document.querySelector('#pop-student-history-modal .pop-modal > div[style*="height"]');
    chartContainer.innerHTML = '<canvas id="studentHistoryChart"></canvas>';

    try {
        const { data, error } = await supabaseClient
            .from('results')
            .select(`total_score, assignments!inner ( title, created_at )`)
            .eq('student_id', studentId);

        if (error) throw error;

        if (!data || data.length === 0) {
            alert("這位同學暫時還沒有歷程數據喔。");
            modal.classList.remove('active');
            return;
        }

        // Phase 10 Sort Logic
        data.sort((a, b) => new Date(a.assignments.created_at) - new Date(b.assignments.created_at));

        const labels = data.map(d => {
            const dateObj = new Date(d.assignments.created_at);
            return `${d.assignments.title} (${dateObj.getMonth() + 1}/${dateObj.getDate()})`;
        });
        const scores = data.map(d => d.total_score);

        const ctx = document.getElementById('studentHistoryChart');
        if (_historyChart) _historyChart.destroy(); 

        _historyChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: '分數', // 這個 Label 會被隱藏
                    data: scores,
                    borderColor: '#5A8F7B',
                    backgroundColor: 'rgba(90, 143, 123, 0.15)',
                    borderWidth: 3,
                    pointBackgroundColor: '#fff',
                    pointBorderColor: '#5A8F7B',
                    pointRadius: 5,
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, suggestedMax: 100, grid: { color: '#f0f0f0' } },
                    x: { grid: { display: false } }
                },
                plugins: {
                    // 🔥 隱藏 Legend (點擊消失的問題解決)
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(90, 143, 123, 0.9)',
                        padding: 10,
                        cornerRadius: 8,
                        displayColors: false
                    }
                }
            }
        });

    } catch (err) {
        console.error("History Error:", err);
        alert("讀取歷程時發生了一點小問題，請稍後再試。");
        modal.classList.remove('active');
    }
}

function jumpToStudentFromOverview(originalName) {
  showPage('page2');
  const sel = document.getElementById('student-select');
  if (!sel) return;
  sel.value = originalName;
  sel.dispatchEvent(new Event('change'));
  sel.focus();
}

// [v19.8] 評語分析數據獲取 (核心修復：嚴格篩選已批改學生)
function getAnalysisData() {
  // 🔥 關鍵修正：不再只看 r.data 是否存在，而是檢查內容是否為空
  const records = allStudentRecords.filter(r => {
      if (!r.data) return false;
      const s = r.data.scores || {};
      // 判斷標準：有總分 OR 有評語內容
      const hasScore = (s.total !== '' && s.total !== null && s.total !== undefined);
      const hasComment = (r.data.pureStudentComment || r.data.studentComment || '').trim().length > 0;
      return hasScore || hasComment;
  });

  if (!records.length) return null;

  let sums = { content:0, expression:0, structure:0, punctuation:0, typos:0, total:0 };
  let counts = { content:0, expression:0, structure:0, punctuation:0, typos:0, total:0 };

  records.forEach(r => {
    const s = r.data.scores || {};
    Object.keys(sums).forEach(key => {
        const val = parseFloat(s[key]);
        if (!isNaN(val)) { sums[key] += val; counts[key]++; }
    });
  });

  const avgFn = (sum, cnt) => cnt ? (sum / cnt) : null;
  
  const scoreSummary = [
    { 指標:'內容', 平均分: avgFn(sums.content, counts.content) }, 
    { 指標:'表達', 平均分: avgFn(sums.expression, counts.expression) },
    { 指標:'結構', 平均分: avgFn(sums.structure, counts.structure) }, 
    { 指標:'標點及字體', 平均分: avgFn(sums.punctuation, counts.punctuation) },
    { 指標:'錯別字加減分', 平均分: avgFn(sums.typos, counts.typos) }, 
    { 指標:'總分', 平均分: avgFn(sums.total, counts.total) },
  ];

  const freq = {};
  records.forEach(r => {
    const seen = new Set();
    (r.data.checkedCritiques || []).forEach(item => {
      const title = getCritiqueData(item.id, 'title');
      if (title && !seen.has(title)) {
        seen.add(title);
        freq[title] = (freq[title] || 0) + 1;
      }
    });
  });

  const topEntries = Object.entries(freq)
                      .sort((a,b) => b[1] - a[1])
                      .slice(0, 10)
                      .map(([title, count], idx) => ({ 排名: idx + 1, 評語標題: title, 被選次數: count }));

  return { scoreSummary, topEntries, studentCount: records.length };
}

// ==========================================
// ====== Chart.js 圖表整合 (開始) ======
// ==========================================

// 1. 定義全域變數存放圖表實例 (放在 script 最上方或其他全域變數附近)
let globalScoreChart = null;
let globalCritiqueChart = null;

/* [v17.1] 評語分析頁 (Progress Bar) */
function renderAnalysisPage() {
    const scoreDiv = document.getElementById('analysis-score-summary');
    const topDiv = document.getElementById('analysis-top-critique');
    const scoreCanvas = document.getElementById('scoreChartCanvas');
    const critiqueCanvas = document.getElementById('critiqueChartCanvas');

    const analysisData = getAnalysisData();

    if (!analysisData) {
        const emptyHTML = `<div class="empty-state-message">目前尚未有已儲存的學生評語。</div>`;
        scoreDiv.innerHTML = emptyHTML; topDiv.innerHTML = emptyHTML;
        if (globalScoreChart) { globalScoreChart.destroy(); globalScoreChart = null; }
        if (globalCritiqueChart) { globalCritiqueChart.destroy(); globalCritiqueChart = null; }
        return;
    }

    const { scoreSummary, topEntries, studentCount } = analysisData;
    const totalStudents = allStudentRecords.length;
    const pct = totalStudents > 0 ? Math.round((studentCount / totalStudents) * 100) : 0;

    // 🔥 插入 Progress Bar (在 Card 之前)
    const progressHtml = `
        <div style="background:#fff; padding:15px; border-radius:12px; border:1px solid #eee; margin-bottom:20px;">
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                <span style="font-weight:bold; color:var(--title-color);">分析樣本量</span>
                <span style="color:#666;">${studentCount} / ${totalStudents} 人 (${pct}%)</span>
            </div>
            <div style="width:100%; height:8px; background:#f0f0f0; border-radius:99px; overflow:hidden;">
                <div style="width:${pct}%; height:100%; background:var(--accent-color); border-radius:99px;"></div>
            </div>
        </div>
    `;
    
    // 渲染表格 (保留原邏輯)
    scoreDiv.innerHTML = `<table class="analysis-table"><thead><tr><th>指標</th><th>平均分</th></tr></thead><tbody>${scoreSummary.map(row => `<tr><td>${escapeHtml(row.指標)}</td><td>${row.平均分 != null ? row.平均分.toFixed(2) : '-'}</td></tr>`).join('')}</tbody></table>`;
    topDiv.innerHTML = topEntries.length ? `<table class="analysis-table"><thead><tr><th>排名</th><th>評語標題</th><th>次數</th></tr></thead><tbody>${topEntries.map(row => `<tr><td>${row.排名}</td><td>${escapeHtmlAttr(row.評語標題)}</td><td>${row.被選次數}</td></tr>`).join('')}</tbody></table>` : `<div class="empty-state-message">無數據</div>`;

    // 插入 Progress Bar 到 Grid 之前
    const grid = document.querySelector('.analysis-grid');
    // 檢查是否已存在 (避免重複插)
    const existingProg = document.getElementById('analysis-progress-container');
    if(existingProg) existingProg.remove();
    
    const progDiv = document.createElement('div');
    progDiv.id = 'analysis-progress-container';
    progDiv.innerHTML = progressHtml;
    grid.parentNode.insertBefore(progDiv, grid);

    // 繪製圖表 (保留原邏輯) - 略，因為無改動
    // ... (Charts Drawing Logic) ...
    // 如果需要圖表代碼，請保留之前的 renderAnalysisPage 後半部分
    // 為了確保不報錯，這裡簡單帶過圖表更新
    const radarData = scoreSummary.filter(s => s.指標 !== '總分');
    const labels = radarData.map(s => s.指標);
    const dataPoints = radarData.map(s => s.平均分 || 0);
    if (globalScoreChart) globalScoreChart.destroy();
    globalScoreChart = new Chart(scoreCanvas, { type: 'radar', data: { labels: labels, datasets: [{ label: '平均表現', data: dataPoints, backgroundColor: 'rgba(90, 143, 123, 0.2)', borderColor: 'rgba(90, 143, 123, 1)' }] }, options: { scales: { r: { suggestedMin: 0 } }, plugins: { legend: { display: false } } } });

    const top5 = topEntries.slice(0, 5);
    if (globalCritiqueChart) globalCritiqueChart.destroy();
    globalCritiqueChart = new Chart(critiqueCanvas, { type: 'bar', data: { labels: top5.map(e=>e.評語標題), datasets: [{ label: '次數', data: top5.map(e=>e.被選次數), backgroundColor: 'rgba(90, 143, 123, 0.7)' }] }, options: { indexAxis: 'y', plugins: { legend: { display: false } } } });
}

// ==========================================
// ====== Chart.js 圖表整合 (結束) ======
// ==========================================


/* === [v11.1] 強力 Prompt 生成引擎 (Strict Mode) === */
/* ================================================= */

function generateAIPrompt() {
    // 1. 獲取資料
    const levelSelect = document.getElementById('ai-student-level');
    const levelText = levelSelect.options[levelSelect.selectedIndex].text;
    const topic = document.getElementById('ai-topic').value.trim();
    if (!topic) { alert('請先填寫「作文題目」！'); return; }
    const focusSelect = document.getElementById('ai-focus');
    const focusText = focusSelect.options[focusSelect.selectedIndex].text;
    const focusValue = focusSelect.value;
    const highlights = document.getElementById('ai-highlights').value.trim();

    // 2. 數量設定
    let countInst = '請提供 5 個優點 (excellent) 和 5 個待改進 (problem)。';
    if (focusValue === 'encourage') countInst = '請提供 8 個優點 (excellent) 和 4 個待改進 (problem)。';
    if (focusValue === 'improve') countInst = '請提供 4 個優點 (excellent) 和 8 個待改進 (problem)。';

    // 3. 組合 Prompt (使用更嚴格的 System Instruction)
    const prompt = `
你現在是一個「JSON 數據生成器」。你的唯一任務是根據我的要求，輸出一格式正確的 JSON Array。
請勿輸出任何開場白、結尾語或 markdown 標記 (如 \`\`\`json)，只輸出純 JSON 代碼。

【任務背景】
我是香港中學中文老師，正在為作文題目「${topic}」建立評語庫。
- 學生程度：${levelText}
- 評語風格：${focusText}
- 特別要求：${highlights ? highlights : '無'}
- ${countInst}

【數據結構要求】
請回傳一個 Array，包含多個 Object，每個 Object 代表一條評語，欄位如下：
1. "critique_id": 字串，格式為 "ai_" 加上隨機數。
2. "category": 字串，必須是 ["扣題與立意", "取材與刻畫", "結構與鋪排", "語言與表達"] 其中之一。
3. "type": 字串，必須是 "excellent" (優點) 或 "problem" (待改進)。
4. "title": 字串，4-8字簡短標題。
5. "strength_summary": (僅優點用) 字串，優點描述。可用 [選項1] 代表可變內容。
6. "problem_core": (僅待改進用) 字串，問題描述。可用 [選項1] 代表可變內容。
7. "suggestion": (僅待改進用) 字串，具體建議。
8. "example": 字串，具體例子 (配合題目「${topic}」)。
9. "options": 字串，下拉選單內容 (如有 [選項1])，每行一個選項。多組用 | 分隔。無則留空。
10. "options_label": 字串，選單標題。無則留空。

【JSON 範例 (請嚴格模仿格式)】
[
  {
    "critique_id": "ai_demo_01",
    "category": "取材與刻畫",
    "type": "problem",
    "title": "人物描寫欠立體",
    "strength_summary": "",
    "problem_core": "對[選項1]的描寫較為單一，未能展現其[選項2]。",
    "suggestion": "可加入心理描寫或矛盾掙扎。",
    "example": "例如寫父親，除了寫嚴肅，也可寫他背後的關懷。",
    "options": "主角\\n配角|內心世界\\n性格特質",
    "options_label": "人物|描寫角度"
  },
  {
    "critique_id": "ai_demo_02",
    "category": "扣題與立意",
    "type": "excellent",
    "title": "立意深刻",
    "strength_summary": "能從平凡小事中領悟[選項1]，昇華主題。",
    "problem_core": "",
    "suggestion": "",
    "example": "由一次遲到經歷，反思守時對誠信的重要性。",
    "options": "親情的可貴\\n成長的代價",
    "options_label": "領悟道理"
  }
]

現在，請生成符合上述題目要求的 JSON Array：
`;

    // 4. 寫入
    document.getElementById('ai-prompt-preview').value = prompt.trim();
}

/* ========================================= */
/* === [v11.4] AI 應用邏輯 (連帶開 Project) === */
/* ========================================= */

function applyAIJson() {
    const jsonInput = document.getElementById('ai-json-input').value.trim();
    if (!jsonInput) {
        alert('請先將從 AI 獲取的 JSON 內容貼到輸入框中。');
        return;
    }

    let importedData;
    try {
        importedData = JSON.parse(jsonInput);
    } catch (e) {
        alert(`JSON 格式錯誤。請確保您複製了完整的 JSON 陣列 (由 [ 開始，到 ] 結束)。`);
        return;
    }

    if (!Array.isArray(importedData)) {
        alert('導入失敗：內容不是一個有效的 JSON 陣列。');
        return;
    }

    // 🔥 攔截點：檢查是否有現行 Project
    // 判斷標準：有無 currentAssignmentId (雲端) 或 student-select 有無選項 (本地)
    const hasActiveProject = window.currentAssignmentId || (document.getElementById('student-select') && document.getElementById('student-select').options.length > 1);

    if (!hasActiveProject) {
        // --- 觸發補鑊流程 ---
        
        // 1. 把 JSON 暫存起來
        document.getElementById('quick-json-storage').value = jsonInput; // 存字串即可

        // 2. 準備 Modal
        const modal = document.getElementById('pop-quick-project-modal');
        const select = document.getElementById('quick-class-select');
        const manualArea = document.getElementById('quick-manual-area');

        // 3. 判斷登入狀態載入班級
        if (currentUser) {
            select.style.display = 'block';
            manualArea.style.display = 'none';
            // 借用 Page 1 的邏輯載入班級，但塞入這個新的 Select
            loadClassesToSelect(select); 
        } else {
            select.style.display = 'none';
            manualArea.style.display = 'block';
        }

        // 4. 顯示 Modal
        modal.classList.add('active');
        return; // 暫停執行，等待用戶在 Modal 按確認
    }

    // --- 正常流程 (已有 Project) ---
    executeApplyJson(importedData);
}

/* ========================================= */
/* === [v11.7 Fix] 應用並跳轉 (Auto Scroll) === */
/* ========================================= */

function executeApplyJson(data) {
    // 1. 寫入評語庫
    applyCritiquesToDOM(data.map(c => ({
        id: c.critique_id, category: c.category, type: c.type, title: c.title,
        strengthSummary: c.strength_summary, problemCore: c.problem_core,
        suggestion: c.suggestion, example: c.example, options: c.options,
        optionsLabel: c.options_label
    })));

    // 2. 刷新介面
    buildOverviewPage();
    buildChecklist();
    updateAllOutputs();
    
    // 3. 標記變更 (但不強制立即上雲，避免報錯，讓用戶稍後操作時自動存)
    isDataDirty = true;
    updateUIBasedOnAuthState();

    document.getElementById('ai-json-input').value = '';

    if(typeof showToast === 'function') showToast("✅ 評語庫已就緒！", "success");
    
    // 4. 跳轉並聚焦
    confirmUI('評語庫已準備好！\n是否立即前往「批改頁」開始？', () => {
        // 第二個參數 'grading-section-student' 會告訴 showPage 自動滑過去
        showPage('page2', 'grading-section-student');
    });
}

/* ---------------- AI 生成回饋 ---------------- */

function exportStudentDataForAI() {
  if (!checkXlsxLibrary()) return;
  const savedRecords = allStudentRecords.filter(r => r.data);
  if (savedRecords.length === 0) {
    alert('沒有任何已儲存的學生記錄可供匯出。');
    return;
  }
  savedRecords.sort((a, b) => (a.number || 999) - (b.number || 999));
  const dataToExport = savedRecords.map(record => {
    const s = record.data.scores;
    return {
      '學號': record.number, '姓名': record.name, '內容': s.content, '表達': s.expression, '結構': s.structure, '標點': s.punctuation, '錯別字': s.typos,
      '總分': s.total, '學生版評語': record.data.pureStudentComment,
    };
  });
  const ws = XLSX.utils.json_to_sheet(dataToExport);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, '學生評語資料');
  const filename = `全班評語資料_供AI分析_${getDateTimeString()}.xlsx`;
  XLSX.writeFile(wb, filename);
}

function generateFeedbackPromptV2() {
  const analysisData = getAnalysisData();
  const topic = document.getElementById('topic').value.trim();
  const className = (allStudentRecords.find(r => r.data)?.data.class) || '未指定班別';
  const studentLevelSelect = document.getElementById('ai-student-level');
  const studentLevel = studentLevelSelect.options[studentLevelSelect.selectedIndex].text;
  
  if (!topic) {
    alert('請先在第一頁填寫「作文題目」。');
    showPage('page1');
    document.getElementById('topic').focus();
    return;
  }
  if (!analysisData && (document.getElementById('ai-source-stats').checked || document.getElementById('ai-source-excel').checked)) {
    alert('目前尚未有已儲存的學生評語，無法生成包含數據分析的 Prompt。');
    return;
  }
  const modules = {
    classOverview: document.getElementById('ai-module-overview').checked,
    topicAnalysis: document.getElementById('ai-module-topic').checked,
    materialAndThemeExamples: document.getElementById('ai-module-material-theme').checked,
    excellentStudents: document.getElementById('ai-module-excellent-students').checked,
    workTiers: document.getElementById('ai-module-tiers').checked,
    writingPractices: document.getElementById('ai-module-practice').checked,
    teachingPlan: document.getElementById('ai-module-plan').checked,
  };
  const extraHints = document.getElementById('ai-feedback-extra-hints').value.trim();
  const requestedModules = Object.entries(modules).filter(([,v]) => v).map(([k]) => k);
  if (requestedModules.length === 0) {
    alert('請至少勾選一項「請 AI 生成的回饋模組」。');
    return;
  }

  let prompt = `# Role and Goal\n你是一位資深的香港中學中文科老師，現正為全班同學就最近一次的作文練習撰寫一份綜合性的回饋文件。你的目標是根據我提供的全班整體表現數據，生成一個結構化的 JSON 物件，該物件的內容將用於產生兩份 Word 文件：一份給老師的詳細教學材料，另一份給學生的簡明回饋單張。\n\n# Persona\n- 教學風格：專業、溫和、具鼓勵性、層次分明。\n- 語言：使用繁體中文和香港慣用詞彙。\n- 專長：分析學生寫作的共性問題，並提供清晰的教學指導和分層次的材料。\n\n# Context: Class Performance Data\n- 作文題目：「${topic}」\n- 班別：${className}\n- 學生級別：${studentLevel}\n`;
  if (document.getElementById('ai-source-excel').checked) prompt += `- 全班詳細表現：我已上傳名為「全班評語資料_供AI分析.xlsx」的檔案，其中包含每位學生的分數和評語。請務必詳細分析此檔案，以了解學生的具體表現，並從中抽取匿名示例。\n`;
  if (document.getElementById('ai-module-excellent-students').checked) prompt += `- 優秀同學名單：請從 Excel 中選取分數較高的同學，作為「優秀同學特點」的例子。如果 Excel 檔案中沒有具體姓名，請使用「陳同學」、「李同學」等通用稱謂。\n`;
  if (analysisData && document.getElementById('ai-source-stats').checked) {
    const scoreText = analysisData.scoreSummary.map(s => `- ${s.指標}：${s.平均分 != null ? s.平均分.toFixed(2) : 'N/A'}`).join('\n');
    const topCritiquesText = analysisData.topEntries.map(t => `- "${t.評語標題}" (出現 ${t.被選次數} 次)`).join('\n');
    prompt += `- 系統數據摘要：\n  - 已批改作品數量：${analysisData.studentCount}\n  - 全班分數平均值：\n${scoreText.replace(/^-/gm, '    -')}\n  - 最常見的評語項目：\n${topCritiquesText.replace(/^-/gm, '    -') || '    - (無)'}\n`;
  }
  prompt += `\n# Core Task\n根據以上數據，為作文「${topic}」撰寫一份綜合回饋。請嚴格按照下方指定的 JSON 結構和內容要求，生成所有被要求的部分。\n\n# General Instructions\n- 內容必須同時兼顧「老師版」和「學生版」的需要。\n- 「老師版」應詳細、專業，包含教學策略和深入分析。\n- 「學生版」應簡潔、視覺化、多用點列，語氣親切鼓勵。\n- 請在生成的文字中，使用 Markdown 的 \`**文字**\` 來標示粗體。\n- 所有示例都應匿名化，但內容需反映真實學生作品的水平。\n\n# Output Format (VERY IMPORTANT)\n你的回覆必須是、也只能是一個 JSON 物件。不要包含任何 JSON 以外的文字、註解或 markdown 語法。直接以 \`{\` 開頭，以 \`}\` 結尾。\n如果某個模組未被要求生成，請將其值設為 \`null\` 或省略該鍵。\n\n## JSON 結構詳解 (請嚴格遵守):\n\`\`\`json\n{\n  "classOverview": {\n    "teacherSummary": "(String) **老師版**：專業、深入地總結全班表現，分析結構性弱點、核心問題及教學切入點。",\n    "studentSummary": "(String) **學生版**：以「老師的話」形式撰寫，語氣親切鼓勵，點出共同進步之處及挑戰，並給予方向性建議。"\n  },\n  "topicAnalysis": {\n    "keywords": ["(String) 題目關鍵字1", "依依不捨", "離愁", "..."],\n    "analysisTeacher": "(String) **老師版**：深入的審題與立意深度分析，可使用表格形式的文字（用 Tab 或空格分隔），欄位包括：關鍵詞、寫作要求、常見弊病、進階方向。",\n    "highlightsAndProblems": {\n      "highlights": ["(String) 全班亮點1", "文章結構普遍完整"],\n      "problems": [\n        { "problem": "行程細節過於流水賬", "tip": "刪減搭車、吃飯等瑣碎過程..." },\n        { "problem": "友人形象模糊", "tip": "加入描寫友人的外貌、習慣動作..." }\n      ]\n    }\n  },\n  "materialAndThemeExamples": [\n    {\n      "theme": "(String) 立意方向1，如：離別是成長的催化劑。",\n      "material": "(String) 具體選材建議1，如：透過描寫送別後，主角開始獨立處理以往依賴朋友幫忙的事，來體現成長。"\n    }\n  ],\n  "excellentStudents": [\n    {\n      "name": "(String) 優秀同學姓名（如：陳同學）",\n      "strength": "(String) 該同學的優點總結，如：描寫細膩，善於運用感官刻畫離愁。"\n    }\n  ],\n  "workTiers": {\n    "high": {\n      "characteristics": ["(String) 上品作品的特徵1（點列式）", "能細緻描寫友人的神態與動作"],\n      "sample": "(String) 匿名化的上品作品示例段落。",\n      "commentary": "(String) **老師版**：針對該示例的深入點評，分析其優點及技巧。",\n      "selfChecklist": ["(String) 供學生自評的問題1", "我的結尾是否昇華了主題？"]\n    },\n    "mid": {\n      "characteristics": ["(String) 中品作品的特徵1", "敘事完整，情感尚可"],\n      "sample": "(String) 匿名化的中品作品示例段落。",\n      "commentary": "(String) **老師版**：針對該示例的點評，指出可改善之處。",\n      "selfChecklist": ["(String) 供學生自評的問題1", "我的「難過」有沒有具體的細節支持？"]\n    },\n    "low": {\n      "characteristics": ["(String) 下品作品的特徵1", "過於側重行程記錄"],\n      "sample": "(String) 匿名化的下品作品示例段落。",\n      "commentary": "(String) **老師版**：針對該示例的點評，點出基本問題及修正方向。",\n      "selfChecklist": ["(String) 供學生自評的問題1", "我是否寫了很多與「送別」無關的瑣事？"]\n    }\n  },\n  "teachingPlan": {\n    "objectives": ["(String) 本次跟進教學的學習目標1", "..."],\n    "activities": [\n      { "name": "(String) 活動名稱1", "description": "(String) 活動詳細描述", "duration": "(String) 預計時間" }\n    ],\n    "remedialStrategies": ["(String) 針對能力稍遜學生的補底策略1", "..."],\n    "extensionActivities": ["(String) 給能力較佳學生的延伸挑戰1", "..."]\n  },\n  "writingPractices": [\n    {\n      "prompt": "(String) **練習一** 的題目。",\n      "guidelines": ["(String) 練習一的寫作指引1（點列式）", "..."],\n      "modelAnswer": "(String) 參考示例答案。",\n      "commentary": "(String, Optional) **老師版**：對練習一示例的簡要點評。"\n    }\n  ]\n}\n\`\`\`\n${extraHints ? `\n# 額外提示\n${extraHints}\n` : ''}請現在開始生成。`;
  document.getElementById('ai-feedback-prompt-preview').value = prompt.trim();
}

function _getAIFeedbackData() {
  const jsonInput = document.getElementById('ai-feedback-json-input').value.trim();
  if (!jsonInput) {
    alert('請先將從 AI 獲取的 JSON 內容貼到輸入框中。');
    return null;
  }
  let aiData;
  try {
    aiData = JSON.parse(jsonInput);
  } catch (e) {
    alert(`JSON 格式錯誤，無法解析。請確保您複製了完整的 JSON 物件內容（由 { 開始，到 } 結束）。\n\n錯誤訊息：${e.message}`);
    return null;
  }
  if (typeof aiData !== 'object' || aiData === null || Array.isArray(aiData)) {
    alert('導入失敗：內容不是一個有效的 JSON 物件。');
    return null;
  }
  return aiData;
}

/* ---------------- 評語總覽頁 ---------------- */

function setCritiqueData(id, data) {
    const el = document.querySelector(`#critique-data div[data-id="${id}"]`);
    if (!el) return;
    for (const key in data) {
        if (data[key]) el.dataset[key] = data[key];
        else delete el.dataset[key];
    }
    isDataDirty = true;
    updateUIBasedOnAuthState();
}

function populateCategoryDropdown(selectElement, currentCategory) {
  const allCritiques = document.querySelectorAll('#critique-data div[data-id]');
  const existingCategories = [...new Set(Array.from(allCritiques).map(el => el.dataset.category))].filter(Boolean);
  selectElement.innerHTML = '';
  existingCategories.forEach(cat => {
    const opt = document.createElement('option');
    opt.value = cat; opt.textContent = cat;
    if (cat === currentCategory) opt.selected = true;
    selectElement.appendChild(opt);
  });
  const newOpt = document.createElement('option');
  newOpt.value = '__new__'; newOpt.textContent = '新增分類...';
  selectElement.appendChild(newOpt);
}

function deleteCritique(id) {
    const critiqueEl = document.querySelector(`#critique-data div[data-id="${id}"]`);
    if (critiqueEl) critiqueEl.remove();
    buildOverviewPage();
    buildChecklist();
    updateAllOutputs();
    isDataDirty = true;
    updateUIBasedOnAuthState();
}

function buildOverviewPage() {
  const overviewList = document.getElementById('overview-list');
  overviewList.innerHTML = '';
  const allCritiques = document.querySelectorAll('#critique-data div[data-id]');
  populateCategoryDropdown(document.getElementById('new-critique-category-select'));
  if (allCritiques.length === 0) {
    overviewList.innerHTML = `<div class="empty-state-message">您的評語庫目前是空的。<br>請使用上方的「新增評語項目」或「導入」功能來建立您的第一個評語。</div>`;
    return;
  }
  const critiquesByCategory = {};
  allCritiques.forEach(critiqueEl => {
    const category = critiqueEl.dataset.category || '未分類';
    if (!critiquesByCategory[category]) critiquesByCategory[category] = [];
    critiquesByCategory[category].push(critiqueEl);
  });
  
  const sortedCategoryNames = Object.keys(critiquesByCategory).sort((a, b) => {
    const indexA = CATEGORY_ORDER.indexOf(a);
    const indexB = CATEGORY_ORDER.indexOf(b);
    if (indexA > -1 && indexB > -1) return indexA - indexB;
    if (indexA > -1) return -1;
    if (indexB > -1) return 1;
    return a.localeCompare(b);
  });

  sortedCategoryNames.forEach(categoryName => {
    const categoryGroup = document.createElement('details');
    categoryGroup.className = 'category-group';
    categoryGroup.open = true;
    categoryGroup.innerHTML = `<summary><h3>${categoryName}</h3></summary>`;
    const categoryContent = document.createElement('div');
    categoryContent.className = 'category-content';
    critiquesByCategory[categoryName].forEach(critiqueEl => {
      const id = critiqueEl.dataset.id;
      const type = critiqueEl.dataset.type;
      const title = critiqueEl.querySelector('h4')?.textContent || critiqueEl.dataset.title || '(無標題)';
      const currentCat = critiqueEl.dataset.category || '';
      const optionsRaw = (critiqueEl.dataset.options || '');
      const optionsLabel = critiqueEl.dataset.optionsLabel || '';

      const wrapper = document.createElement('details');
      wrapper.className = `overview-item ${type === 'problem' ? 'is-problem' : 'is-excellent'}`;
      wrapper.open = false;
      const header = document.createElement('summary');
      header.innerHTML = `${title} <span class="badge">${critiqueEl.dataset.category}</span>`;
      wrapper.appendChild(header);

      const body = document.createElement('div');
      body.className = 'overview-body';
      
      const headerGrid = document.createElement('div');
      headerGrid.style.cssText = 'display: grid; grid-template-columns: 1fr auto auto; gap: 10px; align-items: end; margin-bottom: 15px;';
      
      const titleGroup = document.createElement('div');
      titleGroup.className = 'overview-row';
      titleGroup.style.marginBottom = '0';
      titleGroup.innerHTML = `<label>項目標題</label><input type="text" value="${escapeHtmlAttr(title)}" />`;
      
      const categoryGroup = document.createElement('div');
      categoryGroup.className = 'overview-row';
      categoryGroup.style.marginBottom = '0';
      categoryGroup.innerHTML = `<label>範疇分類</label><select></select>`;
      const categorySelect = categoryGroup.querySelector('select');
      populateCategoryDropdown(categorySelect, currentCat);
      
      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'danger-btn';
      deleteBtn.textContent = '刪除';
      
      headerGrid.appendChild(titleGroup);
      headerGrid.appendChild(categoryGroup);
      headerGrid.appendChild(deleteBtn);
      
      const inputTitle = titleGroup.querySelector('input');
      inputTitle.addEventListener('input', () => {
        const h4 = critiqueEl.querySelector('h4');
        if (h4) h4.textContent = inputTitle.value;
        else critiqueEl.dataset.title = inputTitle.value;
        rebuildChecklistAndOutputsDebounced();
        header.innerHTML = `${inputTitle.value} <span class="badge">${critiqueEl.dataset.category}</span>`;
        isDataDirty = true;
        updateUIBasedOnAuthState();
      });

      categorySelect.addEventListener('change', () => {
          let newCategory = categorySelect.value;
          if (newCategory === '__new__') {
              newCategory = prompt('請輸入新的分類名稱：', '');
              if (newCategory) {
                  critiqueEl.dataset.category = newCategory;
                  isDataDirty = true;
                  updateUIBasedOnAuthState();
                  buildOverviewPage();
              } else {
                  categorySelect.value = critiqueEl.dataset.category;
              }
          } else {
              critiqueEl.dataset.category = newCategory;
              isDataDirty = true;
              updateUIBasedOnAuthState();
              buildOverviewPage();
          }
      });

      deleteBtn.onclick = () => confirmUI(`確定要永久刪除「${title}」這個評語項目嗎？此操作無法復原。`, () => deleteCritique(id));

      const fieldsBox = document.createElement('div');
      fieldsBox.style.cssText = 'border:1px solid var(--border-color); border-radius:8px; background:#fff; padding:12px;';
      const isExcellent = type === 'excellent';
      fieldsBox.innerHTML = `
        <h5 style="margin:0 0 8px 0; color:var(--title-color);">來源欄位</h5>
        <div class="overview-row" style="display:${isExcellent ? 'block' : 'none'};"><label>優點總結 (可用 [選項1], [選項2]..)</label><textarea data-field="strengthSummary">${critiqueEl.dataset.strengthSummary || ''}</textarea></div>
        <div class="overview-row" style="display:${isExcellent ? 'none' : 'block'};"><label>問題 (可用 [選項1], [選項2]..)</label><textarea data-field="problemCore">${critiqueEl.dataset.problemCore || ''}</textarea></div>
        <div class="overview-row" style="display:${isExcellent ? 'none' : 'block'};"><label>宜 (可用 [選項1], [選項2]..)</label><textarea data-field="suggestion">${critiqueEl.dataset.suggestion || ''}</textarea></div>
        <div class="overview-row"><label>例子（每行一條）</label><textarea data-field="example">${(critiqueEl.dataset.example || '').replace(/<p>/g, '').replace(/<\/p>/g, '\n').replace(/例：/g, '')}</textarea></div>
        <div class="overview-row"><label>下拉選項的描述文字 (用 | 分隔多個)</label><textarea data-field="optionsLabel" placeholder="例如：困難情節|描寫角度">${optionsLabel}</textarea></div>
        <div class="overview-row"><label>下拉選項 (每行一項，用 | 分隔多組)</label><textarea data-field="options" placeholder="天氣突變&#10;體力透支&#10;其他&#10;|&#10;正面&#10;側面">${optionsRaw}</textarea></div>`;
      
      body.appendChild(headerGrid);
      body.appendChild(fieldsBox);
      fieldsBox.querySelectorAll('textarea[data-field]').forEach(ta => {
        ta.addEventListener('input', () => {
          const payload = {}; payload[ta.dataset.field] = ta.value;
          setCritiqueData(id, payload);
          rebuildChecklistAndOutputsDebounced();
        });
      });
      wrapper.appendChild(body);
      categoryContent.appendChild(wrapper);
    });
    categoryGroup.appendChild(categoryContent);
    overviewList.appendChild(categoryGroup);
  });
}

let rebuildTimer = null;
function rebuildChecklistAndOutputsDebounced() {
  clearTimeout(rebuildTimer);
  rebuildTimer = setTimeout(() => {
    buildChecklist();
    updateAllOutputs();
  }, 120);
}

function bindOverviewEvents() {
  document.querySelectorAll('input[name="new-critique-type"]').forEach(radio => {
    radio.addEventListener('change', (e) => {
      document.querySelectorAll('#new-critique-fields [data-type-scope]').forEach(el => el.style.display = 'none');
      document.querySelectorAll(`#new-critique-fields [data-type-scope="${e.target.value}"]`).forEach(el => el.style.display = 'block');
    });
  });
  document.getElementById('new-critique-category-select').addEventListener('change', (e) => {
    document.getElementById('new-critique-category-new-wrapper').style.display = e.target.value === '__new__' ? 'block' : 'none';
  });
}

function addNewCritique() {
  const title = document.getElementById('new-critique-title').value.trim();
  const type = document.querySelector('input[name="new-critique-type"]:checked').value;
  const categorySelect = document.getElementById('new-critique-category-select');
  let category = categorySelect.value === '__new__' ? document.getElementById('new-critique-category-new').value.trim() : categorySelect.value;
  if (!title || !category) {
    alert('「評語標題」和「範疇分類」為必填項目。');
    return;
  }
  const newCritiqueDiv = document.createElement('div');
  newCritiqueDiv.dataset.id = 'custom_' + Date.now();
  newCritiqueDiv.dataset.type = type;
  newCritiqueDiv.dataset.category = category;
  newCritiqueDiv.innerHTML = `<h4>${title}</h4>`;
  document.querySelectorAll('#new-critique-fields textarea[data-field]').forEach(ta => {
    if (ta.value.trim()) newCritiqueDiv.dataset[ta.dataset.field] = ta.value.trim();
  });
  document.getElementById('critique-data').appendChild(newCritiqueDiv);
  document.getElementById('new-critique-title').value = '';
  document.getElementById('new-critique-category-new').value = '';
  document.querySelectorAll('#new-critique-fields textarea').forEach(ta => ta.value = '');
  document.getElementById('add-critique-section').open = false;
  buildOverviewPage();
  buildChecklist();
  updateAllOutputs();
  isDataDirty = true;
  updateUIBasedOnAuthState();
  alert('新評語項目已成功新增！');
}

function collectExportData() {
  return Array.from(document.querySelectorAll('#critique-data div[data-id]')).map(el => ({
    id: el.dataset.id, category: el.dataset.category, type: el.dataset.type,
    title: el.querySelector('h4')?.textContent || el.dataset.title || '',
    strengthSummary: el.dataset.strengthSummary || '', problemCore: el.dataset.problemCore || '',
    suggestion: el.dataset.suggestion || '', example: el.dataset.example || '',
    options: el.dataset.options || '', optionsLabel: el.dataset.optionsLabel || '',
  }));
}

/* --- 清空與手動編輯 --- */
function handleManualEdit(which) {
  const ta = which === 'full' ? document.getElementById('full-output') : document.getElementById('student-report-output');
  if (ta) ta.dataset.userEditing = '1';
}

// [v19.7] 清空功能 (強制隱藏所有展開的編輯框)
function clearAllCore(doUpdate = true) {
  // 1. 清空一般輸入框
  document.getElementById('unique-comment').value = '';
  ['score-content','score-expression','score-structure','score-punctuation','score-typos','score-total'].forEach(id=>{ const el = document.getElementById(id); if (el) el.value='';});
  
  // 2. 清空錯別字
  currentTypos = [];
  renderTypoList();
  
  // 3. 🔥 強制處理 Checkbox 與 編輯框
  // A. 取消所有勾選
  document.querySelectorAll('#checklist-container input[type="checkbox"]').forEach(cb => { 
    cb.checked = false; 
  });

  // B. 🔥 暴力隱藏所有「下拉選單區」
  document.querySelectorAll('.interactive-module').forEach(div => {
      div.style.display = 'none';
      // 順手重置裡面的選單
      div.querySelectorAll('select').forEach(s => s.selectedIndex = 0);
      div.querySelectorAll('input').forEach(i => i.value = '');
  });

  // C. 🔥 暴力隱藏所有「編輯框 (Textarea)」
  document.querySelectorAll('.editable-comment').forEach(div => {
      div.style.display = 'none';
      const ta = div.querySelector('textarea');
      if(ta) ta.value = ''; // 清空內容
  });

  // 4. 清空常見錯別字勾選
  document.querySelectorAll('#typo-saved-list input[type="checkbox"]').forEach(cb => cb.checked = false);
  
  // 5. 更新輸出 (清空總評語)
  if (doUpdate) {
    renderCommonTyposCheckedState();
    updateAllOutputs();
  }
}

/* ======================================================== */
/* ====== 導入導出相關功能 (Excel & JSON & Word) ====== */
/* ======================================================== */

/* [v17.5] 檔名生成器 (格式：[類型] ([班別])_([題目])) */
function getSanitizedTopicFilename(typePrefix) {
    const topic = document.getElementById('topic').value.trim() || '未命名題目';
    // 優先讀取 Page 1 班級，讀唔到就讀手動欄
    const select = document.getElementById('student-class'); // Page 2 hidden input
    const p1Select = document.getElementById('setup-class-select');
    
    let className = '未命名班級';
    
    if (select && select.value) className = select.value;
    else if (p1Select && p1Select.selectedIndex > 0) className = p1Select.options[p1Select.selectedIndex].dataset.className || p1Select.value;

    // 清洗檔名 (移除 / \ : * ? " < > |)
    const safeTopic = topic.replace(/[\\/:*?"<>|]/g, '');
    const safeClass = className.replace(/[\\/:*?"<>|]/g, '');
    
    // 格式：[類型] (班級)_(題目)
    return `${typePrefix} (${safeClass})_(${safeTopic})`;
}

function getDateTimeString() {
  const d = new Date();
  const pad = n => n.toString().padStart(2,'0');
  return `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}_${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}`;
}

function checkXlsxLibrary() {
    if (typeof XLSX === 'undefined') {
        alert('處理 Excel 功能初始化失敗。\n請檢查網絡連線，然後重新整理頁面。');
        return false;
    }
    return true;
}

function handleFileImport(file, onDataReady) {
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => onDataReady(e.target.result);
    reader.onerror = (error) => alert('讀取檔案失敗！');
    reader.readAsText(file, 'UTF-8');
}

function downloadFile(filename, content, mimeType) {
    const blob = new Blob([content], { type: mimeType });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function exportOverviewToExcel() {
    if (!checkXlsxLibrary()) return;
    const savedRecords = allStudentRecords.filter(r => r.data);
    if (savedRecords.length === 0) { alert('沒有任何已儲存的學生記錄可供匯出。'); return; }
    savedRecords.sort((a, b) => (a.number || 999) - (b.number || 999));
    
    const dataToExport = savedRecords.map(record => {
        const s = record.data.scores;
        return {
            '學號': record.number, '姓名': record.name, 
            '內容': s.content, '表達': s.expression, '結構': s.structure, '標點': s.punctuation, '錯別字': s.typos, '總分': s.total, 
            '評語': record.data.pureStudentComment
        };
    });
    const wsMain = XLSX.utils.json_to_sheet(dataToExport);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, wsMain, '總覽');
    
    // 🔥 使用統一檔名
    XLSX.writeFile(wb, getSanitizedTopicFilename('學生評語總覽') + '.xlsx');
}

function textToWordHtmlWithLists(text) {
    if (!text) return '';
    const lines = text.split('\n');
    let html = '';
    let inList = false;
    let listType = '';
    for (const line of lines) {
        const trimmedLine = line.trim();
        let isListItem = false;
        let currentListType = '';
        if (trimmedLine.startsWith('- ') || trimmedLine.startsWith('* ')) { isListItem = true; currentListType = 'ul'; }
        else if (/^\(\d+\)/.test(trimmedLine) || /^\d+\./.test(trimmedLine)) { isListItem = true; currentListType = 'ol'; }
        if (isListItem) {
            if (!inList || listType !== currentListType) {
                if (inList) html += `</${listType}>`;
                html += `<${currentListType}>`;
                inList = true;
                listType = currentListType;
            }
            html += `<li>${escapeHtml(trimmedLine.replace(/^[-*]\s*|^\(\d+\)\s*|^\d+\.\s*/, ''))}</li>`;
        } else {
            if (inList) { html += `</${listType}>`; inList = false; }
            html += `<p>${escapeHtml(line)}</p>`;
        }
    }
    if (inList) html += `</${listType}>`;
    return html.replace(/<p><\/p>/g, '');
}

function exportOverviewToWord() {
  const records = allStudentRecords.filter(r => r.data);
  if (records.length === 0) {
    alert('沒有任何已儲存的學生記錄可供匯出。');
    return;
  }
  records.sort((a, b) => (a.number || 999) - (b.number || 999));
  const topic = document.getElementById('topic').value.trim() || '未命名文章';
  const className = records[0].data.class || document.getElementById('student-class').value || '未指定班別';

  /**
   * 1. 智能分析函數 (保留原樣)
   */
  function formatSmartComment(text) {
    if (!text) return '—';
    
    const lines = text.split('\n').map(l => l.trim()).filter(l => l);
    let html = '';
    let isListOpen = false;

    lines.forEach(line => {
        const isBulletItem = /^(問題|宜|例|建議|優點|缺點|表現)[:：]/.test(line) || line.startsWith('•');
        const isHeader = line.startsWith('【');

        if (isBulletItem) {
            if (!isListOpen) { html += '<ul>'; isListOpen = true; }
            html += `<li>${escapeHtml(line)}</li>`;
        } else {
            if (isListOpen) { html += '</ul>'; isListOpen = false; }

            if (isHeader) {
                html += `<div class="comment-title">${escapeHtml(line)}</div>`;
            } else {
                html += `<div class="comment-text">${escapeHtml(line)}</div>`;
            }
        }
    });

    if (isListOpen) { html += '</ul>'; }
    return html;
  }

  /**
   * 2. HTML 生成代碼 (完全保留原本格式與字體設定)
   */
  let content = `<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:w="urn:schemas-microsoft-com:office:word" xmlns="http://www.w3.org/TR/REC-html40">
<head>
<meta charset="utf-8" />
<title>學生評語-${escapeHtmlAttr(topic)}</title>
<style>
    /* --- A4 頁面設定 --- */
    @page { size: 210mm 297mm; margin: 1cm; }
    
    /* --- 全局字體 --- */
    body { 
        font-family: "ThePeakFontBeta", "FangSong", "PMingLiU", serif; 
        font-size: 12pt; 
        line-height: 1.5; 
        font-weight: normal; 
    }

    /* --- 樣式設定 --- */
    .label-bold { font-weight: bold; }
    .topic-section { margin-bottom: 12pt; }
    .student-info-section { margin-bottom: 4pt; text-align: left; }

    .comment-title {
        font-weight: bold;
        margin-top: 12pt;
        margin-bottom: 4pt;
        text-align: left;
    }
    .comment-text {
        margin-top: 4pt;
        margin-bottom: 2pt;
        text-align: left;
    }

    ul { margin: 2pt 0 4pt 24pt; padding: 0; list-style-type: disc; }
    li { margin-bottom: 2pt; }

    .line { border-top: 1px solid #000; margin: 8pt 0; }
    .box {
        border: 1px solid #000;
        padding: 8pt 10pt;
        margin: 8pt 0;
        font-size: 11pt;
    }

    table.score {
        width: 100%;
        border-collapse: collapse;
        margin: 8pt 0;
        font-size: 10.5pt;
    }
    table.score th, table.score td {
        border: 1px solid #000;
        padding: 4pt 6pt;
        text-align: center;
    }

    .section-title { font-weight: normal; margin: 10pt 0 4pt 0; font-size: 12pt; }

    /* === Dashboard Edit Button === */
.dashboard-edit-btn {
  background: transparent;
  border: 1px solid transparent;
  color: #aaa;
  cursor: pointer;
  font-size: 1.1rem;
  padding: 4px 8px;
  border-radius: 4px;
  transition: all 0.2s;
  z-index: 10; /* 確保在最上層 */
}
.dashboard-edit-btn:hover {
  background-color: rgba(0,0,0,0.05);
  color: var(--accent-color);
  border-color: #ddd;
}
/* 防止點擊按鈕時觸發父層的 onclick */
.task-item, .class-group-content > div {
  position: relative; /* 讓絕對定位生效 (如有需要) */
}
  
/* === Phase 2.2 新增樣式 (新開作業頁面) === */
.setup-mode-switch {
  display: flex;
  gap: 20px;
  margin-bottom: 20px;
  padding: 15px;
  background: #fdfbf7;
  border: 1px solid #e1d8c8;
  border-radius: 10px;
}

.setup-mode-switch label {
  cursor: pointer;
  font-weight: bold;
  color: #5b5044;
  display: flex;
  align-items: center;
  gap: 8px;
}

.student-checklist-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
  gap: 10px;
  margin-top: 15px;
  max-height: 300px;
  overflow-y: auto;
  padding: 10px;
  border: 1px solid #eee;
  border-radius: 8px;
  background: #fff;
}


.student-check-card:hover {
  background-color: #f7f3eb;
  border-color: #5A8F7B;
}

.student-check-card.checked {
  background-color: #e8f5e9;
  border-color: #5A8F7B;
  color: #2e7d32;
  font-weight: bold;
}
/* [v11.10] 緊急修復：遮擋與排版 */

/* 1. 設定選單 (使用 fixed 定位，脫離父層限制) */
.settings-menu-popover {
    position: fixed !important; /* 終極手段 */
    top: 70px !important;
    right: 20px !important;
    left: auto !important; /* 確保唔會受 left 影響 */
    z-index: 2147483647 !important; /* 瀏覽器最大值 */
    box-shadow: 0 20px 60px rgba(0,0,0,0.4) !important;
}

/* 2. 常用評語 (強制獨佔一行 + 樣式微調) */
/* 選擇器特指 "常用評語" 那個 details */
details.category-group[style*="border: 2px solid"] {
    grid-column: 1 / -1 !important; /* 橫跨所有欄位 */
    width: 100%;
    margin-bottom: 25px; /* 同下面分開啲 */
    order: -1; /* 強制排最前 */
}

/* 確保常用評語預設收合 (可選) */
/* 如果你想預設收埋，請在 JS 改 open = false，或者手動撳 */

/* =========================================
   [v13.0] 頂部導航修復 & 懸浮文字特效
   請將此段貼在 CSS 文件最底部以確保生效
   ========================================= */

/* 1. 容器設定：修復手機版間距與切邊問題 */
.sub-nav-island {
    display: flex !important; /* 強制 Flex 排列 */
    justify-content: space-between;
    align-items: center;
    width: 95%;
    max-width: 380px;
    margin: 0 auto 20px auto; /* 居中 */
    padding: 10px 15px;
    background: rgba(255, 255, 255, 0.6); /* 半透明白底 */
    backdrop-filter: blur(10px);
    border-radius: 50px; /* 圓潤外型 */
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    box-sizing: border-box;
}

/* 2. 按鈕基本設定 */
.sub-nav-island .nav-item {
    position: relative; /* 這是為了讓文字可以定位 */
    flex: 1;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 10px 0;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* 彈性動畫 */
    background: transparent; /* 預設無背景 */
    border-radius: 50%; /* 圓形按鈕 */
    height: 50px; /* 固定高度確保圓形 */
    width: 50px;  /* 固定寬度 */
    max-width: 50px; /* 鎖定寬度防止撐開 */
}

/* Emoji 圖標大小 */
.sub-nav-island .nav-item .nav-icon {
    font-size: 1.4rem;
    z-index: 2; /* 確保圖標在最上層 */
}

/* 3. [重點] 懸浮文字 (Floating Label) */
.sub-nav-island .nav-item .nav-text {
    position: absolute;
    top: -35px; /* 初始位置：在圖標上方 */
    left: 50%;
    transform: translateX(-50%) scale(0.8); /* 居中並縮小 */
    background-color: #333; /* 深色背景氣泡 */
    color: #fff;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 0.75rem;
    white-space: nowrap;
    opacity: 0; /* 平時隱藏 */
    visibility: hidden;
    transition: all 0.3s ease;
    pointer-events: none; /* 防止擋住點擊 */
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}

/* 加個小三角形指住下面 (Speech Bubble effect) */
.sub-nav-island .nav-item .nav-text::after {
    content: '';
    position: absolute;
    bottom: -4px;
    left: 50%;
    transform: translateX(-50%);
    border-width: 4px 4px 0;
    border-style: solid;
    border-color: #333 transparent transparent transparent;
}

/* 4. Active (被選中) 狀態 */
.sub-nav-island .nav-item.active {
    background-color: #fff; /* 選中時變白底 */
    box-shadow: 0 4px 12px rgba(0,0,0,0.1); /* 加陰影 */
    transform: translateY(-2px); /* 輕微浮起 */
}

/* 選中時，文字飄出來 */
.sub-nav-island .nav-item.active .nav-text {
    opacity: 1;
    visibility: visible;
    top: -42px; /* 向上飄一點點 */
    transform: translateX(-50%) scale(1); /* 變回原大 */
}

/* 手機版微調 */
@media (max-width: 768px) {
    .sub-nav-island {
        gap: 5px; /* 按鈕之間的間距 */
    }
}


/* =========================================
   [v14.0] 主導航欄 (Main Nav) 懸浮特效
   專門針對 .main-nav 及其按鈕設計
   ========================================= */

/* 1. 導航欄底座 (Island) */
.main-nav {
    display: flex;
    justify-content: space-between; /* 平均分佈 */
    align-items: center;
    width: 90%;
    max-width: 380px; /* 限制最大寬度，唔好太闊 */
    margin: 0 auto;   /* 居中 */
    padding: 10px 20px;
    
    /* 懸浮島外觀 */
    background: rgba(255, 255, 255, 0.85); /* 透白底 */
    backdrop-filter: blur(12px); /* 磨砂玻璃效果 */
    border-radius: 60px; /* 圓潤邊角 */
    box-shadow: 0 10px 30px rgba(0,0,0,0.1); /* 柔和陰影 */
    
    /* 固定在底部 (如果你想佢黐住底，可以保留呢幾行) */
    position: fixed;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 1000;
}

/* 2. 按鈕重置與設定 */
.main-nav .nav-btn {
    position: relative; /* 關鍵：為咗定位飄起嘅文字 */
    background: transparent;
    border: none;
    outline: none;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    width: 50px;
    height: 50px;
    border-radius: 50%; /* 圓形 */
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* 彈跳動畫 */
    padding: 0;
    -webkit-tap-highlight-color: transparent; /* 移除手機點擊藍框 */
}

/* Emoji 圖標大小 */
.main-nav .nav-btn .nav-icon {
    font-size: 1.6rem;
    line-height: 1;
    z-index: 2;
    transition: transform 0.3s ease;
}

/* 3. [核心] 飄起文字 (Floating Text) */
.main-nav .nav-btn .nav-text {
    position: absolute;
    top: -10px; /* 初始位置：同 Emoji 重疊或稍高 */
    left: 50%;
    transform: translateX(-50%) scale(0.5); /* 縮細 */
    
    background-color: #2c3e50; /* 深色氣泡底 */
    color: #fff;
    font-size: 0.75rem;
    font-weight: 500;
    padding: 5px 10px;
    border-radius: 12px;
    white-space: nowrap;
    
    opacity: 0; /* 平時隱藏 */
    visibility: hidden;
    pointer-events: none;
    transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}

/* 氣泡下面個小三角形 */
.main-nav .nav-btn .nav-text::after {
    content: '';
    position: absolute;
    bottom: -4px;
    left: 50%;
    transform: translateX(-50%);
    border-width: 4px 4px 0;
    border-style: solid;
    border-color: #2c3e50 transparent transparent transparent;
}

/* 4. Active (被選中) 狀態特效 */
.main-nav .nav-btn.active {
    background-color: #fff; /* 選中時按鈕變白底 */
    box-shadow: 0 5px 15px rgba(0,0,0,0.15); /* 加強陰影 */
    transform: translateY(-5px); /* 成個掣浮起 */
}

/* 選中時，文字飄上去 */
.main-nav .nav-btn.active .nav-text {
    opacity: 1;
    visibility: visible;
    top: -45px; /* 向上飄到頭頂 */
    transform: translateX(-50%) scale(1); /* 變回原大 */
}

/* 選中時，Emoji 稍微縮細少少，讓路俾個氣泡 */
.main-nav .nav-btn.active .nav-icon {
    transform: scale(0.9);
}
    /* ========================================= */
/* === [v17.0] 視覺大修復 (CSS Polish) === */
/* ========================================= */

/* 1. 修復 Pop-up 按鈕斷行問題 */
.pop-footer {
    display: flex;
    justify-content: center;
    gap: 10px;
    flex-wrap: wrap; /* 允許換行 */
}
.pop-btn {
    white-space: normal; /* 文字可換行 */
    line-height: 1.2;
    padding: 10px 20px;
    height: auto;
    min-height: 44px;
}

/* 2. AI 頁面：左右欄比例調整 (左大右小) */
@media (min-width: 900px) {
    .ai-page-grid {
        grid-template-columns: 1.6fr 1fr !important; /* 左邊佔更多 */
    }
}
/* 右欄按鈕不要拉太長 */
.ai-magic-card button {
    max-width: 100%;
}



/* 4. Dashboard Project Card 進度條修復 */
.task-progress {
    width: 100%;
    margin-top: 10px;
}
.task-progress-bar-bg {
    width: 100%; height: 6px; background: #eee; border-radius: 99px; overflow:hidden;
}
.task-progress-bar-fill {
    height: 100%; background: var(--accent-color); border-radius: 99px;
}
/* ========================================= */
/* === [v17.1] 視覺與排版終極修正 === */
/* ========================================= */

/* 1. AI 烘焙室：左大右小 (65% : 35%) */
@media (min-width: 900px) {
    .ai-page-grid {
        grid-template-columns: 2fr 1fr !important; /* 左邊更闊 */
    }
}

/* 2. Pop-up 按鈕文字換行 (解決顯示不全) */
.pop-btn {
    white-space: normal !important;
    height: auto !important;
    min-height: 44px;
    line-height: 1.3 !important;
    text-align: center;
}

/* 3. 預設隱藏所有頁面 (解決 F5 閃爍跳頁問題) */
/* 配合 JS，載入完成前不顯示任何 Page，防止看到 Page 1 閃現 */
.page-content {
    display: none !important;
}
.page-content.active {
    display: block !important;
}

/* 4. 罐頭評語選擇框美化 (Generic Modal List) */
/* 限制高度，加 Scroll，防止頂出螢幕 */
#pop-generic-input-container {
    max-height: 50vh;
    overflow-y: auto;
    border: 1px solid #eee;
    border-radius: 8px;
    padding: 5px;
    margin-bottom: 15px;
    background: #fafafa;
}

/* 2. Pop-up 按鈕字體縮細 (防止斷行) */
.pop-btn {
    font-size: 0.9rem !important; /* 縮細 */
    padding: 8px 16px !important;
    white-space: nowrap !important; /* 強制不換行 */
    min-width: auto !important;
}
/* 進度還原 Modal 的按鈕寬度 */
#pop-restore-modal .pop-btn {
    min-width: 120px;
}
/* 3. 最近作業連結 (P8) */
.recent-link {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    background: #f0fdf4;
    color: #15803d;
    padding: 4px 10px;
    border-radius: 99px;
    font-size: 0.85rem;
    cursor: pointer;
    border: 1px solid #bbf7d0;
    margin-top: 10px;
    text-decoration: none;
    transition: all 0.2s;
}
.recent-link:hover {
    background: #dcfce7;
    transform: translateX(2px);
}

/* ========================================= */
/* === [v18.2] 排版與去線 (Final Fix) === */
/* ========================================= */

/* 1. Header 右側按鈕強制並列 (Side-by-side) */
.header-right {
    display: flex !important;       /* 強制 Flex 佈局 */
    flex-direction: row !important; /* 強制橫向排列 */
    align-items: center !important; /* 垂直置中 */
    gap: 12px !important;           /* 按鈕之間的間距 */
    
    /* 確保手機版定位正確 */
    position: absolute;
    top: 20px;
    right: 20px;
}

/* 確保書籤掣在 Desktop 也能顯示 (如果你想 Desktop 都有) */
/* 如果只想手機有，保持原本 media query 即可；這裡強制對齊樣式 */
.header-book-btn {
    margin-right: 0 !important; /* 移除舊 margin，改用 gap */
    margin-bottom: 0 !important;
    position: relative !important; /* 防止絕對定位亂跑 */
    top: auto !important;
    right: auto !important;
}

/* [v18.10] 強制隱藏舊版切換器 (靈魂頁面殺手) */
#project-switcher-container, #project-switcher {
    display: none !important;
    visibility: hidden !important;
    pointer-events: none !important;
}


</style>
</head>
<body>`;

  records.forEach((record, idx) => {
    const s = record.data.scores || {};
    
    // ========== 修正的地方在這裡 (開始) ==========
    // 原本的程式碼把錯別字物件當成字串處理導致報錯，這裡修正為正確讀取物件
    let typoHtml = "本次沒有記錄錯別字。";
    if (record.data.typos && record.data.typos.length > 0) {
        typoHtml = '<ul>' + record.data.typos.map(t => {
            // 判斷是物件還是字串，防止報錯
            let displayText = '';
            if (typeof t === 'object') {
                const w = t.wrong || '';
                const c = t.correct || '（未填正字）';
                displayText = `${w}→${c}`;
            } else {
                displayText = String(t).replace(/^\d+\.\s*/, '');
            }
            return `<li>${escapeHtml(displayText)}</li>`;
        }).join('') + '</ul>';
    }
    // ========== 修正的地方在這裡 (結束) ==========

    // 評語
    const commentHtml = formatSmartComment(record.data.pureStudentComment);

    // 分頁
    if (idx > 0) content += `<br style="page-break-before:always" />`;

    content += `
      <div class="student-page">
        
        <div class="topic-section">
            <span class="label-bold">題目：</span>${escapeHtml(topic)}
        </div>
        <br>
        <div class="student-info-section">
            <span class="label-bold">班別：</span>${escapeHtml(record.data.class || className)}　　
            <span class="label-bold">學號：</span>${escapeHtml(record.number != null ? String(record.number) : '')}　　
            <span class="label-bold">姓名：</span>${escapeHtml(record.name)}
        </div>
      
        <p class="section-title">一、分數概覽</p>
        <table class="score">
            <tr><th>內容</th><th>表達</th><th>結構</th><th>標點</th><th>錯別字</th><th>總分</th></tr>
            <tr>
                <td>${escapeHtmlAttr(s.content||'')}</td>
                <td>${escapeHtmlAttr(s.expression||'')}</td>
                <td>${escapeHtmlAttr(s.structure||'')}</td>
                <td>${escapeHtmlAttr(s.punctuation||'')}</td>
                <td>${escapeHtmlAttr(s.typos||'')}</td>
                <td>${escapeHtmlAttr(s.total||'')}</td>
            </tr>
        </table>

        <div class="line"></div>
        
        <p class="section-title">二、錯別字記錄</p>
        <div class="box">${typoHtml}</div>
        
        <p class="section-title">三、回饋</p>
        <div class="box">${commentHtml}</div>
        
      </div>`;
  });

  const filename = getSanitizedTopicFilename('學生評語_學生版') + '.doc';
    downloadFile(filename, content, 'application/msword;charset=utf-8');
}


function exportAnalysisToExcel() {
  if (!checkXlsxLibrary()) return;
  const data = getAnalysisData();
  if (!data) {
    alert('目前尚未有已儲存的學生評語，無法匯出分析。');
    return;
  }
  const wb = XLSX.utils.book_new();
  const scoreRows = data.scoreSummary.map(r=>({ 指標: r.指標, 平均分: r.平均分 == null ? '' : Number(r.平均分.toFixed(2)) }));
  const wsScore = XLSX.utils.json_to_sheet(scoreRows);
  XLSX.utils.book_append_sheet(wb, wsScore, '分數平均');
  const wsTop = XLSX.utils.json_to_sheet(data.topEntries);
  XLSX.utils.book_append_sheet(wb, wsTop, '評語TOP10');
  const className = (allStudentRecords.find(r=>r.data)?.data.class) || document.getElementById('student-class').value || '未指定班別';
 XLSX.writeFile(wb, getSanitizedTopicFilename('評語分析數據') + '.xlsx');
}

function buildTeachingHintFromAnalysis(data) {
  if (!data) return '目前樣本較少，建議待更多作品批改後再進一步分析。';
  let lines = [];
  const avgTotal = data.scoreSummary.find(r=>r.指標==='總分')?.平均分;
  if (avgTotal != null) lines.push(`本班已批改作品 ${data.studentCount} 份，平均總分約為 ${avgTotal.toFixed(1)} 分。`);
  const lowOnes = data.scoreSummary.filter(r=>r.平均分 != null && r.指標!=='總分').sort((a,b)=>a.平均分 - b.平均分).slice(0,2);
  if (lowOnes.length) lines.push(`在各評分項目中，以「${lowOnes.map(r=>r.指標).join('、')}」的平均分數相對較低，可作為下階段補救教學重點。`);
  if (data.topEntries.length) lines.push(`最常被勾選的評語為「${data.topEntries[0].評語標題}」（共 ${data.topEntries[0].被選次數} 次），反映此為普遍問題或優點，值得課堂上跟進。`);
  return lines.join('\n');
}

function exportAnalysisToWord() {
  const data = getAnalysisData();
  if (!data) {
    alert('目前尚未有已儲存的學生評語，無法匯出分析。');
    return;
  }
  const topic = document.getElementById('topic').value.trim() || '未命名文章';
  const className = (allStudentRecords.find(r=>r.data)?.data.class) || document.getElementById('student-class').value || '未指定班別';
  const hint = buildTeachingHintFromAnalysis(data);
  const dateStr = new Date().toLocaleDateString('zh-Hant');
  let content = `<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:w="urn:schemas-microsoft-com:office:word" xmlns="http://www.w3.org/TR/REC-html40"><head><meta charset="utf-8" /><title>評語分析-${escapeHtmlAttr(topic)}</title><style>body{font-family:"PMingLiU","新細明體","Microsoft JhengHei",sans-serif;font-size:11pt;line-height:1.6;}h1{font-size:16pt;margin-bottom:6pt;}h2{font-size:14pt;border-bottom:1px solid #000;padding-bottom:3pt;margin-top:15pt;}h3{font-size:12pt;margin-top:12pt;}.meta-line{margin:2pt 0;}pre{font-family:inherit;white-space:pre-wrap;border:1px solid #ccc;padding:8pt;background:#f9f9f9;}table{border-collapse:collapse;width:100%;margin:10pt 0;}th,td{border:1px solid #666;padding:5pt;text-align:left;vertical-align:top;}th{background-color:#f2f2f2;}</style></head><body><h1>評語分析備忘</h1><div class="meta-line">班別：${escapeHtml(className)}</div><div class="meta-line">題目：${escapeHtml(topic)}</div><div class="meta-line">日期：${escapeHtml(dateStr)}</div><div class="meta-line">已批改作品數：${data.studentCount}</div><h2>一、分數概覽</h2><table><tr><th>指標</th><th>平均分</th></tr>${data.scoreSummary.map(row => `<tr><td>${escapeHtml(row.指標)}</td><td>${row.平均分!=null?row.平均分.toFixed(2):'-'}</td></tr>`).join('')}</table>${data.topEntries.length>0?`<h2>二、最常見評語項目 TOP 10</h2><table><tr><th>排名</th><th>評語標題</th><th>被選次數</th></tr>${data.topEntries.map(row=>`<tr><td>${row.排名}</td><td>${escapeHtml(row.評語標題)}</td><td>${row.被選次數}</td></tr>`).join('')}</table>`:''}<h2>三、教學提示（草稿）</h2><pre>${escapeHtml(hint)}</pre></body></html>`;
    const filename = getSanitizedTopicFilename('評語分析報告') + '.doc';
    downloadFile(filename, content, 'application/msword;charset=utf-8');
}

// --- 修改開始: 修正 Excel 導出功能 ---
function downloadCritiqueTemplate() {
    if (!checkXlsxLibrary()) return;
    const ws = XLSX.utils.json_to_sheet([
        { id: "c1", category: "扣題與立意", type: "excellent", title: "扣題準確", strengthSummary: "能緊扣題目要求...", problemCore: "", suggestion: "", example: "文章題為...", options: "", optionsLabel: "" },
        { id: "c2", category: "扣題與立意", type: "problem", title: "立意膚淺", strengthSummary: "", problemCore: "立意不夠深刻...", suggestion: "可思考事件背後...", example: "只停留在...", options: "", optionsLabel: "" }
    ]);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, '評語庫範本');
    XLSX.writeFile(wb, '評語庫-範本.xlsx');
}
/**
 * 下載學生名單 Excel 範本
 */
function downloadStudentListTemplate() {
  // 檢查 XLSX 庫是否已載入
  if (!checkXlsxLibrary()) return;

  // 定義範本資料 (包含範例資料，讓使用者知道格式)
  const templateData = [
    { "班別": "6A", "學號": "01", "姓名": "陳大文" },
    { "班別": "6A", "學號": "02", "姓名": "李小美" }
  ];

  // 建立工作表
  const ws = XLSX.utils.json_to_sheet(templateData);
  
  // 建立工作簿並加入工作表
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "學生名單範本");

  // 下載檔案
  XLSX.writeFile(wb, "學生名單範本.xlsx");
}
function exportCritiquesToExcel() {
    if (!checkXlsxLibrary()) return;
    const dataToExport = collectExportData();
    if (dataToExport.length === 0) { 
        alert('評語庫目前為空，沒有內容可以導出。'); 
        return; 
    }
    const ws = XLSX.utils.json_to_sheet(dataToExport);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, '評語庫');
    XLSX.writeFile(wb, `評語庫-${getDateTimeString()}.xlsx`);
}

function exportProgressToExcel() {
  if (!checkXlsxLibrary() || !allStudentRecords.length) {
    alert('目前沒有學生名單，無法匯出進度。');
    return;
  }
  const rows = allStudentRecords.map(r => {
    const d = r.data || {}; const s = d.scores || {};
    return {
      studentNumber: r.number, studentName: r.name, originalName: r.originalName, class: d.class || '', topic: d.topic || '',
      uniqueComment: d.uniqueComment || '', scoreContent: s.content || '', scoreExpression: s.expression || '',
      scoreStructure: s.structure || '', scorePunctuation: s.punctuation || '', scoreTypos: s.typos || '', scoreTotal: s.total || '',
      typosJSON: JSON.stringify(d.typos || []), checkedCritiquesJSON: JSON.stringify(d.checkedCritiques || []),
      selectedTitles: d.selectedTitles || '', fullComment: d.fullComment || '', studentComment: d.studentComment || '',
      pureFullComment: d.pureFullComment || '', pureStudentComment: d.pureStudentComment || ''
    };
  });
  const ws = XLSX.utils.json_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, '評語進度');
  XLSX.writeFile(wb, `評語進度_${getDateTimeString()}.xlsx`);
}
// --- 修改結束 ---

function handleStudentListImport(event) {
    if (!checkXlsxLibrary()) return;
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            // ... (省略中間代碼，保持不變) ...
            
            const textarea = document.getElementById('student-names');
            textarea.value = studentList;
            textarea.dispatchEvent(new Event('input', { bubbles: true }));
            alert(`成功匯入 ${jsonData.length} 位學生！`);
            
            // 🔥 加入這一行！
            loadDashboard(); 

        } catch (error) { alert(`匯入學生名單失敗: ${error.message}`); } finally { event.target.value = ''; }
    };
    reader.readAsArrayBuffer(file);
}

function handleCritiqueImportExcel(event) {
    if (!checkXlsxLibrary()) return;
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const wb = XLSX.read(e.target.result, { type: 'array' });
            const wsname = wb.SheetNames[0];
            const ws = wb.Sheets[wsname];
            const jsonData = XLSX.utils.sheet_to_json(ws);
            if (jsonData.length > 0 && !['category', 'type', 'title'].every(field => field in jsonData[0])) {
                alert(`導入失敗！Excel 的標題行必須包含 'category', 'type', 'title'。`); return;
            }
            applyCritiquesToDOM(jsonData);
            buildOverviewPage(); buildChecklist(); updateAllOutputs();
            alert('評語庫已成功從 Excel 檔案導入！');
        } catch (error) { alert(`導入 Excel 失敗: ${error.message}`); }
    };
    reader.readAsArrayBuffer(file);
    event.target.value = '';
}

function exportCritiquesToJSON() {
    const dataToExport = collectExportData();
    if (dataToExport.length === 0) { alert('評語庫目前為空，沒有內容可以導出。'); return; }
    downloadFile(`評語庫-${getDateTimeString()}.json`, JSON.stringify(dataToExport, null, 2), 'application/json');
}

function handleCritiqueImportJSON(event) {
    handleFileImport(event.target.files[0], (fileContent) => {
        try {
            const data = JSON.parse(fileContent);
            const critiques = Array.isArray(data) ? data : data.items;
            if (!Array.isArray(critiques)) throw new Error("JSON 檔案格式不正確，找不到評語陣列。");
            applyCritiquesToDOM(critiques);
            buildOverviewPage(); buildChecklist(); updateAllOutputs();
            alert('評語庫已成功從 JSON 檔案導入！');
        } catch (error) { alert(`導入 JSON 失敗: ${error.message}`); }
    });
    event.target.value = '';
}

function handleProgressImportExcel(event) {
  if (!checkXlsxLibrary()) return;
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      // ... (省略中間代碼，保持不變) ...
      
      updateAllOutputs();
      isDataDirty = true;
      updateUIBasedOnAuthState();
      alert('評語進度已成功匯入。');

      // 🔥 加入這一行！
      loadDashboard();

    } catch (err) { alert('匯入進度失敗：' + err.message); } finally { event.target.value = ''; }
  };
  reader.readAsArrayBuffer(file);
}
function safeParseJSON(str) {
  if (!str) return [];
  try { return JSON.parse(str); } catch { return []; }
}

function escapeHtml(text) {
  if (!text && text !== 0) return "";
  return String(text).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;");
}
function escapeHtmlAttr(s) {
  return (s || '').toString().replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

/**
 * 構建 AI 回饋 Word HTML (權限調整版 - 2025 Final)
 * 學生版：只隱藏數據 (A2-A3) 及 教學計劃 (B3)，其他分析內容全開
 */
function _buildAiFeedbackWordHtml(aiData, mode) {
    const topic = document.getElementById('topic').value.trim() || '未命名文章';
    const className = (allStudentRecords.find(r => r.data)?.data.class) || '未指定班別';
    const dateStr = new Date().toLocaleDateString('zh-Hant');
    
    const mdToHtml = (text) => text ? text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>') : '';
    const listToHtml = (text) => textToWordHtmlWithLists(text);
    const analysis = getAnalysisData();

    // CSS 樣式
    const css = `
        <style>
            body { font-family: "Microsoft JhengHei", "PMingLiU", sans-serif; font-size: 11pt; line-height: 1.5; color: #000; }
            .doc-header { text-align: center; margin-bottom: 20pt; border-bottom: 3px double #000; padding-bottom: 10pt; }
            .main-title { font-size: 22pt; font-weight: bold; letter-spacing: 1px; margin-bottom: 5pt; }
            .sub-info { font-size: 12pt; margin-top: 10pt; }
            .section-title { font-size: 16pt; font-weight: bold; margin-top: 30pt; margin-bottom: 12pt; border-bottom: 2px solid #000; padding-bottom: 3pt; page-break-after: avoid; }
            .sub-title { font-size: 13pt; font-weight: bold; margin-top: 20pt; margin-bottom: 8pt; border-left: 6px solid #000; padding-left: 8pt; page-break-after: avoid; }
            table { width: 100%; border-collapse: collapse; margin-bottom: 15pt; }
            th, td { border: 1px solid #000; padding: 8pt; vertical-align: top; text-align: left; }
            th { background-color: #ffffff; font-weight: bold; text-align: center; border-bottom: 2px solid #000; }
            .example-font { font-family: "ThePeakFontBeta", "隨風體", "Sui Feng", "KaiTi", "BiauKai", serif; font-size: 12pt; line-height: 1.6; color: #333; }
            .sample-box { border: 1px solid #000; padding: 10pt; margin: 5pt 0 10pt 0; }
            .hint-box { border: 1px dashed #000; padding: 8pt; margin: 5pt 0 10pt 0; font-size: 10.5pt; }
            .teacher-only { border: 2px dashed #666; padding: 15pt; margin: 15pt 0; position: relative; background: transparent; }
            .teacher-tag { position: absolute; top: -12px; left: 10px; background: #fff; border: 1px solid #000; padding: 2px 8px; font-size: 10pt; font-weight: bold; }
            ul { margin: 3pt 0; padding-left: 1.5em; }
            .keep-together { page-break-inside: avoid; }
        </style>
    `;

    let html = `
        <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
        <head><meta charset='utf-8'><title>${escapeHtmlAttr(topic)}</title>${css}</head>
        <body>
        <div class="doc-header">
            <div class="main-title">📝 寫作教學回饋與跟進詳案 (${mode === 'teacher' ? '教師版' : '學生版'})</div>
            <div class="sub-info">班別：${escapeHtml(className)}　|　日期：${dateStr}　|　題目：${escapeHtml(topic)}</div>
        </div>
    `;

    // ==========================
    // 甲、學生表現分析
    // ==========================
    html += `<div class="section-title">甲、學生表現分析 📊</div>`;

    // 1. 概覽 (分流：老師看分析，學生看鼓勵)
    html += `<div class="sub-title">1. 整體表現概覽</div>`;
    if (mode === 'teacher') {
        if (aiData.classOverview && aiData.classOverview.teacherSummary) {
            html += `<div>${mdToHtml(listToHtml(aiData.classOverview.teacherSummary))}</div>`;
        }
    } else {
        // 學生版顯示親切的 Summary
        if (aiData.classOverview && aiData.classOverview.studentSummary) {
            html += `<div class="sample-box" style="border: 1px dashed #000;">${mdToHtml(listToHtml(aiData.classOverview.studentSummary))}</div>`;
        }
    }

    // 2 & 3. 數據 (只有老師睇到)
    if (mode === 'teacher') {
        html += `<div class="teacher-only"><span class="teacher-tag">🔒 教師專用數據</span>`;
        
        // 2. 分數
        html += `<div class="sub-title" style="margin-top:0;">2. 分數概覽 📈</div>`;
        if (analysis && analysis.scoreSummary) {
            html += `<table><tr><th>指標</th><th>平均分</th></tr>`;
            analysis.scoreSummary.forEach(row => {
                html += `<tr><td align="center">${row.指標}</td><td align="center">${row.平均分 !== null ? row.平均分.toFixed(2) : '-'}</td></tr>`;
            });
            html += `</table>`;
        } else { html += `<p>(暫無分數數據)</p>`; }

        // 3. Top 10
        html += `<div class="sub-title">3. 最常見評語項目 TOP 10 📋</div>`;
        if (analysis && analysis.topEntries && analysis.topEntries.length > 0) {
            html += `<table style="font-size:10.5pt;"><tr><th>排名</th><th>評語標題</th><th>次數</th></tr>`;
            analysis.topEntries.forEach(row => {
                html += `<tr><td align="center">${row.排名}</td><td>${row.評語標題}</td><td align="center">${row.被選次數}</td></tr>`;
            });
            html += `</table>`;
        } else { html += `<p>(暫無評語數據)</p>`; }
        html += `</div>`;
    }

    // 4. 本班亮點 (全公開)
    if (aiData.topicAnalysis && aiData.topicAnalysis.highlightsAndProblems) {
        const { highlights, problems } = aiData.topicAnalysis.highlightsAndProblems;
        // 學生版編號調整 (因為隱藏了2,3，所以亮點變第2項)
        const hlTitle = mode === 'teacher' ? '4. 本班亮點 ✨' : '2. 本班亮點 ✨';
        html += `<div class="sub-title">${hlTitle}</div><ul>`;
        (highlights || []).forEach(h => html += `<li>${mdToHtml(escapeHtml(h))}</li>`);
        html += `</ul>`;

        // 5. 常見問題 (全公開)
        const pbTitle = mode === 'teacher' ? '5. 常見問題與提示 ⚠️' : '3. 常見問題與提示 ⚠️';
        html += `<div class="sub-title">${pbTitle}</div><table><tr><th width="40%">問題</th><th width="60%">提示</th></tr>`;
        (problems || []).forEach(p => {
            html += `<tr><td>${mdToHtml(escapeHtml(p.problem))}</td><td>💡 ${mdToHtml(escapeHtml(p.tip))}</td></tr>`;
        });
        html += `</table>`;
    }

    // 6. 優秀同學 (全公開)
    if (aiData.excellentStudents && aiData.excellentStudents.length > 0) {
        const exTitle = mode === 'teacher' ? '6. 優秀同學特點 🏆' : '4. 優秀同學特點 🏆';
        html += `<div class="sub-title">${exTitle}</div><ul>`;
        aiData.excellentStudents.forEach(s => {
            html += `<li><b>${escapeHtml(s.name)}：</b> ${mdToHtml(escapeHtml(s.strength))}</li>`;
        });
        html += `</ul>`;
    }

    html += `<br style="page-break-before: always;">`;

    // ==========================
    // 乙、教學內容
    // ==========================
    const sectionTwoTitle = mode === 'teacher' ? '乙、教學內容與跟進詳案 📚' : '乙、重點學習內容 📚';
    html += `<div class="section-title">${sectionTwoTitle}</div>`;

    // 1. 審題與立意 (現在學生都可以看)
    html += `<div class="sub-title">1. 審題與立意深度解碼 🔍</div>`;
    
    // 深層分析 (開放給學生)
    if (aiData.topicAnalysis && aiData.topicAnalysis.analysisTeacher) {
         html += `<p><b>審題分析：</b></p><div class="sample-box" style="border:none;">${mdToHtml(listToHtml(aiData.topicAnalysis.analysisTeacher))}</div>`;
    }
    
    // 選材立意舉隅 (開放給學生)
    if (aiData.materialAndThemeExamples && aiData.materialAndThemeExamples.length > 0) {
        html += `<p><b>選材立意舉隅 💡</b></p><table><tr><th width="30%">立意方向</th><th width="70%">選材建議</th></tr>`;
        aiData.materialAndThemeExamples.forEach(item => {
            html += `<tr><td align="center"><b>${escapeHtml(item.theme)}</b></td><td>${escapeHtml(item.material)}</td></tr>`;
        });
        html += `</table>`;
    }

    // 2. 分層作品 (現在學生都可以看點評)
    html += `<div class="sub-title">2. 分層作品示例與講評 📝</div>`;
    if (aiData.workTiers) {
        const tiers = [
            { key: 'high', name: '上品作品', icon: '🌟' },
            { key: 'mid', name: '中品作品', icon: '😐' },
            { key: 'low', name: '下品作品', icon: '📉' }
        ];

        tiers.forEach(tier => {
            const data = aiData.workTiers[tier.key];
            if (data) {
                html += `<div class="keep-together">`;
                html += `<b>【${tier.name}】 ${tier.icon}</b>`;
                html += `<div class="sample-box"><div class="example-font">${mdToHtml(listToHtml(data.sample))}</div></div>`;
                html += `<ul>`;
                if (data.characteristics) data.characteristics.forEach(c => html += `<li><b>🔹 特點：</b> ${escapeHtml(c)}</li>`);
                
                // 點評 (開放給學生)
                if (data.commentary) html += `<li><b>🔸 點評：</b> ${mdToHtml(escapeHtml(data.commentary))}</li>`;
                
                if (data.selfChecklist) data.selfChecklist.forEach(q => html += `<li><b>❓ 反思：</b> ${escapeHtml(q)}</li>`);
                html += `</ul></div>`;
            }
        });
    }

    html += `<br style="page-break-before: always;">`;

    // 3. 教學計劃 (只有老師睇到)
    if (mode === 'teacher' && aiData.teachingPlan) {
        const tp = aiData.teachingPlan;
        html += `<div class="teacher-only"><span class="teacher-tag">🔒 教學計劃建議 (Teacher Only)</span>`;
        html += `<div class="sub-title" style="margin-top:0;">3. 教學計劃建議 📅</div>`;
        
        html += `<table><tr><th width="20%">範疇</th><th width="80%">詳細內容</th></tr>`;
        if (tp.objectives) html += `<tr><td align="center"><b>學習目標</b></td><td><ul>${tp.objectives.map(o => `<li>${escapeHtml(o)}</li>`).join('')}</ul></td></tr>`;
        if (tp.activities) {
            let actHtml = '';
            tp.activities.forEach(a => actHtml += `<b>${escapeHtml(a.name)} (${escapeHtml(a.duration)})：</b> ${escapeHtml(a.description)}<br>`);
            html += `<tr><td align="center"><b>課堂活動</b></td><td>${actHtml}</td></tr>`;
        }
        if (tp.remedialStrategies) html += `<tr><td align="center"><b>補底策略</b></td><td><ul>${tp.remedialStrategies.map(s => `<li>${escapeHtml(s)}</li>`).join('')}</ul></td></tr>`;
        if (tp.extensionActivities) html += `<tr><td align="center"><b>延伸活動</b></td><td><ul>${tp.extensionActivities.map(e => `<li>${escapeHtml(e)}</li>`).join('')}</ul></td></tr>`;
        html += `<tr><td align="center"><b>差異化支援</b></td><td>提供分層工作紙；拔尖學生挑戰開放式寫作。</td></tr>`;
        html += `</table></div>`;
    }

    // 4. 跟進練習 (全開放)
    if (aiData.writingPractices && aiData.writingPractices.length > 0) {
        const practiceSectionTitle = mode === 'teacher' ? '四、跟進練習：鞏固與遷移 ✍️' : '三、跟進練習：鞏固與遷移 ✍️';
        html += `<div class="section-title">${practiceSectionTitle}</div>`;
        
        const practiceTitles = ['1. 關鍵段落：片段練習', '2. 立意昇華段', '3. 刻意練習修辭及寫作手法', '4. 舉一反三：遷移應用'];
        
        aiData.writingPractices.forEach((p, i) => {
            const title = practiceTitles[i] || `練習 ${i + 1}`;
            html += `<div class="keep-together">`;
            html += `<div class="sub-title">${title}</div>`;
            if (p.prompt) html += `<p><b>題目：</b>${mdToHtml(escapeHtml(p.prompt))}</p>`;
            if (p.guidelines) {
                html += `<div class="hint-box"><b>💡 學生指引：</b><ul>${p.guidelines.map(g => `<li>${escapeHtml(g)}</li>`).join('')}</ul></div>`;
            }
            if (p.modelAnswer) {
                // 老師版會顯示「參考示例」，學生版也會顯示 (因為是 Model Answer)
                // 這次不再加鎖，讓學生自學
                html += `<div class="sample-box"><b>參考示例：</b><div class="example-font">${mdToHtml(listToHtml(p.modelAnswer))}</div></div>`;
            }
            html += `</div>`;
        });
    }

    html += `</body></html>`;
    return html;
}

function generateTeacherWord() {
    const aiData = _getAIFeedbackData();
    if (!aiData) return;
    downloadFile(`AI回饋_${getSanitizedTopicFilename()}_老師版.doc`, _buildAiFeedbackWordHtml(aiData, 'teacher'), 'application/msword;charset=utf-8');
}

function generateStudentWord() {
    const aiData = _getAIFeedbackData();
    if (!aiData) return;
    downloadFile(`AI回饋_${getSanitizedTopicFilename()}_學生版.doc`, _buildAiFeedbackWordHtml(aiData, 'student'), 'application/msword;charset=utf-8');
}
// ==========================================
// ====== 新增：鍵盤快捷鍵功能 (開始) ======
// ==========================================

// [v18.6] Page 1 名單選取 (強制 ID 寫入 + 除錯版)
// 請確保這是文件中唯一的 handleClassSelectChange 函數
window.handleClassSelectChange = async function() {
    const select = document.getElementById('setup-class-select');
    const container = document.getElementById('setup-student-checklist');
    const area = document.getElementById('setup-student-area');

    if (!container || !area) return;

    container.innerHTML = '';
    area.style.display = 'none';
    
    if (!select || !select.value) return;

    // 設定全域變數
    window.currentClassId = select.value;
    
    area.style.display = 'block';
    container.innerHTML = '<div style="padding:10px; color:#666;">🔄 正在讀取並同步 ID...</div>';

    try {
        const { data: students, error } = await supabaseClient
            .from('students')
            .select('*')
            .eq('class_id', select.value);
            
        if (error) throw error;

        container.innerHTML = '';
        if (!students || students.length === 0) { 
            container.innerHTML = '<div style="padding:10px;">此班級暫無學生資料</div>'; 
            return; 
        }

        // 使用統一排序
        sortStudents(students);

        let debugCount = 0;

        students.forEach(s => {
            const div = document.createElement('div');
            div.className = 'student-check-card checked';
            
            // 處理顯示名稱
            let displayNum = s.student_number;
            if (displayNum && /^\d$/.test(displayNum)) displayNum = '0' + displayNum;
            
            let cleanInfo = s.name;
            if (/^\d+$/.test(s.name)) {
                cleanInfo = s.name;
            } else if (displayNum) {
                cleanInfo = `${displayNum}-${s.name}`;
            }

            // 🔥 核心修復：寫入 ID
            // 如果 s.id 是 undefined，這裡會報錯或顯示 undefined，方便除錯
            if (!s.id) {
                console.error("發現異常數據 (無 ID):", s);
                div.style.border = "2px solid red";
                div.title = "資料庫錯誤：缺少 ID";
            } else {
                debugCount++;
            }

            div.dataset.info = cleanInfo;
            div.dataset.dbId = s.id; // 這是關鍵！

            div.innerHTML = `
                <input type="checkbox" checked>
                <span>${escapeHtml(displayNum||'')}<br>${escapeHtml(s.name||'')}</span>
            `;
            
            div.onclick = (e) => {
                // 防止點擊 Checkbox 時觸發兩次
                if (e.target.tagName === 'INPUT') return;
                const cb = div.querySelector('input');
                cb.checked = !cb.checked;
                div.classList.toggle('checked', cb.checked);
            };
            container.appendChild(div);
        });
        
        console.log(`✅ 已成功載入 ${debugCount} 位學生 (均包含 ID)`);

    } catch (err) { 
        console.error("List Load Error:", err);
        container.innerHTML = `<div style="color:red;">讀取錯誤: ${err.message}</div>`; 
    }
};

// [v18.8] 瀏覽器上一頁監聽
window.addEventListener('popstate', (event) => {
    if (event.state && event.state.pageId) {
        // 傳入 false 代表「不要再 Push History」，防止無限迴圈
        showPage(event.state.pageId, null, false);
    } else {
        // 如果沒有 state (例如回到最初)，預設回首頁
        showPage('page-home', null, false);
    }
});

// [Pro-v9.6.1] 全能快捷鍵 (包含舊有導航 + 新增輸入流)
function initHotkeys() {
  
  document.addEventListener('keydown', (e) => {
    
    // ============================
    // 1. 【舊有功能保留】 (Navigation & Save)
    // ============================

    // (A) 儲存 (Ctrl + S / Cmd + S)
    if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's') {
      e.preventDefault(); // 阻止瀏覽器存網頁
      if (document.getElementById('page2').classList.contains('active')) {
         saveCurrentStudentData('cloud');
      }
    }

    // (B) Alt 組合鍵 (切換學生 / 切換頁面)
    if (e.altKey && !e.ctrlKey && !e.shiftKey) {
      
      // B1. 切換學生 (Alt + 左/右)
      if (['ArrowLeft', 'ArrowRight'].includes(e.key)) {
        if (document.getElementById('page2').classList.contains('active')) {
          e.preventDefault();
          const direction = e.key === 'ArrowRight' ? 'next' : 'prev';
          navigateToStudent(direction);
          
          // 增加 Toast 提示，讓你知轉了誰
          const select = document.getElementById('student-select');
          if (select && select.value) {
             if (typeof showToast === 'function') showToast(`已切換至：${select.options[select.selectedIndex].text}`, 'info');
          }
        }
      }
      
      // B2. 切換分頁 (Alt + 1~8)
      const pageKeys = ['1', '2', '3', '4', '5', '6', '7', '8'];
      if (pageKeys.includes(e.key)) {
        e.preventDefault();
        const targetPage = document.getElementById('page' + e.key);
        if (targetPage) {
            showPage('page' + e.key);
            const pageNames = {'1':'基本設定','2':'批改頁','3':'評語庫','4':'學生總覽','5':'分析','6':'AI 生成','7':'AI 回饋','8':'班級管理'};
            if (typeof showToast === 'function') showToast(`已切換至：${pageNames[e.key] || '頁面 ' + e.key}`, 'info');
        }
      }
    }

    // ============================
    // 2. 【新增功能】 (Input Flow)
    // ============================

    // (C) 彈窗內 Enter = 確認 (Smart Modal Enter)
    if (e.key === 'Enter') {
        // 檢查焦點是否在彈窗的 input 內 (排除 textarea，因為 textarea Enter 要換行)
        if (e.target.matches('.pop-modal input')) {
            const modal = e.target.closest('.pop-modal');
            // 找該彈窗內的「確認」按鈕
            const confirmBtn = modal ? modal.querySelector('.pop-btn-confirm') : null;
            
            if (confirmBtn && !confirmBtn.disabled && confirmBtn.offsetParent !== null) {
                e.preventDefault();
                confirmBtn.click(); // 模擬點擊
            }
        }
    }
  });

  // ============================
  // 3. 【新增功能】 (Score & Textarea Flow)
  // ============================

  // (D) 分數欄 Enter 自動跳下一格 (Excel 體驗)
  const scoreInputs = ['score-content', 'score-expression', 'score-structure', 'score-punctuation', 'score-typos'];
  scoreInputs.forEach((id, index) => {
      const el = document.getElementById(id);
      if (el) {
          el.addEventListener('keydown', (e) => {
              if (e.key === 'Enter') {
                  e.preventDefault();
                  if (index < scoreInputs.length - 1) {
                      // 跳去下一格
                      const nextId = scoreInputs[index + 1];
                      const nextEl = document.getElementById(nextId);
                      if(nextEl) {
                          nextEl.focus();
                          nextEl.select(); // 自動全選，方便覆蓋
                      }
                  } else {
                      // 最後一格 (錯別字) -> 跳去「特別留言」
                      document.getElementById('unique-comment')?.focus();
                  }
              }
          });
          // 點擊選框時也自動全選
          el.addEventListener('focus', function() { this.select(); });
      }
  });

  // (E) 文字框 Ctrl+Enter 快速儲存
  const textAreas = ['unique-comment', 'student-report-output', 'full-output'];
  textAreas.forEach(id => {
      const el = document.getElementById(id);
      if(el) {
          el.addEventListener('keydown', (e) => {
              if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                  e.preventDefault();
                  saveCurrentStudentData('cloud');
                  el.blur(); // 移除焦點，代表「已處理」
              }
          });
      }
  });
}

function showHotkeyHelp() {
    const helpContent = `
        <div style="text-align: left; font-size: 0.95rem;">
            <p><strong>通用導航：</strong></p>
            <ul style="margin-top:5px; margin-bottom:15px;">
                <li><code>Alt + 1-7</code>：切換分頁 1 至 7</li>
            </ul>
            <p><strong>批改頁專用：</strong></p>
            <ul style="margin-top:5px;">
                <li><code>Ctrl + S</code> (Mac: <code>Cmd + S</code>)：儲存當前學生</li>
                <li><code>Alt + →</code>：下一位學生</li>
                <li><code>Alt + ←</code>：上一位學生</li>
            </ul>
        </div>
    `;
    
    // 重用 Pop Art 風格的 Modal
    const popModal = document.getElementById('pop-project-modal');
    const popList = document.getElementById('pop-project-list');
    
    // 修改內容
    popModal.querySelector('.pop-icon').textContent = '⌨️';
    popModal.querySelector('h3').textContent = '鍵盤快捷鍵列表';
    popModal.querySelector('.pop-desc').textContent = '提升批改效率的秘密武器';
    
    popList.innerHTML = helpContent;
    
    // 隱藏不必要的元素
    const input = document.getElementById('pop-project-input');
    const cancelBtn = document.getElementById('pop-project-cancel');
    input.style.display = 'none';
    cancelBtn.style.display = 'none';
    
    const confirmBtn = document.getElementById('pop-project-confirm');
    confirmBtn.textContent = '知道了';
    
    // 綁定關閉事件
    confirmBtn.onclick = () => {
        popModal.classList.remove('active');
        // 還原 UI 狀態 (以免影響 Project Load 功能)
        setTimeout(() => {
            input.style.display = 'block';
            cancelBtn.style.display = 'inline-block';
            confirmBtn.textContent = '確定載入';
            // 還原標題 (雖然 loadProject 會自己改，但重置比較保險)
            popModal.querySelector('.pop-icon').textContent = '📂';
            popModal.querySelector('h3').textContent = '雲端專案讀取';
        }, 300);
    };
    
    popModal.classList.add('active');
}

// ==========================================
// ====== 新增：鍵盤快捷鍵功能 (結束) ======
// ==========================================
// ==========================================
// ====== 離線防災備份功能 (加強版) ======
// ==========================================

const BACKUP_KEY = 'idw_grading_backup_v1';
let backupTimer = null;

function triggerAutoSave() {
    clearTimeout(backupTimer);
    backupTimer = setTimeout(() => {
        saveToLocalBackup();
        loadDashboard(); // <--- 加入這行，讓首頁的「編輯中」卡片即時反映進度
    }, 1000); 
}

// 2. 執行備份 (修正版：只在批改頁執行)
function saveToLocalBackup() {
    // ✅ 新增檢查：如果現在不是在 Page 2，就不要執行備份，防止報錯
    const page2 = document.getElementById('page2');
    if (!page2 || !page2.classList.contains('active')) {
        return;
    }

    // A. 獲取當前正在編輯的學生資料
    let currentEditingData = null;
    const currentStudentName = document.getElementById('student-select')?.value;
    
    if (currentStudentName) {
        const checkedCritiques = [];
        document.querySelectorAll('#checklist-container input[type="checkbox"]:checked').forEach(cb => {
            const id = cb.id;
            const selectValues = [];
            const module = document.getElementById(`module-${id}`);
            if (module) {
                module.querySelectorAll('select').forEach((select, index) => {
                    let value = select.value;
                    let otherValue = '';
                    if (value === '其他') {
                        const otherInput = document.getElementById(`${id}-other-${index + 1}-text`);
                        otherValue = otherInput ? otherInput.value : '';
                    }
                    selectValues.push({ value, otherValue });
                });
            }
            checkedCritiques.push({ id, selectValues });
        });

        // 安全獲取數值
        const getVal = (id) => document.getElementById(id) ? document.getElementById(id).value : '';

        currentEditingData = {
            name: currentStudentName,
            data: {
                class: getVal('student-class'),
                topic: getVal('topic'),
                uniqueComment: getVal('unique-comment'),
                scores: {
                    content: getVal('score-content'),
                    expression: getVal('score-expression'),
                    structure: getVal('score-structure'),
                    punctuation: getVal('score-punctuation'),
                    typos: getVal('score-typos'),
                    total: getVal('score-total'),
                },
                typos: [...currentTypos],
                checkedCritiques: checkedCritiques,
                fullComment: getVal('full-output'),
                studentComment: getVal('student-report-output')
            }
        };
    }

    // B. 準備備份包
    const backupData = {
        timestamp: Date.now(),
        className: document.getElementById('student-class') ? document.getElementById('student-class').value : '',
        topic: document.getElementById('topic') ? document.getElementById('topic').value : '',
        namesText: document.getElementById('student-names') ? document.getElementById('student-names').value : '',
        students: allStudentRecords, 
        critiques: typeof collectExportData === 'function' ? collectExportData() : [],
        typos: commonTypos, 
        currentStudent: currentStudentName,
        liveEdit: currentEditingData
    };

    try {
        localStorage.setItem(BACKUP_KEY, JSON.stringify(backupData));
    } catch (e) {
        console.warn("備份失敗 (可能是儲存空間不足)", e);
    }
}

// 3. 檢查備份
function checkLocalBackup() {
    const backup = localStorage.getItem(BACKUP_KEY);
    if (!backup) return;

    try {
        const data = JSON.parse(backup);
        // 如果備份存在且是 7 天內的
        if (data.timestamp && (Date.now() - data.timestamp < 7 * 24 * 60 * 60 * 1000)) {
            const btn = document.getElementById('restore-backup-btn');
            if (btn) {
                const date = new Date(data.timestamp);
                const timeStr = `${date.getMonth()+1}/${date.getDate()} ${date.getHours()}:${date.getMinutes() < 10 ? '0' : ''}${date.getMinutes()}`;
                btn.style.display = 'inline-flex';
                btn.textContent = `♻️ 發現未儲存備份 (${timeStr}) - 點此還原`;
                btn.style.animation = "pulse 2s infinite";
            }
        }
    } catch (e) {
        console.error("檢查備份錯誤", e);
    }
}

// [Pro-v4.2-UI] 還原備份 (修復報錯)
function restoreFromLocalBackup() {
    const backup = localStorage.getItem(BACKUP_KEY);
    if (!backup) {
        alert("找不到備份資料。");
        return;
    }

    try {
        const data = JSON.parse(backup);

        // 還原評語庫
        if (data.critiques && data.critiques.length > 0) {
            const cData = document.getElementById('critique-data');
            if(cData) {
                cData.innerHTML = '';
                applyCritiquesToDOM(data.critiques);
            }
        }

        // 還原基礎資料
        if(document.getElementById('student-class')) document.getElementById('student-class').value = data.className || '';
        if(document.getElementById('topic')) document.getElementById('topic').value = data.topic || '';
        if(document.getElementById('student-names')) document.getElementById('student-names').value = data.namesText || '';
        commonTypos = data.typos || [];

        // 還原學生資料
        let restoredRecords = data.students || [];
        if (data.liveEdit && data.liveEdit.name) {
            const idx = restoredRecords.findIndex(r => r.originalName === data.liveEdit.name);
            if (idx >= 0) {
                restoredRecords[idx].data = {
                    ...restoredRecords[idx].data,
                    ...data.liveEdit.data
                };
            }
        }
        allStudentRecords = restoredRecords;

        // 重建 UI
        updateStudentDropdown();
        buildChecklist();
        buildOverviewPage();
        renderCommonTypoList();
        renderStudentOverviewTable();
        updateHeaderInfo();

        // 跳轉回上次編輯的學生
        if (data.currentStudent) {
            const select = document.getElementById('student-select');
            let optionExists = false;
            for(let i=0; i<select.options.length; i++) {
                if(select.options[i].value === data.currentStudent) {
                    optionExists = true;
                    break;
                }
            }

            if (optionExists) {
                select.value = data.currentStudent;
                loadStudentData(data.currentStudent);
                showPage('page2');
                if(typeof showToast === 'function') showToast(`還原成功！已回到學生：${data.currentStudent}`, "success");
            } else {
                if(typeof showToast === 'function') showToast("還原成功！", "success");
            }
        } else {
            if(typeof showToast === 'function') showToast("還原成功！", "success");
        }

        // 🔥 移除了會報錯的那行 style.display = 'none'
        loadDashboard(); 

    } catch (e) {
        console.error(e);
        alert("還原失敗，資料可能已損壞。\n錯誤訊息：" + e.message);
    }
}

/* ==========================================
   ====== Dashboard 2.0 (防重複終極版) ======
   ========================================== */
let isDashboardRendering = false; // 加入鎖定旗標

// [v19.1] Dashboard 讀取 (修復純學號顯示問題)
async function loadDashboard() {
    const focusList = document.getElementById('focus-task-list');
    const classContainer = document.getElementById('class-accordion-container');
    
    if(!focusList) return; 

    focusList.innerHTML = '<div class="dashboard-loading"><div class="spinner"></div> 正在同步雲端數據...</div>';
    if(classContainer) classContainer.innerHTML = '';

    if (!currentUser) {
        renderEmptyState(focusList);
        return;
    }

    try {
        console.log("📊 正在刷新 Dashboard (Hipster Mode)...");

        // 1. 讀取班級
        const { data: classesData, error: classError } = await supabaseClient
            .from('classes').select('*').eq('user_id', currentUser.id)
            .order('academic_year', { ascending: false });
        if (classError) throw classError;

        // 2. 讀取作業
        const { data: assignments, error: assignError } = await supabaseClient
            .from('assignments')
            .select('id, title, created_at, class_id, classes(class_name)') 
            .eq('user_id', currentUser.id)
            .order('created_at', { ascending: false });
        if (assignError) throw assignError;

        // 3. 讀取成績
        const assignmentIds = assignments ? assignments.map(a => a.id) : [];
        
        // 🔥 關鍵修改：讀取 students 的 name 和 student_number
        const { data: resultsData } = await supabaseClient
            .from('results')
            .select('assignment_id, total_score, comment_student, updated_at, students(name, student_number)')
            .in('assignment_id', assignmentIds);

        // 4. 計算統計
        const statsMap = {}; 

        if (resultsData) {
            resultsData.forEach(r => {
                if (!statsMap[r.assignment_id]) {
                    statsMap[r.assignment_id] = { total: 0, graded: 0, lastUpdate: null, lastStudent: null };
                }
                
                const stats = statsMap[r.assignment_id];
                stats.total++; 

                const hasScore = (r.total_score !== null && r.total_score !== '');
                const hasComment = (r.comment_student && r.comment_student.trim().length > 0);
                
                if (hasScore || hasComment) {
                    stats.graded++;
                    
                    const rDate = new Date(r.updated_at);
                    if (!stats.lastUpdate || rDate > new Date(stats.lastUpdate)) {
                        stats.lastUpdate = r.updated_at;
                        
                        // 🔥 智能名字邏輯：如果沒名，就用學號，再沒就用 (號碼 X)
                        let sName = r.students ? r.students.name : '';
                        const sNum = r.students ? r.students.student_number : '';
                        
                        if (!sName || sName.trim() === '') {
                            sName = sNum ? `${sNum}` : '未知學生';
                        }
                        stats.lastStudent = sName;
                    }
                }
            });
        }

        // 5. 組裝數據
        const assignmentMap = {};
        const allProjectsFlat = [];

        if (assignments) {
            assignments.forEach(a => {
                const cls = classesData.find(c => c.id === a.class_id) || { class_name: '未知', academic_year: '' };
                const stats = statsMap[a.id] || { total: 0, graded: 0, lastUpdate: null, lastStudent: null };
                
                const progress = stats.total > 0 ? Math.round((stats.graded / stats.total) * 100) : 0;
                
                const richProject = {
                    id: a.id,
                    source_type: 'new',
                    topic: a.title,
                    class_id: a.class_id,
                    class_name: cls.class_name,
                    academic_year: cls.academic_year,
                    created_at: a.created_at,
                    last_updated: stats.lastUpdate || a.created_at,
                    last_student: stats.lastStudent, 
                    graded_count: stats.graded,
                    total_students: stats.total,
                    progress: progress,
                    isCompleted: (stats.total > 0 && stats.graded >= stats.total)
                };

                allProjectsFlat.push(richProject);
                if (!assignmentMap[a.class_id]) assignmentMap[a.class_id] = [];
                assignmentMap[a.class_id].push(richProject);
            });
        }

        // 6. 渲染
        const focusItems = allProjectsFlat.filter(p => !p.isCompleted).slice(0, 5);
        focusList.innerHTML = ''; 
        renderNewDetailCards(focusItems, focusList);

        if(classContainer) {
            classContainer.innerHTML = ''; 
            renderClassCentricAccordion(classesData, assignmentMap, classContainer, true);
        }
        
        updateWelcomeMessage();

    } catch (error) {
        console.error("Dashboard Error:", error);
        focusList.innerHTML = `<div style="color:#c86a5a; padding:1rem;">讀取失敗: ${error.message}</div>`;
    }
}


// [Pro-v4.2-UI] 停止載入離線備份到 Dashboard (避免重複混亂)
function getOfflineProjectMeta() {
    // 強制回傳 null，讓 Dashboard 只顯示雲端資料
    // 因為備份還原功能將移到 Header 的資料夾按鈕 (📂) 內
    return null;
}
// 為了防止舊代碼殘留，如果還有 loadOfflineData 函數，請手動刪除它，或將其內容清空
function loadOfflineData() { return []; }

// [v10.4] 渲染文件夾網格 (Cozy Folder Grid)
function renderFocusList(items, container) {
    if (items.length === 0) {
        container.style.display = 'block'; 
        container.innerHTML = `
            <div style="text-align:center; padding:3rem; color:#aaa; background:rgba(255,255,255,0.5); border-radius:16px; border:2px dashed #eee;">
                <div style="font-size:2.5rem; margin-bottom:10px;">🍃</div>
                案頭很乾淨，沒有積壓的工作。<br>
                <span style="font-size:0.9rem;">(點擊上方按鈕開始新工作)</span>
            </div>`;
        return;
    }
    
    container.style.display = 'grid'; 

    let html = '';
    items.forEach((item, index) => {
        // 使用新的文件夾 HTML 結構
        const dateStr = new Date(item.last_updated).toLocaleDateString();
        // 點擊動作
        let clickAction = (item.source_type === 'legacy') ? `loadProjectById('${item.id}')` : `openAssignment('${item.id}')`;
        // 準備 Edit Modal 數據
        const itemSafe = JSON.stringify(item).replace(/"/g, '&quot;');

       /* [v17.1] Dashboard Card (含 Progress Bar) */
html += `
<div class="cozy-folder" onclick="${clickAction}">
    <div style="position:absolute; top:15px; right:15px;" onclick="event.stopPropagation();">
        <button onclick="openEditModal(${itemSafe})" style="background:transparent; border:none; color:#ddd; cursor:pointer; font-size:1.1rem; padding:5px;">⚙️</button>
    </div>

    <div class="folder-meta">
        <span class="folder-class">${escapeHtml(item.class_name)}</span>
        <div class="folder-title">${escapeHtml(item.topic)}</div>
    </div>

    <div class="task-progress">
        <div style="display:flex; justify-content:space-between; font-size:0.75rem; color:#888; margin-bottom:4px;">
            <span>📅 ${dateStr}</span>
            <span>${item.progress}%</span>
        </div>
        <div class="task-progress-bar-bg">
            <div class="task-progress-bar-fill" style="width: ${item.progress}%"></div>
        </div>
    </div>
</div>`;

    });
    container.innerHTML = html;
}

// 為了兼容性，保留 buildCardHtml 但改名或不使用，這裡我們直接在 renderFocusList 裡寫了 HTML
// 如果其他地方 (e.g. Archives) 還有用到 buildCardHtml，請將其更新為類似上面的簡約版，或者暫時保持原樣。
// 為了統一，建議 Archives 也用類似樣式，但稍微緊湊一點。
// --- Helper: 渲染 Empty State ---
function renderEmptyState(container) {
    container.innerHTML = `
        <div style="text-align: center; padding: 3rem 1rem; background: #fdfbf7; border: 2px dashed #e0e0e0; border-radius: 16px;">
            <div style="font-size: 3rem; margin-bottom: 0.5rem;">🌱</div>
            <h3 style="color: #888;">暫無紀錄</h3>
            <p style="color: #999; margin-bottom: 1.5rem;">點擊右上角的「＋」開始您的第一個批改任務吧。</p>
            <button class="action-btn" onclick="showPage('page1')">開新批改</button>
        </div>
    `;
}

// --- Helper: 資料分組 (終極防重複版 - 只認數字) ---
function groupByYearAndClass(projects) {
    const groups = {};
    
    // 標準化工具：只提取數字，強制重組成 YYYY-YYYY
    const normalizeKey = (str) => {
        if (!str) return '未知年份';
        
        // 1. 轉成字串並只保留數字 (殺死所有空格、橫線、全形符號)
        const nums = String(str).replace(/[^\d]/g, '');
        
        // 2. 如果剛好是 8 個數字 (例如 20252026)，就強制變身
        if (nums.length === 8) {
            return `${nums.substring(0, 4)}-${nums.substring(4, 8)}`;
        }
        
        // 3. 其他情況 (例如 "2025" 或 "未知") 就保留原樣，但去除頭尾空格
        return String(str).trim();
    };

    projects.forEach(p => {
        // 取得原始年份
        const rawYear = p.normalizedYear || p.academic_year;
        
        // 進行標準化 (這是關鍵！)
        const y = normalizeKey(rawYear);
        
        // 班別也去除前後空格
        const c = (p.class_name || '未分類').trim();
        
        if (!groups[y]) groups[y] = {};
        if (!groups[y][c]) groups[y][c] = [];
        groups[y][c].push(p);
    });
    return groups;
}

// [v19.0] 渲染班級歸檔 (支援新卡片格式)
function renderClassCentricAccordion(classes, assignmentMap, container, useNewCard = false) {
    if(!classes || classes.length === 0) {
        container.innerHTML = '<div style="color:#ccc; text-align:center; padding:1rem;">(暫無班級資料)</div>';
        return;
    }

    const groups = {};
    classes.forEach(c => {
        const year = c.academic_year || '未知學年';
        if (!groups[year]) groups[year] = [];
        groups[year].push(c);
    });

    const years = Object.keys(groups).sort().reverse();

    years.forEach((year) => {
        const yearDiv = document.createElement('div');
        yearDiv.innerHTML = `<h4 style="margin: 2rem 0 0.8rem 0; color:#aaa; font-size:0.85rem; text-transform:uppercase; letter-spacing:1px; border-bottom:1px solid #eee; padding-bottom:4px;">📅 ${year} 學年</h4>`;
        container.appendChild(yearDiv);

        const yearClasses = groups[year].sort((a, b) => a.class_name.localeCompare(b.class_name));

        yearClasses.forEach((cls) => {
            const projects = assignmentMap[cls.id] || [];
            
            const header = document.createElement('div');
            header.className = 'class-group-header';
            header.innerHTML = `
                <span>📁 ${escapeHtml(cls.class_name)}</span>
                <span style="font-weight:normal; color:#888; font-size:0.9rem;">${projects.length} 份作業 ${projects.length > 0 ? '▼' : '➕'}</span>
            `;
            
            const content = document.createElement('div');
            content.className = 'class-group-content';
            
            if (projects.length > 0) {
                // 🔥 如果是新模式，用新的 renderNewDetailCards (但要改少少邏輯因為它係 render 整個 container)
                // 這裡簡單起見，我們直接生成 HTML string
                if (useNewCard) {
                    const tempDiv = document.createElement('div');
                    renderNewDetailCards(projects, tempDiv);
                    content.innerHTML = tempDiv.innerHTML;
                    content.className = 'class-group-content active folder-grid'; // 確保 grid 樣式生效
                } else {
                    // 舊 fallback
                    let listHtml = '';
                    projects.forEach((p, pIndex) => {
                        const uniqueId = `cls-${cls.id}-${pIndex}`;
                        listHtml += buildCardHtml(p, uniqueId);
                    });
                    content.innerHTML = listHtml;
                }
            } else {
                content.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align:center; padding:20px; border:2px dashed #eee; border-radius:12px; background:#fafafa;">
                        <p style="color:#999; font-size:0.9rem; margin-bottom:10px;">此班級尚未有作業</p>
                        <button class="action-btn" onclick="startNewProjectForClass('${cls.id}', '${escapeHtmlAttr(cls.class_name)}')" style="font-size:0.9rem;">
                            ✨ 為 ${escapeHtml(cls.class_name)} 開新作業
                        </button>
                    </div>
                `;
            }

            header.onclick = () => {
                content.classList.toggle('active');
                if (content.classList.contains('active')) {
                    content.style.display = 'grid'; // 強制 Grid
                } else {
                    content.style.display = 'none';
                }
            };

            container.appendChild(header);
            container.appendChild(content);
        });
    });
}

// 輔助函數：從 Dashboard 直接跳轉去開新 Project
function startNewProjectForClass(classId, className) {
    // 1. 轉去 Page 1
    showPage('page1');
    
    // 2. 自動設定模式為「從班級名單」
    const rb = document.querySelector('input[name="setup-mode"][value="registry"]');
    if(rb) { rb.checked = true; toggleSetupMode(); }

    // 3. 自動選取該班級 (延遲少少等 Dropdown Load 完)
    setTimeout(() => {
        const select = document.getElementById('setup-class-select');
        if(select) {
            select.value = classId;
            handleClassSelectChange(); // 觸發學生名單載入
            if(typeof showToast === 'function') showToast(`已為您選取：${className}`, "info");
        }
    }, 500);
}

// [v20.1] 載入作業 (嚴格模式：分母只計算作業內的學生)
async function openAssignment(assignmentId) {
    if (!currentUser) return;
    try {
        // 1. 讀取作業基本資料
        const { data: assignment, error: assignError } = await supabaseClient
            .from('assignments')
            .select(`*, classes(class_name)`)
            .eq('id', assignmentId)
            .single();
        if (assignError) throw assignError;

        // 2. 🔥 核心修正：只讀取 results 表 (這是唯一的真理)
        // 絕對不讀取 classes/students 表來合併，確保分母 = 建立時的人數
        const { data: results, error: resError } = await supabaseClient
            .from('results')
            .select(`
                *,
                students (id, name, student_number) 
            `)
            .eq('assignment_id', assignmentId);
            
        if (resError) throw resError;

        // 3. 處理評語庫還原
        const documentContainer = document.getElementById('critique-data');
        documentContainer.innerHTML = '';
        if (assignment.settings && assignment.settings.critiques && assignment.settings.critiques.length > 0) {
            applyCritiquesToDOM(assignment.settings.critiques);
        } else {
            loadDefaultCritiques();
        }
        buildChecklist();
        buildOverviewPage();

        // 4. UI 設定
        window.currentAssignmentId = assignment.id;
        window.currentClassId = assignment.class_id;
        
        if(document.getElementById('student-class')) document.getElementById('student-class').value = assignment.classes ? assignment.classes.class_name : '未知班級';
        if(document.getElementById('topic')) document.getElementById('topic').value = assignment.title;
        if(document.getElementById('page2-topic-display')) document.getElementById('page2-topic-display').value = assignment.title;

        // 5. 數據組裝 (Strict Mapping)
        allStudentRecords = results.map(res => {
            const st = res.students; 
            if (!st) return null; // 資料庫關聯防爆

            const extraData = res.comment_data || {};
            
            const dataObj = {
                class: assignment.classes ? assignment.classes.class_name : '',
                topic: assignment.title,
                uniqueComment: extraData.uniqueComment || '',
                scores: {
                    content: res.content_score, expression: res.expression_score, structure: res.structure_score,
                    punctuation: res.punctuation_score, total: res.total_score, typos: res.typo_score || 0
                },
                typos: extraData.typos || [], 
                checkedCritiques: extraData.checkedCritiques || [],
                fullComment: res.comment_full || '', 
                studentComment: res.comment_student || '', 
                pureStudentComment: extraData.pureStudentComment || res.comment_student || '', 
                pureFullComment: extraData.pureFullComment || res.comment_full || ''
            };

            // 純學號處理
            let displayNum = st.student_number;
            if (displayNum && /^\d$/.test(displayNum)) displayNum = '0' + displayNum;
            const originalName = `${displayNum ? displayNum + '-' : ''}${st.name}`;

            return {
                number: st.student_number, 
                name: st.name, 
                originalName: originalName,
                dbId: st.id, 
                data: dataObj
            };
        }).filter(r => r !== null);

        // 排序
        sortStudents(allStudentRecords);

        // 填寫名單文字框
        document.getElementById('student-names').value = allStudentRecords.map(r => r.originalName).join('\n');
        
        // 強制刷新 UI
        updateStudentDropdown(); 
        renderStudentOverviewTable(); 
        updateHeaderInfo();

        showPage('page2');
        if(typeof showToast === 'function') showToast(`已載入：${assignment.title}`, "success");
        
        localStorage.removeItem('idw_jump_target');

    } catch (error) {
        console.error(error);
        alert(`載入失敗：${error.message}`);
    }
}

// 5. 歡迎訊息更新
function updateWelcomeMessage() {
    const h = new Date().getHours();
    const msg = document.getElementById('welcome-msg');
    if (!msg) return;
    if (h < 12) msg.textContent = "早晨，老師。☕";
    else if (h < 18) msg.textContent = "午後好，撐住。🍵";
    else msg.textContent = "夜深了，注意休息。🌙";
}



/* ========================================= */
/* === [v16.1] 智能入口 (Selective Restore) === */
/* ========================================= */

// [v20.1] 初始化 (瞬間路由 + 非同步載入)
document.addEventListener('DOMContentLoaded', () => { // 移除 async，確保立即執行
    
    // 🔥 1. 瞬間路由 (Instant Routing)
    // 在載入任何數據前，立即決定顯示哪個頁面，杜絕閃爍
    const lastPage = localStorage.getItem('idw_last_page');
    const resetToHomePages = ['page1', 'page2']; // 這些頁面刷新必回首頁
    let targetPageId = 'page-home';

    if (lastPage && !resetToHomePages.includes(lastPage)) {
        targetPageId = lastPage;
    }

    // 手動切換 Active Class (比 showPage 更快，不涉邏輯)
    document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active'));
    const targetEl = document.getElementById(targetPageId);
    if(targetEl) targetEl.classList.add('active');

    // 同步導航按鈕狀態
    document.querySelectorAll('.main-nav .nav-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.sub-nav-btn').forEach(btn => btn.classList.remove('active'));
    
    // 簡單還原按鈕狀態 (詳細邏輯稍後由 showPage 補足)
    if (targetPageId === 'page-home') {
        const homeBtn = document.querySelector('.main-nav .nav-btn[data-target="home"]');
        if(homeBtn) homeBtn.classList.add('active');
        const subContainer = document.getElementById('sub-nav-container');
        if(subContainer) subContainer.style.display = 'none';
    } else {
        const subBtn = document.getElementById('nav-' + targetPageId);
        if(subBtn) {
            subBtn.classList.add('active');
            // 嘗試顯示懸浮島
            const subContainer = document.getElementById('sub-nav-container');
            if(subContainer) subContainer.style.display = 'flex';
            const group = subBtn.closest('.sub-nav-group');
            if(group) {
                document.querySelectorAll('.sub-nav-group').forEach(g => g.style.display = 'none');
                group.style.display = 'flex';
                // 反向激活主導航
                const mainTarget = group.id.replace('sub-nav-', '');
                const mainBtn = document.querySelector(`.main-nav .nav-btn[data-target="${mainTarget}"]`);
                if(mainBtn) mainBtn.classList.add('active');
            }
        }
    }

    // 2. 執行初始化函數
    loadFontSize();
    initHotkeys();
    attachGlobalListeners();
    loadDefaultCritiques();
    initFloatingNavObserver();
    initScrollAutoShow();

    // 3. 非同步執行驗證與數據載入 (不阻擋 UI)
    (async () => {
        await checkUser(); 
        if(typeof loadDashboard === 'function') loadDashboard();
        
        // 為了確保 showPage 的完整邏輯 (如 Scroll Listener) 被掛載，
        // 我們在數據準備好後，安靜地再 Call 一次 showPage (不寫入 History)
        showPage(targetPageId, null, false);
    })();
});

// [Helper] 確認還原
function confirmRestore() {
    document.getElementById('pop-restore-modal').classList.remove('active');
    
    // 呼叫還原函數
    restoreFromLocalBackup(); 
    
    // restoreFromLocalBackup 預設會跳去 Page 2
    // 如果上次係 Page 3，我們要手動跳過去 (數據已還原，只是轉頁)
    const lastPage = localStorage.getItem('idw_last_page');
    if (lastPage === 'page3') {
        showPage('page3');
    }
}

// [Helper] 放棄還原
function discardAndGoHome() {
    document.getElementById('pop-restore-modal').classList.remove('active');
    showPage('page-home');
    if(typeof loadDashboard === 'function') loadDashboard();
}


// -------------------------------------------------------------
// ============================
// ✅ Email + 密碼 登入邏輯
// ============================

// 1. 打開登入視窗
function handleLogin() {
  const modal = document.getElementById('pop-login-modal');
  if(document.getElementById('login-email')) document.getElementById('login-email').value = "";
  if(document.getElementById('login-password')) document.getElementById('login-password').value = "";
  modal.classList.add('active');
}

// 2. 關閉視窗
function closeLoginModal() {
  const modal = document.getElementById('pop-login-modal');
  if(modal) modal.classList.remove('active');
}


// [Pro-v9.5.4] 登入/註冊 (暴力刷新版)
async function handlePasswordAuth(action) {
  const email = document.getElementById('login-email').value.trim();
  const password = document.getElementById('login-password').value.trim();
  
  // 鎖定按鈕
  const targetBtn = event.target; 
  const originalText = targetBtn.innerText;
  targetBtn.innerText = "連線中...";
  targetBtn.disabled = true;

  if (!email || !password) {
    alert("請輸入 Email 及 密碼");
    targetBtn.innerText = originalText;
    targetBtn.disabled = false;
    return;
  }

  try {
    // 1. 白名單檢查 (Signup Only)
    if (action === 'signup') {
        const { data: whiteData } = await supabaseClient.from('whitelist').select('email').eq('email', email).maybeSingle();
        if (!whiteData) {
            alert("⛔ 抱歉，此 Email 不在邀請名單內。");
            targetBtn.innerText = originalText;
            targetBtn.disabled = false;
            return; 
        }
    }

    // 2. 執行登入/註冊
    let error = null;
    let data = null;

    if (action === 'signup') {
      const res = await supabaseClient.auth.signUp({ email, password });
      error = res.error; data = res.data;
    } else {
      const res = await supabaseClient.auth.signInWithPassword({ email, password });
      error = res.error; data = res.data;
    }

    if (error) throw error;

    // 3. 成功處理
    if (data.user) {
         // 🔥 第一件事：更新全域變數
         currentUser = data.user;

         // 🔥 第二件事：暴力更新 Header (不經過判斷邏輯)
         const authStatus = document.getElementById('auth-status');
         if(authStatus) {
             authStatus.textContent = `已登入: ${data.user.email}`;
             authStatus.style.backgroundColor = "rgba(90, 143, 123, 0.2)";
         }
         // 隱藏登入按鈕，顯示登出按鈕
         if(document.getElementById('login-btn')) document.getElementById('login-btn').style.display = 'none';
         if(document.getElementById('logout-btn')) document.getElementById('logout-btn').style.display = 'inline-flex';
         if(document.getElementById('sync-btn')) document.getElementById('sync-btn').style.display = 'inline-flex';

         // 顯示成功 Toast
         if (typeof showToast === 'function') showToast("歡迎回來，老師。☕", "success");
         
         // 關閉 Modal
         closeLoginModal();

         // 🔥 第三件事：重新載入數據 (Await 確保次序)
         await loadDataFromCloud();
         if (typeof loadDashboard === 'function') await loadDashboard();
         if (typeof loadPage1ClassDropdown === 'function') await loadPage1ClassDropdown(true);
    }

  } catch (err) {
    console.error(err);
    alert("登入失敗：" + err.message);
  } finally {
    // 解鎖按鈕
    targetBtn.innerText = originalText;
    targetBtn.disabled = false;
  }
}
// 4. 處理忘記密碼
async function handleForgotPassword() {
  const email = document.getElementById('login-email').value.trim();
  if (!email) {
    alert("請先在上方輸入您的電郵地址，然後再按「忘記密碼」。");
    return;
  }

  if (!confirm(`系統將會發送一封「重設密碼」郵件到：\n${email}\n\n確定嗎？`)) return;

  const authStatus = document.getElementById('auth-status');
  if(authStatus) authStatus.textContent = "正在發送...";

  try {
    const { data, error } = await supabaseClient.auth.resetPasswordForEmail(email, {
      redirectTo: window.location.href, // 重設後跳轉回本頁
    });
    
    if (error) throw error;

    alert("✅ 郵件已發送！\n請去 Email 點擊連結，系統會帶你回來設定新密碼。");
    closeLoginModal();
    if(authStatus) authStatus.textContent = "等待重設...";
  } catch (err) {
    alert("發送失敗：" + err.message);
    if(authStatus) authStatus.textContent = "操作失敗";
  }
}

// ==========================================
// ====== Dashboard 編輯功能 (新) ======
// ==========================================

// [v19.5] 開啟編輯 Modal (接收獨立參數)
function openEditModal(id, sourceType, topic, className, year) {
    document.getElementById('edit-project-id').value = id;
    document.getElementById('edit-source-type').value = sourceType;
    // class-id 這裡暫時無法獲取，如果是修改標題通常不需要 class-id (除非要連動 classes table)
    // 我們可以根據 className 去撞，或者對於 Assignments 表來說，修改 Title 不需要 ClassID
    document.getElementById('edit-class-id').value = ''; 
    
    document.getElementById('edit-year').value = year || '';
    document.getElementById('edit-class').value = className || '';
    document.getElementById('edit-topic').value = topic || '';

    document.getElementById('pop-edit-modal').classList.add('active');
}

async function saveProjectMeta() {
    const id = document.getElementById('edit-project-id').value;
    const sourceType = document.getElementById('edit-source-type').value;
    const classId = document.getElementById('edit-class-id').value;
    
    const newYear = document.getElementById('edit-year').value.trim();
    const newClass = document.getElementById('edit-class').value.trim();
    const newTopic = document.getElementById('edit-topic').value.trim();

    if (!newClass || !newTopic) {
        alert("班別和題目不能為空！");
        return;
    }

    const btn = document.querySelector('#pop-edit-modal .pop-btn-confirm');
    const originalText = btn.textContent;
    btn.textContent = "儲存中...";
    btn.disabled = true;

    try {
        if (sourceType === 'legacy') {
            const { error } = await supabaseClient
                .from('student_projects')
                .update({ 
                    topic: newTopic, 
                    class_name: newClass,
                    academic_year: newYear 
                })
                .eq('id', id);
            if (error) throw error;
        } 
        else if (sourceType === 'new') {
            const { error: assignError } = await supabaseClient
                .from('assignments')
                .update({ title: newTopic })
                .eq('id', id);
            if (assignError) throw assignError;

            if (classId) {
                const { error: classError } = await supabaseClient
                    .from('classes')
                    .update({ 
                        class_name: newClass,
                        academic_year: newYear 
                    })
                    .eq('id', classId);
                if (classError) throw classError;
            }
        }
        else if (sourceType === 'local_memory') {
            document.getElementById('student-class').value = newClass;
            document.getElementById('topic').value = newTopic;
            triggerAutoSave();
        }

        if (typeof showToast === 'function') showToast("更新成功！", "success");
        else alert("更新成功！");
        
        document.getElementById('pop-edit-modal').classList.remove('active');
        loadDashboard();

    } catch (error) {
        console.error(error);
        alert("更新失敗：" + error.message);
    } finally {
        btn.textContent = originalText;
        btn.disabled = false;
    }
}

// [Pro-v7.4] 刪除專案 (修復雙重彈窗)
async function deleteProject() {
    const id = document.getElementById('edit-project-id').value;
    const sourceType = document.getElementById('edit-source-type').value;
    const title = document.getElementById('edit-topic').value;

    // 🔥 移除舊的 confirm()，直接使用自定義 UI 確認
    // 注意：這裡我們暫時隱藏編輯 Modal，以免兩個 Modal 重疊很難看
    document.getElementById('pop-edit-modal').classList.remove('active');

    const userConfirmed = await showCustomModal({
        icon: '⚠️',
        title: '刪除確認',
        desc: `確定要刪除「${title}」嗎？\n此操作無法復原。`,
        confirmText: '忍痛刪除',
        cancelText: '保留'
    });

    if (!userConfirmed) {
        // 如果取消，重新打開編輯 Modal (或者就讓它關閉，看你 UX 喜好)
        // 這裡選擇不重新打開，讓用戶感覺是「取消操作」
        return;
    }

    // 用戶確認後，顯示 Loading 狀態 (這裡因為編輯 Modal 已關，我們用 Toast 提示)
    if (typeof showToast === 'function') showToast("正在刪除...", "info");

    try {
        if (sourceType === 'legacy') {
            const { error } = await supabaseClient.from('student_projects').delete().eq('id', id);
            if (error) throw error;
        } 
        else if (sourceType === 'new') {
            const { error } = await supabaseClient.from('assignments').delete().eq('id', id);
            if (error) throw error;
        }
        else if (sourceType === 'local_backup' || id === 'local_backup') {
            localStorage.removeItem('idw_grading_backup_v1');
            const restoreBtn = document.getElementById('restore-backup-btn');
            if(restoreBtn) restoreBtn.style.display = 'none';
        }
        else if (sourceType === 'local_memory' || id === 'local_memory') {
            allStudentRecords = [];
            clearAllCore(true);
            localStorage.removeItem('idw_grading_backup_v1');
        }

        if (typeof showToast === 'function') showToast("已成功刪除", "success");
        
        // 刷新 Dashboard
        loadDashboard(); 

    } catch (error) {
        console.error("Delete Failed:", error);
        alert("刪除失敗：" + (error.message || "未知錯誤"));
        // 如果失敗，可能需要重新打開編輯 Modal 讓用戶重試，但這裡簡單處理
    }
}

// [Pro-v7.1] 全域變數：捕捉網址 Hash (防止 Supabase 清除後遺失)
const _globalHash = window.location.hash;

/* ========================================= */
/* === [v14.0] 用戶檢查 (連動防閃爍) === */
/* ========================================= */

async function checkUser() {
    const gate = document.getElementById('login-gate');

    // 1. 檢查 Session
    const { data: { session }, error } = await supabaseClient.auth.getSession();

    currentUser = session ? session.user : null;
    updateUIBasedOnAuthState();

    if (currentUser) {
        console.log("✅ 歡迎回來:", currentUser.email);
        
        // 🔥 設定防閃爍標記 (下次 F5 就唔會閃)
        localStorage.setItem('idw_is_logged_in', 'yes');

        // 確保門是開的
        if (gate) gate.classList.add('unlocked');

        // 後台刷新數據
        try {
            await Promise.all([
                loadDataFromCloud(),
                (typeof loadDashboard === 'function') ? loadDashboard() : Promise.resolve(),
                (typeof loadPage1ClassDropdown === 'function') ? loadPage1ClassDropdown(true) : Promise.resolve(),
                (typeof loadAllClasses === 'function') ? loadAllClasses() : Promise.resolve()
            ]);
        } catch (e) {
            console.warn("背景數據更新:", e);
        }

        // 處理邀請連結 Hash
        if (typeof _globalHash !== 'undefined' && _globalHash && _globalHash.includes('type=invite')) {
            setTimeout(() => {
                const pwdModal = document.getElementById('pop-reset-password-modal');
                if(pwdModal) {
                    pwdModal.querySelector('h3').textContent = "👋 歡迎加入！請設定密碼";
                    pwdModal.classList.add('active');
                }
                history.replaceState(null, null, ' ');
            }, 1000);
        }
    } else {
        console.log("🔒 未偵測到 Session，執行鎖門。");
        
        // 🔥 移除標記 & 關門
        localStorage.removeItem('idw_is_logged_in');
        if (gate) gate.classList.remove('unlocked');
    }
}

// 2. 獨立的密碼重設函數 (由 HTML 按鈕直接呼叫，確保 100% 有反應)
async function confirmResetPassword() {
    const input = document.getElementById('new-password-input');
    const btn = document.getElementById('confirm-reset-btn');
    const modal = document.getElementById('pop-reset-password-modal');

    const newPassword = input.value.trim();
    
    if (newPassword.length < 6) {
        alert("❌ 密碼太短！最少 6 個字元。");
        return;
    }

    const originalText = btn.innerText;
    btn.innerText = "更新中...";
    btn.disabled = true;

    try {
        const { error } = await supabaseClient.auth.updateUser({ password: newPassword });

        if (error) throw error;

        alert("🎉 密碼已設定成功！\n請記住您的密碼。");
        modal.classList.remove('active');
        history.replaceState(null, null, ' ');

    } catch (err) {
        console.error(err);
        alert("❌ 更新失敗：" + err.message);
    } finally {
        btn.innerText = "確認修改";
        btn.disabled = false;
    }
}

// 3. 簡化版監聽器 (只負責登出和忘記密碼郵件)
supabaseClient.auth.onAuthStateChange((event, session) => {
    console.log("Auth Event:", event);
    
    if (event === 'SIGNED_OUT') {
        currentUser = null;
        updateUIBasedOnAuthState();
        allStudentRecords = [];
        commonTypos = [];
        if (typeof loadDashboard === 'function') loadDashboard();
    } 
    // 處理「忘記密碼」郵件連結 (type=recovery)
    else if (event === 'PASSWORD_RECOVERY') {
        const modal = document.getElementById('pop-reset-password-modal');
        if(modal) {
            modal.classList.add('active');
            setTimeout(() => document.getElementById('new-password-input')?.focus(), 200);
        }
    }
});

// 4. 綁定 Enter 鍵 (通用綁定，放在最後)
document.addEventListener('DOMContentLoaded', () => {
    const pwdInput = document.getElementById('new-password-input');
    if (pwdInput) {
        pwdInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') confirmResetPassword();
        });
    }
});


// ==========================================
// ====== Kebab Menu (三點選單) 控制邏輯 ======
// ==========================================

// 切換選單顯示/隱藏
function toggleKebabMenu(event, uniqueId) {
    event.stopPropagation(); // 防止觸發卡片點擊
    
    // 1. 先關閉所有其他已打開的選單
    closeAllKebabMenus();

    // 2. 打開當前選單
    const menu = document.getElementById(`kebab-dropdown-${uniqueId}`);
    if (menu) {
        menu.classList.add('show');
    }
}

// 關閉所有選單
function closeAllKebabMenus() {
    document.querySelectorAll('.kebab-dropdown').forEach(el => el.classList.remove('show'));
}

// 全域監聽：點擊畫面任何地方都關閉選單
document.addEventListener('click', () => {
    closeAllKebabMenus();
});

// ==========================================
// ====== Phase 2.1: 學生名單管理邏輯 ======
// ==========================================

// 1. 打開「管理名單」視窗
async function manageStudents(classId, className) {
    document.getElementById('manage-class-id').value = classId;
    document.getElementById('manage-class-title').textContent = `管理名單：${className}`;
    document.getElementById('pop-manage-students-modal').classList.add('active');
    
    // 載入該班現有的學生
    await loadMasterStudentList(classId);
}

// 2. 關閉視窗並刷新班級列表 (更新人數)
function closeManageStudentsModal() {
    document.getElementById('pop-manage-students-modal').classList.remove('active');
    loadAllClasses(); // 刷新外面的卡片，更新「學生人數」
}

// [v18.2.0] Page 8: Render List with Inline Editing
async function loadMasterStudentList(classId) {
    const listContainer = document.getElementById('master-student-list');
    listContainer.innerHTML = '<div style="text-align:center; color:#999; padding:10px;">讀取中...</div>';

    try {
        const { data: students, error } = await supabaseClient
            .from('students')
            .select('*')
            .eq('class_id', classId);

        if (error) throw error;

        if (students.length === 0) {
            listContainer.innerHTML = `<div style="text-align:center; color:#ccc; padding:20px;">
                暫無學生。<br>請點擊上方「匯入 Excel」或手動新增。
            </div>`;
            return;
        }

        // 自然排序
        const collator = new Intl.Collator(undefined, { numeric: true, sensitivity: 'base' });
        students.sort((a, b) => {
            const numA = (a.student_number || '').toString();
            const numB = (b.student_number || '').toString();
            const numResult = collator.compare(numA, numB);
            if (numResult !== 0) return numResult;
            return collator.compare(a.name || '', b.name || '');
        });

        // 渲染表格
        let html = '<table style="width:100%; border-collapse:collapse; font-size:0.9rem;">';
        students.forEach(s => {
            const safeId = s.id;
            
            // 判斷此行是否正在編輯
            if (_editingMasterStudentId === safeId) {
                // === 編輯模式 (顯示 Input) ===
                html += `
                <tr style="background:#fffde7; border-bottom:1px solid #ddd;">
                    <td style="padding:8px; width:60px;">
                        <input type="text" id="edit-num-${safeId}" value="${escapeHtmlAttr(s.student_number)}" class="pop-input" style="padding:4px; margin:0; text-align:center;">
                    </td>
                    <td style="padding:8px;">
                        <input type="text" id="edit-name-${safeId}" value="${escapeHtmlAttr(s.name)}" class="pop-input" style="padding:4px; margin:0;">
                    </td>
                    <td style="padding:8px; text-align:right; white-space:nowrap;">
                        <button class="action-btn" style="padding:4px 8px; font-size:0.8rem; margin-right:5px;" onclick="saveMasterStudentInline('${safeId}')">💾</button>
                        <button class="secondary-btn" style="padding:4px 8px; font-size:0.8rem;" onclick="cancelMasterStudentInline()">✕</button>
                    </td>
                </tr>`;
            } else {
                // === 閱讀模式 (顯示文字) ===
                let displayNum = s.student_number || '';
                if (displayNum && /^\d$/.test(displayNum)) displayNum = '0' + displayNum;
                
                // 安全引號
                const nameForJs = (s.name || '').replace(/'/g, "\\'");

                html += `
                <tr style="border-bottom:1px dashed #eee;">
                    <td style="padding:8px; width:60px; font-weight:bold; color:#5A8F7B;">${escapeHtml(displayNum || '-')}</td>
                    <td style="padding:8px; display:flex; align-items:center; gap:8px;">
                        ${escapeHtml(s.name)}
                        <button class="light-btn" style="padding:2px 6px; font-size:0.8rem; background:#f0f0f0; color:#888;" onclick="showStudentHistory('${safeId}', '${nameForJs}')" title="查看成長歷程">📈</button>
                    </td>
                    <td style="padding:8px; text-align:right; white-space:nowrap;">
                        <button onclick="_editingMasterStudentId='${safeId}'; loadMasterStudentList('${classId}');" title="編輯" style="background:transparent; border:none; cursor:pointer; font-size:1rem; margin-right:8px;">✏️</button>
                        <button class="danger-btn" style="padding:2px 8px; font-size:0.75rem;" onclick="deleteStudentFromMaster('${safeId}', '${nameForJs}')">刪除</button>
                    </td>
                </tr>`;
            }
        });
        html += '</table>';
        listContainer.innerHTML = html;

    } catch (error) {
        console.error(error);
        listContainer.innerHTML = `<div style="color:red;">讀取錯誤：${error.message}</div>`;
    }
}

// [v18.2.0] Page 8 Inline Save
async function saveMasterStudentInline(studentId) {
    const newNum = document.getElementById(`edit-num-${studentId}`).value.trim();
    const newName = document.getElementById(`edit-name-${studentId}`).value.trim();
    const classId = document.getElementById('manage-class-id').value;

    if (!newName) { alert("姓名不能為空"); return; }

    try {
        const { error } = await supabaseClient
            .from('students')
            .update({ student_number: newNum, name: newName })
            .eq('id', studentId);

        if (error) throw error;

        // 成功，退出編輯模式並刷新
        _editingMasterStudentId = null;
        if(typeof showToast === 'function') showToast("已更新", "success");
        loadMasterStudentList(classId);

    } catch (e) {
        alert("更新失敗：" + e.message);
    }
}

function cancelMasterStudentInline() {
    _editingMasterStudentId = null;
    const classId = document.getElementById('manage-class-id').value;
    loadMasterStudentList(classId);
}

// 4. 處理 Excel 匯入 (核心功能)
async function handleMasterListImport(input) {
    if (!input.files || input.files.length === 0) return;
    const file = input.files[0];
    const classId = document.getElementById('manage-class-id').value;

    const reader = new FileReader();
    reader.onload = async (e) => {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 }); // 讀取為陣列陣列 [[row1], [row2]]

            // 解析 Excel：假設第一行是標題，或者自動偵測
            // 我們嘗試尋找含有數字和文字的行
            const studentsToInsert = [];
            
            // 簡單解析邏輯：
            // 如果一行有 2 個欄位，假設是 [學號, 姓名] 或 [姓名, 學號]
            // 我們用正則表達式判斷
            
            for (let row of jsonData) {
                if (row.length < 2) continue; // 忽略太短的行
                
                let num = '';
                let name = '';
                
                // 嘗試判斷哪一個是學號，哪一個是姓名
                const colA = String(row[0]).trim();
                const colB = String(row[1]).trim();

                // 如果第一欄係數字 (1, 01, '1')，第二欄係中文/英文 -> A:學號, B:姓名
                if (/^\d+$/.test(colA) || /^\d+[A-Za-z]?$/.test(colA)) {
                    num = colA;
                    name = colB;
                } 
                // 相反
                else if (/^\d+$/.test(colB)) {
                    num = colB;
                    name = colA;
                }
                // 如果都唔係，可能係標題 (e.g. "學號", "姓名") -> 跳過
                else {
                    continue;
                }

                if (name && num) {
                    studentsToInsert.push({
                        class_id: classId,
                        student_number: num,
                        name: name
                    });
                }
            }

            if (studentsToInsert.length === 0) {
                alert("無法識別 Excel 內容。請確保 Excel 包含兩欄：學號、姓名。");
                return;
            }

            if (!confirm(`即將匯入 ${studentsToInsert.length} 位學生，確定嗎？`)) return;

            // 寫入 Database
            const { error } = await supabaseClient
                .from('students')
                .insert(studentsToInsert);

            if (error) throw error;

            alert(`成功匯入 ${studentsToInsert.length} 位學生！`);
            loadMasterStudentList(classId); // 刷新列表

        } catch (error) {
            console.error(error);
            alert("匯入失敗：" + error.message);
        } finally {
            input.value = ''; // 清空 Input 方便下次再選
        }
    };
    reader.readAsArrayBuffer(file);
}

// 5. 手動新增單個學生
async function addSingleStudentToMaster() {
    const classId = document.getElementById('manage-class-id').value;
    const numInput = document.getElementById('new-student-no');
    const nameInput = document.getElementById('new-student-name');
    
    const num = numInput.value.trim();
    const name = nameInput.value.trim();

    if (!name) {
        alert("請輸入姓名");
        return;
    }

    try {
        const { error } = await supabaseClient
            .from('students')
            .insert([{ class_id: classId, student_number: num, name: name }]);

        if (error) throw error;

        // 清空輸入框並刷新
        numInput.value = '';
        nameInput.value = '';
        loadMasterStudentList(classId);

    } catch (error) {
        alert("新增失敗：" + error.message);
    }
}

// [v18.1.1] Page 8: Delete Logic (Custom UI)
async function deleteStudentFromMaster(studentId, studentName) {
    // 1. 使用自定義 Modal 取代原生 confirm
    const isConfirmed = await showCustomModal({
        icon: '🗑️',
        title: '危險動作',
        desc: `確定要從母名單移除 [${studentName}] 嗎？\n此操作無法復原，且會影響日後的新增作業。`,
        confirmText: '確認移除',
        cancelText: '取消' // 按取消會回傳 false
    });
    
    if (!isConfirmed) return;
    
    const classId = document.getElementById('manage-class-id').value;
    // 雖然 Custom Modal 無按鈕鎖定 (因為是 await)，但這裡可以加一點視覺反饋
    if(typeof showToast === 'function') showToast("正在移除...", "info");

    try {
        const { error } = await supabaseClient
            .from('students')
            .delete()
            .eq('id', studentId);
            
        if (error) throw error;
        
        // 成功後刷新列表
        await loadMasterStudentList(classId);
        
        if(typeof showToast === 'function') showToast(`已移除：${studentName}`, "success");

    } catch (error) {
        // 使用 Custom Modal 顯示錯誤 (比較一致)
        showCustomModal({
            icon: '❌',
            title: '刪除失敗',
            desc: error.message,
            confirmText: '知道了'
        });
    }
}

// [v18.1.0] Page 8: Edit Student Logic (UUID)
async function editStudentFromMaster(studentId, oldNum, oldName) {
    const classId = document.getElementById('manage-class-id').value;

    // 1. 修改學號
    const newNum = await showCustomModal({
        icon: '🔢', 
        title: '編輯學生', 
        desc: `修改 [${oldName}] 的學號`,
        showInput: true, 
        defaultValue: oldNum
    });
    if (newNum === false) return; // 按了取消

    // 2. 修改姓名
    const newName = await showCustomModal({
        icon: '✏️', 
        title: '編輯學生', 
        desc: '修改姓名',
        showInput: true, 
        defaultValue: oldName
    });
    if (newName === false) return; // 按了取消
    
    if (!newName.trim()) { alert("姓名不能為空"); return; }

    // 3. 執行 UPDATE
    try {
        const { error } = await supabaseClient
            .from('students')
            .update({ 
                student_number: newNum.trim(),
                name: newName.trim()
            })
            .eq('id', studentId);

        if (error) throw error;

        if(typeof showToast === 'function') showToast("資料已更新", "success");
        loadMasterStudentList(classId); // 刷新列表

    } catch (e) {
        alert("更新失敗：" + e.message);
    }
}

// ==========================================
// ====== Phase 2.1 (Part 2): 班級頁邏輯 ======
// ==========================================

// [Fix-Page8-Duplicate] 班級管理列表 (防重複、防撞車版)
let _isClassesLoading = false; // Page 8 專用鎖

/* [v18.3] 班級卡片 (極簡風格渲染) */
async function loadAllClasses() {
    const container = document.getElementById('class-management-list');
    if (!container || _isClassesLoading) return;
    _isClassesLoading = true;
    container.innerHTML = '<div class="dashboard-loading"><div class="spinner"></div> 讀取中...</div>';

    try {
        const { data: classes } = await supabaseClient.from('classes').select('*').eq('user_id', currentUser.id).order('academic_year', {ascending:false}).order('class_name', {ascending:true});
        const { data: assignments } = await supabaseClient.from('assignments').select('id, title, class_id, created_at').eq('user_id', currentUser.id).order('created_at', {ascending:false});
        
        // 讀取進度數據 (優化版)
        const { data: results } = await supabaseClient.from('results').select('assignment_id, updated_at, students(name)');

        container.innerHTML = '';
        if (!classes || !classes.length) {
            container.innerHTML = `<div style="text-align:center;padding:3rem;color:#999;">暫無班級</div>`;
            _isClassesLoading = false; return;
        }

        // 🎨 文青質感配色 (用於標籤)
        const colors = ['#5A8F7B', '#c86a5a', '#8d775f', '#607d8b', '#d4a373', '#7986cb'];

        for (let i = 0; i < classes.length; i++) {
            const cls = classes[i];
            const { count: studentCount } = await supabaseClient.from('students').select('*', { count: 'exact', head: true }).eq('class_id', cls.id);
            const color = colors[i % colors.length];
            
            // Recent Project Logic
            const recentProj = assignments ? assignments.find(a => a.class_id === cls.id) : null;
            let recentHtml = `<span style="font-size:0.8rem; color:#ccc;">(暫無作業)</span>`;
            
            if (recentProj) {
                const projResults = results ? results.filter(r => r.assignment_id === recentProj.id) : [];
                const gradedCount = projResults.length;
                const total = studentCount || 1;
                
                projResults.sort((a,b) => new Date(b.updated_at) - new Date(a.updated_at));
                const lastStudentName = projResults.length > 0 ? (projResults[0].students?.name || "未知") : "無";
                const jumpAction = `localStorage.setItem('idw_jump_target', '${lastStudentName}'); openAssignment('${recentProj.id}');`;

                // 簡約連結：只有文字和箭頭
                recentHtml = `
                    <div onclick="${jumpAction}" style="cursor:pointer; display:flex; flex-direction:column; gap:2px;">
                        <div style="font-size:0.85rem; color:#666;">
                            📝 <b>${escapeHtml(recentProj.title)}</b>
                            <span style="color:${color}; margin-left:5px;">(${gradedCount}/${total})</span>
                        </div>
                        <div style="font-size:0.75rem; color:#999;">
                            最後：${escapeHtml(lastStudentName)} <span style="font-size:0.9rem; vertical-align:middle;">➜</span>
                        </div>
                    </div>
                `;
            }

            const card = document.createElement('div');
            card.className = 'task-item'; // 使用新 CSS
            
            // 寫入變數供按鈕使用
            card.style.setProperty('--btn-color', color);

            card.innerHTML = `
                <!-- 上半部：標籤與標題 -->
                <div>
                    <span class="class-tag" style="background:${color}15; color:${color};">
                        ${escapeHtml(cls.academic_year)}
                    </span>
                    <div class="class-title">${escapeHtml(cls.class_name)}</div>
                    <div style="font-size:0.85rem; color:#888; margin-top:5px;">👤 ${studentCount||0} 位學生</div>
                </div>

                <!-- 下半部：最近作業與操作 -->
                <div class="class-footer">
                    <!-- 左邊：最近作業狀態 (可點擊) -->
                    <div style="flex:1;">
                        ${recentHtml}
                    </div>

                    <!-- 右邊：工具按鈕 -->
                    <div style="display:flex; gap:6px; align-items:center;">
                        <button class="action-btn" title="開新作業" 
                            style="padding:6px 10px; font-size:0.9rem; background:${color}; width:32px; height:32px; display:flex; justify-content:center; align-items:center; border-radius:8px;" 
                            onclick="startNewProjectForClass('${cls.id}', '${escapeHtmlAttr(cls.class_name)}')">
                            ✨
                        </button>
                        
                        <div style="width:1px; height:20px; background:#eee; margin:0 4px;"></div>

                        <button onclick="manageStudents('${cls.id}', '${escapeHtmlAttr(cls.class_name)}')" title="名單" style="background:transparent; border:none; cursor:pointer; font-size:1.1rem; opacity:0.6;">👥</button>
                        <button onclick="editClass('${cls.id}', '${escapeHtmlAttr(cls.academic_year)}', '${escapeHtmlAttr(cls.class_name)}')" title="編輯" style="background:transparent; border:none; cursor:pointer; font-size:1rem; opacity:0.4;">✏️</button>
                        <button onclick="deleteClass('${cls.id}', '${escapeHtmlAttr(cls.class_name)}')" title="刪除" style="background:transparent; border:none; cursor:pointer; font-size:1rem; opacity:0.4; color:#c86a5a;">🗑️</button>
                    </div>
                </div>
            `;
            container.appendChild(card);
        }
    } catch (e) { container.innerHTML = '錯誤'; console.error(e); } finally { _isClassesLoading = false; }
}
/* [v17.3] 新增班級 (強制同步 P1) */
async function createNewClass() {
    if (!currentUser) { alert("請先登入"); return; }
    
    // 1. 問學年 (Enter 鍵修復在 showCustomModal)
    const today = new Date();
    const defYear = (today.getMonth() + 1) >= 9 ? `${today.getFullYear()}-${today.getFullYear()+1}` : `${today.getFullYear()-1}-${today.getFullYear()}`;
    const inputYear = await showCustomModal({ icon: '📅', title: '新增班級', desc: '學年', showInput: true, defaultValue: defYear });
    if (!inputYear) return;

    // 2. 問班名
    const className = await showCustomModal({ icon: '🏫', title: '新增班級', desc: '班名 (e.g. 6A)', showInput: true, defaultValue: '' });
    if (!className) return;

    try {
        const { data, error } = await supabaseClient.from('classes').insert([{ user_id: currentUser.id, academic_year: inputYear.trim(), class_name: className.trim() }]).select().single();
        if (error) throw error;

        // 🔥 3. 核心：強制清空並重載 Page 1 選單
        const p1Select = document.getElementById('setup-class-select');
        if (p1Select) {
            p1Select.innerHTML = '<option>刷新中...</option>';
            await loadPage1ClassDropdown(true); // true = 強制刷新
        }

        // 4. 刷新 Page 8
        await loadAllClasses();
        
        manageStudents(data.id, data.class_name);
        if (typeof showToast === 'function') showToast("🎉 班級已建立", "success");

    } catch (error) { alert(error.message); }
}

// [Pro-v7.5] 刪除班級 (加入 Page 1 聯動更新)
async function deleteClass(classId, className) {
    const confirmDelete = await showCustomModal({
        icon: '⚠️',
        title: '刪除確認',
        desc: `確定要刪除「${className}」嗎？\n這將會同時刪除該班級的所有學生名單。\n(已批改的作業記錄不會受影響)`,
        confirmText: '確認刪除',
        cancelText: '再諗諗'
    });

    if (!confirmDelete) return;

    try {
        const { error } = await supabaseClient
            .from('classes')
            .delete()
            .eq('id', classId);

        if (error) throw error;
        
        if (typeof showToast === 'function') showToast(`已刪除班級：${className}`, "success");
        
        // A. 刷新 Page 8 列表 (自己)
        await loadAllClasses(); 
        
        // B. 🔥 刷新 Page 1 下拉選單 (重點！刪完要去通知 Page 1 移除個選項)
        await loadPage1ClassDropdown(true); 

    } catch (error) {
        console.error(error);
        showCustomModal({ icon:'❌', title:'刪除失敗', desc: error.message });
    }
}

// 4. Hook 落 showPage 度，確保切換頁面時會刷新
// 修改原本的 showPage 函數太麻煩，我們用 Event Listener 監聽
// 在 initHotkeys 或 attachGlobalListeners 附近加入：
document.addEventListener('click', (e) => {
    if(e.target && e.target.id === 'nav-page8') {
        loadAllClasses();
    }
});

// ✅✅✅ 貼上結束 ✅✅✅


// ==========================================
// ====== Phase 2.2: 開新批改流程 (修正版) ======
// ==========================================

// 1. 切換模式 (UI Toggle)
function toggleSetupMode() {
    const mode = document.querySelector('input[name="setup-mode"]:checked').value;
    const regPanel = document.getElementById('setup-registry-panel');
    const manPanel = document.getElementById('setup-manual-panel');
    
    if (mode === 'registry') {
        regPanel.style.display = 'block';
        manPanel.style.display = 'none';
        loadPage1ClassDropdown(); // 載入班級
    } else {
        regPanel.style.display = 'none';
        manPanel.style.display = 'block';
    }
}

// [Pro-v9.9-Fix] 下拉選單 (強制清空重讀版)
async function loadPage1ClassDropdown(forceRefresh = false) {
    const select = document.getElementById('setup-class-select');
    if (!select) return;

    if (!currentUser) {
        select.innerHTML = '<option value="">(請先登入)</option>';
        return;
    }
    
    // 🔥 邏輯修正：如果不強制刷新，且已經有資料 (長度 > 1)，先至 Return
    // 即係話：forceRefresh = true 時，下面呢句會被無視，直接執行落去
    if (!forceRefresh && select.options.length > 1) return; 

    // 🔥 關鍵動作：即刻清空舊資料，防止舊班級殘留
    select.innerHTML = '<option>讀取中...</option>';

    try {
        const { data: classes, error } = await supabaseClient
            .from('classes')
            .select('*')
            .eq('user_id', currentUser.id)
            .order('academic_year', { ascending: false })
            .order('class_name', { ascending: true });

        if (error) throw error;

        // 如果連 DB 都冇資料
        if (!classes || classes.length === 0) {
            select.innerHTML = '<option value="">(暫無班級)</option>';
            return;
        }

        // 重新建立選項
        select.innerHTML = '<option value="">-- 請選擇班級 --</option>';
        classes.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c.id;
            opt.textContent = `${c.class_name} (${c.academic_year})`;
            opt.dataset.className = c.class_name; 
            select.appendChild(opt);
        });
        
        console.log("✅ Page 1 班級名單已更新 (數量: " + classes.length + ")");

    } catch (err) {
        console.error("Page 1 讀取失敗:", err);
        select.innerHTML = '<option value="">讀取失敗，請重試</option>';
    }
}


// 4. 全選 / 全不選
function toggleAllSetupStudents(checked) {
    document.querySelectorAll('#setup-student-checklist .student-check-card').forEach(card => {
        const cb = card.querySelector('input');
        cb.checked = checked;
        if(checked) card.classList.add('checked');
        else card.classList.remove('checked');
    });
}


// ==========================================
// ====== Phase 2.2: 開新批改流程 (完整版) ======
// ==========================================

function toggleSetupMode() {
    const mode = document.querySelector('input[name="setup-mode"]:checked').value;
    document.getElementById('setup-registry-panel').style.display = mode === 'registry' ? 'block' : 'none';
    document.getElementById('setup-manual-panel').style.display = mode === 'manual' ? 'block' : 'none';
    if (mode === 'registry') loadPage1ClassDropdown();
}

async function loadPage1ClassDropdown() {
    const select = document.getElementById('setup-class-select');
    if (!select || select.options.length > 1) return; 
    if (!currentUser) { select.innerHTML = '<option value="">(請先登入)</option>'; return; }

    select.innerHTML = '<option>讀取中...</option>';
    try {
        const { data: classes } = await supabaseClient
            .from('classes').select('*').eq('user_id', currentUser.id)
            .order('academic_year', { ascending: false }).order('class_name', { ascending: true });

        if (!classes.length) { select.innerHTML = '<option value="">(暫無班級)</option>'; return; }

        select.innerHTML = '<option value="">-- 請選擇班級 --</option>';
        classes.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c.id;
            opt.textContent = `${c.class_name} (${c.academic_year})`;
            opt.dataset.className = c.class_name; 
            select.appendChild(opt);
        });
    } catch (e) { console.error(e); select.innerHTML = '<option>讀取失敗</option>'; }
}



function toggleAllSetupStudents(checked) {
    document.querySelectorAll('#setup-student-checklist .student-check-card').forEach(card => {
        const cb = card.querySelector('input');
        cb.checked = checked;
        card.classList.toggle('checked', checked);
    });
}

/* ================================================= */
/* === [v16.1 Fix] Page 1 啟動批改 (純班級版) === */
/* ================================================= */

// [v18.5] 步驟一：檢查並彈出確認視窗 (含 ID 安全檢查)
let _pendingSetupData = null; 

// [v18.7] 步驟一：檢查並彈出確認視窗 (點列名單版)
function startGradingWithSetup(actionType) {
    const topicInput = document.getElementById('topic');
    if (!topicInput || !topicInput.value.trim()) {
        alert("請輸入作文題目！");
        if(topicInput) topicInput.focus();
        return;
    }

    const select = document.getElementById('setup-class-select');
    if (!select || !select.value) {
        alert("請選擇班級！");
        return;
    }

    const checkedCards = document.querySelectorAll('#setup-student-checklist .student-check-card.checked');
    if (checkedCards.length === 0) {
        alert("⚠️ 請至少勾選一位學生！");
        return;
    }

    const className = select.options[select.selectedIndex].dataset.className || '未命名班級';
    const topic = topicInput.value.trim();
    const count = checkedCards.length;

    const selectedStudents = [];
    let rawStudentList = "";
    const tempRecords = [];
    const displayNames = [];
    
    // 安全檢查旗標
    let missingIdCount = 0;

    checkedCards.forEach(card => {
        const info = card.dataset.info; 
        const dbId = card.dataset.dbId; 
        
        if (!dbId || dbId === "undefined" || dbId === "null") {
            missingIdCount++;
            console.warn("Missing ID for card:", info);
        } else {
            rawStudentList += info + "\n";
            selectedStudents.push(dbId);
            displayNames.push(info);

            const p = parseStudentName(info);
            tempRecords.push({
                number: p.number, name: p.name, originalName: p.originalName, dbId: dbId, data: null
            });
        }
    });

    // 自動修復機制
    if (missingIdCount > 0) {
        if(confirm(`系統偵測到 ${missingIdCount} 位學生資料未同步 (缺少 ID)。\n\n點擊「確定」將嘗試自動修復並重新讀取列表。\n(讀取完成後，請再次點擊開始按鈕)`)) {
            window.handleClassSelectChange();
        }
        return;
    }
    
    _pendingSetupData = {
        actionType: actionType,
        classId: select.value,
        className: className,
        topic: topic,
        selectedIds: selectedStudents,
        tempRecords: tempRecords,
        rawStudentList: rawStudentList
    };

    document.getElementById('confirm-topic-display').textContent = topic;
    document.getElementById('confirm-class-display').textContent = className;
    document.getElementById('confirm-count-display').textContent = `${count} 人`;
    
    // ✅ [修改部分] 渲染點列式名單 (CSS Grid 雙欄佈局)
    const listEl = document.getElementById('confirm-student-list');
    if(listEl) {
        // 使用 Grid 讓名單排成兩欄，並加上小圓點
        const listHtml = `
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
                ${displayNames.map(name => `
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <span style="color: #5A8F7B; font-size: 1.2em;">•</span>
                        <span>${escapeHtml(name)}</span>
                    </div>
                `).join('')}
            </div>
        `;
        listEl.innerHTML = listHtml;
    }
    
    const confirmBtn = document.getElementById('btn-create-project-confirm');
    if(confirmBtn) confirmBtn.onclick = executeCreateProject; 
    
    const modal = document.getElementById('pop-setup-confirm-modal');
    if(modal) modal.classList.add('active');
}

// [v18.4] 步驟二：執行建立與初始化 (Safe Insert Fix)
async function executeCreateProject() {
    if (!_pendingSetupData) return;
    
    const { actionType, classId, topic, selectedIds, tempRecords, rawStudentList, className } = _pendingSetupData;
    const btn = document.getElementById('btn-create-project-confirm');
    
    const orgText = btn.textContent;
    btn.textContent = "建立中..."; 
    btn.disabled = true;

    try {
        if (!currentUser) {
            throw new Error("請先登入以建立雲端專案");
        }

        // 1. 建立/獲取 Assignment (避開 ON CONFLICT 錯誤)
        // 先檢查是否已存在
        const { data: existingAssign, error: checkError } = await supabaseClient
            .from('assignments')
            .select('id')
            .eq('class_id', classId)
            .eq('title', topic)
            .maybeSingle(); // 使用 maybeSingle 避免報錯

        if (checkError) throw checkError;

        let assignmentId;

        if (existingAssign) {
            // 如果已存在，直接用舊 ID
            assignmentId = existingAssign.id;
            console.log("專案已存在，使用舊 ID:", assignmentId);
        } else {
            // 如果不存在，才插入新的一筆
            const { data: newAssign, error: createError } = await supabaseClient
                .from('assignments')
                .insert({
                    user_id: currentUser.id,
                    class_id: classId,
                    title: topic,
                    created_at: new Date().toISOString()
                })
                .select()
                .single();
            
            if (createError) throw createError;
            assignmentId = newAssign.id;
        }

        // 2. 批量寫入 Results (初始化分母)
        if (selectedIds.length > 0) {
            const resultsToInsert = selectedIds.map(stuId => ({
                assignment_id: assignmentId,
                student_id: stuId,
                updated_at: new Date().toISOString()
            }));

            // 使用 ignoreDuplicates: true 來忽略重複插入錯誤 (Supabase 標準功能)
            const { error: batchError } = await supabaseClient
                .from('results')
                .upsert(resultsToInsert, { onConflict: 'assignment_id, student_id', ignoreDuplicates: true });
            
            if (batchError) throw batchError;
        }

        // 3. 設定前端環境
        window.currentClassId = classId;
        window.currentAssignmentId = assignmentId;
        window.currentProjectType = 'cloud';
        
        allStudentRecords = tempRecords;
        sortStudents(allStudentRecords);

        // 4. 同步 UI
        if(document.getElementById('student-names')) document.getElementById('student-names').value = rawStudentList;
        if(document.getElementById('student-class')) document.getElementById('student-class').value = className;
        if(document.getElementById('page2-topic-display')) document.getElementById('page2-topic-display').value = topic;

        updateStudentDropdown();
        updateHeaderInfo();

        // 5. 關閉 Modal
        document.getElementById('pop-setup-confirm-modal').classList.remove('active');

        // 6. 處理評語庫與跳轉
        if (actionType === 'default') {
            loadCannedCritiquesAndFocus(); 
        } else {
            const cData = document.getElementById('critique-data');
            if(cData) cData.innerHTML = '';
            buildChecklist();
            buildOverviewPage();
            showPage('page2', 'student-select');
        }

        if(typeof showToast === 'function') showToast(`✅ 專案已建立！已分配 ${selectedIds.length} 位學生`, "success");

        // 7. 刷新 Dashboard
        if (typeof loadDashboard === 'function') loadDashboard();

    } catch (error) {
        console.error("Setup Error:", error);
        alert("建立失敗：" + error.message);
    } finally {
        btn.textContent = orgText; 
        btn.disabled = false;
    }
}

// 下載「手動模式」專用的簡單範本
function downloadManualTemplate() {
    if (typeof XLSX === 'undefined') {
        alert('Excel 功能未就緒，請稍後再試。');
        return;
    }
    
    // 簡單的單欄或雙欄格式
    const templateData = [
        { "學號": "01", "姓名": "陳大文 (範例)" },
        { "學號": "02", "姓名": "李小美 (範例)" },
        { "學號": "03", "姓名": "張志明 (範例)" }
    ];

    const ws = XLSX.utils.json_to_sheet(templateData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "學生名單");
    
    XLSX.writeFile(wb, "學生名單範本_手動輸入用.xlsx");
}
// 1. 下載班級名單範本
function downloadMasterListTemplate() {
    if (typeof XLSX === 'undefined') {
        alert('Excel 功能未就緒。');
        return;
    }
    const templateData = [
        { "學號": "01", "姓名": "陳大文" },
        { "學號": "02", "姓名": "李小美" }
    ];
    const ws = XLSX.utils.json_to_sheet(templateData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "名單範本");
    XLSX.writeFile(wb, "班級名單範本.xlsx");
}

// 2. 批量貼上新增 (支援一行一個)
async function addBatchStudentsToMaster() {
    const classId = document.getElementById('manage-class-id').value;
    const text = document.getElementById('batch-student-input').value;
    
    if (!text.trim()) {
        alert("請輸入或貼上學生名單！");
        return;
    }

    // 解析文字 (支援 "01 陳大文" 或 "陳大文")
    const lines = text.split('\n').filter(line => line.trim() !== '');
    const studentsToInsert = lines.map(line => {
        const match = line.trim().match(/^(\d+)[-\s._]*(.*)$/);
        if (match) {
            return { class_id: classId, student_number: match[1], name: match[2].trim() };
        } else {
            return { class_id: classId, student_number: '', name: line.trim() };
        }
    });

    if (studentsToInsert.length === 0) return;

    const btn = event.target;
    const orgText = btn.textContent;
    btn.textContent = "新增中...";
    btn.disabled = true;

    try {
        const { error } = await supabaseClient.from('students').insert(studentsToInsert);
        if (error) throw error;
        
        alert(`成功新增 ${studentsToInsert.length} 位學生！`);
        document.getElementById('batch-student-input').value = ''; // 清空
        loadMasterStudentList(classId); // 刷新列表
    } catch (err) {
        alert("新增失敗：" + err.message);
    } finally {
        btn.textContent = orgText;
        btn.disabled = false;
    }
}
// [Pro-v4.2-Fix] 從記憶體渲染下拉選單 (保護 ID 不丟失)
function renderDropdownFromMemory() {
    const studentSelect = document.getElementById('student-select');
    studentSelect.innerHTML = allStudentRecords.length === 0 ? '<option value="">請先在上方輸入學生名單</option>' : '';
    
    allStudentRecords.forEach(p => {
        const option = document.createElement('option');
        option.value = p.originalName;
        
        let displayName = p.name;
        if (p.number !== null) {
            const paddedNum = p.number.toString().padStart(2, '0');
            displayName = `${paddedNum} ${p.name}`;
        }
        option.textContent = displayName;
        studentSelect.appendChild(option);
    });

    if (studentSelect.options.length > 0) {
        studentSelect.selectedIndex = 0;
        loadStudentData(studentSelect.value);
    }
    
    updateAllOutputs();
    renderStudentOverviewTable();
}
// [Pro-v5.0] 共用排序工具 (統一全 App 標準)
function sortStudents(studentsArray) {
    const collator = new Intl.Collator(undefined, { numeric: true, sensitivity: 'base' });
    return studentsArray.sort((a, b) => {
        // 處理可能係物件 (Page 1) 或者純名單物件
        // 統一轉成字串比較
        const numA = (a.student_number || a.number || '').toString();
        const numB = (b.student_number || b.number || '').toString();
        
        const numResult = collator.compare(numA, numB);
        if (numResult !== 0) return numResult;
        
        const nameA = a.name || '';
        const nameB = b.name || '';
        return collator.compare(nameA, nameB);
    });
}
/* [v17.3] 通用 Modal (Enter 修復) */
function showCustomModal({ icon='✨', title, desc, showInput=false, defaultValue='', confirmText='確定', cancelText='取消' }) {
    return new Promise((resolve) => {
        const modal = document.getElementById('pop-generic-modal');
        const titleEl = document.getElementById('pop-generic-title');
        const descEl = document.getElementById('pop-generic-desc');
        const iconEl = document.getElementById('pop-generic-icon');
        const inputContainer = document.getElementById('pop-generic-input-container');
        const input = document.getElementById('pop-generic-input'); // 確保 HTML 有這個 ID
        const confirmBtn = document.getElementById('pop-generic-confirm');
        const cancelBtn = document.getElementById('pop-generic-cancel');

        iconEl.textContent = icon;
        titleEl.textContent = title;
        descEl.textContent = desc || '';
        confirmBtn.textContent = confirmText;
        cancelBtn.textContent = cancelText;

        // Reset Input Container HTML (防止殘留 Checkbox)
        if (showInput) {
            inputContainer.style.display = 'block';
            inputContainer.innerHTML = `<input type="text" id="pop-generic-input" class="pop-input" value="${escapeHtmlAttr(defaultValue)}">`;
            const newInput = document.getElementById('pop-generic-input');
            
            setTimeout(() => { 
                newInput.focus(); 
                newInput.select(); 
            }, 100);

            // 🔥 綁定 Enter
            newInput.onkeydown = (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    e.stopPropagation(); // 防止冒泡
                    confirmBtn.click();
                }
            };
        } else {
            inputContainer.style.display = 'none';
            setTimeout(() => confirmBtn.focus(), 100);
        }

        modal.classList.add('active');

        const cleanup = () => {
            modal.classList.remove('active');
            confirmBtn.onclick = null;
            cancelBtn.onclick = null;
        };

        confirmBtn.onclick = () => { 
            const val = document.getElementById('pop-generic-input')?.value;
            cleanup(); 
            resolve(showInput ? val : true); 
        };
        
        // Cancel 鍵不做任何 Enter 綁定，防止誤觸
        cancelBtn.onclick = () => { cleanup(); resolve(false); };
    });
}

// [Pro-v6.12] 編輯班級功能
async function editClass(classId, oldYear, oldName) {
    // 1. 修改學年
    const newYear = await showCustomModal({
        icon: '📅', title: '編輯班級', desc: '修改學年',
        showInput: true, defaultValue: oldYear
    });
    if (!newYear) return;

    // 2. 修改班名
    const newName = await showCustomModal({
        icon: '🏫', title: '編輯班級', desc: '修改班別名稱',
        showInput: true, defaultValue: oldName
    });
    if (!newName) return;

    try {
        const { error } = await supabaseClient
            .from('classes')
            .update({ academic_year: newYear.trim(), class_name: newName.trim() })
            .eq('id', classId);

        if (error) throw error;
        
        if(typeof showToast === 'function') showToast("班級資料已更新", "success");
        loadAllClasses();

    } catch (e) {
        alert("更新失敗：" + e.message);
    }
}

// [Pro-v9.2] 智能重載評語庫 (Helper)
async function reloadCritiqueLibrary(genre) {
    const dataContainer = document.getElementById('critique-data');
    if (!dataContainer) return;
    
    dataContainer.innerHTML = ''; // 1. 清空現有 DOM

    // 2. 準備要載入的文體 (指定文體 + 通用)
    const genresToLoad = genre ? [genre, 'common'] : ['common'];
    const critiquesToLoad = new Map();

    const addCritique = (critique) => {
        if (!critiquesToLoad.has(critique.id)) {
            critiquesToLoad.set(critique.id, critique);
        }
    };

    // 3. 載入罐頭評語
    genresToLoad.forEach(g => {
        if (cannedCritiques && cannedCritiques[g]) {
            cannedCritiques[g].forEach(addCritique);
        }
    });

    // 4. 載入用戶自定義評語 (從雲端)
    if (currentUser) {
        try {
            const { data: customData } = await supabaseClient
                .from('critiques')
                .select('*')
                .eq('user_id', currentUser.id);
            
            if (customData) {
                customData.forEach(c => {
                    // 確保欄位對應
                    addCritique({
                        id: c.critique_id, 
                        category: c.category, 
                        type: c.type, 
                        title: c.title,
                        strengthSummary: c.strength_summary, 
                        problemCore: c.problem_core,
                        suggestion: c.suggestion, 
                        example: c.example, 
                        options: c.options, 
                        optionsLabel: c.options_label
                    });
                });
            }
        } catch (e) { console.error("Reload Custom Critiques Error", e); }
    }

    // 5. 寫入 DOM 並重建介面
    const finalCritiques = Array.from(critiquesToLoad.values());
    applyCritiquesToDOM(finalCritiques);
    buildChecklist();
    buildOverviewPage();
    
    console.log(`✅ 評語庫已切換至：${genre || '通用'}`);
}

// [Pro-v9.5 Step 3] 附加預設評語 (Append Logic)
function appendPresetsMenu() {
    // 重用 Generic Modal 顯示選項
    const modal = document.getElementById('pop-generic-modal');
    const inputContainer = document.getElementById('pop-generic-input-container');
    const confirmBtn = document.getElementById('pop-generic-confirm');
    
    document.getElementById('pop-generic-icon').textContent = '➕';
    document.getElementById('pop-generic-title').textContent = '附加預設評語';
    document.getElementById('pop-generic-desc').textContent = '選擇要加入的類別 (將加到現有評語後，不會刪除舊資料)：';
    
    // 選項 HTML
    inputContainer.style.display = 'block';
    inputContainer.innerHTML = `
        <div style="text-align:left; padding:10px;">
            <label class="pop-list-item"><input type="checkbox" class="append-cb" value="narrative"> 📝 記敘文</label>
            <label class="pop-list-item"><input type="checkbox" class="append-cb" value="lyrical"> ❤️ 抒情文</label>
            <label class="pop-list-item"><input type="checkbox" class="append-cb" value="descriptive"> 🖼️ 描寫文</label>
            <label class="pop-list-item"><input type="checkbox" class="append-cb" value="argumentative"> 🗣️ 議論文</label>
            <label class="pop-list-item"><input type="checkbox" class="append-cb" value="common"> 🔧 通用評語</label>
        </div>
    `;
    
    modal.classList.add('active');
    
    confirmBtn.onclick = () => {
        const selected = Array.from(inputContainer.querySelectorAll('.append-cb:checked')).map(cb => cb.value);
        if (selected.length === 0) { modal.classList.remove('active'); return; }
        
        executeAppend(selected);
        
        // 還原 Modal
        inputContainer.innerHTML = '<input type="text" id="pop-generic-input" class="pop-input">';
        modal.classList.remove('active');
    };
}

function executeAppend(genres) {
    // 1. 收集現有評語
    const currentData = collectExportData();
    const existingIds = new Set(currentData.map(c => c.id));
    
    // 2. 收集要加入的罐頭
    let addedCount = 0;
    genres.forEach(g => {
        if (cannedCritiques[g]) {
            cannedCritiques[g].forEach(c => {
                // 防止 ID 重複 (雖然罐頭 ID 固定，但為了安全)
                if (!existingIds.has(c.id)) {
                    currentData.push(c);
                    existingIds.add(c.id);
                    addedCount++;
                }
            });
        }
    });
    
    if (addedCount === 0) {
        if(typeof showToast === 'function') showToast("所選評語已存在，無需加入。", "info");
        return;
    }

    // 3. 寫回 DOM
    applyCritiquesToDOM(currentData);
    buildOverviewPage(); // 刷新 Page 3 列表
    buildChecklist();    // 刷新 Page 2 列表
    isDataDirty = true;
    updateUIBasedOnAuthState();
    
    if(typeof showToast === 'function') showToast(`成功加入 ${addedCount} 條評語！`, "success");
}


// ============================================================
// [Pro-v9.7] 班級綜合報告邏輯 (Class Hub Export Logic)
// ============================================================

// 1. 打開報告視窗 & 載入作業列表
async function openClassReportModal(classId, className) {
    // 設定標題與隱藏 ID
    document.getElementById('report-class-id').value = classId;
    document.getElementById('report-class-title').textContent = `綜合報告：${className}`;
    
    const modal = document.getElementById('pop-class-report-modal');
    const listContainer = document.getElementById('report-project-list');
    
    // 大窗模式設定 (確保樣式正確)
    modal.querySelector('.pop-modal').classList.add('pop-modal-large');
    modal.classList.add('active');
    
    // 顯示 Loading
    listContainer.innerHTML = '<div style="text-align:center; padding:20px; color:#666;"><div class="spinner"></div> 正在讀取作業列表...</div>';

    try {
        // 讀取該班所有 Assignments
        const { data: assignments, error } = await supabaseClient
            .from('assignments')
            .select('id, title, created_at,classes(class_name)')
            .eq('class_id', classId)
            .order('created_at', { ascending: false });

        if (error) throw error;

        if (!assignments || assignments.length === 0) {
            listContainer.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">此班級暫無作業記錄。</div>';
            return;
        }

        // 渲染列表 (Checkbox)
        let html = '';
        assignments.forEach(p => {
            const dateObj = new Date(p.created_at);
            const dateStr = `${dateObj.getFullYear()}/${dateObj.getMonth()+1}/${dateObj.getDate()}`;
            
            html += `
                <label class="pop-list-item" style="display:flex; align-items:center; gap:12px; cursor:pointer; padding:12px;">
                    <input type="checkbox" class="report-proj-cb" value="${p.id}" style="width:1.3rem; height:1.3rem; accent-color:#5A8F7B;">
                    <div style="flex:1;">
                        <div style="font-weight:bold; color:#333; font-size:1rem;">${escapeHtml(p.title)}</div>
                        <div style="font-size:0.85rem; color:#888;">建立日期：${dateStr}</div>
                    </div>
                </label>
            `;
        });
        listContainer.innerHTML = html;

    } catch (err) {
        console.error(err);
        listContainer.innerHTML = `<div style="color:#c86a5a; text-align:center; padding:20px;">讀取失敗：${err.message}</div>`;
    }
}

// 2. 按下「生成 Excel」按鈕的處理
async function generateCombinedExcel() {
    // A. 檢查有無剔選作業
    const checkedBoxes = document.querySelectorAll('.report-proj-cb:checked');
    const projectIds = Array.from(checkedBoxes).map(cb => cb.value);
    
    if (projectIds.length === 0) {
        alert("請至少勾選一份作業！");
        return;
    }

    // B. 獲取模式 (Exam vs Trend)
    const modeRadio = document.querySelector('input[name="report-mode"]:checked');
    const mode = modeRadio ? modeRadio.value : 'exam';
    
    const classId = document.getElementById('report-class-id').value;
    const className = document.getElementById('report-class-title').textContent.replace('綜合報告：', '');

    // C. 鎖定按鈕 (避免連按)
    const btn = document.querySelector('#pop-class-report-modal .pop-btn-confirm');
    const originalText = btn.textContent;
    btn.textContent = "數據整合中...";
    btn.disabled = true;

    try {
        // D. 呼叫核心引擎 (下一步會寫這個函數)
        await processExcelGeneration(classId, className, projectIds, mode);
        
        // 完成後關閉
        document.getElementById('pop-class-report-modal').classList.remove('active');
        
    } catch (err) {
        console.error(err);
        alert("生成失敗：" + err.message);
    } finally {
        btn.textContent = originalText;
        btn.disabled = false;
    }
}

// [Pro-v9.8] Excel 超級引擎 (Class Hub Engine)
async function processExcelGeneration(classId, className, projectIds, mode) {
    // 1. 準備數據 (一次過撈晒全班 + 相關成績)
    if(typeof showToast === 'function') showToast("正在下載數據...", "info");

    // A. 撈學生名單
    const { data: students, error: stuErr } = await supabaseClient
        .from('students')
        .select('*')
        .eq('class_id', classId)
        .order('student_number', { ascending: true });
    if (stuErr) throw stuErr;

    // B. 撈選定的作業資料 (標題、日期)
    const { data: assignments, error: assErr } = await supabaseClient
        .from('assignments')
        .select('*')
        .in('id', projectIds)
        .order('created_at', { ascending: true }); // 按時間排序
    if (assErr) throw assErr;

    // C. 撈所有成績 (Results)
    const { data: results, error: resErr } = await supabaseClient
        .from('results')
        .select('*')
        .in('assignment_id', projectIds);
    if (resErr) throw resErr;

    // 2. 數據組裝 (Map Student -> Results)
    const studentMap = {};
    students.forEach(s => {
        studentMap[s.id] = {
            info: s,
            results: {} // assignment_id -> resultObj
        };
    });
    results.forEach(r => {
        if (studentMap[r.student_id]) {
            studentMap[r.student_id].results[r.assignment_id] = r;
        }
    });

    // 3. 開始建立 Excel
    if (!checkXlsxLibrary()) return;
    const wb = XLSX.utils.book_new();

    // ==========================================
    // Sheet 1: 總表 (Master Sheet) - 根據模式分流
    // ==========================================
    let masterData = [];

    if (mode === 'exam') {
        // --- 模式 A: 考試單次合併 (Exam Mode) ---
        // 邏輯：假設學生只會答其中一題。如果答多題，取最高分或顯示異常。
        // 欄位：學號, 姓名, 選答題目, 總分, 內容, 表達... (來自該題)
        
        masterData = students.map(s => {
            const sResults = studentMap[s.id].results;
            // 找出該生有分數的 Assignment
            const doneAssignIds = Object.keys(sResults);
            
            let row = { '學號': s.student_number, '姓名': s.name };
            
            if (doneAssignIds.length === 0) {
                row['狀態'] = '缺席 / 未交';
                row['總分'] = '';
            } else {
                // 取第一個找到的成績 (通常考試只做一份)
                const targetId = doneAssignIds[0]; 
                const targetAssign = assignments.find(a => a.id === targetId);
                const r = sResults[targetId];
                
                row['選答題目'] = targetAssign ? targetAssign.title : '未知';
                row['總分'] = r.total_score;
                row['內容'] = r.content_score;
                row['表達'] = r.expression_score;
                row['結構'] = r.structure_score;
                row['標點'] = r.punctuation_score;
                row['錯別字'] = r.typo_score;
                
                if (doneAssignIds.length > 1) {
                    row['備註'] = '⚠️ 系統偵測到多於一份作答紀錄';
                }
            }
            return row;
        });

    } else {
        // --- 模式 B: 歷程趨勢 (Trend Mode) ---
        // 邏輯：列出所有作業分數，並計算平均
        // 欄位：學號, 姓名, 作業1, 作業2, ..., 平均分
        
        masterData = students.map(s => {
            let row = { '學號': s.student_number, '姓名': s.name };
            let totalScore = 0;
            let count = 0;

            assignments.forEach(a => {
                const r = studentMap[s.id].results[a.id];
                if (r) {
                    row[a.title] = r.total_score;
                    totalScore += (parseFloat(r.total_score) || 0);
                    count++;
                } else {
                    row[a.title] = '--';
                }
            });

            row['平均分'] = count > 0 ? (totalScore / count).toFixed(1) : '';
            return row;
        });
    }

    // 寫入 Sheet 1
    const wsMaster = XLSX.utils.json_to_sheet(masterData);
    XLSX.utils.book_append_sheet(wb, wsMaster, "總表概覽");

    // ==========================================
    // Sheet 2~N: 各作業詳細分頁 (Detailed Sheets)
    // ==========================================
    assignments.forEach(a => {
        // 只篩選有做呢份功課嘅學生
        const rows = [];
        students.forEach(s => {
            const r = studentMap[s.id].results[a.id];
            if (r) {
                rows.push({
                    '學號': s.student_number,
                    '姓名': s.name,
                    '總分': r.total_score,
                    '內容': r.content_score,
                    '表達': r.expression_score,
                    '結構': r.structure_score,
                    '標點': r.punctuation_score,
                    '錯別字': r.typo_score,
                    '評語 (學生版)': r.comment_data?.pureStudentComment || '',
                    '完整評語': r.comment_data?.pureFullComment || ''
                });
            }
        });

        if (rows.length > 0) {
            // Sheet Name 最多 31 字，要截短
            const safeSheetName = a.title.replace(/[\\/?*\[\]]/g, '').substring(0, 30);
            const wsDetail = XLSX.utils.json_to_sheet(rows);
            XLSX.utils.book_append_sheet(wb, wsDetail, safeSheetName);
        }
    });

    // 4. 下載檔案
    const modeLabel = mode === 'exam' ? '考試分析' : '歷程分析';
    const filename = `${className}_${modeLabel}_${getDateTimeString()}.xlsx`;
    XLSX.writeFile(wb, filename);
}

// ============================================================
// [Pro-v9.8] 快速切換作業邏輯 (Smart Switcher)
// ============================================================

// 1. 載入同班的其他作業
async function loadSiblingProjects(classId, currentProjectId) {
    const container = document.getElementById('project-switcher-container');
    const select = document.getElementById('project-switcher');
    
    if (!classId || !currentUser) {
        container.style.display = 'none';
        return;
    }

    try {
        // 讀取該班所有作業
        const { data: projects } = await supabaseClient
            .from('assignments')
            .select('id, title')
            .eq('class_id', classId)
            .order('created_at', { ascending: false });

        // 如果只有一份作業，不需要顯示切換器
        if (!projects || projects.length <= 1) {
            container.style.display = 'none';
            return;
        }

        // 渲染選單
        select.innerHTML = '';
        projects.forEach(p => {
            const option = document.createElement('option');
            option.value = p.id;
            option.textContent = p.title;
            if (p.id === currentProjectId) option.selected = true;
            select.appendChild(option);
        });

        // 顯示切換器
        container.style.display = 'block';

    } catch (e) {
        console.error("Switcher Load Error", e);
        container.style.display = 'none';
    }
}

// 2. 執行切換
// [Pro-v9.8.1] 執行切換 (優化提示節奏)
async function switchProject(newProjectId) {
    if (!newProjectId) return;

    // A. 視覺鎖定 (話俾老師知做緊野)
    const switcherSelect = document.getElementById('project-switcher');
    if(switcherSelect) switcherSelect.disabled = true;
    
    try {
        // 1. 儲存舊進度 (會彈出 "☁️ 雲端同步完成")
        // 我們這裡不需額外 Toast，因為 saveCurrentStudentData 本身會彈
        await saveCurrentStudentData('cloud'); 
        
        // 🔥 關鍵改動：人為延遲 0.8 秒
        // 讓老師有時間睇清楚 "同步完成" 既 Toast，先至轉畫面
        await new Promise(r => setTimeout(r, 800));
        
        // 2. 載入新作業 (會彈出 "已載入：XXX")
        await openAssignment(newProjectId);
        
    } catch (e) {
        alert("切換失敗：" + e.message);
    } finally {
        if(switcherSelect) switcherSelect.disabled = false;
    }
}


// [Pro-v9.9.6] 登入牆按鈕功能

// [Pro-v9.9.9] 登入牆按鈕 (等待數據載入版)
async function handleGateAuth() {
    const email = document.getElementById('gate-email').value.trim();
    const password = document.getElementById('gate-password').value.trim();
    const btn = event.target;
    const orgText = btn.innerText;

    if (!email || !password) {
        alert("請輸入電郵和密碼 ☕");
        return;
    }

    btn.innerText = "驗證中...";
    btn.disabled = true;

    try {
        const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
        if (error) throw error;

        if (data.user) {
            currentUser = data.user;
            
            // 視覺回饋
            if (typeof showToast === 'function') showToast("歡迎回來，老師。", "success");
            
            // 🔥 關鍵：等待 checkUser 完成數據載入才開門
            // 這樣使用者一看到畫面，數據就已經在那裡了
            await checkUser(); 
            
            // 雙重保險：確保門是開的
            document.getElementById('login-gate').classList.add('unlocked');
        }
    } catch (e) {
        alert("登入失敗：" + e.message);
    } finally {
        btn.innerText = orgText;
        btn.disabled = false;
    }
}
// B. 打開註冊視窗 (借用原本的 Pop-up，浮在牆上面)
function openRegisterModal() {
    // 這裡我們直接打開原本的登入/註冊 Modal，並切換狀態
    // 為了簡單，我們可以直接打開，老師在那裡按 "註冊"
    const modal = document.getElementById('pop-login-modal');
    if(modal) {
        // 清空欄位
        document.getElementById('login-email').value = "";
        document.getElementById('login-password').value = "";
        modal.classList.add('active');
        // 提示用戶
        if(typeof showToast === 'function') showToast("請填寫資料並點擊「註冊」", "info");
    }
}

// [Pro-v10.1] 忘記密碼 (加強檢查版)
async function openForgotModal() {
    const emailInput = document.getElementById('gate-email');
    if(!emailInput) return;
    
    const email = emailInput.value.trim();
    if (!email) {
        alert("請先在上方輸入您的電郵地址，方便我們寄送重設連結給您。");
        emailInput.focus();
        return;
    }
    
    if(!confirm(`確定要發送重設密碼郵件到：\n${email}\n\n(請檢查垃圾郵件箱)`)) return;

    // 視覺反饋
    const link = document.querySelector('a[onclick="openForgotModal()"]');
    const originalText = link ? link.textContent : '忘記密碼？';
    if(link) link.textContent = "發送中...";

    try {
        console.log("正在發送重設郵件至:", email);
        console.log("Redirect URL:", window.location.href);

        const { data, error } = await supabaseClient.auth.resetPasswordForEmail(email, {
            redirectTo: window.location.href, // 確保重設後會跳返嚟呢一頁
        });

        if (error) {
            // 特別處理 Rate Limit 錯誤
            if (error.message.includes("Rate limit")) {
                throw new Error("發送太頻繁，請稍後再試 (約 1 分鐘後)。");
            }
            throw error;
        }

        alert(`✅ 郵件已發送！\n\n請前往 Email (${email}) 查收。\n(如收不到，請檢查 Spam/Junk Folder)`);

    } catch (err) {
        console.error("Forgot Password Error:", err);
        alert("發送失敗：" + err.message);
    } finally {
        if(link) link.textContent = originalText;
    }
}


/* [v12.1] Back To Top 邏輯 */
const backToTopBtn = document.getElementById("back-to-top-btn");

window.addEventListener('scroll', () => {
  if (!backToTopBtn) return;
  const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
  
  if (scrollTop > 300) {
    backToTopBtn.style.display = "block";
  } else {
    backToTopBtn.style.display = "none";
  }
});

function scrollToTop() {
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

/* ========================================= */
/* === [Edition: 書] Mobile Menu Logic === */
/* ========================================= */

// 1. 開關全螢幕目錄
function toggleBookMenu() {
    const overlay = document.getElementById('mobile-book-overlay');
    const isActive = overlay.classList.contains('active');
    
    if (isActive) {
        overlay.classList.remove('active');
    } else {
        overlay.classList.add('active');
        // 打開時，自動展開當前所在的主分類
        autoExpandCurrentSection();
    }
}

// 2. 切換子選單展開/收合 (手風琴)
function toggleBookSub(sectionId) {
    // 搵返點擊嗰個 item 嘅父層 div
    // 結構係: div.book-main-item > div.book-main-header (click target)
    // 但 onclick 綁定在 div.book-main-item 上，所以 event.currentTarget 就係該 item
    const item = event.currentTarget;
    
    // 檢查是否已經展開
    const isExpanded = item.classList.contains('expanded');
    
    // A. 先收埋其他所有已展開的 (單開邏輯，比較整潔)
    document.querySelectorAll('.book-main-item').forEach(el => {
        el.classList.remove('expanded');
    });

    // B. 如果原本未展開，就展開佢
    if (!isExpanded) {
        item.classList.add('expanded');
    }
}

// 3. 處理導航點擊
function mobileNavClick(mainTarget, pageId) {
    // A. 執行原有導航邏輯
    if (pageId) {
        showPage(pageId); // 跳轉頁面
    } else if (mainTarget === 'home') {
        showPage('page-home'); // 跳轉首頁
    }
    
    // B. 更新 Desktop Nav 狀態 (保持同步)
    switchMainTab(mainTarget);

    // C. 關閉手機目錄
    toggleBookMenu();
}

// 4. 自動展開當前章節 (UX 優化)
function autoExpandCurrentSection() {
    // 收埋全部先
    document.querySelectorAll('.book-main-item').forEach(el => el.classList.remove('expanded'));

    // 檢查邊個 Page 係 active
    const activePage = document.querySelector('.page-content.active');
    if (!activePage) return;
    
    let targetSection = '';
    const pid = activePage.id;

    // 映射表：Page ID -> Section
    if (pid === 'page-home') targetSection = 'home';
    else if (['page1', 'page2', 'page4', 'page5'].includes(pid)) targetSection = 'workspace';
    else if (['page6', 'page7'].includes(pid)) targetSection = 'ailab';
    else if (['page3', 'page8'].includes(pid)) targetSection = 'archives';

    // 觸發展開
    if (targetSection && targetSection !== 'home') {
        // 搵返對應嘅 onclick 元素並加上 expanded
        const items = document.querySelectorAll('.book-main-item');
        // 這裡我們簡單粗暴地根據 onclick string 來找
        items.forEach(item => {
            if (item.getAttribute('onclick').includes(`'${targetSection}'`)) {
                item.classList.add('expanded');
            }
        });
    }
}

/* ========================================= */
/* === [v11.1] 溫暖系複製功能 (Barista Style) === */
/* ========================================= */


// Page 7: 回饋生成
function generateFeedbackPromptAndCopy() {
    generateFeedbackPromptV2(); // 產生指令

    const promptText = document.getElementById('ai-feedback-prompt-preview').value;
    if (!promptText) return;

    navigator.clipboard.writeText(promptText).then(() => {
        // ✨ 溫暖提示
        if (typeof showToast === 'function') {
            showToast("🥛 牛奶與糖已備好 (Excel/數據)！請連同指令交給 AI 咖啡師。", "success");
        } else {
            alert("指令已複製！");
        }
    }).catch(err => {
        alert("複製失敗，請手動展開下方「技術細節」複製。");
    });
}

/* ======================================================= */
/* === [v11.2 Fix] 安全版一鍵生成與複製 (Debug Mode) === */
/* ======================================================= */

function generateAndCopyPrompt() {
    try {
        // --- 1. 抓取欄位資料 ---
        const topicInput = document.getElementById('ai-topic');
        if (!topicInput) throw new Error("找不到題目輸入框 (ai-topic)，請檢查 HTML。");
        
        const topic = topicInput.value.trim();
        if (!topic) {
            alert('請先填寫「作文題目」！');
            topicInput.focus();
            return;
        }

        const levelSelect = document.getElementById('ai-student-level');
        const levelText = levelSelect ? levelSelect.options[levelSelect.selectedIndex].text : "中學程度";
        
        const focusSelect = document.getElementById('ai-focus');
        const focusText = focusSelect ? focusSelect.options[focusSelect.selectedIndex].text : "平衡";
        const focusValue = focusSelect ? focusSelect.value : "balanced";
        
        const highlightsInput = document.getElementById('ai-highlights');
        const highlights = highlightsInput ? highlightsInput.value.trim() : "";

        // --- 2. 設定數量 ---
        let countInst = '請提供 5 個優點 (excellent) 和 5 個待改進 (problem)。';
        if (focusValue === 'encourage') countInst = '請提供 8 個優點 (excellent) 和 4 個待改進 (problem)。';
        if (focusValue === 'improve') countInst = '請提供 4 個優點 (excellent) 和 8 個待改進 (problem)。';

        // --- 3. 組合 Prompt (嚴格 JSON 模式) ---
        const prompt = `
你現在是一個「JSON 數據生成器」。你的唯一任務是根據我的要求，輸出一格式正確的 JSON Array。
請勿輸出任何開場白、結尾語或 markdown 標記 (如 \`\`\`json)，只輸出純 JSON 代碼。

【任務背景】
我是香港中學中文老師，正在為作文題目「${topic}」建立評語庫。
- 學生程度：${levelText}
- 評語風格：${focusText}
- 特別要求：${highlights ? highlights : '無'}
- ${countInst}

【數據結構要求】
請回傳一個 Array，包含多個 Object，每個 Object 代表一條評語，欄位如下：
1. "critique_id": 字串，格式為 "ai_" 加上隨機數。
2. "category": 字串，必須是 ["扣題與立意", "取材與刻畫", "結構與鋪排", "語言與表達"] 其中之一。
3. "type": 字串，必須是 "excellent" (優點) 或 "problem" (待改進)。
4. "title": 字串，4-8字簡短標題。
5. "strength_summary": (僅優點用) 字串，優點描述。可用 [選項1] 代表可變內容。
6. "problem_core": (僅待改進用) 字串，問題描述。可用 [選項1] 代表可變內容。
7. "suggestion": (僅待改進用) 字串，具體建議。
8. "example": 字串，具體例子 (配合題目「${topic}」)。
9. "options": 字串，下拉選單內容 (如有 [選項1])，每行一個選項。多組用 | 分隔。無則留空。
10. "options_label": 字串，選單標題。無則留空。

【JSON 範例 (請嚴格模仿格式)】
[
  {
    "critique_id": "ai_demo_01",
    "category": "取材與刻畫",
    "type": "problem",
    "title": "人物描寫欠立體",
    "strength_summary": "",
    "problem_core": "對[選項1]的描寫較為單一，未能展現其[選項2]。",
    "suggestion": "可加入心理描寫或矛盾掙扎。",
    "example": "例如寫父親，除了寫嚴肅，也可寫他背後的關懷。",
    "options": "主角\\n配角|內心世界\\n性格特質",
    "options_label": "人物|描寫角度"
  },
  {
    "critique_id": "ai_demo_02",
    "category": "扣題與立意",
    "type": "excellent",
    "title": "立意深刻",
    "strength_summary": "能從平凡小事中領悟[選項1]，昇華主題。",
    "problem_core": "",
    "suggestion": "",
    "example": "由一次遲到經歷，反思守時對誠信的重要性。",
    "options": "親情的可貴\\n成長的代價",
    "options_label": "領悟道理"
  }
]

現在，請生成符合上述題目要求的 JSON Array：`;

        // --- 4. 寫入預覽框 (如果有) ---
        const previewBox = document.getElementById('ai-prompt-preview');
        if (previewBox) previewBox.value = prompt.trim();

        // --- 5. 執行複製 ---
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(prompt.trim())
                .then(() => {
                    // 成功提示
                    if (typeof showToast === 'function') {
                        showToast("☕️ 咖啡豆已預備好！請將指令交給您的專屬咖啡師 (AI) 進行沖泡。", "success");
                    } else {
                        alert("☕️ 咖啡豆已預備好！\n請貼上給 AI。");
                    }
                })
                .catch(err => {
                    throw new Error("Clipboard API 失敗: " + err);
                });
        } else {
            // 後備方案 (針對舊瀏覽器)
            if (previewBox) {
                previewBox.select();
                document.execCommand('copy');
                if (typeof showToast === 'function') showToast("☕️ 咖啡豆已預備好！", "success");
                else alert("☕️ 咖啡豆已預備好！");
            } else {
                throw new Error("無法自動複製，請手動展開下方細節複製。");
            }
        }

    } catch (error) {
        console.error("生成指令時發生錯誤:", error);
        alert("⚠️ 發生錯誤：" + error.message + "\n\n(請截圖並通知開發者，或檢查是否已填寫題目)");
    }
}

/* ========================================= */
/* === [v11.4] 快速開 Project 核心邏輯   === */
/* ========================================= */

// 1. 幫 Modal 載入班級 (重用邏輯)
async function loadClassesToSelect(selectEl) {
    selectEl.innerHTML = '<option>讀取中...</option>';
    try {
        const { data: classes } = await supabaseClient
            .from('classes').select('*').eq('user_id', currentUser.id)
            .order('academic_year', { ascending: false }).order('class_name', { ascending: true });
        
        if (!classes || classes.length === 0) {
            selectEl.innerHTML = '<option value="">(暫無班級，請先去檔案室建立)</option>';
            return;
        }
        selectEl.innerHTML = '<option value="">-- 請選擇班級 --</option>';
        classes.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c.id;
            opt.textContent = `${c.class_name} (${c.academic_year})`;
            opt.dataset.className = c.class_name; // 記住班名
            selectEl.appendChild(opt);
        });
    } catch (e) { console.error(e); selectEl.innerHTML = '<option>讀取失敗</option>'; }
}

/* ================================================= */
/* === [v11.8 Fix] 題目鎖定 + 名單載入修復版 === */
/* ================================================= */

async function confirmQuickProject() {
    // 1. 準備資料
    const jsonStr = document.getElementById('quick-json-storage').value;
    let aiData;
    try { aiData = JSON.parse(jsonStr); } catch(e) { alert("數據錯誤"); return; }

    const topicInput = document.getElementById('ai-topic');
    const topic = topicInput.value.trim();

    // 🔥 改動 A：強制檢查題目
    if (!topic) {
        alert("⚠️ 請務必填寫「作文題目」才能建立專案！");
        // 關閉 Modal，讓老師填寫
        document.getElementById('pop-quick-project-modal').classList.remove('active');
        setTimeout(() => topicInput.focus(), 300);
        return;
    }

    // 同步題目到所有欄位
    if(document.getElementById('topic')) document.getElementById('topic').value = topic;
    if(document.getElementById('page2-topic-display')) document.getElementById('page2-topic-display').value = topic;

    if (currentUser) {
        // === A. 雲端模式 ===
        const select = document.getElementById('quick-class-select');
        const classId = select.value;
        if (!classId) { alert("請選擇班級！"); return; }
        
        const className = select.options[select.selectedIndex].dataset.className || '未命名班級';
        const btn = document.querySelector('#pop-quick-project-modal .pop-btn-confirm');
        const orgText = btn.textContent;
        btn.textContent = "建立中..."; btn.disabled = true;

        try {
            // A1. 讀取學生
            const { data: students, error: stError } = await supabaseClient
                .from('students').select('*').eq('class_id', classId);
            
            if (stError) throw stError;
            if (!students || students.length === 0) {
                alert("此班級沒有學生，請先到「檔案室」建立。");
                btn.textContent = orgText; btn.disabled = false;
                return;
            }

            // A2. 建立記憶體資料
            sortStudents(students);
            allStudentRecords = students.map(s => {
                let displayNum = s.student_number;
                if (displayNum && /^\d$/.test(displayNum)) displayNum = '0' + displayNum;
                const originalName = `${displayNum ? displayNum + '-' : ''}${s.name}`;
                return {
                    number: s.student_number, name: s.name, originalName: originalName,
                    dbId: s.id, data: null
                };
            });

            // 🔥 改動 B：立即刷新下拉選單 (在建立 Project 之前就做，確保 UI 響應)
            document.getElementById('student-names').value = allStudentRecords.map(r => r.originalName).join('\n');
            updateStudentDropdown(); 

            // A3. 設定環境變數
            window.currentClassId = classId;
            window.currentProjectType = 'cloud';
            if(document.getElementById('student-class')) document.getElementById('student-class').value = className;

            // A4. 檢查或建立 Assignments (使用 check-then-create)
            const { data: existingProject } = await supabaseClient
                .from('assignments').select('id').eq('class_id', classId).eq('title', topic).maybeSingle();

            let finalAssignmentId;
            if (existingProject) {
                finalAssignmentId = existingProject.id;
            } else {
                const { data: newProject, error: createError } = await supabaseClient
                    .from('assignments')
                    .insert([{
                        user_id: currentUser.id, class_id: classId, title: topic, created_at: new Date().toISOString()
                    }]).select().single();
                if (createError) throw createError;
                finalAssignmentId = newProject.id;
            }
            window.currentAssignmentId = finalAssignmentId;

            // A5. 其他 UI 刷新
            updateHeaderInfo();
            if (typeof loadDashboard === 'function') loadDashboard();

        } catch (err) {
            console.error(err);
            alert("建立失敗：" + err.message);
            btn.textContent = orgText; btn.disabled = false;
            return;
        }

    } else {
        // === B. 本地模式 ===
        const manualList = document.getElementById('quick-manual-list').value.trim();
        if (!manualList) { alert("請輸入學生名單！"); return; }

        const parsedNames = manualList.split('\n').map(n => n.trim()).filter(n=>n).map(n => parseStudentName(n));
        allStudentRecords = parsedNames.map(p => ({ number: p.number, name: p.name, originalName: p.originalName, dbId: null, data: null }));
        sortStudents(allStudentRecords);

        window.currentProjectType = 'local';
        window.currentClassId = null;
        window.currentAssignmentId = null;
        
        if(document.getElementById('student-names')) document.getElementById('student-names').value = manualList;
        updateStudentDropdown(); // 刷新選單
        updateHeaderInfo();
    }

    // 🔥 改動 C：在注入 AI 評語前，再次確保選中第一位學生
    const studentSelect = document.getElementById('student-select');
    if (studentSelect && studentSelect.options.length > 0) {
        // 如果第一項是提示文字(value="")，選第二項
        if(studentSelect.options[0].value === "") {
             if(studentSelect.options.length > 1) studentSelect.selectedIndex = 1;
        } else {
             studentSelect.selectedIndex = 0;
        }
        // 載入該學生資料 (初始化 Data 結構)
        loadStudentData(studentSelect.value);
    }

    // 執行 AI 評語注入
    executeApplyJson(aiData);

    // 關閉 Modal
    document.getElementById('pop-quick-project-modal').classList.remove('active');
}
/* === [v11.8] 題目全域同步監聽 === */
// 確保 DOM 載入後執行
document.addEventListener('DOMContentLoaded', () => {
    const p1Topic = document.getElementById('topic');
    const p2Topic = document.getElementById('page2-topic-display');
    const aiTopic = document.getElementById('ai-topic');

    // 定義同步函數
    function syncAllTopics(sourceVal) {
        if(p1Topic) p1Topic.value = sourceVal;
        if(p2Topic) p2Topic.value = sourceVal;
        if(aiTopic) aiTopic.value = sourceVal;
        updateHeaderInfo(); // 更新頂部資訊
        isDataDirty = true;
        updateUIBasedOnAuthState();
    }

    // 綁定監聽
    if(p1Topic) p1Topic.addEventListener('input', (e) => syncAllTopics(e.target.value));
    if(p2Topic) p2Topic.addEventListener('input', (e) => syncAllTopics(e.target.value));
    // AI Topic 已經有自己的監聽，這裡只需確保 P2 變更時會推過去
});
/* ========================================= */
/* === [v19.1] 報告生成 (圖表顯形版) === */
/* ========================================= */

/* ========================================= */
/* === [v19.3] 報告引擎 (歷程圖 + 雜誌風) === */
/* ========================================= */

// [v19.7] 報告生成 (確保容器位置正確)
async function printReport(mode) {
    let container = document.getElementById('print-container');
    
    // 🔥 關鍵修正：確保 print-container 存在且位於 body 的最底層
    if (!container) {
        container = document.createElement('div');
        container.id = 'print-container';
        document.body.appendChild(container);
    } else {
        // 如果它被包在其他 div 裡面，把它搬出來
        if (container.parentNode !== document.body) {
            document.body.appendChild(container);
        }
    }

    if (typeof showToast === 'function') showToast("📊 正在準備列印格式...", "info");

    // 1. 自動同步
    if (currentUser && document.getElementById('page2').classList.contains('active')) {
        await saveCurrentStudentData('cloud_silent');
    }

    // 2. 篩選目標
    let targets = [];
    if (mode === 'single') {
        const currentName = document.getElementById('student-select').value;
        const record = allStudentRecords.find(r => r.originalName === currentName);
        if (!record) { alert("請先選擇一位學生！"); return; }
        targets = [record];
    } else {
        targets = allStudentRecords.filter(r => r.data && (r.data.scores.total || r.data.pureStudentComment));
        targets.sort((a, b) => (a.number || 999) - (b.number || 999));
        if (targets.length === 0) { alert("沒有資料可列印。"); return; }
        if (!confirm(`即將生成 ${targets.length} 份報告 (含歷程圖)，確定嗎？`)) return;
    }

    const className = document.getElementById('student-class').value || '未命名班級';
    const topic = document.getElementById('topic').value || '未命名題目';
    const dateStr = new Date().toLocaleDateString('zh-HK');

    container.innerHTML = '';
    const chartsToRender = []; 

    // 3. 生成 HTML
    for (let i = 0; i < targets.length; i++) {
        const student = targets[i];
        const d = student.data || {};
        const s = d.scores || {content:0, expression:0, structure:0, punctuation:0, typos:0, total:0};
        const comment = d.pureStudentComment || d.studentComment || "（暫無評語）";
        const canvasId = `history-chart-${i}`;

        let historyData = [];
        if (student.dbId) {
            const { data: hist } = await supabaseClient
                .from('results')
                .select('total_score, assignments!inner(title, created_at)')
                .eq('student_id', student.dbId)
                .order('assignments(created_at)', { ascending: true });
            
            if (hist) {
                historyData = hist
                    .map(h => ({
                        title: h.assignments.title,
                        score: h.total_score,
                        date: new Date(h.assignments.created_at)
                    }))
                    .sort((a, b) => a.date - b.date);
            }
        }

        const pageHtml = `
        <div class="report-page">
            <div class="report-header">
                <div class="report-title-block">
                    <h1>${escapeHtml(student.name)}</h1>
                    <div class="report-sub-title">${escapeHtml(topic)}</div>
                </div>
                <div class="report-meta-grid">
                    <div>班別：${escapeHtml(className)}</div>
                    <div>學號：${student.number || '-'}</div>
                    <div>日期：${dateStr}</div>
                </div>
            </div>

            <div class="chart-section" style="display: ${historyData.length > 1 ? 'block' : 'none'}">
                <canvas id="${canvasId}"></canvas>
            </div>

            <table class="score-table">
                <thead>
                    <tr><th>內容 (40)</th><th>表達 (30)</th><th>結構 (20)</th><th>標點 (10)</th><th>錯別字</th><th>總分</th></tr>
                </thead>
                <tbody>
                    <tr>
                        <td>${s.content||'-'}</td>
                        <td>${s.expression||'-'}</td>
                        <td>${s.structure||'-'}</td>
                        <td>${s.punctuation||'-'}</td>
                        <td style="color:#c86a5a;">${s.typos||'-'}</td>
                        <td style="font-weight:bold; color:#5A8F7B; font-size:14pt;">${s.total||'-'}</td>
                    </tr>
                </tbody>
            </table>

            <div class="comment-section">
                <div class="comment-label">教師評語</div>
                <div class="comment-content">${formatReportComment(comment)}</div>
            </div>

            <div class="report-footer">
                ${escapeHtml(className)} | ${escapeHtml(student.name)} | 學習歷程報告
            </div>
        </div>
        `;
        
        container.insertAdjacentHTML('beforeend', pageHtml);

        if (historyData.length > 1) {
            chartsToRender.push({
                id: canvasId,
                labels: historyData.map(h => h.title),
                data: historyData.map(h => h.score)
            });
        }
    }

    // 4. 繪製圖表 & 列印
    requestAnimationFrame(() => {
        chartsToRender.forEach(c => {
            const ctx = document.getElementById(c.id).getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: c.labels,
                    datasets: [{
                        label: '得分走勢',
                        data: c.data,
                        borderColor: '#5A8F7B', 
                        backgroundColor: 'rgba(90, 143, 123, 0.1)',
                        borderWidth: 2,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: '#5A8F7B',
                        pointRadius: 4,
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false,
                    scales: {
                        y: { beginAtZero: true, suggestedMax: 100, grid: { color: '#eee' } },
                        x: { grid: { display: false } }
                    },
                    plugins: { 
                        legend: { display: false },
                        title: { display: true, text: '個人寫作成績走勢', font: { family: "'LXGW WenKai TC'" }, color: '#999', align: 'start' }
                    }
                }
            });
        });

        setTimeout(() => {
            window.print();
        }, 500);
    });
}

// [Helper] 格式化評語 (如之前已加可忽略)
function formatReportComment(text) {
    if (!text) return "（暫無評語）";
    return text.split('\n').map(line => {
        const safeLine = escapeHtml(line);
        if (line.trim().startsWith('【')) return `<strong>${safeLine}</strong>`;
        return safeLine;
    }).join('<br>');
}

// [v19.7] 渲染簡約版卡片 (右上角只保留刪除 🗑️)
function renderNewDetailCards(items, container) {
    if (items.length === 0) {
        container.style.display = 'block'; 
        container.innerHTML = `
            <div style="text-align:center; padding:4rem 2rem; color:#b0a89e; border:1px dashed #e1d8c8; border-radius:24px; background:rgba(255,255,255,0.4);">
                <div style="font-size:2.2rem; margin-bottom:15px; opacity:0.6;">☕</div>
                <div style="font-size:1.1rem; color:#8d775f; margin-bottom:5px;">案頭清爽</div>
                <div style="font-size:0.9rem; font-weight:300;">享受這片刻的寧靜，或點擊上方「+」開啟新篇章。</div>
            </div>`;
        return;
    }
    
    container.style.display = 'grid'; 
    container.style.gridTemplateColumns = 'repeat(auto-fill, minmax(300px, 1fr))';
    container.style.gap = '20px';

    let html = '';

    items.forEach(item => {
        const createDate = new Date(item.created_at).toLocaleDateString('zh-HK', {month:'2-digit', day:'2-digit'});
        
        // 字串安全處理
        const safeTitle = (item.topic || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
        
        // 刪除動作
        const deleteAction = `event.stopPropagation(); confirmDeleteProjectDirectly('${item.id}', '${safeTitle}')`;
        const loadAction = `openAssignment('${item.id}')`;

        // 進度條顏色
        const progressColor = item.progress === 100 ? '#5A8F7B' : (item.progress > 50 ? '#d4a373' : '#e0e0e0');

        html += `
        <div class="cozy-folder" onclick="${loadAction}" 
             style="cursor:pointer; padding:24px; min-height:auto; background:#fff; border:1px solid rgba(0,0,0,0.04); box-shadow: 0 4px 24px rgba(0,0,0,0.03); transition: transform 0.2s, box-shadow 0.2s; border-radius:20px; position: relative;">
            
            <!-- 🔥 右上角：變回單一刪除按鈕 (🗑️) -->
            <button onclick="${deleteAction}" title="刪除作業" 
                style="position:absolute; top:15px; right:15px; background:transparent; border:none; color:#e0e0e0; font-size:1.1rem; cursor:pointer; transition:color 0.2s;">
                🗑️
            </button>
            <style>button[title="刪除作業"]:hover { color: #c86a5a !important; transform: scale(1.1); }</style>

            <!-- 頂部：班級標籤 -->
            <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:12px; padding-right: 40px;">
                <span style="font-size:0.75rem; letter-spacing:1px; color:#999; text-transform:uppercase; font-weight:600; border:1px solid #eee; padding:2px 8px; border-radius:6px;">
                    ${escapeHtml(item.class_name)}
                </span>
                <span style="font-size:0.8rem; color:#ccc;">${createDate}</span>
            </div>

            <!-- 標題 -->
            <div class="folder-title" style="font-size:1.3rem; font-weight:500; color:#5b5044; margin-bottom:15px; line-height:1.4;">
                ${escapeHtml(item.topic)}
            </div>

            <!-- 資訊分隔線 -->
            <div style="border-top:1px dashed #f0f0f0; margin:15px 0;"></div>

            <!-- 進度數據 -->
            <div style="display:flex; align-items:center; justify-content:space-between; color:#8c867a; font-size:0.9rem;">
                <div style="display:flex; align-items:center; gap:6px;">
                    <span>👥 ${item.graded_count} / ${item.total_students}</span>
                </div>
                <div style="font-weight:bold; color:${progressColor};">
                    ${item.progress}%
                </div>
            </div>
            
            <!-- 進度條 (視覺化) -->
            <div style="width:100%; height:4px; background:#f5f5f5; border-radius:99px; margin-top:10px; overflow:hidden;">
                <div style="width:${item.progress}%; height:100%; background:${progressColor};"></div>
            </div>
        </div>`;
    });
    
    container.innerHTML = html;
}
// [v19.2] 直接刪除專案邏輯
async function confirmDeleteProjectDirectly(id, title) {
    const userConfirmed = await showCustomModal({
        icon: '⚠️',
        title: '刪除作業',
        desc: `確定要刪除「${title}」嗎？\n所有學生的成績和評語都將消失，無法復原。`,
        confirmText: '忍痛刪除',
        cancelText: '保留'
    });

    if (!userConfirmed) return;

    if (typeof showToast === 'function') showToast("正在刪除...", "info");

    try {
        const { error } = await supabaseClient.from('assignments').delete().eq('id', id);
        if (error) throw error;

        if (typeof showToast === 'function') showToast("已成功刪除", "success");
        loadDashboard(); // 刷新

    } catch (error) {
        console.error("Delete Failed:", error);
        alert("刪除失敗：" + error.message);
    }
}



// [v19.6] 專案詳情與名單預覽
async function openProjectDetails(id, topic, className, created, updated, total, graded) {
    const modal = document.getElementById('pop-project-details-modal');
    
    // 填入基本資料
    document.getElementById('detail-topic').textContent = topic;
    document.getElementById('detail-class').textContent = className;
    
    const cDate = new Date(created);
    const uDate = new Date(updated);
    document.getElementById('detail-create-date').textContent = `${cDate.toLocaleDateString()} ${cDate.toLocaleTimeString()}`;
    document.getElementById('detail-update-date').textContent = `${uDate.toLocaleDateString()} ${uDate.toLocaleTimeString()}`;
    document.getElementById('detail-count').textContent = `${graded} / ${total} (完成度 ${total>0 ? Math.round(graded/total*100):0}%)`;
    
    document.getElementById('detail-project-id').value = id;
    document.getElementById('detail-project-title').value = topic;

    // 清空並顯示 Loading
    const listDiv = document.getElementById('detail-student-list');
    listDiv.innerHTML = '<div style="color:#999; padding:20px; text-align:center;">🔄 正在讀取學生名單...</div>';
    
    modal.classList.add('active');

    // 讀取已批改名單 (從 Results 抓)
    try {
        const { data: results, error } = await supabaseClient
            .from('results')
            .select('updated_at, students(name, student_number)')
            .eq('assignment_id', id)
            .order('updated_at', { ascending: false }); // 最近批改在上

        if (error) throw error;

        if (!results || results.length === 0) {
            listDiv.innerHTML = '<div style="padding:20px; text-align:center; color:#ccc;">尚未有批改記錄</div>';
        } else {
            let html = '<div style="display:flex; flex-direction:column; gap:5px; padding:10px;">';
            results.forEach(r => {
                const s = r.students;
                if (!s) return;
                
                let sName = s.name;
                let sNum = s.student_number;
                if (sNum && /^\d$/.test(sNum)) sNum = '0' + sNum;
                const displayName = sNum ? `${sNum} ${sName}` : sName;
                
                // 格式化時間 (只顯示月/日)
                const d = new Date(r.updated_at);
                const timeStr = `${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${d.getMinutes()<10?'0'+d.getMinutes():d.getMinutes()}`;

                html += `
                    <div style="display:flex; justify-content:space-between; border-bottom:1px dashed #eee; padding:4px 0;">
                        <span style="color:#333;">${escapeHtml(displayName)}</span>
                        <span style="color:#999; font-size:0.8rem;">${timeStr}</span>
                    </div>
                `;
            });
            html += '</div>';
            listDiv.innerHTML = html;
        }
    } catch (e) {
        console.error(e);
        listDiv.innerHTML = `<span style="color:red; padding:10px;">讀取失敗: ${e.message}</span>`;
    }
}

function deleteProjectFromDetails() {
    const id = document.getElementById('detail-project-id').value;
    const title = document.getElementById('detail-project-title').value;
    document.getElementById('pop-project-details-modal').classList.remove('active');
    confirmDeleteProjectDirectly(id, title);
}
</script> <!-- 呢個係原本全個檔案唯一的結尾，保留佢 -->

<!-- [v12.2] Back To Top (確保在最外層，不受干擾) -->
<button id="back-to-top-btn" onclick="scrollToTop()" title="回到頂部" style="display: none;">⬆</button>

<!-- [v13.5-Hotfix] 強制修復手機目錄顯示問題 -->
<style>
/* 1. 強制設定 Overlay 的基礎狀態 (確保它存在於 DOM，只是看不見) */
@media (max-width: 768px) {
    #mobile-book-overlay {
        display: flex !important;       /* 強制變成 Flex 佈局，覆蓋 display: none */
        visibility: hidden !important;  /* 暫時隱藏 (保留動畫能力) */
        opacity: 0 !important;          /* 全透明 */
        pointer-events: none !important;/* 禁止點擊 */
        
        /* 確保位置正確 */
        position: fixed !important;
        top: 0; left: 0; right: 0; bottom: 0;
        z-index: 2147483647 !important; /* 確保在最頂層 (比所有野都高) */
        background: rgba(253, 251, 247, 0.95) !important; /* 確保有背景色 */
        backdrop-filter: blur(10px);
        
        /* 確保內容排版 */
        flex-direction: column;
        justify-content: flex-start;
        padding-top: 60px; /* 避開頂部 */
    }

    /* 2. 當加上 .active 時，讓它顯形 */
    #mobile-book-overlay.active {
        visibility: visible !important; /* 變回可見 */
        opacity: 1 !important;          /* 變回實色 */
        pointer-events: auto !important;/* 恢復點擊 */
    }
}
</style>

<script>
// [JS] 強制覆蓋舊的 toggleBookMenu 函數，確保邏輯無誤
window.toggleBookMenu = function() {
    const overlay = document.getElementById('mobile-book-overlay');
    if (!overlay) {
        console.error("搵唔到 #mobile-book-overlay 元素！");
        return;
    }

    // 切換 active class
    const isActive = overlay.classList.contains('active');
    
    if (isActive) {
        overlay.classList.remove('active');
        // 關閉時恢復頁面捲動
        document.body.style.overflow = '';
    } else {
        overlay.classList.add('active');
        // 打開時鎖定背景捲動 (防止滑動到底下內容)
        document.body.style.overflow = 'hidden';
        
        // 嘗試自動展開當前章節
        if (typeof autoExpandCurrentSection === 'function') {
            autoExpandCurrentSection();
        }
    }
};
</script>
</body>
</html>
