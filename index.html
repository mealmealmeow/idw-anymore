// [v18.7] 步驟一：檢查並彈出確認視窗 (點列名單版)
function startGradingWithSetup(actionType) {
    const topicInput = document.getElementById('topic');
    if (!topicInput || !topicInput.value.trim()) {
        alert("請輸入作文題目！");
        if(topicInput) topicInput.focus();
        return;
    }

    const select = document.getElementById('setup-class-select');
    if (!select || !select.value) {
        alert("請選擇班級！");
        return;
    }

    const checkedCards = document.querySelectorAll('#setup-student-checklist .student-check-card.checked');
    if (checkedCards.length === 0) {
        alert("⚠️ 請至少勾選一位學生！");
        return;
    }

    const className = select.options[select.selectedIndex].dataset.className || '未命名班級';
    const topic = topicInput.value.trim();
    const count = checkedCards.length;

    const selectedStudents = [];
    let rawStudentList = "";
    const tempRecords = [];
    const displayNames = [];
    
    // 安全檢查旗標
    let missingIdCount = 0;

    checkedCards.forEach(card => {
        const info = card.dataset.info; 
        const dbId = card.dataset.dbId; 
        
        if (!dbId || dbId === "undefined" || dbId === "null") {
            missingIdCount++;
            console.warn("Missing ID for card:", info);
        } else {
            rawStudentList += info + "\n";
            selectedStudents.push(dbId);
            displayNames.push(info);

            const p = parseStudentName(info);
            tempRecords.push({
                number: p.number, name: p.name, originalName: p.originalName, dbId: dbId, data: null
            });
        }
    });

    // 自動修復機制
    if (missingIdCount > 0) {
        if(confirm(`系統偵測到 ${missingIdCount} 位學生資料未同步 (缺少 ID)。\n\n點擊「確定」將嘗試自動修復並重新讀取列表。\n(讀取完成後，請再次點擊開始按鈕)`)) {
            window.handleClassSelectChange();
        }
        return;
    }
    
    _pendingSetupData = {
        actionType: actionType,
        classId: select.value,
        className: className,
        topic: topic,
        selectedIds: selectedStudents,
        tempRecords: tempRecords,
        rawStudentList: rawStudentList
    };

    document.getElementById('confirm-topic-display').textContent = topic;
    document.getElementById('confirm-class-display').textContent = className;
    document.getElementById('confirm-count-display').textContent = `${count} 人`;
    
    // ✅ [修改部分] 渲染點列式名單 (CSS Grid 雙欄佈局)
    const listEl = document.getElementById('confirm-student-list');
    if(listEl) {
        // 使用 Grid 讓名單排成兩欄，並加上小圓點
        const listHtml = `
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
                ${displayNames.map(name => `
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <span style="color: #5A8F7B; font-size: 1.2em;">•</span>
                        <span>${escapeHtml(name)}</span>
                    </div>
                `).join('')}
            </div>
        `;
        listEl.innerHTML = listHtml;
    }
    
    const confirmBtn = document.getElementById('btn-create-project-confirm');
    if(confirmBtn) confirmBtn.onclick = executeCreateProject; 
    
    const modal = document.getElementById('pop-setup-confirm-modal');
    if(modal) modal.classList.add('active');
}
