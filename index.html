<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æ–‡è¨€å°æ±ºï¼šå»‰é — VS å²³é™½æ¨“</title>
    <link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=Noto+Serif+TC:wght@500;700;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* --- æ ¸å¿ƒæ¨£å¼ --- */
        :root {
            --bg-dark: #0f1219;
            --bg-gradient: radial-gradient(circle at 50% 0%, #2c3e50 0%, #0f1219 80%);
            --gold-primary: #d4af37;
            --gold-metal: linear-gradient(135deg, #bf953f 0%, #fcf6ba 40%, #b38728 60%, #aa771c 100%);
            --red-royal: #8a1c1c;
            --panel-bg: rgba(20, 25, 35, 0.85);
            --panel-border: 1px solid rgba(212, 175, 55, 0.4);
            --font-title: 'Ma Shan Zheng', cursive;
            --font-body: 'Noto Serif TC', serif;
        }

        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: var(--bg-dark); background-image: var(--bg-gradient); font-family: var(--font-body); color: #fff; user-select: none; }
        
        /* MCé¡Œ æ›è¡Œå„ªåŒ– */
        .q-text { 
            font-size: 1.8rem; font-weight: bold; color: #1a1a1a; 
            line-height: 1.6; font-family: var(--font-body);
            white-space: pre-wrap;
            text-align: left;
            width: 100%;
        }
        .q-text.short { text-align: center; } 

        #app { position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; flex-direction: column; z-index: 1; }
        
        /* Header */
        header { height: 70px; display: flex; justify-content: space-between; align-items: center; padding: 0 40px; background: linear-gradient(to bottom, rgba(0,0,0,0.9), rgba(0,0,0,0)); border-bottom: 1px solid rgba(255,255,255,0.1); }
        .app-title { font-family: var(--font-title); font-size: 2.8rem; letter-spacing: 5px; background: var(--gold-metal); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 2px 10px rgba(212, 175, 55, 0.5)); }
        .info-pill { background: rgba(0,0,0,0.6); border: 1px solid rgba(255,255,255,0.2); padding: 5px 15px; border-radius: 20px; font-size: 0.9rem; color: #ccc; }

        /* Game Stage */
        #game-stage { flex: 1; display: grid; grid-template-columns: 280px 1fr 280px; gap: 20px; padding: 20px 40px; align-items: center; justify-items: center; height: 100%; overflow: hidden; }
        
        .team-panel { width: 100%; height: 92%; background: var(--panel-bg); border: var(--panel-border); border-radius: 100px 100px 20px 20px; display: flex; flex-direction: column; align-items: center; padding: 30px 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); backdrop-filter: blur(10px); transition: 0.4s; position: relative; }
        .team-panel.active { border-color: var(--gold-primary); box-shadow: 0 0 60px rgba(212, 175, 55, 0.2), inset 0 0 20px rgba(212, 175, 55, 0.1); transform: translateY(-5px) scale(1.02); z-index: 5; }
        
        .avatar-frame { width: 90px; height: 90px; border-radius: 50%; background: var(--gold-metal); padding: 3px; margin-bottom: 15px; box-shadow: 0 10px 20px rgba(0,0,0,0.5); }
        .avatar { width: 100%; height: 100%; border-radius: 50%; background-size: cover; border: 2px solid #1a1a1a; }
        .team-title { font-family: var(--font-title); font-size: 2.4rem; margin-bottom: 5px; text-shadow: 0 2px 4px rgba(0,0,0,0.8); }
        .score-display { font-size: 4.5rem; font-weight: 900; background: linear-gradient(to bottom, #fff, #bbb); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin: 10px 0; }
        
        /* å¿ƒå¿ƒæ¨£å¼ */
        .hearts-container { font-size: 1.5rem; color: #e74c3c; margin-bottom: auto; letter-spacing: 2px; min-height: 1.8rem; }
        
        .student-plate { width: 100%; text-align: center; padding: 15px 0; border-top: 1px solid rgba(255,255,255,0.1); margin-top: auto; }
        .student-name { font-size: 2rem; font-weight: bold; color: var(--gold-primary); min-height: 2.4rem; text-shadow: 0 2px 4px #000; }

        /* æ‰‹å‹•æ§åˆ¶æŒ‰éˆ•å€ (é è¨­åŠé€æ˜ï¼Œæ»‘é¼ ç§»éå»è®Šæ¸…æ¥š) */
        .manual-controls {
            position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%);
            opacity: 0.2; transition: 0.3s;
            display: flex; gap: 5px;
            background: rgba(0,0,0,0.8); padding: 5px; border-radius: 10px;
        }
        .manual-controls:hover { opacity: 1; }
        .mini-btn { background: #444; color: #fff; border: 1px solid #666; cursor: pointer; border-radius: 4px; padding: 2px 8px; font-size: 0.8rem; }
        .mini-btn:hover { background: #666; }

        /* Card Stage */
        .card-stage { width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; perspective: 1500px; }
        .main-card { width: 100%; max-width: 650px; height: 85%; position: relative; transform-style: preserve-3d; transition: transform 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .main-card.flipped { transform: rotateY(180deg); }
        .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 20px; border: 4px solid #444; outline: 2px solid var(--gold-primary); outline-offset: -8px; background: #fdfbf7; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 30px 80px rgba(0,0,0,0.8); }
        .front { background-image: url('https://www.transparenttextures.com/patterns/rice-paper-2.png'); }
        .back { transform: rotateY(180deg); background: #fff; padding: 40px; text-align: left; overflow-y: auto; color: #222; }
        
        .q-visual { height: 35%; background: #222; position: relative; border-bottom: 4px double var(--gold-primary); overflow: hidden; }
        .q-img { width: 100%; height: 100%; background-size: cover; background-position: center; opacity: 0.8; transition: transform 5s ease; }
        .q-body { flex: 1; padding: 40px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .q-cat { position: absolute; top: 15px; left: 15px; background: var(--gold-primary); color: #000; padding: 6px 15px; font-weight: bold; font-size: 1rem; border-radius: 4px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 2;}

        /* Footer */
        footer { height: 100px; padding: 0 40px; background: linear-gradient(to top, rgba(0,0,0,0.95), transparent); display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; z-index: 10; }
        .gem-btn { position: relative; border: none; outline: none; background: transparent; cursor: pointer; padding: 15px 35px; border-radius: 50px; font-size: 1.2rem; font-weight: 900; color: #fff; background: linear-gradient(180deg, rgba(255,255,255,0.1), rgba(0,0,0,0.2)); box-shadow: 0 4px 6px rgba(0,0,0,0.3); transition: all 0.2s; overflow: hidden; display: flex; align-items: center; gap: 10px; justify-content: center; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }
        .btn-gold { background-color: #d4af37; background-image: linear-gradient(160deg, #f1c40f, #b8860b); border: 2px solid #fff5c3; color: #3d2c00; text-shadow: none; }
        .btn-green { background-image: linear-gradient(160deg, #2ecc71, #27ae60); border: 2px solid #a8e6cf; }
        .btn-red { background-image: linear-gradient(160deg, #e74c3c, #c0392b); border: 2px solid #ffbcb5; }
        .gem-btn:active { transform: translateY(2px); box-shadow: none; }
        .hidden { display: none !important; }

        /* Overlays */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(5, 5, 8, 0.95); z-index: 2000; display: none; flex-direction: column; justify-content: center; align-items: center; backdrop-filter: blur(15px); }
        .cards-container { display: flex; gap: 30px; perspective: 1200px; width: 100%; justify-content: center; align-items: center; flex-wrap: wrap; }
        .tarot-card { width: 240px; height: 420px; position: relative; cursor: pointer; transform-style: preserve-3d; transition: transform 0.6s; margin: 10px; }
        .tarot-card:hover { transform: translateY(-20px) rotateX(10deg); z-index: 10; }
        .tarot-card.flipped { transform: rotateY(180deg); }
        .tarot-card.disabled { opacity: 0.2; filter: grayscale(100%); pointer-events: none; }
        .tarot-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 15px; overflow: hidden; box-shadow: 0 15px 40px rgba(0,0,0,0.8); }
        .tarot-back { background-color: #111; background-image: radial-gradient(#333 15%, transparent 16%), radial-gradient(#333 15%, transparent 16%); background-size: 20px 20px; border: 4px solid var(--gold-primary); display: flex; justify-content: center; align-items: center; }
        .tarot-front { background: #fffbf0; transform: rotateY(180deg); padding: 20px; text-align: center; display: flex; flex-direction: column; align-items: center; border: 6px solid var(--gold-primary); }
        .tf-type { font-size: 0.8rem; letter-spacing: 2px; margin-bottom: 10px; opacity: 0.6; }
        .tf-title { font-family: var(--font-title); font-size: 2.2rem; line-height: 1.2; color: #000; margin-bottom: 15px; border-bottom: 2px solid #ccc; padding-bottom: 10px; width: 100%; }
        .tf-desc { font-size: 1.1rem; color: #444; font-weight: bold; flex: 1; display: flex; align-items: center; justify-content: center; }
        .style-punish .tarot-back { border-color: var(--red-royal); background-color: #2b0505; }
        .style-punish .tarot-front { border-color: var(--red-royal); }

        #wheel-result-card { background: #fff; width: 500px; padding: 40px; border-radius: 20px; text-align: center; border: 5px solid var(--red-royal); box-shadow: 0 0 100px var(--red-royal); display: none; animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from{transform:scale(0.5); opacity:0;} to{transform:scale(1); opacity:1;} }
        
        input[type="file"] { display: none; }
        textarea { width: 100%; height: 100px; padding: 10px; border: 1px solid #ccc; border-radius: 5px; background: #f9f9f9; font-family: inherit; font-size: 0.9rem; resize: vertical; }

        @media (max-width: 1024px) {
            #game-stage { grid-template-columns: 1fr; grid-template-rows: auto 1fr auto; padding: 10px; }
            .team-panel { height: auto; flex-direction: row; padding: 10px; border-radius: 20px; width: 95%; margin: 5px; }
            .avatar-frame { width: 60px; height: 60px; margin: 0 15px 0 0; }
            .score-display { font-size: 2.5rem; margin-left: auto; margin-right: 20px; }
            .card-stage { height: 400px; }
            footer { grid-template-columns: 1fr; height: auto; gap: 10px; padding: 15px; }
            .gem-btn { padding: 12px 20px; font-size: 1rem; width: 100%; }
            #action-btns { flex-direction: column; width: 100%; }
        }
    </style>
</head>
<body>
    <div id="app">
        <header>
            <div class="info-pill">é¡Œåº«: <span id="q-count">28</span> | å›åˆ: <span id="turn-count">1</span></div>
            <div class="app-title">å¤éŸ»å°æ±º</div>
            <button class="gem-btn" style="padding:8px 15px; font-size:1rem;" onclick="openSettings()">âš™ï¸ è¨­å®š/åˆ†çµ„</button>
        </header>
        
        <div id="game-stage">
            <div class="team-panel team-a active" id="panel-a">
                <div class="avatar-frame"><div class="avatar" style="background-image: url('https://images.unsplash.com/photo-1599707367072-cd6ad6cb3d57?w=400')"></div></div>
                <div>
                    <div class="team-title" style="color:#ff7675;">å»‰é —éšŠ</div>
                    <div class="hearts-container" id="hearts-a">â¤ï¸â¤ï¸â¤ï¸</div>
                </div>
                <div class="score-display" id="score-a">100</div>
                <div class="student-plate">
                    <div style="font-size:0.8rem; color:#aaa;">å…ˆé‹’æˆ°å°‡</div>
                    <div class="student-name" id="student-name-a">æº–å‚™</div>
                </div>
                <div class="manual-controls">
                    <button class="mini-btn" onclick="modStat('a','s',10)">+10</button>
                    <button class="mini-btn" onclick="modStat('a','s',-10)">-10</button>
                    <button class="mini-btn" onclick="modStat('a','h',1)">+â¤</button>
                    <button class="mini-btn" onclick="modStat('a','h',-1)">-â¤</button>
                </div>
            </div>

            <div class="card-stage">
                <div class="main-card" id="game-card" onclick="flipCard()">
                    <div class="card-face front">
                        <div class="q-visual" id="card-img"><div class="q-img" style="background-image: url('https://images.unsplash.com/photo-1516541196182-6bdb0516ed27?w=800')"></div></div>
                        <div class="q-body">
                            <div class="q-cat" id="q-cat">æº–å‚™</div>
                            <div class="q-text short" id="q-text">é»æ“Šä¸‹æ–¹ã€ŒæŠ½å–è©¦ç…‰ã€<br>é–‹å§‹å°æ±º</div>
                            <div style="margin-top:auto; font-size:0.9rem; color:#999;">(é»æ“Šå¡ç‰‡ç¿»é–±ç­”æ¡ˆ)</div>
                        </div>
                    </div>
                    <div class="card-face back">
                        <div style="font-size:1.5rem; color:#c0392b; border-bottom:2px solid #ccc; margin-bottom:15px; font-weight:bold;">ç­”æ¡ˆè§£æ</div>
                        <div id="q-ans" style="font-size:1.4rem; line-height:1.6; color:#333;"></div>
                    </div>
                </div>
            </div>

            <div class="team-panel team-b" id="panel-b">
                <div class="avatar-frame"><div class="avatar" style="background-image: url('https://images.unsplash.com/photo-1505664194779-8beaceb93744?w=400')"></div></div>
                <div>
                    <div class="team-title" style="color:#74b9ff;">è—ºç›¸å¦‚éšŠ</div>
                    <div class="hearts-container" id="hearts-b">â¤ï¸â¤ï¸â¤ï¸</div>
                </div>
                <div class="score-display" id="score-b">100</div>
                <div class="student-plate">
                    <div style="font-size:0.8rem; color:#aaa;">å…ˆé‹’æˆ°å°‡</div>
                    <div class="student-name" id="student-name-b">æº–å‚™</div>
                </div>
                <div class="manual-controls">
                    <button class="mini-btn" onclick="modStat('b','s',10)">+10</button>
                    <button class="mini-btn" onclick="modStat('b','s',-10)">-10</button>
                    <button class="mini-btn" onclick="modStat('b','h',1)">+â¤</button>
                    <button class="mini-btn" onclick="modStat('b','h',-1)">-â¤</button>
                </div>
            </div>
        </div>

        <footer>
            <div style="display:flex; gap:20px; justify-content:center;">
                <button class="gem-btn" onclick="initSelection('chance')">âœ¨ éŒ¦å›Š (æ©Ÿæœƒ)</button>
            </div>
            
            <div style="display:flex; flex-direction:column; align-items:center;">
                <button class="gem-btn btn-gold" id="btn-draw" onclick="drawQuestion()" style="transform:scale(1.1);">ğŸ“œ æŠ½å–è©¦ç…‰</button>
                <div id="action-btns" class="hidden" style="display:flex; gap:20px;">
                    <button class="gem-btn btn-green" onclick="handleResult(true)">âœ… ç­”å° (+10 & +â¤)</button>
                    <button class="gem-btn btn-red" onclick="handleResult(false)">âŒ ç­”éŒ¯ (-10 & -â¤)</button>
                </div>
            </div>

            <div style="display:flex; justify-content:center;">
                <button class="gem-btn btn-red" style="border:2px dashed #ff5e57;" onclick="showWheel()">ğŸ¡ çµ‚æ¥µæ‡²ç½°</button>
            </div>
        </footer>
    </div>

    <div class="overlay" id="overlay-select">
        <h1 id="select-title" style="font-family:var(--font-title); color:var(--gold-primary); font-size:4rem; margin-bottom:40px;">å‘½é‹æŠ‰æ“‡</h1>
        <div class="cards-container" id="cards-grid"></div>
        <button class="gem-btn hidden" id="btn-confirm-select" style="margin-top:50px;" onclick="closeSelection()">ç¢ºèª (ä¸‹ä¸€ä½)</button>
    </div>

    <div class="overlay" id="overlay-settings">
        <div style="background:#fff; color:#000; padding:40px; border-radius:20px; width:900px; max-height:85vh; overflow-y:auto; box-shadow:0 0 50px rgba(0,0,0,0.8);">
            <h2 style="font-family:var(--font-title); color:#2c3e50; border-bottom:2px solid #d4af37; padding-bottom:10px;">âš™ï¸ éŠæˆ²è¨­å®š & åå–®ç®¡ç†</h2>
            
            <div style="background:#f0f8ff; padding:20px; border-radius:10px; margin-bottom:20px; border:1px solid #a8d0e6;">
                <h3 style="margin-top:0; color:#2980b9;">ğŸ² å¿«é€Ÿéš¨æ©Ÿåˆ†çµ„</h3>
                <p style="font-size:0.9rem; color:#666;">å°‡å…¨ç­åå–®è²¼åœ¨ä¸‹æ–¹ (ä¸€è¡Œä¸€å€‹åå­—)ï¼Œç³»çµ±æœƒè‡ªå‹•æ‰“äº‚ä¸¦å¹³å‡åˆ†é…çµ¦å…©éšŠã€‚</p>
                <textarea id="raw-roster-input" placeholder="è²¼ä¸Šåå–®ï¼Œä¾‹å¦‚ï¼š
é™³å¤§æ–‡
æå°æ˜
å¼µå¿—å¼·
..." style="height:120px; margin-bottom:10px;"></textarea>
                <button class="gem-btn btn-green" style="padding:8px 20px; font-size:1rem;" onclick="randomizeTeams()">ğŸš€ åŸ·è¡Œéš¨æ©Ÿåˆ†çµ„</button>
            </div>

            <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:20px;">
                <div>
                    <h4>ğŸ›¡ï¸ å»‰é —éšŠ (Team A)</h4>
                    <textarea id="input-roster-a" readonly style="background:#eee; color:#555;"></textarea>
                </div>
                <div>
                    <h4>ğŸŒŠ è—ºç›¸å¦‚éšŠ (Team B)</h4>
                    <textarea id="input-roster-b" readonly style="background:#eee; color:#555;"></textarea>
                </div>
            </div>
            
            <div style="text-align:center; margin-top:20px;">
                <button class="gem-btn btn-red" style="padding:10px 40px;" onclick="document.getElementById('overlay-settings').style.display='none'">é—œé–‰è¨­å®š</button>
            </div>
        </div>
    </div>

    <div class="overlay" id="overlay-wheel">
        <h1 style="font-family:var(--font-title); color:var(--gold-primary); font-size:4rem; text-shadow:0 0 20px black; margin-bottom:20px;">çµ‚æ¥µè¼ªç›¤</h1>
        <div style="width:500px; height:500px; position:relative; margin-bottom:20px;" id="wheel-container">
            <div style="position:absolute; top:-30px; left:50%; transform:translateX(-50%); width:0; height:0; border-left:25px solid transparent; border-right:25px solid transparent; border-top:50px solid #fff; z-index:10; filter:drop-shadow(0 5px 5px rgba(0,0,0,0.5));"></div>
            <canvas id="wheel-canvas" width="500" height="500" style="width:100%; height:100%; border-radius:50%; border:10px solid var(--gold-primary); box-shadow:0 0 60px rgba(0,0,0,0.8);"></canvas>
        </div>
        <div id="wheel-result-card">
            <h2 id="w-res-title" style="font-family:var(--font-title); font-size:3rem; color:#c0392b; margin:0 0 20px 0;">çµæœæ¨™é¡Œ</h2>
            <p id="w-res-desc" style="font-size:1.5rem; color:#333; line-height:1.5; font-weight:bold;">...</p>
            <button class="gem-btn btn-red" style="margin-top:30px; width:100%;" onclick="closeWheel()">ğŸ˜± æ¥å—å‘½é‹</button>
        </div>
        <div id="wheel-controls">
            <button class="gem-btn btn-gold" id="btn-spin" onclick="spinWheel()">ğŸš€ å•Ÿå‹•å‘½é‹</button>
            <button class="gem-btn" style="margin-top:20px; background:#555;" onclick="document.getElementById('overlay-wheel').style.display='none'">é—œé–‰</button>
        </div>
    </div>

    <script>
        // --- 1. è³‡æ–™åº« (å®Œå…¨ä¿ç•™æ‚¨è¦æ±‚çš„å…§å®¹) ---
        let db = {
            questions: [
                {cat:"å»‰é —è—ºç›¸å¦‚: å­—è©", q:"ã€Œç§¦æ˜­ç‹èä¹‹ï¼Œä½¿äººéºè¶™ç‹æ›¸ã€‚ã€ä¸­ï¼Œã€Œéºã€å­—ä½œä½•è§£ï¼Ÿ", a:"ã€é€ / çµ¦ã€‘", img:""},
                {cat:"å»‰é —è—ºç›¸å¦‚: å­—è©", q:"ã€Œæ‹œç‚ºä¸Šå¿ã€åŠã€Œç›¸å¦‚è«‹å¾—ä»¥é ¸è¡€æ¿ºå¤§ç‹çŸ£ã€ä¸­çš„ã€Œæ‹œã€å’Œã€Œè«‹ã€åˆ†åˆ¥ä½œä½•è§£ï¼Ÿ", a:"æ‹œï¼šã€æˆäºˆå®˜è· / ä»»å‘½ã€‘\nè«‹ï¼šã€è«‹æ±‚ï¼ˆç§¦ç‹æ‰¹å‡†è‡ªå·±ï¼‰ã€‘", img:""},
                {cat:"å»‰é —è—ºç›¸å¦‚: èªæ³•", q:"ã€Œè‡£èª æè¦‹æ¬ºæ–¼ç‹è€Œè² è¶™ã€‚ã€å¥ä¸­çš„ã€Œè¦‹ã€å­—æœ‰ä½•èªæ³•ä½œç”¨ï¼Ÿ", a:"è¡¨ç¤ºã€è¢«å‹•ã€‘ã€‚\nã€Œè¦‹æ¬ºã€å³ã€Œè¢«æ¬ºè² /æ¬ºé¨™ã€ã€‚", img:""},
                {cat:"å»‰é —è—ºç›¸å¦‚: å…§å®¹", q:"ç¹†è³¢æ¨è–¦è—ºç›¸å¦‚å‡ºä½¿ç§¦åœ‹ï¼Œæ˜¯åŸºæ–¼å“ªä¸€ä»¶äº‹è­‰æ˜ç›¸å¦‚å…·å‚™å‹‡æ°£èˆ‡æ™ºè¬€ï¼Ÿ", a:"ç›¸å¦‚æ›¾åˆ†æç¹†è³¢æ‡‰å¦æŠ•å¥”ç‡•åœ‹ä¸€äº‹ã€‚\né€™é¡¯ç¤ºä»–èƒ½ã€å¯©æ™‚åº¦å‹¢ã€‘(æ™º)åŠæ•¢æ–¼å‘ä¸»å­é€²è««(å‹‡)ã€‚", img:""},
                {cat:"å»‰é —è—ºç›¸å¦‚: å…§å®¹", q:"åœ¨ã€Œæ¾ æ± ä¹‹æœƒã€ä¸­ï¼Œç‚ºä½•è—ºç›¸å¦‚å …æŒè¦ç§¦ç‹æ“Šç¼¶ï¼Ÿ", a:"ç‚ºäº†ç¶­è­·è¶™åœ‹çš„ã€åœ‹é«” / å°Šåš´ã€‘ã€‚\nå› ç‚ºç§¦ç‹ä»¤è¶™ç‹é¼“ç‘Ÿä¸¦å¯«å…¥å²å†Šæ˜¯ç¾è¾±è¶™åœ‹ï¼Œç›¸å¦‚è¦ä»¥ç‰™é‚„ç‰™ã€‚", img:""},
                {cat:"å»‰é —è—ºç›¸å¦‚: ç­–ç•¥", q:"ä»¥ä¸‹å“ªé …ã€Œä¸æ˜¯ã€è—ºç›¸å¦‚åœ¨ã€Œå®Œç’§æ­¸è¶™ã€ä¸­ä½¿ç”¨çš„ç­–ç•¥ï¼Ÿ\nA. å‡ç¨±ç’§æœ‰ç‘•ç–µï¼Œå–å›ç’§ç‰\nB. æ€’é«®è¡å† ï¼Œå€šæŸ±å¨è„…äººç’§ä¿±ç¢\nC. æ´¾éš¨å¾ç©¿ä¾¿æœæ‡·ç’§å¾å°è·¯é€ƒèµ°\nD. å¨è„…è¦åœ¨ç§¦å»·ä¸Šæœæ¯’è‡ªæ®º", a:"ç­”æ¡ˆï¼šã€Dã€‘\n(æ–‡ä¸­æœªææœæ¯’ï¼Œä»–æ˜¯å¨è„…è¦ä»¥é ­æ“ŠæŸ±ï¼Œèˆ‡ç’§ä¿±ç¢)", img:""},
                {cat:"å»‰é —è—ºç›¸å¦‚: å…§å®¹", q:"ã€Œè² èŠè«‹ç½ªã€ä¸€äº‹ä¸­ï¼Œå»‰é —å¾—æ‚‰ä»€éº¼çœŸç›¸å¾Œæ„Ÿåˆ°æ…šæ„§ï¼Ÿ", a:"ä»–çŸ¥é“è—ºç›¸å¦‚è™•è™•å¿è®“ï¼Œæ˜¯ç‚ºäº†ã€åœ‹å®¶å®‰å±ï¼ˆå…ˆåœ‹å®¶ä¹‹æ€¥è€Œå¾Œç§ä»‡ï¼‰ã€‘ï¼Œè€Œéæ€•ä»–ã€‚", img:""},
                {cat:"å»‰é —è—ºç›¸å¦‚: æ‰‹æ³•", q:"å¸é¦¬é·åœ¨æ–‡ä¸­æ¥µåŠ›æå¯«ç§¦åœ‹çš„å¼·å¤§å’Œç§¦ç‹çš„å‚²æ…¢ï¼Œé€™å°åˆ»ç•«è—ºç›¸å¦‚çš„å½¢è±¡æœ‰ä»€éº¼ä½œç”¨ï¼Ÿ", a:"ã€è¥¯æ‰˜ / åè¥¯ã€‘ä½œç”¨ã€‚\nä»¥ç§¦ä¹‹å¼·å¤§åè¥¯ç›¸å¦‚çš„ã€æ™ºå‹‡é›™å…¨ã€‘å’Œä¸ç•å¼·æ¬Šã€‚", img:""},
                {cat:"å»‰é —è—ºç›¸å¦‚: å¥å¼", q:"ã€Œæ±‚äººå¯ä½¿å ±ç§¦è€…ã€ä¸€å¥é‹ç”¨äº†ä»€éº¼æ–‡è¨€å¥å¼ï¼Ÿ", a:"ã€å®šèªå¾Œç½®ã€‘å¥ã€‚\næ­£å¸¸èªåºæ‡‰ç‚ºã€Œæ±‚å¯ä½¿å ±ç§¦ä¹‹äººã€ã€‚", img:""},
                {cat:"å»‰é —è—ºç›¸å¦‚: å…§å®¹", q:"å»‰é —æšè¨€ã€Œæˆ‘è¦‹ç›¸å¦‚ï¼Œå¿…è¾±ä¹‹ã€çš„åŸå› æ˜¯ä»€éº¼ï¼Ÿ", a:"ä»–èªç‚ºè‡ªå·±æœ‰ã€æ”»åŸé‡æˆ°ã€‘ä¹‹å¤§åŠŸï¼Œè€Œç›¸å¦‚åƒ…æ†‘ã€å£èˆŒä¹‹å‹ã€‘ä½å±…å…¶ä¸Šï¼Œä¸”å‡ºèº«å‘è³¤ã€‚", img:""},
                {cat:"å»‰é —è—ºç›¸å¦‚: è±¡å¾µ", q:"ã€Œå’Œæ°ç’§ã€åœ¨æ–‡ä¸­é™¤äº†æ˜¯å¯¶ç‰©å¤–ï¼Œé‚„è±¡å¾µäº†ä»€éº¼ï¼Ÿ", a:"è±¡å¾µäº†ç§¦è¶™å…©åœ‹å¤–äº¤é¬¥çˆ­çš„ã€è—‰å£ / ç±Œç¢¼ã€‘ã€‚\nç§¦ä»¥æ­¤è©¦æ¢è¶™ï¼Œè¶™ä»¥æ­¤ä¿å…¨å°Šåš´ã€‚", img:""},
                {cat:"å»‰é —è—ºç›¸å¦‚: å…§å®¹", q:"ç§¦ç‹æœ€çµ‚ç‚ºä½•æ²’æœ‰æ®ºè—ºç›¸å¦‚ï¼Œåè€Œç¦®é€ä»–å›è¶™åœ‹ï¼Ÿ", a:"å› ç‚ºç§¦ç‹èªç‚ºæ®ºäº†ç›¸å¦‚ä¹Ÿå¾—ä¸åˆ°ç’§ï¼Œåè€Œæœƒæ–·çµ•ç§¦è¶™å‹å¥½é—œä¿‚ï¼ˆã€çµ•ç§¦è¶™ä¹‹æ­¡ã€‘ï¼‰ï¼Œä¸¦èƒŒè² æƒ¡åã€‚", img:""},
                {cat:"å»‰é —è—ºç›¸å¦‚: å½¢è±¡", q:"è©¦ç”¨å…©å€‹å››å­—æˆèªæ¦‚æ‹¬è—ºç›¸å¦‚çš„å½¢è±¡ã€‚", a:"ã€æ™ºå‹‡é›™å…¨ã€‘ã€ã€é¡§å…¨å¤§å±€ã€‘\n(æˆ–ï¼šè‡¨å±ä¸æ‡¼ã€æ„›åœ‹å¿˜èº«)ã€‚", img:""},
                {cat:"å»‰é —è—ºç›¸å¦‚: ä¸»æ—¨", q:"æœ¬æ–‡ä¸»æ—¨æ˜¯ä»€éº¼ï¼Ÿ\nA. è¨˜è¼‰æˆ°åœ‹æ­·å²\nB. è®šæšå»‰é —å‹‡æ­¦\nC. æ­Œé Œå°‡ç›¸å’Œç¦åŠå…¶å°åœ‹å®¶çš„è²¢ç»\nD. æ‰¹è©•ç§¦åœ‹ç„¡ç¦®", a:"ç­”æ¡ˆï¼šã€Cã€‘\né‡é»åœ¨æ–¼ã€Œå°‡ç›¸å’Œã€å°è¶™åœ‹å®‰å®šçš„é‡è¦æ€§ã€‚", img:""},
                
                {cat:"å²³é™½æ¨“è¨˜: å­—è©", q:"ã€Œæ»•å­äº¬è¬«å®ˆå·´é™µéƒ¡ã€ä¸­ï¼Œã€Œè¬«ã€å­—ä½œä½•è§£ï¼Ÿ", a:"ã€è²¶å®˜ / é™è·ã€‘ã€‚\n(æŒ‡å› ç½ªæˆ–éå¤±è¢«é™è·æˆ–æµæ”¾)", img:""},
                {cat:"å²³é™½æ¨“è¨˜: å­—è©", q:"ã€Œå±¬äºˆä½œæ–‡ä»¥è¨˜ä¹‹ã€ä¸­ï¼Œã€Œå±¬ã€å­—é€šå“ªä¸€å€‹å­—ï¼Ÿè§£é‡‹ç‚ºä½•ï¼Ÿ", a:"é€šã€å›‘ã€‘ã€‚è§£é‡‹ç‚ºã€å›‘å’ / è¨—ä»˜ã€‘ã€‚", img:""},
                {cat:"å²³é™½æ¨“è¨˜: ä¿®è¾­", q:"ã€ŒéŠœé å±±ï¼Œåé•·æ±Ÿã€é‹ç”¨äº†ä»€éº¼ä¿®è¾­æ‰‹æ³•ï¼Ÿæœ‰ä½•æ•ˆæœï¼Ÿ", a:"1. ã€æ“¬äººã€‘(æŠŠæ´åº­æ¹–æ“¬äººåŒ–)\n2. ã€å°å¶ã€‘\næ•ˆæœï¼šç”Ÿå‹•åœ°å¯«å‡ºæ´åº­æ¹–æ°£å‹¢ç£…ç¤¡ã€‚", img:""},
                {cat:"å²³é™½æ¨“è¨˜: å…§å®¹", q:"ä½œè€…åœ¨å¯«æ™¯æ™‚ï¼Œæå¯«ã€Œéœªé›¨éœéœã€çš„æ™¯è±¡ï¼Œç›®çš„æ˜¯å¸¶å‡ºé·å®¢é¨·äººæ€æ¨£çš„å¿ƒæƒ…ï¼Ÿ", a:"ã€æ‚²ã€‘\n(å»åœ‹æ‡·é„‰ï¼Œæ†‚è®’ç•è­ï¼Œæ„Ÿæ¥µè€Œæ‚²)ã€‚", img:""},
                {cat:"å²³é™½æ¨“è¨˜: å…§å®¹", q:"æå¯«ã€Œæ˜¥å’Œæ™¯æ˜ã€æ™‚ï¼Œã€ŒéŒ¦é±—æ¸¸æ³³ã€æ˜¯æŒ‡ä»€éº¼ï¼Ÿ", a:"æŒ‡ã€ç¾éº—çš„é­šã€‘åœ¨æ°´ä¸­æ¸¸å‹•ã€‚\nã€ŒéŒ¦é±—ã€é‹ç”¨äº†å€Ÿä»£æ³•ã€‚", img:""},
                {cat:"å²³é™½æ¨“è¨˜: å…§å®¹", q:"ã€Œæµ®å…‰èºé‡‘ï¼Œéœå½±æ²‰ç’§ã€æå¯«çš„æ˜¯ä»€éº¼æ™‚é–“çš„æ™¯è‰²ï¼Ÿ", a:"ã€æ™šä¸Š / å¤œæ™šã€‘ã€‚\n(å› ç‚ºæœ‰çš“æœˆåƒé‡Œ)ã€‚", img:""},
                {cat:"å²³é™½æ¨“è¨˜: çµæ§‹", q:"æ–‡ä¸­ã€Œå—Ÿå¤«ï¼ã€äºŒå­—åœ¨çµæ§‹ä¸Šæœ‰ä»€éº¼ä½œç”¨ï¼Ÿ", a:"ã€æ‰¿ä¸Šå•Ÿä¸‹ã€‘(æˆ–è½‰æŠ˜)ã€‚\nç”±ä¸Šæ–‡æå¯«é·å®¢é¨·äººçš„æ‚²å–œä¹‹æƒ…ï¼Œè½‰å…¥ä¸‹æ–‡æŠ’ç™¼å¤ä»äººçš„è­°è«–ã€‚", img:""},
                {cat:"å²³é™½æ¨“è¨˜: ä¸»æ—¨", q:"å¤ä»äººçš„ã€Œä¸ä»¥ç‰©å–œï¼Œä¸ä»¥å·±æ‚²ã€æ˜¯ä»€éº¼æ„æ€ï¼Ÿ", a:"ä¸å› ç‚ºã€å¤–åœ¨ç’°å¢ƒã€‘çš„å¥½å£æˆ–ã€å€‹äººéš›é‡ã€‘çš„å¾—å¤±è€Œæ„Ÿåˆ°é«˜èˆˆæˆ–æ‚²å‚·ã€‚", img:""},
                {cat:"å²³é™½æ¨“è¨˜: åå¥", q:"èŒƒä»²æ·¹æå‡ºçš„æ”¿æ²»æŠ±è² ï¼ˆåƒå¤åå¥ï¼‰æ˜¯ä»€éº¼ï¼Ÿ", a:"ã€å…ˆå¤©ä¸‹ä¹‹æ†‚è€Œæ†‚ï¼Œå¾Œå¤©ä¸‹ä¹‹æ¨‚è€Œæ¨‚ã€‘ã€‚", img:""},
                {cat:"å²³é™½æ¨“è¨˜: å­—è©", q:"ã€Œå»åœ‹æ‡·é„‰ã€ä¸­çš„ã€Œå»ã€å­—ä½œä½•è§£ï¼Ÿ", a:"ã€é›¢é–‹ã€‘ã€‚\nã€Œå»åœ‹ã€æŒ‡é›¢é–‹äº¬åŸã€‚", img:""},
                {cat:"å²³é™½æ¨“è¨˜: è©³ç•¥", q:"ç‚ºä½•ä½œè€…åœ¨æ–‡ä¸­è©³å¯«æ´åº­æ¹–çš„æ™¯è‰²ï¼Œå»ç•¥å¯«å²³é™½æ¨“æœ¬èº«çš„å»ºç¯‰ï¼Ÿ", a:"å› ç‚ºæ–‡ç« é‡é»åœ¨æ–¼ã€å€Ÿæ™¯æŠ’æƒ… / å€Ÿäº‹ä»¥æ­¤ã€‘ã€‚\né‡é»æ˜¯ç™»æ¨“å¾Œçš„æ„Ÿå—åŠè¡¨é”æ”¿æ²»ç†æƒ³ï¼Œè€Œéå»ºç¯‰èªªæ˜æ›¸ã€‚", img:""},
                {cat:"å²³é™½æ¨“è¨˜: ä¿®è¾­", q:"ã€Œæª£å‚¾æ¥«æ‘§ã€é‹ç”¨äº†ä»€éº¼ä¿®è¾­æ‰‹æ³•ï¼Ÿ", a:"1. ã€å€Ÿä»£ã€‘(ç”¨æª£ã€æ¥«å€Ÿä»£èˆ¹éš»)\n2. ã€äº’æ–‡ã€‘(æª£å‚¾å’Œæ¥«æ‘§äº’ç‚ºè£œå……)", img:""},
                {cat:"å²³é™½æ¨“è¨˜: æ¯”è¼ƒ", q:"é·å®¢é¨·äººèˆ‡å¤ä»äººæœ€å¤§çš„åˆ†åˆ¥æ˜¯ï¼š\nA. æ–‡å­¸æ‰è¯\nB. æ˜¯å¦å—å¤–ç‰©å½±éŸ¿å¿ƒå¢ƒ\nC. å®˜è·é«˜ä½\nD. æ˜¯å¦åˆ°éå²³é™½æ¨“", a:"ç­”æ¡ˆï¼šã€Bã€‘\né·å®¢é¨·äººæœƒè§¸æ™¯ç”Ÿæƒ…(å—å¤–ç‰©å½±éŸ¿)ï¼Œå¤ä»äººå‰‡è¶…è¶Šç‰©æˆ‘ã€‚", img:""},
                {cat:"å²³é™½æ¨“è¨˜: ç¸½çµ", q:"ã€Œå¾®æ–¯äººï¼Œå¾èª°èˆ‡æ­¸ï¼Ÿã€è¡¨é”äº†ä½œè€…æ€æ¨£çš„æ„Ÿæƒ…ï¼Ÿ", a:"1. å°å¤ä»äººçš„ã€ä»°æ…• / åš®å¾€ã€‘ã€‚\n2. èˆ‡æœ‹å‹(æ»•å­äº¬)çš„ã€äº’å‹‰ã€‘ã€‚\n3. æ²’æœ‰åŒé“ä¸­äººã€å­¤å–®å¯‚å¯ã€‘ã€‚", img:""}
            ],
            ops: [
                {title:"å®Œç’§æ­¸è¶™", desc:"ã€é˜²ç¦¦ã€‘æ™ºå‹‡é›™å…¨ï¼ä¿ç•™æ­¤å¡ï¼Œå¯æŠµéŠ·ä¸€æ¬¡ã€Œç­”éŒ¯æ‰£åˆ†ã€æˆ–ã€Œæ‡²ç½°å¡ã€æ•ˆæœã€‚", val:0},
                {title:"æ…¶æ›†æ–°æ”¿", desc:"ã€å¤§èµ¦ã€‘ç™¾å»¢å…·èˆˆï¼Œæ”¿é€šäººå’Œã€‚å…¨ç­æ¯äººåŠ  1 åˆ†ï¼Œæœ¬éšŠé¡å¤–åŠ  20 åˆ†ã€‚", val:20},
                {title:"å¿ƒæ› ç¥æ€¡", desc:"ã€è±å…ã€‘å¯µè¾±çš†å¿˜ã€‚è‹¥ä¸‹ä¸€é¡Œç­”éŒ¯ï¼Œè€å¸«ä¸å¿å¿ƒæ‰£åˆ†ï¼Œåˆ†æ•¸ä¸è®Šã€‚", val:0},
                {title:"å°‡ç›¸å’Œ", desc:"ã€åˆä½œã€‘æŒ‡å®šæ•µæ–¹ä¸€ä½éšŠå“¡èˆ‡ä½ ã€Œæ¡æ‰‹è¨€å’Œã€ï¼Œé›™æ–¹å„åŠ  10 åˆ†ã€‚", val:10},
                {title:"é€£æ©«åˆç¸±", desc:"ã€ç­–ç•¥ã€‘å¯é¸æ“‡èˆ‡æ•µéšŠäº¤æ›ç•¶å‰åˆ†æ•¸ï¼ˆåƒ…é™åˆ†æ•¸ä½æ–¼æ•µéšŠæ™‚ä½¿ç”¨ï¼‰ï¼Œæˆ–ç›´æ¥åŠ 15åˆ†ã€‚", val:15},
                {title:"æ¾ æ± ä¹‹æœƒ", desc:"ã€æ”»æ“Šã€‘è«‹æ•µæ–¹éšŠé•·å‡ºä¾†ã€Œæ“Šç¼¶ã€(æ‹æ±ä¸‰ä¸‹)ã€‚è‹¥ä¸å¾ï¼Œæ•µæ–¹æ‰£ 15 åˆ†ã€‚", val:0}
            ],
            puns: [
                {title:"è² èŠè«‹ç½ª", desc:"ã€æ‰£åˆ†ã€‘çŸ¥éŒ¯èƒ½æ”¹ã€‚å…¨éšŠéœ€å‘è€å¸«/æ•µéšŠèªªã€Œå°ä¸èµ·ï¼Œæˆ‘éŒ¯äº†ã€ï¼Œä¸¦æ‰£ 10 åˆ†ã€‚", val:10},
                {title:"é™°é¢¨æ€’è™Ÿ", desc:"ã€é‡æ“Šã€‘æ¿æµªæ’ç©ºï¼Œå•†æ—…ä¸è¡Œã€‚é‹æ°£æ¥µå·®ï¼Œç›´æ¥æ‰£é™¤ 20 åˆ†ã€‚", val:20},
                {title:"æ‡·ç’§å…¶ç½ª", desc:"ã€é™·å®³ã€‘å› ç‚ºå¤ªå„ªç§€è€Œè¢«é‡å°ã€‚æ•µæ–¹å¯ä»¥æŒ‡å®šä½ éšŠä¸€åæˆå“¡ä¸‹å›åˆã€Œç¦è¨€ã€ã€‚", val:0},
                {title:"å»åœ‹æ‡·é„‰", desc:"ã€æ‚²æƒ…ã€‘æ»¿ç›®è•­ç„¶ï¼Œæ„Ÿæ¥µè€Œæ‚²ã€‚å…¨éšŠéœ€åšå‡ºã€Œæ†‚é¬±ã€çš„è¡¨æƒ… 10 ç§’ï¼Œå¦å‰‡æ‰£åˆ†åŠ å€ã€‚", val:10},
                {title:"æª£å‚¾æ¥«æ‘§", desc:"ã€ç½é›£ã€‘èˆ¹æ¯€äº†ï¼æœ¬å›åˆç„¡æ³•å¾—åˆ†ï¼Œä¸”éœ€æ‰£é™¤ 15 åˆ†ä¿®èˆ¹è²»ã€‚", val:15},
                {title:"æ‡·æ‰ä¸é‡", desc:"ã€æš«åœã€‘ä½ è¦ºå¾—è‡ªå·±æ‡·æ‰ä¸é‡ï¼Œæ±ºå®šç½·å·¥ä¸€å›åˆï¼ˆä¸‹å›åˆä¸èƒ½ç”±ä½ å›ç­”ï¼‰ã€‚", val:0}
            ],
            wheel: [
                {title:"æ“Šç¼¶åŠ©èˆˆ", desc:"æ¨¡ä»¿ç§¦ç‹ï¼Œåœ¨æ¡Œä¸Šæ‰“ä¸€æ®µç¯€å¥ï¼ˆæ“Šç¼¶ï¼‰ï¼Œå…¨çµ„å¹«å¿™æ‰“æ‹å­ã€‚"},
                {title:"å…ˆæ†‚å¾Œæ¨‚", desc:"å…¨çµ„èµ·ç«‹ï¼Œç”¨æœ€æ¿€æ˜‚çš„èªæ°£æœ—èª¦ï¼šã€Œå…ˆå¤©ä¸‹ä¹‹æ†‚è€Œæ†‚ï¼Œå¾Œå¤©ä¸‹ä¹‹æ¨‚è€Œæ¨‚ï¼ã€"},
                {title:"è² èŠè«‹ç½ª", desc:"éšŠé•·éœ€èƒŒè‘—ä¸€å€‹æ›¸åŒ…ï¼ˆè±¡å¾µèŠæ¢ï¼‰ï¼Œå‘æ•µéšŠæ‹±æ‰‹ä½œæ–ã€‚"},
                {title:"æ€’é«®è¡å† ", desc:"æ¨¡ä»¿è—ºç›¸å¦‚ã€Œæ€’é«®è¡å† ã€çš„è¡¨æƒ…ï¼Œçªè‘—æ•µæ–¹éšŠä¼ 10 ç§’ï¼Œä¸èƒ½ç¬‘ã€‚"},
                {title:"è™å˜¯çŒ¿å•¼", desc:"å…¨çµ„æ¨¡ä»¿ã€Šå²³é™½æ¨“è¨˜ã€‹ä¸­çš„ã€Œè™å˜¯çŒ¿å•¼ã€è²éŸ³ï¼Œè¦å¤ æ·’å²ã€‚"},
                {title:"é¿å¸­è€Œè¬", desc:"å…¨çµ„èµ·ç«‹ï¼Œå‘æ•µæ–¹éšŠä¼ 90 åº¦é èº¬ï¼Œå¤§å–Šï¼šã€Œå»‰å°‡è»ï¼Œæˆ‘å€‘æœäº†ï¼ã€"},
                {title:"è‚‰è¢’è² èŠ", desc:"é€™å¤ªæ®˜å¿äº†... å…¨çµ„éœ€åšã€Œæ·±è¹²ã€5 ä¸‹ï¼Œä»¥ç¤ºæ‚”æ„ã€‚"},
                {title:"å·¦å³çš†é¡", desc:"å‡è£è—ºç›¸å¦‚æŒç’§å¤§å–ä¸€è²ï¼Œæ•µæ–¹å…¨éšŠéœ€é…åˆåšå‡ºã€Œåš‡å¾—å¾Œé€€ã€çš„å‹•ä½œã€‚"}
            ],
            roster: { a: [], b: [] }
        };

        function initDefaultRoster() {
            if (db.roster.a.length === 0) {
                for(let i=1; i<=14; i++) db.roster.a.push(`A${i}`);
                for(let i=1; i<=14; i++) db.roster.b.push(`B${i}`);
            }
        }
        initDefaultRoster();

        // --- 2. éŠæˆ²æ ¸å¿ƒé‚è¼¯ ---
        let state = {
            turn: 'a',
            scores: { a: 100, b: 100 },
            hearts: { a: 3, b: 3 }, // é è¨­ 3 é¡†å¿ƒ
            curQ: null,
            usage: { a: {}, b: {} },
            turnCount: 1
        };

        window.onload = function() {
            updateUI();
            updateSettingsUI();
        };

        function updateUI() {
            document.getElementById('q-count').innerText = db.questions.length;
            document.getElementById('turn-count').innerText = state.turnCount;
            const t = state.turn;
            const a = document.getElementById('panel-a');
            const b = document.getElementById('panel-b');
            
            if (t === 'a') { a.classList.add('active'); b.classList.remove('active'); }
            else { b.classList.add('active'); a.classList.remove('active'); }
            
            ['a','b'].forEach(team => {
                document.getElementById(`score-${team}`).innerText = state.scores[team];
                
                // é¡¯ç¤ºå¿ƒå¿ƒé‚è¼¯ï¼š<=0 é¡¯ç¤ºå¿ƒç¢ï¼Œå¦å‰‡é¡¯ç¤ºç´…å¿ƒ
                let hStr = "";
                if (state.hearts[team] <= 0) {
                    hStr = "ğŸ’”";
                } else {
                    for(let i=0; i<state.hearts[team]; i++) hStr += "â¤ï¸";
                }
                document.getElementById(`hearts-${team}`).innerText = hStr;
            });
        }

        function updateSettingsUI() {
            document.getElementById('input-roster-a').value = db.roster.a.join('\n');
            document.getElementById('input-roster-b').value = db.roster.b.join('\n');
        }

        // --- æ ¸å¿ƒåŠ æ¸›åˆ†/å¿ƒæ©Ÿåˆ¶ ---
        function modStat(team, type, val) {
            if (type === 'h') {
                // åŠ æ¸›å¿ƒé‚è¼¯
                let newHearts = state.hearts[team] + val;
                
                // ä¸Šé™ 5
                if (newHearts > 5) newHearts = 5;
                // ä¸‹é™ 0 (0 å°±æœƒé¡¯ç¤ºå¿ƒè£‚é–‹)
                if (newHearts < 0) newHearts = 0;
                
                state.hearts[team] = newHearts;
            } else {
                // åŠ æ¸›åˆ†é‚è¼¯
                state.scores[team] += val;
            }
            updateUI();
        }

        // --- ç­”é¡Œçµæœè™•ç† (è‡ªå‹•æ‰£/åŠ å¿ƒ) ---
        function handleResult(isCorrect) {
            if(isCorrect) {
                // ç­”å°ï¼š+10åˆ†ï¼Œ+1å¿ƒï¼ŒæŠ½æ©Ÿæœƒ
                modStat(state.turn, 's', 10);
                modStat(state.turn, 'h', 1);
                initSelection('chance');
            } else {
                // ç­”éŒ¯ï¼š-10åˆ†ï¼Œ-1å¿ƒï¼ŒæŠ½æ‡²ç½°
                modStat(state.turn, 's', -10);
                modStat(state.turn, 'h', -1);
                initSelection('punish');
            }
        }

        // --- å…¶ä»–è¼”åŠ©åŠŸèƒ½ (åˆ†çµ„ã€æŠ½é¡Œ) ---
        function randomizeTeams() {
            const raw = document.getElementById('raw-roster-input').value.trim();
            if(!raw) return alert("è«‹å…ˆè²¼ä¸Šåå–®ï¼");
            let names = raw.split(/\n+/).map(n => n.trim()).filter(n => n);
            if(names.length < 2) return alert("åå–®äººæ•¸å¤ªå°‘ï¼");
            for (let i = names.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [names[i], names[j]] = [names[j], names[i]];
            }
            const half = Math.ceil(names.length / 2);
            db.roster.a = names.slice(0, half);
            db.roster.b = names.slice(half);
            state.usage = { a: {}, b: {} }; 
            updateSettingsUI();
            alert(`åˆ†çµ„å®Œæˆï¼\nå»‰é —éšŠ: ${db.roster.a.length} äºº\nå²³é™½æ¨“éšŠ: ${db.roster.b.length} äºº`);
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function drawQuestion() {
            if (db.questions.length === 0) return alert("æ‰€æœ‰é¡Œç›®å·²æŠ½å®Œï¼");
            const idx = Math.floor(Math.random() * db.questions.length);
            state.curQ = db.questions[idx];
            db.questions.splice(idx, 1);
            
            // éš¨æ©Ÿé¸äºº
            const currentRoster = db.roster[state.turn];
            let studentName = "---";
            if (currentRoster && currentRoster.length > 0) {
                let minUsage = 2;
                let hasZero = currentRoster.some(name => (state.usage[state.turn][name] || 0) === 0);
                let targetUsage = hasZero ? 0 : 1;
                let candidates = currentRoster.filter(name => (state.usage[state.turn][name] || 0) === targetUsage);
                if (candidates.length === 0 && !hasZero) {
                    state.usage[state.turn] = {};
                    candidates = currentRoster;
                }
                studentName = candidates[Math.floor(Math.random() * candidates.length)];
                state.usage[state.turn][studentName] = (state.usage[state.turn][studentName] || 0) + 1;
            } else {
                studentName = "å…¨é«”éšŠå“¡";
            }
            document.getElementById(`student-name-${state.turn}`).innerText = studentName;
            document.getElementById(`student-name-${state.turn==='a'?'b':'a'}`).innerText = "---";
            
            // é¡¯ç¤ºé¡Œç›®å¡
            const card = document.getElementById('game-card');
            card.classList.remove('flipped');
            document.getElementById('q-cat').innerText = state.curQ.cat;
            const qTextEl = document.getElementById('q-text');
            qTextEl.innerText = state.curQ.q;
            if(state.curQ.q.length < 20 && !state.curQ.q.includes('\n')) qTextEl.classList.add('short');
            else qTextEl.classList.remove('short');
            
            document.getElementById('q-ans').innerText = state.curQ.a;
            const img = document.getElementById('card-img');
            const innerImg = img.querySelector('.q-img');
            if(state.curQ.img && state.curQ.img.startsWith('http')) {
                innerImg.style.backgroundImage = `url('${state.curQ.img}')`;
                img.style.display = 'block';
            } else {
                img.style.display = 'none';
            }

            document.getElementById('btn-draw').classList.add('hidden');
            document.getElementById('action-btns').classList.remove('hidden');
            updateUI();
        }

        function closeQuestion() {
            state.turn = state.turn === 'a' ? 'b' : 'a';
            state.turnCount++;
            document.getElementById('btn-draw').classList.remove('hidden');
            document.getElementById('action-btns').classList.add('hidden');
            document.getElementById('game-card').classList.remove('flipped');
            document.getElementById('student-name-a').innerText = "æº–å‚™";
            document.getElementById('student-name-b').innerText = "æº–å‚™";
            updateUI();
        }

        function flipCard() {
            document.getElementById('game-card').classList.toggle('flipped');
        }

        function openSettings() {
            document.getElementById('overlay-settings').style.display='flex';
            updateSettingsUI();
        }

        // --- Card Selection ---
        function initSelection(type) {
            const pool = type === 'chance' ? db.ops : db.puns;
            let deck = [...pool];
            shuffleArray(deck);
            let selected3 = deck.slice(0, 3);
            while(selected3.length < 3) selected3.push({title:"ç©ºç¼º", desc:"...", val:0});
            shuffleArray(selected3);

            const grid = document.getElementById('cards-grid');
            grid.innerHTML = '';
            const overlayClass = type === 'chance' ? 'style-chance' : 'style-punish';
            document.getElementById('overlay-select').className = `overlay ${overlayClass}`;
            document.getElementById('select-title').innerText = type === 'chance' ? "âœ¨ éŒ¦å›Š" : "âš¡ è²¶è¬«";

            selected3.forEach((cardData) => {
                const el = document.createElement('div');
                el.className = 'tarot-card';
                el.onclick = () => revealCard(el, cardData, type);
                el.innerHTML = `
                    <div class="tarot-face tarot-back">
                        <div class="tarot-emblem">${type==='chance'?'â˜…':'âš¡'}</div>
                    </div>
                    <div class="tarot-face tarot-front">
                        <div class="tf-type">${type==='chance'?'BONUS':'PENALTY'}</div>
                        <div class="tf-title">${cardData.title}</div>
                        <div class="tf-desc">${cardData.desc}</div>
                    </div>
                `;
                grid.appendChild(el);
            });

            document.getElementById('overlay-select').style.display = 'flex';
            document.getElementById('btn-confirm-select').classList.add('hidden');
        }

        function revealCard(el, data, type) {
            if(el.classList.contains('flipped') || document.querySelectorAll('.tarot-card.flipped').length > 0) return;
            el.classList.add('flipped');
            document.querySelectorAll('.tarot-card').forEach(c => { if(c !== el) c.classList.add('disabled'); });

            if(data.val !== 0) {
                if(type === 'punish') {
                    modStat(state.turn, 's', -data.val); 
                } else if (type === 'chance' && data.title === 'æ…¶æ›†æ–°æ”¿') {
                    modStat(state.turn, 's', data.val); 
                }
            }
            setTimeout(() => {
                document.getElementById('btn-confirm-select').classList.remove('hidden');
            }, 800);
        }

        function closeSelection() {
            document.getElementById('overlay-select').style.display = 'none';
            if(!document.getElementById('action-btns').classList.contains('hidden')) {
                closeQuestion();
            }
        }

        // --- Wheel Logic ---
        let wheelSpinning = false;
        function showWheel() {
            document.getElementById('overlay-wheel').style.display='flex';
            document.getElementById('wheel-container').style.display='block';
            document.getElementById('wheel-controls').style.display='block';
            document.getElementById('wheel-result-card').style.display='none';
            document.getElementById('wheel-canvas').style.transition = "none";
            document.getElementById('wheel-canvas').style.transform = "rotate(0deg)";
            initWheel();
            document.getElementById('btn-spin').disabled = false;
        }

        function initWheel() {
            const cvs = document.getElementById('wheel-canvas');
            const ctx = cvs.getContext('2d');
            const w=500, h=500, cx=250, cy=250, r=240;
            const len = db.wheel.length;
            const arc = Math.PI*2/len;
            const colors = ['#1a1a1a', '#333'];
            ctx.clearRect(0,0,w,h);
            ctx.save();
            ctx.translate(cx,cy);
            for(let i=0; i<len; i++) {
                const ang = i*arc;
                ctx.beginPath();
                ctx.moveTo(0,0);
                ctx.arc(0,0,r,ang,ang+arc);
                ctx.fillStyle = colors[i%2];
                ctx.fill();
                ctx.lineWidth = 2; ctx.strokeStyle = "#d4af37"; ctx.stroke();
                ctx.save();
                ctx.rotate(ang + arc/2);
                ctx.textAlign = "right";
                ctx.fillStyle = "#fff";
                ctx.font = "bold 18px Arial";
                ctx.fillText(db.wheel[i].title, r-20, 5);
                ctx.restore();
            }
            ctx.restore();
        }

        function spinWheel() {
            if(wheelSpinning) return;
            wheelSpinning = true;
            document.getElementById('btn-spin').disabled = true;
            const len = db.wheel.length;
            const winningIndex = Math.floor(Math.random() * len);
            const segmentAngle = 360 / len;
            const currentAngle = (winningIndex * segmentAngle) + (segmentAngle / 2);
            let rotateAngle = -90 - currentAngle;
            rotateAngle -= (360 * 5);
            const cvs = document.getElementById('wheel-canvas');
            cvs.style.transition = "transform 5s cubic-bezier(0.1,0,0.1,1)";
            cvs.style.transform = `rotate(${rotateAngle}deg)`;
            setTimeout(() => {
                showWheelResult(winningIndex);
                wheelSpinning = false;
            }, 5200);
        }

        function showWheelResult(idx) {
            const item = db.wheel[idx];
            document.getElementById('wheel-container').style.display = 'none';
            document.getElementById('wheel-controls').style.display = 'none';
            const card = document.getElementById('wheel-result-card');
            document.getElementById('w-res-title').innerText = item.title;
            document.getElementById('w-res-desc').innerText = item.desc;
            card.style.display = 'block';
        }

        function closeWheel() {
            document.getElementById('overlay-wheel').style.display = 'none';
        }

        // --- Excel Import/Export ---
        function downloadTemplate() {
            const wb = XLSX.utils.book_new();
            const qData = [["åˆ†é¡", "é¡Œç›®", "ç­”æ¡ˆ", "åœ–ç‰‡URL"]];
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(qData), "Questions");
            const rData = [["TeamA", "TeamB"]];
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(rData), "Roster");
            const cData = [["æ¨™é¡Œ", "æè¿°", "åˆ†æ•¸"]];
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(cData), "Chance");
            const pData = [["æ¨™é¡Œ", "æè¿°", "åˆ†æ•¸"]];
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(pData), "Punish");
            const wData = [["æ¨™é¡Œ", "æè¿°"]];
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(wData), "Wheel");
            XLSX.writeFile(wb, "å¤éŸ»å°æ±º_ç©ºç™½ç¯„æœ¬.xlsx");
        }

        function exportToExcel() {
            const wb = XLSX.utils.book_new();
            let qBody = db.questions.map(item => [item.cat, item.q, item.a, item.img]);
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet([["åˆ†é¡", "é¡Œç›®", "ç­”æ¡ˆ", "åœ–ç‰‡URL"]].concat(qBody)), "Questions");
            const maxLen = Math.max(db.roster.a.length, db.roster.b.length);
            let rBody = [];
            for(let i=0; i<maxLen; i++) rBody.push([db.roster.a[i] || "", db.roster.b[i] || ""]);
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet([["TeamA", "TeamB"]].concat(rBody)), "Roster");
            let cBody = db.ops.map(item => [item.title, item.desc, item.val]);
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet([["æ¨™é¡Œ", "æè¿°", "åˆ†æ•¸"]].concat(cBody)), "Chance");
            let pBody = db.puns.map(item => [item.title, item.desc, item.val]);
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet([["æ¨™é¡Œ", "æè¿°", "åˆ†æ•¸"]].concat(pBody)), "Punish");
            let wBody = db.wheel.map(item => [item.title, item.desc]);
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet([["æ¨™é¡Œ", "æè¿°"]].concat(wBody)), "Wheel");
            XLSX.writeFile(wb, "å¤éŸ»å°æ±º_è¨­å®š.xlsx");
        }

        function importFromExcel(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const wb = XLSX.read(data, {type: 'array'});
                let msg = "";
                const getSheetData = (name) => {
                    const ws = wb.Sheets[name];
                    return ws ? XLSX.utils.sheet_to_json(ws) : null;
                };
                const qs = getSheetData("Questions");
                if(qs) {
                    db.questions = qs.map(row => ({
                        cat: row["åˆ†é¡"] || "æœªåˆ†é¡",
                        q: row["é¡Œç›®"] || "ç„¡é¡Œç›®",
                        a: row["ç­”æ¡ˆ"] || "",
                        img: row["åœ–ç‰‡URL"] || ""
                    }));
                    msg += `é¡Œç›®: ${db.questions.length} é¡Œ\n`;
                }
                const rs = getSheetData("Roster");
                if(rs) {
                    let newA = [], newB = [];
                    rs.forEach(row => {
                        if(row["TeamA"]) newA.push(row["TeamA"]);
                        if(row["TeamB"]) newB.push(row["TeamB"]);
                    });
                    if(newA.length) db.roster.a = newA;
                    if(newB.length) db.roster.b = newB;
                    msg += `åå–®: A(${newA.length}), B(${newB.length})\n`;
                }
                alert("åŒ¯å…¥æˆåŠŸï¼\n" + msg);
                state.usage = { a: {}, b: {} };
                updateUI();
                updateSettingsUI();
                input.value = "";
            };
            reader.readAsArrayBuffer(file);
        }
    </script>
</body>
</html>
